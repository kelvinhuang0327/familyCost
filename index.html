<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Â∫≠Êî∂ÊîØÂπ≥Âè∞</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .member-stats {
            margin-bottom: 30px;
        }

        .record-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .member-stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .member-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .record-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-item.income {
            border-left-color: #51cf66;
        }

        .record-item.expense {
            border-left-color: #ff6b6b;
        }

        .record-info {
            flex: 1;
        }

        .record-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-amount {
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #51cf66;
        }

        .record-amount.expense {
            color: #ff6b6b;
        }


        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-records {
            font-size: 12px;
            margin-top: 5px;
        }

        .day-income {
            color: #51cf66;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(81, 207, 102, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-expense {
            color: #ff6b6b;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .import-section, .export-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .import-section h3, .export-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-card h4 {
            margin-bottom: 10px;
            color: #4facfe;
        }

        .import-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-card li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .import-card input[type="file"] {
            display: none;
        }

        .import-card button {
            margin-top: 15px;
        }

        .import-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .preview-table .status-valid {
            color: #51cf66;
        }

        .preview-table .status-invalid {
            color: #ff6b6b;
        }

        .import-actions, .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-section h3 {
            color: white;
        }

        .export-section p {
            opacity: 0.9;
        }

        .backup-options {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .backup-options h4 {
            margin-bottom: 15px;
            color: white;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .backup-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .backup-info p {
            margin-bottom: 8px;
        }

        .member-filter-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .member-filter-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .member-filter-section select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            background: white;
            cursor: pointer;
        }

        .member-filter-section select:focus {
            outline: none;
            border-color: #51cf66;
            box-shadow: 0 0 0 2px rgba(81, 207, 102, 0.2);
        }

        .member-filter-section button {
            margin-left: 10px;
            padding: 8px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .member-filter-section button:hover {
            background: #5a6268;
        }

        .sync-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
        }

        .sync-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .sync-section p {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .sync-instructions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sync-recovery {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-recovery h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-recovery p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .sync-step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .sync-step h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-step p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .sync-tips {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .sync-tips h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .sync-tips li {
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .fix-info {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 8px;
            font-style: italic;
        }

        .refund-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .refund-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .refund-instructions li {
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .refund-benefit {
            background: rgba(40, 167, 69, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #28a745;
        }

        .github-tips {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .sync-method {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .sync-method h5 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 14px;
        }
        
        .sync-method p {
            margin: 0 0 12px 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }
        
        .sync-btn {
            display: inline-block;
            padding: 8px 12px;
            margin: 2px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .github-btn {
            background: rgba(36, 41, 46, 0.8);
            border: 1px solid rgba(36, 41, 46, 0.9);
        }
        
        .github-btn:hover {
            background: rgba(36, 41, 46, 1);
            transform: translateY(-1px);
        }
        
        .qr-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .qr-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        
        .cloud-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .cloud-btn:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
            transform: translateY(-1px);
        }
        
        .link-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .link-btn:hover {
            background: linear-gradient(135deg, #3dd46b 0%, #32e7c7 100%);
            transform: translateY(-1px);
        }
        
        .email-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .email-btn:hover {
            background: linear-gradient(135deg, #f85d8a 0%, #fed030 100%);
            transform: translateY(-1px);
        }

        .github-tips p {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .github-tips ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .github-tips li {
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .github-tips em {
            font-style: italic;
            color: #fff;
        }

        .delete-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border: 1px solid #fed7d7;
        }

        .delete-section h3 {
            margin-bottom: 15px;
            color: #e53e3e;
        }

        .delete-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .delete-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .delete-card h4 {
            margin-bottom: 10px;
            color: #e53e3e;
        }

        .delete-card p {
            margin-bottom: 15px;
            color: #666;
        }

        #dataStats p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        #dataStats span {
            font-weight: bold;
            color: #e53e3e;
        }

        .filter-delete {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-delete select,
        .filter-delete input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e53e3e;
        }

        .delete-preview h4 {
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .delete-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* ÂúñË°®È†ÅÈù¢Ê®£Âºè */
        .chart-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-amount {
                margin: 10px 0;
            }
            
            .record-amount.income {
                color: #51cf66;
            }
            
            .record-amount.expense {
                color: #ff6b6b;
            }
            

            .import-options {
                grid-template-columns: 1fr;
            }

            .import-actions, .export-actions {
                flex-direction: column;
            }

            .sync-instructions {
                grid-template-columns: 1fr;
            }

            .backup-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ ÂÆ∂Â∫≠Êî∂ÊîØÂπ≥Âè∞</h1>
            <p>ËºïÈ¨ÜÁÆ°ÁêÜÊÇ®ÁöÑÂÆ∂Â∫≠Ë≤°Âãô</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Á∏ΩË¶Ω</button>
            <button class="nav-tab" onclick="showTab('list')">üìã ÂàóË°®</button>
            <button class="nav-tab" onclick="showTab('calendar')">üìÖ Êó•ÊõÜ</button>
            <button class="nav-tab" onclick="showTab('charts')">üìà ÂúñË°®</button>
            <button class="nav-tab" onclick="showTab('add')">‚ûï Êñ∞Â¢û</button>
            <button class="nav-tab" onclick="showTab('import')">üì• ÂåØÂÖ•</button>
        </div>

        <div class="content">
            <!-- Á∏ΩË¶ΩÈ†ÅÈù¢ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalExpense">$0</h3>
                        <p>Á∏ΩÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashExpense">$0</h3>
                        <p>ÁèæÈáëÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="creditExpense">$0</h3>
                        <p>‰ø°Áî®Âç°ÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashBalance">$0</h3>
                        <p>ÁèæÈáëÈ§òÈ°ç</p>
                    </div>
                </div>
                <div class="member-stats">
                    <h3>ÂêÑÊàêÂì°Êî∂ÊîØÁµ±Ë®à</h3>
                    <div class="member-stats-grid" id="memberStats"></div>
                </div>
                <div class="records-list">
                    <h3>Ë®òÈåÑÊü•Áúã</h3>
                    <div class="record-filter-tabs">
                        <button class="filter-tab active" onclick="showAllRecords()">ÂÖ®ÈÉ®Ë®òÈåÑ</button>
                        <button class="filter-tab" onclick="showExpenseRecords()">Á∏ΩÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showCashExpenseRecords()">ÁèæÈáëÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showCreditExpenseRecords()">‰ø°Áî®Âç°ÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showIncomeRecords()">Á∏ΩÊî∂ÂÖ•</button>
                    </div>
                    <div class="member-filter-section">
                        <label for="memberFilter">ÊåâÊàêÂì°ÁØ©ÈÅ∏Ôºö</label>
                        <select id="memberFilter" onchange="filterByMember()">
                            <option value="">ÊâÄÊúâÊàêÂì°</option>
                        </select>
                        <button onclick="clearMemberFilter()">Ê∏ÖÈô§ÁØ©ÈÅ∏</button>
                    </div>
                    <div id="recentRecords"></div>
                </div>
            </div>

            <!-- ÂàóË°®È†ÅÈù¢ -->
            <div id="list" class="tab-content">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="ÊêúÂ∞ãË®òÈåÑ..." onkeyup="filterRecords()">
                    <select id="memberFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÊàêÂì°</option>
                        <option value="Kelvin">Kelvin</option>
                        <option value="Phuong">Phuong</option>
                        <option value="Ryan">Ryan</option>
                        <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                    </select>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                        <option value="income">Êî∂ÂÖ•</option>
                        <option value="expense">ÊîØÂá∫</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRecords()">
                </div>
                <div class="records-list">
                    <div id="allRecords"></div>
                </div>
            </div>

            <!-- Êó•ÊõÜÈ†ÅÈù¢ -->
            <div id="calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ ‰∏äÊúà</button>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">‰∏ãÊúà ‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- ÂúñË°®È†ÅÈù¢ -->
            <div id="charts" class="tab-content">
                <div class="chart-controls">
                    <div class="chart-filter-bar">
                        <select id="chartYear" onchange="updateCharts()">
                            <option value="2024">2024Âπ¥</option>
                            <option value="2025" selected>2025Âπ¥</option>
                        </select>
                        <select id="chartMonth" onchange="updateCharts()">
                            <option value="1">1Êúà</option>
                            <option value="2">2Êúà</option>
                            <option value="3">3Êúà</option>
                            <option value="4">4Êúà</option>
                            <option value="5">5Êúà</option>
                            <option value="6">6Êúà</option>
                            <option value="7">7Êúà</option>
                            <option value="8">8Êúà</option>
                            <option value="9">9Êúà</option>
                            <option value="10">10Êúà</option>
                            <option value="11">11Êúà</option>
                            <option value="12">12Êúà</option>
                        </select>
                        <button class="btn" onclick="refreshCharts()">üîÑ ÈáçÊñ∞Êï¥ÁêÜ</button>
                    </div>
                </div>

                <!-- Êî∂ÊîØË∂®Âã¢ÂúñË°® -->
                <div class="chart-section">
                    <h3>üìà Êî∂ÊîØË∂®Âã¢</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- È°ûÂà•Áµ±Ë®àÂúñË°® -->
                <div class="chart-section">
                    <h3>ü•ß È°ûÂà•Áµ±Ë®à</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- ÊàêÂì°Êî∂ÊîØÂ∞çÊØî -->
                <div class="chart-section">
                    <h3>üë• ÊàêÂì°Êî∂ÊîØÂ∞çÊØî</h3>
                    <div class="chart-container">
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÈ†ÅÈù¢ -->
            <div id="add" class="tab-content">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="member">ÊàêÂì°</label>
                            <select id="member" required>
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="type">È°ûÂûã</label>
                            <select id="type" required onchange="handleTypeChange()">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="income">Êî∂ÂÖ•</option>
                                <option value="expense">ÊîØÂá∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">ÈáëÈ°ç</label>
                            <input type="number" id="amount" step="0.01" min="0" required placeholder="Ë´ãËº∏ÂÖ•ÈáëÈ°ç">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="mainCategory" required onchange="handleMainCategoryChange()">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                            </select>
                            <input type="text" id="customMainCategory" placeholder="Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="subCategory">‰ªòÊ¨æÊñπÂºè</label>
                            <select id="subCategory" required>
                                <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                                <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                                <option value="ÁèæÈáë">ÁèæÈáë</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">ÊèèËø∞</label>
                        <textarea id="description" rows="3" placeholder="Ë´ãËº∏ÂÖ•Ë©≥Á¥∞ÊèèËø∞..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Êó•Êúü</label>
                        <input type="date" id="date" required>
                    </div>
                    <button type="submit" class="btn">Êñ∞Â¢ûË®òÈåÑ</button>
                </form>
            </div>

            <!-- ÂåØÂÖ•È†ÅÈù¢ -->
            <div id="import" class="tab-content">
                <div class="import-section">
                    <h3>üì• ÂåØÂÖ•Êî∂ÊîØË®òÈåÑ</h3>
                    <p>ÊîØÊè¥ CSV Âíå Excel Ê™îÊ°àÊ†ºÂºè</p>
                    
                    <div class="import-options">
                        <div class="import-card">
                            <h4>üìÑ CSV Ê™îÊ°àÂåØÂÖ•</h4>
                            <p>Ë´ãÁ¢∫‰øù CSV Ê™îÊ°àÂåÖÂê´‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö</p>
                            <ul>
                                <li>ÊàêÂì° (Kelvin, Phuong, Ryan, ÂÆ∂Áî®)</li>
                                <li>ÈáëÈ°ç (Ê≠£Êï∏=Êî∂ÂÖ•, Ë≤†Êï∏=ÊîØÂá∫)</li>
                                <li>‰∏ªÈ°ûÂà•</li>
                                <li>‰ªòÊ¨æÊñπÂºè (‰ø°Áî®Âç°/ÁèæÈáë)</li>
                                <li>ÊèèËø∞</li>
                                <li>Êó•Êúü (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVImport(event)">
                            <button class="btn" onclick="document.getElementById('csvFile').click()">ÈÅ∏Êìá CSV Ê™îÊ°à</button>
                        </div>
                        
                        <div class="import-card">
                            <h4>üìä Excel Ê™îÊ°àÂåØÂÖ•</h4>
                            <p>Ë´ãÁ¢∫‰øù Excel Ê™îÊ°àÂåÖÂê´‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö</p>
                            <ul>
                                <li>ÊàêÂì° (Kelvin, Phuong, Ryan, ÂÆ∂Áî®)</li>
                                <li>ÈáëÈ°ç (Ê≠£Êï∏=Êî∂ÂÖ•, Ë≤†Êï∏=ÊîØÂá∫)</li>
                                <li>‰∏ªÈ°ûÂà•</li>
                                <li>‰ªòÊ¨æÊñπÂºè (‰ø°Áî®Âç°/ÁèæÈáë)</li>
                                <li>ÊèèËø∞</li>
                                <li>Êó•Êúü (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                            <button class="btn" onclick="document.getElementById('excelFile').click()">ÈÅ∏Êìá Excel Ê™îÊ°à</button>
                        </div>
                    </div>
                    
                    <div class="import-preview" id="importPreview" style="display: none;">
                        <h4>È†êË¶ΩÂåØÂÖ•Êï∏Êìö</h4>
                        <div class="preview-table">
                            <table id="previewTable">
                                <thead>
                                    <tr>
                                        <th>ÊàêÂì°</th>
                                        <th>ÈáëÈ°ç</th>
                                        <th>‰∏ªÈ°ûÂà•</th>
                                        <th>‰ªòÊ¨æÊñπÂºè</th>
                                        <th>ÊèèËø∞</th>
                                        <th>Êó•Êúü</th>
                                        <th>ÁãÄÊÖã</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="import-actions">
                            <button class="btn btn-success" onclick="confirmImport()">Á¢∫Ë™çÂåØÂÖ•</button>
                            <button class="btn btn-danger" onclick="cancelImport()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>üì§ ÂåØÂá∫ÂäüËÉΩ</h3>
                    <p>Â∞áÁèæÊúâË®òÈåÑÂåØÂá∫ÁÇ∫ CSV Êàñ Excel Ê™îÊ°à</p>
                    <div class="export-actions">
                        <button class="btn" onclick="exportToCSV()">ÂåØÂá∫ÁÇ∫ CSV</button>
                        <button class="btn" onclick="exportToExcel()">ÂåØÂá∫ÁÇ∫ Excel</button>
                        <button class="btn" onclick="createSampleExcel()">ÂâµÂª∫Á§∫‰æã Excel</button>
                        <button class="btn" onclick="downloadDataJson()">üìÅ ‰∏ãËºâ data.json ÂÇô‰ªΩ</button>
                        <button class="btn" onclick="downloadExcelBackup()">üìä ‰∏ãËºâ Excel ÂÇô‰ªΩ</button>
                        <button class="btn" onclick="manualDataSync()">üîÑ ÊâãÂãïÂêåÊ≠•Ë≥áÊñô</button>
                    </div>
                    
                    <div class="backup-options">
                        <h4>üíæ ÈÄ≤ÈöéÂÇô‰ªΩÈÅ∏È†Ö</h4>
                        <div class="backup-buttons">
                            <button class="btn btn-primary" onclick="saveToLocalFile()">üíæ ‰øùÂ≠òÂà∞Êú¨Âú∞Ê™îÊ°à</button>
                            <button class="btn btn-success" onclick="saveToGitHub()">üêô Êõ¥Êñ∞ GitHub Ê™îÊ°à</button>
                        </div>
                        <div class="backup-info">
                            <p><strong>Êú¨Âú∞Ê™îÊ°à‰øùÂ≠òÔºö</strong>Áõ¥Êé•‰øùÂ≠òÂà∞ÊÇ®ÁöÑÈõªËÖ¶ÔºàÈúÄË¶ÅÁèæ‰ª£ÁÄèË¶ΩÂô®ÊîØÊè¥Ôºâ</p>
                            <p><strong>GitHub Êõ¥Êñ∞Ôºö</strong>Áõ¥Êé•Êõ¥Êñ∞ GitHub ‰∏äÁöÑ data.json Ê™îÊ°àÔºàÈúÄË¶Å Personal Access TokenÔºâ</p>
                        </div>
                    </div>
                </div>
                
                <div class="sync-section">
                    <h3>üåê Ë∑®ÁÄèË¶ΩÂô®ÂêåÊ≠•</h3>
                    <p><strong>‚ö†Ô∏è ÈáçË¶ÅÊèêÈÜíÔºö</strong>‰∏çÂêåÁÄèË¶ΩÂô®ÁöÑË≥áÊñôÊòØÁç®Á´ãÁöÑÔºåÈúÄË¶ÅÊâãÂãïÂêåÊ≠•ÊâçËÉΩ‰øùÊåÅ‰∏ÄËá¥ÔºÅ</p>
                    <div style="background: rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #ffc107; margin: 0 0 10px 0;">üí° Âø´ÈÄüÂêåÊ≠•Ê≠•È©üÔºö</h4>
                        <ol style="margin: 0; padding-left: 20px; color: white;">
                            <li>Âú®<strong>Áï∂ÂâçÁÄèË¶ΩÂô®</strong>‰∏≠ÈªûÊìä„Äåüì§ ‰∏ÄÈçµÂåØÂá∫„Äç</li>
                            <li>‰∏ãËºâÁîüÊàêÁöÑÊ™îÊ°à</li>
                            <li>Âú®<strong>ÂÖ∂‰ªñÁÄèË¶ΩÂô®</strong>‰∏≠ÈªûÊìä„Äåüì• ‰∏ÄÈçµÂåØÂÖ•„Äç</li>
                            <li>ÈÅ∏ÊìáÂâõÊâç‰∏ãËºâÁöÑÊ™îÊ°à</li>
                            <li>ÂÆåÊàêÔºÅË≥áÊñôÂ∑≤ÂêåÊ≠•</li>
                        </ol>
                    </div>
                    <div class="sync-instructions">
                        <div class="sync-step">
                            <h4>üì§ ‰∏ÄÈçµÂåØÂá∫</h4>
                            <p>‰∏ãËºâÁï∂ÂâçÁÄèË¶ΩÂô®ÁöÑÊâÄÊúâË≥áÊñô</p>
                            <button class="btn btn-primary" onclick="exportForSync()" style="font-size: 16px; padding: 12px 24px;">üì§ ÂåØÂá∫Ë≥áÊñô</button>
                        </div>
                        <div class="sync-step">
                            <h4>üì• ‰∏ÄÈçµÂåØÂÖ•</h4>
                            <p>ÂåØÂÖ•ÂÖ∂‰ªñÁÄèË¶ΩÂô®ÁöÑË≥áÊñôÊ™îÊ°à</p>
                            <input type="file" id="syncFile" accept=".json,.xlsx" style="display: none;" onchange="importSyncFile()">
                            <button class="btn btn-success" onclick="document.getElementById('syncFile').click()" style="font-size: 16px; padding: 12px 24px;">üì• ÂåØÂÖ•Ë≥áÊñô</button>
                        </div>
                    </div>
                    <div class="sync-recovery">
                        <h4>üîÑ Ë≥áÊñôÊÅ¢Âæ©</h4>
                        <p>Â¶ÇÊûúË≥áÊñôÊÑèÂ§ñ‰∏üÂ§±ÔºåÂèØ‰ª•ÂòóË©¶ÂæûËá™ÂãïÂÇô‰ªΩÊÅ¢Âæ©</p>
                        <button class="btn btn-warning" onclick="manualRestoreFromBackup()">ÂæûÂÇô‰ªΩÊÅ¢Âæ©Ë≥áÊñô</button>
                        <button class="btn btn-info" onclick="showBackupInfo()">Êü•ÁúãÂÇô‰ªΩË≥áË®ä</button>
                    </div>
                    
                    <div class="sync-recovery">
                        <h4>üîß Ë≥áÊñô‰øÆÂæ©</h4>
                        <p>Â¶ÇÊûúÁ∏ΩÊî∂ÂÖ•È°ØÁ§∫‰∏çÊ≠£Á¢∫ÔºåÂèØ‰ª•ÂòóË©¶‰øÆÂæ©Êî∂ÂÖ•Ë®òÈåÑ</p>
                        <button class="btn btn-danger" onclick="fixIncomeRecords()">‰øÆÂæ©Êî∂ÂÖ•Ë®òÈåÑ</button>
                        <p class="fix-info">Ê≠§ÂäüËÉΩÊúÉÁµ±‰∏ÄÊî∂ÂÖ•Ë®òÈåÑÁöÑË≠òÂà•ÈÇèËºØÔºåÁ¢∫‰øùÁ∏ΩÊî∂ÂÖ•Ê≠£Á¢∫È°ØÁ§∫</p>
                    </div>
                    
                    <div class="sync-recovery">
                        <h4>üí∞ ÈÄÄË≤ªË®òÈåÑË™™Êòé</h4>
                        <div class="refund-instructions">
                            <p><strong>Â¶Ç‰ΩïË®òÈåÑÈÄÄË≤ªÔºàÂ¶ÇÁâôÈÜ´ÈÄÄË≤ªÔºâÔºö</strong></p>
                            <ol>
                                <li>ÈÅ∏ÊìáÊàêÂì°ÔºöRyan</li>
                                <li>Ëº∏ÂÖ•ÈáëÈ°çÔºöÊ≠£Êï∏Ôºà‰æãÂ¶ÇÔºö500Ôºâ</li>
                                <li>ÈÅ∏Êìá‰∏ªÈ°ûÂà•Ôºöüí∞ ÈÄÄË≤ª</li>
                                <li>ÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºöÁèæÈáë</li>
                                <li>ÊèèËø∞ÔºöÁâôÈÜ´ÈÄÄË≤ªÔºàÊàñÂÖ∂‰ªñÈÄÄË≤ªË™™ÊòéÔºâ</li>
                            </ol>
                            <p class="refund-benefit">
                                <strong>ÊïàÊûúÔºö</strong><br>
                                ‚úÖ ÁèæÈáëÊµÅÊúÉÂ¢ûÂä†ÔºàÊ≠£ÁöÑÁèæÈáëÊµÅÔºâ<br>
                                ‚úÖ Ryan ÁöÑÈ§òÈ°çÊúÉÂ¢ûÂä†<br>
                                ‚úÖ ‰∏çÊúÉÂΩ±ÈüøÂÆ∂Áî®Áµ±Ë®à<br>
                                ‚úÖ Ê≠£Á¢∫ÂèçÊò†ÈÄÄË≤ªÁöÑÊúÉË®àÊÄßË≥™
                            </p>
                        </div>
                    </div>
                    <div class="sync-tips">
                        <h4>üí° ‰ΩøÁî®ÊèêÁ§∫</h4>
                        <ul>
                            <li>Âª∫Ë≠∞‰ΩøÁî® JSON Ê†ºÂºèÈÄ≤Ë°åÂêåÊ≠•ÔºåÁõ∏ÂÆπÊÄßÊõ¥Â•Ω</li>
                            <li>ÊØèÊ¨°ÂêåÊ≠•ÂâçÂª∫Ë≠∞ÂÖàÂÇô‰ªΩÁèæÊúâË≥áÊñô</li>
                            <li>ÂêåÊ≠•Ê™îÊ°àÊúÉËá™ÂãïÂêà‰ΩµÈáçË§áË®òÈåÑ</li>
                        </ul>
                        
                        <h4>üîç Ë™øË©¶‰ø°ÊÅØ</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 12px;">
                            <p><strong>Áï∂ÂâçÁãÄÊÖãÔºö</strong></p>
                            <p>Ë®òÈåÑÊï∏Èáè: <span id="debugRecordCount">-</span> Á≠Ü</p>
                            <p>ÊúÄÂæå‰øùÂ≠ò: <span id="debugLastSave">-</span></p>
                            <p>localStorage: <span id="debugLocalStorage">-</span></p>
                            <button onclick="showDebugInfo()" style="margin-top: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">Âà∑Êñ∞Ë™øË©¶‰ø°ÊÅØ</button>
                            <button onclick="checkAndFixSyncIssues()" style="padding: 5px 10px; background: rgba(0,123,255,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">Ê™¢Êü•ÂêåÊ≠•ÂïèÈ°å</button>
                            <button onclick="forceSync()" style="padding: 5px 10px; background: rgba(255,193,7,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">Âº∑Âà∂ÂêåÊ≠•</button>
                            <button onclick="fixMemberOptions()" style="padding: 5px 10px; background: rgba(40,167,69,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">‰øÆÂæ©ÊàêÂì°ÈÅ∏È†Ö</button>
                            <button onclick="checkDataAnomalies()" style="padding: 5px 10px; background: rgba(220,53,69,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">Ê™¢Êü•Êï∏ÊìöÁï∞Â∏∏</button>
                            <button onclick="removeDuplicateRecords()" style="padding: 5px 10px; background: rgba(108,117,125,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">Ê∏ÖÁêÜÈáçË§áË®òÈåÑ</button>
                            <button onclick="migrateCategoryNames()" style="padding: 5px 10px; background: rgba(255,193,7,0.3); border: none; border-radius: 3px; color: white; cursor: pointer;">ÈÅ∑ÁßªÈ°ûÂà•ÂêçÁ®±</button>
                        </div>
                        
                        <h4>üîÑ Â§öÁ®ÆÂêåÊ≠•ÊñπÊ°à</h4>
                        <div class="sync-options">
                            <div class="sync-method">
                                <h5>üì± QRÁ¢ºÂêåÊ≠•ÔºàÊé®Ëñ¶Ôºâ</h5>
                                <p>Âø´ÈÄüÂú®ÊâãÊ©üÂíåÈõªËÖ¶ÈñìÂêåÊ≠•</p>
                                <button onclick="generateQRCode()" class="sync-btn qr-btn">üì± ÁîüÊàêQRÁ¢º</button>
                                <button onclick="scanQRCode()" class="sync-btn qr-btn">üì∑ ÊéÉÊèèQRÁ¢º</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>‚òÅÔ∏è Èõ≤Á´ØÂêåÊ≠•</h5>
                                <p>Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´ØÂÑ≤Â≠ò</p>
                                <button onclick="syncToCloud()" class="sync-btn cloud-btn">‚òÅÔ∏è ‰∏äÂÇ≥Âà∞Èõ≤Á´Ø</button>
                                <button onclick="syncFromCloud()" class="sync-btn cloud-btn">‚¨áÔ∏è ÂæûÈõ≤Á´Ø‰∏ãËºâ</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>üîó ÈÄ£ÁµêÂêåÊ≠•</h5>
                                <p>ÈÄöÈÅéÈÄ£ÁµêÂàÜ‰∫´Ë≥áÊñô</p>
                                <button onclick="generateSyncLink()" class="sync-btn link-btn">üîó ÁîüÊàêÂêåÊ≠•ÈÄ£Áµê</button>
                                <button onclick="syncFromLink()" class="sync-btn link-btn">‚¨áÔ∏è ÂæûÈÄ£ÁµêÂêåÊ≠•</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>üìß ÈÉµ‰ª∂ÂêåÊ≠•</h5>
                                <p>ÈÄöÈÅéÈÉµ‰ª∂ÈôÑ‰ª∂ÂêåÊ≠•</p>
                                <button onclick="emailSyncData()" class="sync-btn email-btn">üìß ÈÉµ‰ª∂ÂêåÊ≠•</button>
                            </div>
                        </div>
                        
                        <h4>üåê GitHub Â≠òÊ™îÊ©üÂà∂</h4>
                        <div class="github-tips">
                            <p><strong>GitHub Êèê‰æõÂ§öÁ®ÆÂ≠òÊ™îÊ©üÂà∂Ôºö</strong></p>
                            <div style="margin: 15px 0;">
                                <h5>üìÅ Ê™îÊ°àÂ≠òÊ™î (Êé®Ëñ¶)</h5>
                                <p>Áõ¥Êé•Êõ¥Êñ∞ GitHub ÂÄâÂ∫´‰∏≠ÁöÑ data.json Ê™îÊ°à</p>
                                <button onclick="saveToGitHubFile()" class="sync-btn github-btn">üìÅ Â≠òÊ™îÂà∞ GitHub</button>
                                <button onclick="loadFromGitHubFile()" class="sync-btn github-btn">üì• Âæû GitHub ËºâÂÖ•</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5>üìù Issue Â≠òÊ™î</h5>
                                <p>Â∞áË≥áÊñô‰ΩúÁÇ∫ Issue Êèê‰∫§Âà∞ÂÄâÂ∫´</p>
                                <button onclick="saveToGitHubIssue()" class="sync-btn github-btn">üìù Â≠òÊ™îÁÇ∫ Issue</button>
                                <button onclick="loadFromGitHubIssues()" class="sync-btn github-btn">üìã Âæû Issues ËºâÂÖ•</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5>üè∑Ô∏è Release Â≠òÊ™î</h5>
                                <p>ÂâµÂª∫ÁâàÊú¨ÁôºÂ∏É‰æÜÂ≠òÊ™îÈáçË¶ÅË≥áÊñô</p>
                                <button onclick="createGitHubRelease()" class="sync-btn github-btn">üè∑Ô∏è ÂâµÂª∫ÁâàÊú¨Â≠òÊ™î</button>
                            </div>
                            
                            <div style="background: rgba(255,193,7,0.2); padding: 10px; border-radius: 5px; margin-top: 15px;">
                                <p><strong>‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong>GitHub Â≠òÊ™îÈúÄË¶Å Personal Access Token</p>
                                <p>Ë´ãÂú® GitHub Settings > Developer settings > Personal access tokens ‰∏≠ÂâµÂª∫ token</p>
                                <button onclick="clearGitHubToken()" class="sync-btn github-btn" style="margin-top: 10px;">üîÑ ÈáçÊñ∞Ë®≠ÂÆö Token</button>
                                <button onclick="testGitHubToken()" class="sync-btn github-btn" style="margin-top: 5px;">üß™ Ê∏¨Ë©¶ Token</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="delete-section">
                    <h3>üóëÔ∏è ÁßªÈô§Ë≥áÊñôÂäüËÉΩ</h3>
                    <p>ÁÆ°ÁêÜÊÇ®ÁöÑÊî∂ÊîØË®òÈåÑÊï∏Êìö</p>
                    
                    <div class="delete-options">
                        <div class="delete-card">
                            <h4>üìä Êï∏ÊìöÁµ±Ë®à</h4>
                            <div id="dataStats">
                                <p>Á∏ΩË®òÈåÑÊï∏Ôºö<span id="totalRecords">0</span></p>
                                <p>Êî∂ÂÖ•Ë®òÈåÑÔºö<span id="incomeRecords">0</span></p>
                                <p>ÊîØÂá∫Ë®òÈåÑÔºö<span id="expenseRecords">0</span></p>
                                <p>Êï∏ÊìöÂ§ßÂ∞èÔºö<span id="dataSize">0 KB</span></p>
                                <p>Êìç‰ΩúÊ¨°Êï∏Ôºö<span id="operationCount">0</span></p>
                                <p>ÊúÄÂæåÂÇô‰ªΩÔºö<span id="lastBackup">Êú™ÂÇô‰ªΩ</span></p>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>üîç ÁØ©ÈÅ∏Âà™Èô§</h4>
                            <p>Ê†πÊìöÊ¢ù‰ª∂Âà™Èô§Ë®òÈåÑ</p>
                            <div class="filter-delete">
                            <select id="deleteMemberFilter">
                                <option value="">ÊâÄÊúâÊàêÂì°</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                            </select>
                                <select id="deleteTypeFilter">
                                    <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                                    <option value="income">Êî∂ÂÖ•</option>
                                    <option value="expense">ÊîØÂá∫</option>
                                </select>
                                <input type="date" id="deleteDateFrom" placeholder="ÈñãÂßãÊó•Êúü">
                                <input type="date" id="deleteDateTo" placeholder="ÁµêÊùüÊó•Êúü">
                                <button class="btn btn-danger" onclick="previewDelete()">È†êË¶ΩÂà™Èô§</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>‚ö†Ô∏è Âç±Èö™Êìç‰Ωú</h4>
                            <p>Ë´ãË¨πÊÖé‰ΩøÁî®‰ª•‰∏ãÂäüËÉΩ</p>
                            <div class="danger-actions">
                                <button class="btn btn-danger" onclick="clearAllData()">Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö</button>
                                <button class="btn" onclick="backupData()">ÂÇô‰ªΩÊï∏Êìö</button>
                                <button class="btn" onclick="restoreData()">ÈÇÑÂéüÊï∏Êìö</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delete-preview" id="deletePreview" style="display: none;">
                        <h4>È†êË¶ΩÂ∞áË¶ÅÂà™Èô§ÁöÑË®òÈåÑ</h4>
                        <div class="preview-table">
                            <table id="deletePreviewTable">
                                <thead>
                                    <tr>
                                        <th>ÊàêÂì°</th>
                                        <th>ÈáëÈ°ç</th>
                                        <th>‰∏ªÈ°ûÂà•</th>
                                        <th>‰ªòÊ¨æÊñπÂºè</th>
                                        <th>ÊèèËø∞</th>
                                        <th>Êó•Êúü</th>
                                    </tr>
                                </thead>
                                <tbody id="deletePreviewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="delete-actions">
                            <button class="btn btn-danger" onclick="confirmDelete()">Á¢∫Ë™çÂà™Èô§</button>
                            <button class="btn" onclick="cancelDelete()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØË®òÈåÑÁöÑÊ®°ÊÖãÊ°Ü -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Á∑®ËºØË®òÈåÑ</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMember">ÊàêÂì°</label>
                        <select id="editMember" required>
                            <option value="Kelvin">Kelvin</option>
                            <option value="Phuong">Phuong</option>
                            <option value="Ryan">Ryan</option>
                            <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editType">È°ûÂûã</label>
                        <select id="editType" required>
                            <option value="income">Êî∂ÂÖ•</option>
                            <option value="expense">ÊîØÂá∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">ÈáëÈ°ç</label>
                        <input type="number" id="editAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="editMainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="editMainCategory" required>
                            </select>
                        </div>
                    <div class="form-group">
                        <label for="editSubCategory">‰ªòÊ¨æÊñπÂºè</label>
                        <select id="editSubCategory" required>
                            <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                            <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                            <option value="ÁèæÈáë">ÁèæÈáë</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">ÊèèËø∞</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editDate">Êó•Êúü</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">ÂÑ≤Â≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ê∑ªÂä† CSV Âíå Excel Ëß£ÊûêÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Ê∑ªÂä† Chart.js ÂúñË°®Â∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script>
        // Êï∏ÊìöÂ≠òÂÑ≤
        let records = JSON.parse(localStorage.getItem('familyRecords')) || [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Ë™øË©¶ÂáΩÊï∏ÔºöÈ°ØÁ§∫Ë®òÈåÑË©≥ÊÉÖ
        function logRecordsDetail(title, recordsArray = records) {
            console.log(`\n=== ${title} ===`);
            console.log(`Ë®òÈåÑÊï∏Èáè: ${recordsArray.length}`);
            
            if (recordsArray.length > 0) {
                console.log('Ë®òÈåÑË©≥ÊÉÖ:');
                recordsArray.forEach((record, index) => {
                    console.log(`${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} - ${record.date} (${record.type})`);
                });
                
                // Áµ±Ë®à‰ø°ÊÅØ
                const incomeTotal = recordsArray.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
                const expenseTotal = recordsArray.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
                console.log(`\nÁµ±Ë®àÊëòË¶Å:`);
                console.log(`- Êî∂ÂÖ•Á∏ΩÈ°ç: $${incomeTotal.toLocaleString()}`);
                console.log(`- ÊîØÂá∫Á∏ΩÈ°ç: $${expenseTotal.toLocaleString()}`);
                console.log(`- Ê∑®È°ç: $${(incomeTotal - expenseTotal).toLocaleString()}`);
                
                // ÊåâÊàêÂì°Áµ±Ë®à
                const memberStats = {};
                recordsArray.forEach(record => {
                    if (!memberStats[record.member]) {
                        memberStats[record.member] = { income: 0, expense: 0, count: 0 };
                    }
                    memberStats[record.member][record.type] += record.amount;
                    memberStats[record.member].count++;
                });
                
                console.log(`\nÊåâÊàêÂì°Áµ±Ë®à:`);
                Object.keys(memberStats).forEach(member => {
                    const stats = memberStats[member];
                    console.log(`${member}: Êî∂ÂÖ• $${stats.income.toLocaleString()}, ÊîØÂá∫ $${stats.expense.toLocaleString()}, Ë®òÈåÑ ${stats.count} Á≠Ü`);
                });
            } else {
                console.log('Ê≤íÊúâË®òÈåÑ');
            }
            console.log('================\n');
        }

        // ÂÖ®Â±ÄË™øË©¶ÂáΩÊï∏ÔºåÂèØÂú®ÊéßÂà∂Âè∞Ë™øÁî®
        window.showRecords = function() {
            logRecordsDetail('Áï∂ÂâçÊâÄÊúâË®òÈåÑ');
        };
        
        window.showMemberRecords = function(memberName) {
            if (memberName) {
                const memberRecords = records.filter(r => r.member === memberName);
                logRecordsDetail(`${memberName} ÁöÑË®òÈåÑ`, memberRecords);
            } else {
                console.log('Ë´ãÊåáÂÆöÊàêÂì°ÂêçÁ®±Ôºå‰æãÂ¶ÇÔºöshowMemberRecords("Kelvin")');
                console.log('ÂèØÁî®ÊàêÂì°:', familyMembers);
            }
        };
        
        window.showRecordsByType = function(type) {
            if (type && ['income', 'expense'].includes(type)) {
                const typeRecords = records.filter(r => r.type === type);
                logRecordsDetail(`${type} È°ûÂûãË®òÈåÑ`, typeRecords);
            } else {
                console.log('Ë´ãÊåáÂÆöÈ°ûÂûãÔºå‰æãÂ¶ÇÔºöshowRecordsByType("income") Êàñ showRecordsByType("expense")');
            }
        };
        
        // Ê™¢Êü•ÊòØÂê¶Êúâ2025Âπ¥ÁöÑË®òÈåÑÔºåÂ¶ÇÊûúÊúâÂâáÂàáÊèõÂà∞2025Âπ¥
        function checkAndSwitchTo2025() {
            const has2025Records = records.some(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === 2025;
            });
            
            if (has2025Records) {
                currentYear = 2025;
                console.log('Ê™¢Ê∏¨Âà∞2025Âπ¥Ë®òÈåÑÔºåÂàáÊèõÊó•ÊõÜÂà∞2025Âπ¥');
                updateCalendar();
            }
        }
        let importData = []; // ÂÑ≤Â≠òË¶ÅÂåØÂÖ•ÁöÑÊï∏Êìö
        let deleteData = []; // ÂÑ≤Â≠òË¶ÅÂà™Èô§ÁöÑÊï∏Êìö
        let dataBackup = null; // Êï∏ÊìöÂÇô‰ªΩ
        
        // ÂúñË°®Áõ∏ÈóúËÆäÊï∏
        let trendChart = null;
        let categoryChart = null;
        let memberChart = null;

        // È°ûÂà•ÈÅ∏È†Ö
        const categories = {
            income: ['Êî∂ÂÖ•', 'ÁèæÈáëÊµÅÊî∂ÂÖ•'],
            expense: {
                'Â®õÊ®Ç': [],
                'Êó•Â∏∏': [],
                'È§êÈ£≤': [],
                'Ê•äÊ¢Ö': [],
                '‰∫§ÈÄö': [],
                'ÂÖ∂‰ªñÊîØÂá∫': [],
                'ÈÜ´ÁôÇ': ['ÁâôÈÜ´', 'Ë®∫ÊâÄ', 'Ëó•ÂìÅ', 'ÂÅ•Ê™¢'],
                'Á¶ÆÁâ©': [],
                'Â≠∏Ë≤ª': [],
                'ÁèæÈáëÊµÅÊîØÂá∫': []
            }
        };

        // ÂÆ∂Â∫≠ÊàêÂì°
        const familyMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];

        // Âõ∫ÂÆöÊîØÂá∫ÊèêÈÜí
        const recurringExpenses = [
            { name: 'ÊàøÁßü', amount: 15000, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊàøË≤∏', amount: 21454, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊâãÊ©üË≤ª', amount: 1200, day: 15, member: 'Kelvin' },
            { name: 'Á∂≤Ë∑ØË≤ª', amount: 1598, day: 15, member: 'Phuong' }
        ];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkCrossBrowserSync();
        });

        async function initializeApp() {
            console.log('ÈñãÂßãÂàùÂßãÂåñÊáâÁî®Á®ãÂºè...');
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂÇô‰ªΩÂèØ‰ª•ÊÅ¢Âæ©
            await checkAndRestoreFromBackup();
            
            // ÂòóË©¶ÂæûÊ™îÊ°àËÆÄÂèñË≥áÊñô
            await loadDataFromFile();
            
            // Ê™¢Êü•‰∏¶ÂêåÊ≠•Ë≥áÊñô
            await syncDataBetweenSources();
            
            // ÈÅ∑ÁßªËàäÁöÑÊàêÂì°ÂêçÁ®±
            migrateMemberNames();
            
            // ÈÅ∑ÁßªÊîØÂá∫È°ûÂà•ÂêçÁ®±
            migrateCategoryNames();
            
            console.log('ÂàùÂßãÂåñÂÆåÊàêÔºåÁï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            logRecordsDetail('ÂàùÂßãÂåñÂÆåÊàê - ÊâÄÊúâË®òÈåÑ'); // ‰ΩøÁî®Êñ∞ÁöÑË™øË©¶ÂáΩÊï∏
            
            updateCategoryOptions();
            updateMemberFilterOptions();
            ensureMemberOptions(); // Á¢∫‰øùÊâÄÊúâÊàêÂì°ÈÅ∏È†ÖÈÉΩÊ≠£Á¢∫Ë®≠ÁΩÆ
            updateStats();
            updateMemberStats();
            showAllRecords(); // ÈªòË™çÈ°ØÁ§∫ÂÖ®ÈÉ®Ë®òÈåÑ
            updateAllRecords();
            updateCalendar();
            setTodayDate();
            updateDataStats();
            
            // Â¶ÇÊûúÊ≤íÊúâË®òÈåÑÔºå‰∏çËá™ÂãïÊ∑ªÂä†Á§∫‰æãÊï∏Êìö
            // if (records.length === 0) {
            //     addSampleData();
            // }
            
            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
            checkAndSwitchTo2025();
            
            console.log('ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂÆåÊàê');
            
            // Êõ¥Êñ∞Ë™øË©¶‰ø°ÊÅØ
            updateDebugInfo();
            
            // Ê™¢Êü•URL‰∏≠ÊòØÂê¶ÊúâÂêåÊ≠•ÂèÉÊï∏
            checkURLSync();
        }

        // Êõ¥Êñ∞Ë™øË©¶‰ø°ÊÅØ
        function updateDebugInfo() {
            const debugRecordCount = document.getElementById('debugRecordCount');
            const debugLastSave = document.getElementById('debugLastSave');
            const debugLocalStorage = document.getElementById('debugLocalStorage');
            
            if (debugRecordCount) {
                debugRecordCount.textContent = records.length;
            }
            
            if (debugLastSave) {
                const lastSave = localStorage.getItem('lastSaveTime');
                const saveCount = localStorage.getItem('saveCount') || '0';
                debugLastSave.textContent = lastSave ? 
                    `${new Date(lastSave).toLocaleString('zh-TW')} (Á¨¨${saveCount}Ê¨°‰øùÂ≠ò)` : 'Êú™‰øùÂ≠ò';
            }
            
            if (debugLocalStorage) {
                const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                const localCount = localRecords.length;
                const memoryCount = records.length;
                const status = localCount === memoryCount ? '‚úÖ ÂêåÊ≠•' : '‚ö†Ô∏è ‰∏çÂêåÊ≠•';
                debugLocalStorage.textContent = `${localCount} Á≠ÜË®òÈåÑ (Ë®òÊÜ∂È´î: ${memoryCount}) ${status}`;
            }
        }

        // È°ØÁ§∫Ë©≥Á¥∞Ë™øË©¶‰ø°ÊÅØ
        function showDebugInfo() {
            const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
            const lastSave = localStorage.getItem('lastSaveTime');
            const backupCount = localStorage.getItem('backupCount') || '0';
            
            let debugMessage = `üîç Ë™øË©¶‰ø°ÊÅØ\n\n`;
            debugMessage += `Ë®òÊÜ∂È´îË®òÈåÑÊï∏: ${records.length} Á≠Ü\n`;
            debugMessage += `localStorageË®òÈåÑÊï∏: ${localRecords.length} Á≠Ü\n`;
            debugMessage += `ÊúÄÂæå‰øùÂ≠òÊôÇÈñì: ${lastSave ? new Date(lastSave).toLocaleString('zh-TW') : 'Êú™‰øùÂ≠ò'}\n`;
            debugMessage += `ÂÇô‰ªΩË®àÊï∏: ${backupCount}\n\n`;
            
            if (records.length !== localRecords.length) {
                debugMessage += `‚ö†Ô∏è Ë≠¶ÂëäÔºöË®òÊÜ∂È´îËàálocalStorageË®òÈåÑÊï∏‰∏ç‰∏ÄËá¥ÔºÅ\n`;
                debugMessage += `ÈÄôÂèØËÉΩÊòØÂêåÊ≠•ÂïèÈ°åÁöÑÂéüÂõ†„ÄÇ\n\n`;
            }
            
            debugMessage += `ÊúÄËøëÁöÑË®òÈåÑÔºö\n`;
            records.slice(-3).forEach((record, index) => {
                debugMessage += `${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} (${record.date})\n`;
            });
            
            alert(debugMessage);
            
            // Êõ¥Êñ∞Ë™øË©¶‰ø°ÊÅØÈ°ØÁ§∫
            updateDebugInfo();
        }

        // Ê™¢Êü•‰∏¶‰øÆÂæ©Ë≥áÊñôÂêåÊ≠•ÂïèÈ°å
        function checkAndFixSyncIssues() {
            try {
                const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                const memoryCount = records.length;
                const localCount = localRecords.length;
                
                console.log('Ê™¢Êü•ÂêåÊ≠•ÁãÄÊÖã:');
                console.log('- Ë®òÊÜ∂È´îË®òÈåÑÊï∏:', memoryCount);
                console.log('- localStorageË®òÈåÑÊï∏:', localCount);
                
                let issues = [];
                let fixes = [];
                
                // Ê™¢Êü•Ë®òÈåÑÊï∏Èáè‰∏ç‰∏ÄËá¥
                if (memoryCount !== localCount) {
                    issues.push(`Ë®òÈåÑÊï∏Èáè‰∏ç‰∏ÄËá¥ (Ë®òÊÜ∂È´î: ${memoryCount}, localStorage: ${localCount})`);
                    if (localCount > memoryCount) {
                        records = localRecords;
                        fixes.push('Â∑≤Âæû localStorage ÊÅ¢Âæ©Ë®òÈåÑ');
                    } else {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        fixes.push('Â∑≤Â∞áË®òÊÜ∂È´îË®òÈåÑÂêåÊ≠•Âà∞ localStorage');
                    }
                }
                
                // Ê™¢Êü•ÊúÄÂæå‰øùÂ≠òÊôÇÈñì
                const lastSave = localStorage.getItem('lastSaveTime');
                if (!lastSave) {
                    issues.push('Áº∫Â∞ëÊúÄÂæå‰øùÂ≠òÊôÇÈñìË®òÈåÑ');
                    localStorage.setItem('lastSaveTime', new Date().toISOString());
                    fixes.push('Â∑≤Ë®≠ÁΩÆÊúÄÂæå‰øùÂ≠òÊôÇÈñì');
                }
                
                // Ê™¢Êü•Ë®òÈåÑÂÆåÊï¥ÊÄß
                const invalidRecords = records.filter(record => 
                    !record.id || !record.member || !record.type || !record.amount || !record.date
                );
                if (invalidRecords.length > 0) {
                    issues.push(`ÁôºÁèæ ${invalidRecords.length} Á≠Ü‰∏çÂÆåÊï¥ÁöÑË®òÈåÑ`);
                    records = records.filter(record => 
                        record.id && record.member && record.type && record.amount && record.date
                    );
                    fixes.push(`Â∑≤ÁßªÈô§ ${invalidRecords.length} Á≠Ü‰∏çÂÆåÊï¥ÁöÑË®òÈåÑ`);
                }
                
                // È°ØÁ§∫ÁµêÊûú
                if (issues.length === 0) {
                    alert('‚úÖ Ë≥áÊñôÂêåÊ≠•Ê™¢Êü•ÂÆåÊàêÔºåÊ≤íÊúâÁôºÁèæÂïèÈ°åÔºÅ');
                } else {
                    const message = `üîß Ë≥áÊñôÂêåÊ≠•Ê™¢Êü•ÂÆåÊàê\n\nÁôºÁèæÂïèÈ°å:\n${issues.map(i => '‚Ä¢ ' + i).join('\n')}\n\nÂ∑≤‰øÆÂæ©:\n${fixes.map(f => '‚Ä¢ ' + f).join('\n')}`;
                    alert(message);
                    
                    // Êõ¥Êñ∞È°ØÁ§∫
                    updateStats();
                    updateMemberStats();
                    updateAllRecords();
                    updateCalendar();
                    updateDataStats();
                    updateDebugInfo();
                }
                
            } catch (error) {
                console.error('Ê™¢Êü•ÂêåÊ≠•ÂïèÈ°åÊôÇÁôºÁîüÈåØË™§:', error);
                alert('Ê™¢Êü•ÂêåÊ≠•ÂïèÈ°åÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ„ÄÇ');
            }
        }

        // Âº∑Âà∂ÂêåÊ≠•Êï∏Êìö
        function forceSync() {
            if (confirm('Âº∑Âà∂ÂêåÊ≠•Â∞áÈáçÊñ∞ËºâÂÖ•ÊâÄÊúâÊï∏Êìö‰∏¶Á¢∫‰øù‰∏ÄËá¥ÊÄß„ÄÇ\n\nÁ¢∫ÂÆöË¶ÅÂü∑Ë°åÂóéÔºü')) {
                try {
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                    
                    console.log('Âº∑Âà∂ÂêåÊ≠•ÂâçÁãÄÊÖã:');
                    console.log('- Ë®òÊÜ∂È´îË®òÈåÑÊï∏:', records.length);
                    console.log('- localStorageË®òÈåÑÊï∏:', localRecords.length);
                    
                    // ‰ΩøÁî®ËºÉÂ§öÁöÑÊï∏Êìö‰ΩúÁÇ∫Ê¨äÂ®Å‰æÜÊ∫ê
                    if (localRecords.length >= records.length) {
                        records = localRecords;
                        console.log('‰ΩøÁî® localStorage Êï∏Êìö‰ΩúÁÇ∫Ê¨äÂ®Å‰æÜÊ∫ê');
                    } else {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('‰ΩøÁî®Ë®òÊÜ∂È´îÊï∏Êìö‰∏¶ÂêåÊ≠•Âà∞ localStorage');
                    }
                    
                    // Âº∑Âà∂‰øùÂ≠òÂà∞ localStorage
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    localStorage.setItem('lastSaveTime', new Date().toISOString());
                    localStorage.setItem('forceSyncTime', new Date().toISOString());
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                    updateStats();
                    updateMemberStats();
                    updateAllRecords();
                    updateCalendar();
                    updateDataStats();
                    updateDebugInfo();
                    
                    // Ëá™ÂãïÂÇô‰ªΩ
                    saveToDataJson();
                    
                    alert(`Âº∑Âà∂ÂêåÊ≠•ÂÆåÊàêÔºÅ\n\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÂêåÊ≠•ÊôÇÈñì: ${new Date().toLocaleString('zh-TW')}\nÂ∑≤Ëá™ÂãïÂÇô‰ªΩÂà∞ data.json`);
                    
                    console.log('Âº∑Âà∂ÂêåÊ≠•ÂÆåÊàê');
                } catch (error) {
                    console.error('Âº∑Âà∂ÂêåÊ≠•Â§±Êïó:', error);
                    alert('Âº∑Âà∂ÂêåÊ≠•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ„ÄÇ');
                }
            }
        }

        // QRÁ¢ºÂêåÊ≠•ÂäüËÉΩ
        function generateQRCode() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂêåÊ≠•ÔºÅ');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "qr-sync",
                        recordCount: records.length
                    }
                };

                // Â£ìÁ∏ÆÊï∏Êìö‰ª•Ê∏õÂ∞ëQRÁ¢ºÂ§ßÂ∞è
                const compressedData = JSON.stringify(syncData);
                
                // ÂâµÂª∫QRÁ¢º
                const qrContainer = document.createElement('div');
                qrContainer.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; max-height: 90%; overflow: auto;">
                            <h3>üì± QRÁ¢ºÂêåÊ≠•</h3>
                            <p>Áî®ÊâãÊ©üÊéÉÊèèÊ≠§QRÁ¢º‰æÜÂêåÊ≠•Ë≥áÊñô</p>
                            <div id="qrcode" style="margin: 20px 0;"></div>
                            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                                Ë®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü<br>
                                ÁîüÊàêÊôÇÈñì: ${now.toLocaleString('zh-TW')}
                            </p>
                            <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ÈóúÈñâ</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(qrContainer);
                
                // ‰ΩøÁî®Á∞°ÂåñÁöÑQRÁ¢ºÁîüÊàêÔºàÂü∫ÊñºURLÔºâ
                const qrData = encodeURIComponent(JSON.stringify({
                    type: 'family_sync',
                    data: compressedData,
                    timestamp: now.getTime()
                }));
                
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${qrData}`;
                
                const qrElement = document.getElementById('qrcode');
                qrElement.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 300px; height: auto;">`;
                
            } catch (error) {
                console.error('ÁîüÊàêQRÁ¢ºÂ§±Êïó:', error);
                alert('ÁîüÊàêQRÁ¢ºÂ§±ÊïóÔºåË´ãÊ™¢Êü•Êï∏ÊìöÂ§ßÂ∞èÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ');
            }
        }

        function scanQRCode() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Á∞°ÂåñÁöÑQRÁ¢ºÊéÉÊèèÔºàÂØ¶ÈöõÊáâÁî®‰∏≠ÈúÄË¶ÅQRÁ¢ºÊéÉÊèèÂ∫´Ôºâ
                alert('QRÁ¢ºÊéÉÊèèÂäüËÉΩÈúÄË¶ÅÈ°çÂ§ñÁöÑÂ∫´ÊîØÊåÅ„ÄÇ\n\nÂª∫Ë≠∞‰ΩøÁî®‰ª•‰∏ãÊõø‰ª£ÊñπÊ°àÔºö\n1. ‰ΩøÁî®ÊâãÊ©üÁõ∏Ê©üÊéÉÊèèQRÁ¢º\n2. Â∞áQRÁ¢ºÂúñÁâá‰øùÂ≠òÂæå‰ΩøÁî®Âú®Á∑öQRÁ¢ºÊéÉÊèèÂ∑•ÂÖ∑\n3. ‰ΩøÁî®ÂåØÂÖ•/ÂåØÂá∫ÂäüËÉΩÂêåÊ≠•Ë≥áÊñô');
            };
            input.click();
        }

        // Èõ≤Á´ØÂêåÊ≠•ÂäüËÉΩ
        function syncToCloud() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂêåÊ≠•ÔºÅ');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "cloud-sync",
                        recordCount: records.length,
                        device: navigator.userAgent
                    }
                };

                // ÂâµÂª∫ÂèØËÆÄÁöÑÊ™îÊ°àÂêç
                const fileName = `family_data_${formatDateToYYYYMMDD(now)}.json`;
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâÊ™îÊ°à
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Ë≥áÊñôÂ∑≤Ê∫ñÂÇôÂ•Ω‰∏äÂÇ≥Âà∞Èõ≤Á´ØÔºÅ\n\nÊ™îÊ°àÂêçÁ®±: ${fileName}\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\n\nË´ãÂ∞áÊ≠§Ê™îÊ°à‰∏äÂÇ≥Âà∞ÊÇ®ÁöÑÈõ≤Á´ØÂÑ≤Â≠òÊúçÂãôÔºàGoogle Drive„ÄÅOneDrive„ÄÅDropboxÁ≠âÔºâÔºåÁÑ∂ÂæåÂú®ÂÖ∂‰ªñË®≠ÂÇô‰∏ä‰∏ãËºâÂêåÊ≠•„ÄÇ`);
                
            } catch (error) {
                console.error('Èõ≤Á´ØÂêåÊ≠•Ê∫ñÂÇôÂ§±Êïó:', error);
                alert('Ê∫ñÂÇôÈõ≤Á´ØÂêåÊ≠•Ê™îÊ°àÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
            }
        }

        function syncFromCloud() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const syncData = JSON.parse(event.target.result);
                        
                        if (!syncData.records || !Array.isArray(syncData.records)) {
                            alert('Ê™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅË´ãÁ¢∫‰øùÈÅ∏ÊìáÁöÑÊòØÊúâÊïàÁöÑÂêåÊ≠•Ê™îÊ°à„ÄÇ');
                            return;
                        }
                        
                        const importRecords = syncData.records;
                        const currentCount = records.length;
                        
                        console.log('Èõ≤Á´ØÂêåÊ≠•Ê™îÊ°àË≥áË®ä:');
                        console.log('- Ê™îÊ°àË®òÈåÑÊï∏:', importRecords.length);
                        console.log('- Áï∂ÂâçË®òÈåÑÊï∏:', currentCount);
                        console.log('- Ê™îÊ°àÂåØÂá∫ÊôÇÈñì:', syncData.metadata?.exportTime);
                        
                        // Ê™¢Êü•ÈáçË§áË®òÈåÑ
                        const duplicateCheck = checkForDuplicates(importRecords);
                        const newRecords = duplicateCheck.newRecords;
                        const duplicates = duplicateCheck.duplicates;
                        
                        if (newRecords.length === 0) {
                            alert('Ê≤íÊúâÊñ∞ÁöÑË®òÈåÑÈúÄË¶ÅÂêåÊ≠•ÔºåÊâÄÊúâË®òÈåÑÈÉΩÂ∑≤Â≠òÂú®„ÄÇ');
                            return;
                        }
                        
                        // Âêà‰ΩµË®òÈåÑ
                        records = records.concat(newRecords);
                        saveRecords();
                        
                        // Êõ¥Êñ∞È°ØÁ§∫
                        updateStats();
                        updateMemberStats();
                        updateAllRecords();
                        updateCalendar();
                        updateDataStats();
                        updateDebugInfo();
                        
                        const successMessage = `‚úÖ Èõ≤Á´ØÂêåÊ≠•ÂÆåÊàêÔºÅ\n\nüìä ÂêåÊ≠•ÁµêÊûú:\n‚Ä¢ Êñ∞Â¢ûË®òÈåÑ: ${newRecords.length} Á≠Ü\n‚Ä¢ ÈáçË§áË®òÈåÑ: ${duplicates.length} Á≠Ü\n‚Ä¢ Á∏ΩË®òÈåÑÊï∏: ${records.length} Á≠Ü\n\nüïí Ê™îÊ°àË≥áË®ä:\n‚Ä¢ ÂåØÂá∫ÊôÇÈñì: ${new Date(syncData.metadata?.exportTime).toLocaleString('zh-TW')}\n‚Ä¢ ‰æÜÊ∫êË®≠ÂÇô: ${syncData.metadata?.device ? syncData.metadata.device.substring(0, 50) + '...' : 'Êú™Áü•'}`;
                        
                        alert(successMessage);
                        
                    } catch (error) {
                        console.error('Èõ≤Á´ØÂêåÊ≠•Â§±Êïó:', error);
                        if (error instanceof SyntaxError) {
                            alert('Ê™îÊ°àÊ†ºÂºèÈåØË™§ÔºÅ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n‚Ä¢ Ê™îÊ°à‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºè\n‚Ä¢ Ê™îÊ°àÂ∑≤ÊêçÂ£û\n‚Ä¢ ÈÅ∏Êìá‰∫ÜÈåØË™§ÁöÑÊ™îÊ°à\n\nË´ãÁ¢∫‰øùÈÅ∏ÊìáÁöÑÊòØÂæûÊú¨Á≥ªÁµ±ÂåØÂá∫ÁöÑÂêåÊ≠•Ê™îÊ°à„ÄÇ');
                        } else {
                            alert('ÂêåÊ≠•Â§±ÊïóÔºåË´ãÊ™¢Êü•Ê™îÊ°àÊ†ºÂºèÊàñÁ®çÂæåÂÜçË©¶„ÄÇ');
                        }
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ÈÄ£ÁµêÂêåÊ≠•ÂäüËÉΩ
        function generateSyncLink() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂêåÊ≠•ÔºÅ');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "link-sync",
                        recordCount: records.length
                    }
                };

                // Â£ìÁ∏ÆÊï∏Êìö
                const compressedData = btoa(JSON.stringify(syncData));
                
                // ÁîüÊàêÂêåÊ≠•ÈÄ£Áµê
                const baseUrl = window.location.origin + window.location.pathname;
                const syncLink = `${baseUrl}?sync=${compressedData}`;
                
                // ÂâµÂª∫ÂàÜ‰∫´ÁïåÈù¢
                const shareContainer = document.createElement('div');
                shareContainer.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; max-height: 90%; overflow: auto;">
                            <h3>üîó ÂêåÊ≠•ÈÄ£Áµê</h3>
                            <p>Ë§áË£ΩÊ≠§ÈÄ£ÁµêÂàÜ‰∫´Áµ¶ÂÖ∂‰ªñË®≠ÂÇô</p>
                            <textarea id="syncLinkText" readonly style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; word-break: break-all;">${syncLink}</textarea>
                            <div style="margin: 15px 0;">
                                <button onclick="copySyncLink()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">üìã Ë§áË£ΩÈÄ£Áµê</button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ÈóúÈñâ</button>
                            </div>
                            <p style="font-size: 12px; color: #666;">
                                Ë®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü<br>
                                ÁîüÊàêÊôÇÈñì: ${now.toLocaleString('zh-TW')}<br>
                                ÈÄ£ÁµêÊúâÊïàÊúü: 7Â§©
                            </p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(shareContainer);
                
                // ÂÖ®ÂüüÂáΩÊï∏‰æõÊåâÈàïË™øÁî®
                window.copySyncLink = function() {
                    const textArea = document.getElementById('syncLinkText');
                    textArea.select();
                    document.execCommand('copy');
                    alert('‚úÖ ÂêåÊ≠•ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùøÔºÅ\n\nË´ãÂ∞áÊ≠§ÈÄ£ÁµêÂàÜ‰∫´Áµ¶ÂÖ∂‰ªñË®≠ÂÇôÊàñÁÄèË¶ΩÂô®„ÄÇ');
                };
                
            } catch (error) {
                console.error('ÁîüÊàêÂêåÊ≠•ÈÄ£ÁµêÂ§±Êïó:', error);
                alert('ÁîüÊàêÂêåÊ≠•ÈÄ£ÁµêÂ§±ÊïóÔºåÊï∏ÊìöÂèØËÉΩÈÅéÂ§ß„ÄÇË´ã‰ΩøÁî®ÂÖ∂‰ªñÂêåÊ≠•ÊñπÂºè„ÄÇ');
            }
        }

        function syncFromLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            
            if (!syncData) {
                alert('Ê≤íÊúâÊâæÂà∞ÂêåÊ≠•Ë≥áÊñôÔºÅ\n\nË´ãÁ¢∫‰øùÔºö\n‚Ä¢ ÈÄ£ÁµêÂåÖÂê´ÂêåÊ≠•ÂèÉÊï∏\n‚Ä¢ ÈÄ£ÁµêÊ≤íÊúâË¢´Êà™Êñ∑\n‚Ä¢ ‰ΩøÁî®ÂÆåÊï¥ÁöÑÂêåÊ≠•ÈÄ£Áµê');
                return;
            }
            
            try {
                // Ëß£Â£ìÁ∏ÆÊï∏Êìö
                const decodedData = JSON.parse(atob(syncData));
                
                if (!decodedData.records || !Array.isArray(decodedData.records)) {
                    alert('ÂêåÊ≠•Ë≥áÊñôÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅ');
                    return;
                }
                
                const importRecords = decodedData.records;
                const currentCount = records.length;
                
                console.log('ÈÄ£ÁµêÂêåÊ≠•Ë≥áÊñôË≥áË®ä:');
                console.log('- Ê™îÊ°àË®òÈåÑÊï∏:', importRecords.length);
                console.log('- Áï∂ÂâçË®òÈåÑÊï∏:', currentCount);
                console.log('- Ê™îÊ°àÂåØÂá∫ÊôÇÈñì:', decodedData.metadata?.exportTime);
                
                // Ê™¢Êü•ÈáçË§áË®òÈåÑ
                const duplicateCheck = checkForDuplicates(importRecords);
                const newRecords = duplicateCheck.newRecords;
                const duplicates = duplicateCheck.duplicates;
                
                if (newRecords.length === 0) {
                    alert('Ê≤íÊúâÊñ∞ÁöÑË®òÈåÑÈúÄË¶ÅÂêåÊ≠•ÔºåÊâÄÊúâË®òÈåÑÈÉΩÂ∑≤Â≠òÂú®„ÄÇ');
                    // Ê∏ÖÈô§URLÂèÉÊï∏
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                // Âêà‰ΩµË®òÈåÑ
                records = records.concat(newRecords);
                saveRecords();
                
                // Êõ¥Êñ∞È°ØÁ§∫
                updateStats();
                updateMemberStats();
                updateAllRecords();
                updateCalendar();
                updateDataStats();
                updateDebugInfo();
                
                const successMessage = `‚úÖ ÈÄ£ÁµêÂêåÊ≠•ÂÆåÊàêÔºÅ\n\nüìä ÂêåÊ≠•ÁµêÊûú:\n‚Ä¢ Êñ∞Â¢ûË®òÈåÑ: ${newRecords.length} Á≠Ü\n‚Ä¢ ÈáçË§áË®òÈåÑ: ${duplicates.length} Á≠Ü\n‚Ä¢ Á∏ΩË®òÈåÑÊï∏: ${records.length} Á≠Ü\n\nüïí Ê™îÊ°àË≥áË®ä:\n‚Ä¢ ÂåØÂá∫ÊôÇÈñì: ${new Date(decodedData.metadata?.exportTime).toLocaleString('zh-TW')}`;
                
                alert(successMessage);
                
                // Ê∏ÖÈô§URLÂèÉÊï∏
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('ÈÄ£ÁµêÂêåÊ≠•Â§±Êïó:', error);
                alert('ÈÄ£ÁµêÂêåÊ≠•Â§±ÊïóÔºÅ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n‚Ä¢ ÈÄ£ÁµêÂ∑≤ÈÅéÊúüÊàñÊêçÂ£û\n‚Ä¢ Êï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫\n‚Ä¢ Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å');
            }
        }

        // ÈÉµ‰ª∂ÂêåÊ≠•ÂäüËÉΩ
        function emailSyncData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂêåÊ≠•ÔºÅ');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "email-sync",
                        recordCount: records.length
                    }
                };

                // ÂâµÂª∫ÂèØËÆÄÁöÑÊ™îÊ°àÂêç
                const fileName = `family_data_${formatDateToYYYYMMDD(now)}.json`;
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâÊ™îÊ°à
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                
                // ÁîüÊàêÈÉµ‰ª∂ÂÖßÂÆπ
                const subject = encodeURIComponent(`ÂÆ∂Â∫≠Ë®òÂ∏≥ÂêåÊ≠•Ê™îÊ°à - ${now.toLocaleDateString('zh-TW')}`);
                const body = encodeURIComponent(`ÂÆ∂Â∫≠Ë®òÂ∏≥ÂêåÊ≠•Ê™îÊ°à

Ê™îÊ°àË≥áË®äÔºö
‚Ä¢ Ë®òÈåÑÊï∏ÈáèÔºö${records.length} Á≠Ü
‚Ä¢ ÂåØÂá∫ÊôÇÈñìÔºö${now.toLocaleString('zh-TW')}
‚Ä¢ Ê™îÊ°àÊ†ºÂºèÔºöJSON

‰ΩøÁî®Ë™™ÊòéÔºö
1. Â∞áÈôÑ‰ª∂Ê™îÊ°à‰∏ãËºâÂà∞ÂÖ∂‰ªñË®≠ÂÇô
2. Âú®ÂÆ∂Â∫≠Ë®òÂ∏≥Á≥ªÁµ±‰∏≠ÈÅ∏Êìá„ÄåÂæûÈõ≤Á´Ø‰∏ãËºâ„Äç
3. ÈÅ∏ÊìáÊ≠§Ê™îÊ°àÈÄ≤Ë°åÂêåÊ≠•

Ê≥®ÊÑè‰∫ãÈ†ÖÔºö
‚Ä¢ Ë´ãÂ¶•ÂñÑ‰øùÁÆ°Ê≠§Ê™îÊ°à
‚Ä¢ Âª∫Ë≠∞ÂÆöÊúüÂêåÊ≠•‰ª•‰øùÊåÅË≥áÊñô‰∏ÄËá¥ÊÄß
‚Ä¢ Â¶ÇÊúâÂïèÈ°åË´ãËÅØÁπ´Á≥ªÁµ±ÁÆ°ÁêÜÂì°

---
Ê≠§ÈÉµ‰ª∂Áî±ÂÆ∂Â∫≠Ë®òÂ∏≥Á≥ªÁµ±Ëá™ÂãïÁîüÊàê`);
                
                const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
                
                alert(`‚úÖ ÂêåÊ≠•Ê™îÊ°àÂ∑≤Ê∫ñÂÇôÂÆåÊàêÔºÅ\n\nüìß ÈÉµ‰ª∂ÂêåÊ≠•Ê≠•È©üÔºö\n1. ÈªûÊìäÁ¢∫ÂÆöÂæåÊúÉÈñãÂïüÈÉµ‰ª∂Á®ãÂºè\n2. Â∞áÂâõÊâç‰∏ãËºâÁöÑÊ™îÊ°à‰ΩúÁÇ∫ÈôÑ‰ª∂\n3. ÁôºÈÄÅÁµ¶Ëá™Â∑±ÊàñÂÖ∂‰ªñË®≠ÂÇô\n4. Âú®ÂÖ∂‰ªñË®≠ÂÇô‰∏äÊé•Êî∂ÈÉµ‰ª∂‰∏¶‰∏ãËºâÈôÑ‰ª∂\n5. ‰ΩøÁî®„ÄåÂæûÈõ≤Á´Ø‰∏ãËºâ„ÄçÂäüËÉΩÂêåÊ≠•Ë≥áÊñô\n\nÊ™îÊ°àÂêçÁ®±: ${fileName}`);
                
                // ÈñãÂïüÈÉµ‰ª∂Á®ãÂºè
                window.open(mailtoLink);
                
            } catch (error) {
                console.error('ÈÉµ‰ª∂ÂêåÊ≠•Ê∫ñÂÇôÂ§±Êïó:', error);
                alert('Ê∫ñÂÇôÈÉµ‰ª∂ÂêåÊ≠•Ê™îÊ°àÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
            }
        }

        // Ê™¢Êü•Êï∏ÊìöÁï∞Â∏∏
        function checkDataAnomalies() {
            console.log('üîç ÈñãÂßãÊ™¢Êü•Êï∏ÊìöÁï∞Â∏∏...');
            
            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicates = [];
            const seen = new Set();
            
            records.forEach((record, index) => {
                const key = `${record.member}-${record.amount}-${record.mainCategory}-${record.date}`;
                if (seen.has(key)) {
                    duplicates.push({ index, record, key });
                } else {
                    seen.add(key);
                }
            });
            
            if (duplicates.length > 0) {
                console.log('‚ö†Ô∏è ÁôºÁèæÈáçË§áË®òÈåÑ:', duplicates.length, 'Á≠Ü');
                duplicates.forEach(dup => {
                    console.log(`ÈáçË§áË®òÈåÑ ${dup.index}:`, dup.record);
                });
            }
            
            // Ê™¢Êü•Áï∞Â∏∏ÈáëÈ°ç
            const expenseRecords = records.filter(record => record.type === 'expense');
            const largeAmounts = expenseRecords.filter(record => record.amount > 10000);
            const negativeAmounts = expenseRecords.filter(record => record.amount < 0);
            
            console.log('üìä ÈáëÈ°çÁµ±Ë®à:');
            console.log('- Á∏ΩË®òÈåÑÊï∏:', records.length);
            console.log('- ÊîØÂá∫Ë®òÈåÑÊï∏:', expenseRecords.length);
            console.log('- Áï∞Â∏∏Â§ßÈáëÈ°çË®òÈåÑ (>$10,000):', largeAmounts.length);
            console.log('- Ë≤†Êï∏ÈáëÈ°çË®òÈåÑ:', negativeAmounts.length);
            
            if (largeAmounts.length > 0) {
                console.log('Â§ßÈáëÈ°çË®òÈåÑË©≥ÊÉÖ:');
                largeAmounts.forEach(record => {
                    console.log(`- $${record.amount} - ${record.member} - ${record.mainCategory} - ${record.date}`);
                });
            }
            
            if (negativeAmounts.length > 0) {
                console.log('Ë≤†Êï∏ÈáëÈ°çË®òÈåÑË©≥ÊÉÖ:');
                negativeAmounts.forEach(record => {
                    console.log(`- $${record.amount} - ${record.member} - ${record.mainCategory} - ${record.date}`);
                });
            }
            
            // Ë®àÁÆóÁ∏ΩÂíå
            const totalExpense = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            console.log('üí∞ Á∏ΩÊîØÂá∫Ë®àÁÆó:', totalExpense);
            
            return {
                duplicates: duplicates.length,
                largeAmounts: largeAmounts.length,
                negativeAmounts: negativeAmounts.length,
                totalExpense: totalExpense
            };
        }

        // ÈÅ∑ÁßªËàäÁöÑÊàêÂì°ÂêçÁ®±
        function migrateMemberNames() {
            console.log('ÈñãÂßãÈÅ∑ÁßªÊàêÂì°ÂêçÁ®±...');
            let migratedCount = 0;
            
            records.forEach(record => {
                if (record.member === 'ÂÆ∂Áî®Êî∂ÂÖ•' || record.member === 'ÂÆ∂Áî®ÁèæÈáëÊµÅ' || record.member === 'ÁèæÈáëÊµÅ') {
                    record.member = 'ÂÆ∂Áî®';
                    migratedCount++;
                    console.log('ÈÅ∑ÁßªË®òÈåÑ:', record);
                } else if (record.member === 'ÂÆ∂Áî®ÊîØÂá∫') {
                    record.member = 'ÂÆ∂Áî®';
                    migratedCount++;
                    console.log('ÈÅ∑ÁßªË®òÈåÑ:', record);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`ÈÅ∑ÁßªÂÆåÊàê: Êõ¥Êñ∞‰∫Ü ${migratedCount} Á≠ÜË®òÈåÑÁöÑÊàêÂì°ÂêçÁ®±`);
                saveRecords(); // ‰øùÂ≠òÈÅ∑ÁßªÂæåÁöÑÊï∏Êìö
            } else {
                console.log('Ê≤íÊúâÈúÄË¶ÅÈÅ∑ÁßªÁöÑË®òÈåÑ');
            }
        }

        // ÈÅ∑ÁßªÊîØÂá∫È°ûÂà•ÂêçÁ®±
        function migrateCategoryNames() {
            console.log('ÈñãÂßãÈÅ∑ÁßªÊîØÂá∫È°ûÂà•ÂêçÁ®±...');
            let migratedCount = 0;
            
            records.forEach(record => {
                if (record.mainCategory === 'ÂÅ•Â∫∑') {
                    record.mainCategory = 'ÈÜ´ÁôÇ';
                    migratedCount++;
                    console.log(`ÈÅ∑ÁßªÊîØÂá∫È°ûÂà•: ÂÅ•Â∫∑ -> ÈÜ´ÁôÇ (Ë®òÈåÑID: ${record.id})`);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`ÈÅ∑ÁßªÂÆåÊàê: Êõ¥Êñ∞‰∫Ü ${migratedCount} Á≠ÜË®òÈåÑÁöÑÊîØÂá∫È°ûÂà•`);
                saveRecords(); // ‰øùÂ≠òÈÅ∑ÁßªÂæåÁöÑÊï∏Êìö
            } else {
                console.log('Ê≤íÊúâÈúÄË¶ÅÈÅ∑ÁßªÁöÑÊîØÂá∫È°ûÂà•');
            }
        }

        // Ê∏ÖÁêÜÈáçË§áË®òÈåÑ
        function removeDuplicateRecords() {
            console.log('üßπ ÈñãÂßãÊ∏ÖÁêÜÈáçË§áË®òÈåÑ...');
            
            const originalCount = records.length;
            const seen = new Set();
            const uniqueRecords = [];
            
            records.forEach(record => {
                const key = `${record.member}-${record.amount}-${record.mainCategory}-${record.date}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueRecords.push(record);
                } else {
                    console.log('ÁßªÈô§ÈáçË§áË®òÈåÑ:', record);
                }
            });
            
            const removedCount = originalCount - uniqueRecords.length;
            
            if (removedCount > 0) {
                records = uniqueRecords;
                saveRecords();
                
                // Êõ¥Êñ∞È°ØÁ§∫
                updateStats();
                updateMemberStats();
                updateAllRecords();
                updateCalendar();
                updateDataStats();
                updateDebugInfo();
                
                alert(`‚úÖ ÈáçË§áË®òÈåÑÊ∏ÖÁêÜÂÆåÊàêÔºÅ\n\nÁßªÈô§ÈáçË§áË®òÈåÑ: ${removedCount} Á≠Ü\nÂâ©È§òË®òÈåÑ: ${uniqueRecords.length} Á≠Ü\n\nË´ãÈáçÊñ∞Ê™¢Êü•Áµ±Ë®àÊï∏Êìö„ÄÇ`);
                
                console.log(`Ê∏ÖÁêÜÂÆåÊàê: ÁßªÈô§ ${removedCount} Á≠ÜÈáçË§áË®òÈåÑ`);
            } else {
                alert('Ê≤íÊúâÁôºÁèæÈáçË§áË®òÈåÑÈúÄË¶ÅÊ∏ÖÁêÜ„ÄÇ');
            }
        }

        // ÊâãÂãï‰øÆÂæ©ÊàêÂì°ÈÅ∏È†Ö
        function fixMemberOptions() {
            console.log('ÈñãÂßãÊâãÂãï‰øÆÂæ©ÊàêÂì°ÈÅ∏È†Ö...');
            
            // Âº∑Âà∂‰øÆÂæ©ÊâÄÊúâÊàêÂì°ÈÅ∏È†Ö
            const memberSelect = document.getElementById('member');
            if (memberSelect) {
                memberSelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    memberSelect.appendChild(option);
                });
                console.log('Êñ∞Â¢ûË°®ÂñÆÊàêÂì°ÈÅ∏È†ÖÂ∑≤Âº∑Âà∂‰øÆÂæ©:', familyMembers);
            }
            
            const editMemberSelect = document.getElementById('editMember');
            if (editMemberSelect) {
                editMemberSelect.innerHTML = '';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    editMemberSelect.appendChild(option);
                });
                console.log('Á∑®ËºØË°®ÂñÆÊàêÂì°ÈÅ∏È†ÖÂ∑≤Âº∑Âà∂‰øÆÂæ©:', familyMembers);
            }
            
            const deleteMemberFilter = document.getElementById('deleteMemberFilter');
            if (deleteMemberFilter) {
                deleteMemberFilter.innerHTML = '<option value="">ÊâÄÊúâÊàêÂì°</option>';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    deleteMemberFilter.appendChild(option);
                });
                console.log('Âà™Èô§ÁØ©ÈÅ∏ÊàêÂì°ÈÅ∏È†ÖÂ∑≤Âº∑Âà∂‰øÆÂæ©:', familyMembers);
            }
            
            alert(`‚úÖ ÊàêÂì°ÈÅ∏È†ÖÂ∑≤‰øÆÂæ©ÔºÅ\n\n‰øÆÂæ©ÁöÑÈÅ∏È†ÖÔºö\n${familyMembers.join('\n')}\n\nË´ãÊ™¢Êü•Êñ∞Â¢ûÈ†ÅÈù¢ÊòØÂê¶Ê≠£Â∏∏È°ØÁ§∫„ÄÇ`);
        }

        // Ê™¢Êü•URLÂêåÊ≠•ÂèÉÊï∏
        function checkURLSync() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            
            if (syncData) {
                console.log('Ê™¢Ê∏¨Âà∞URLÂêåÊ≠•ÂèÉÊï∏ÔºåÊ∫ñÂÇôËá™ÂãïÂêåÊ≠•...');
                
                // Âª∂ÈÅ≤Âü∑Ë°åÔºåÁ¢∫‰øùÈ†ÅÈù¢ÂÆåÂÖ®ËºâÂÖ•
                setTimeout(() => {
                    if (confirm('Ê™¢Ê∏¨Âà∞ÂêåÊ≠•ÈÄ£ÁµêÔºÅ\n\nÊòØÂê¶Ë¶ÅÁ´ãÂç≥ÂêåÊ≠•Ë≥áÊñôÔºü\n\nÈÄôÂ∞áÊúÉÂêà‰ΩµÊñ∞ÁöÑË®òÈåÑÂà∞Áï∂ÂâçË≥áÊñô‰∏≠„ÄÇ')) {
                        syncFromLink();
                    } else {
                        // Ê∏ÖÈô§URLÂèÉÊï∏
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }, 1000);
            }
        }

        // Ê™¢Êü•Ë∑®ÁÄèË¶ΩÂô®ÂêåÊ≠•ÁãÄÊÖã
        function checkCrossBrowserSync() {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊèêÈÜíÈÅéÁî®Êà∂
            const lastSyncReminder = localStorage.getItem('lastSyncReminder');
            const today = new Date().toDateString();
            
            // Â¶ÇÊûú‰ªäÂ§©ÈÇÑÊ≤íÊúâÊèêÈÜíÈÅéÔºå‰∏îÁî®Êà∂ÊúâË®òÈåÑÔºåÂâáÈ°ØÁ§∫ÊèêÈÜí
            if (lastSyncReminder !== today && records.length > 0) {
                // Âª∂ÈÅ≤È°ØÁ§∫ÊèêÈÜíÔºåËÆìÈ†ÅÈù¢ÂÆåÂÖ®ËºâÂÖ•
                setTimeout(() => {
                    const shouldShowReminder = confirm(
                        'üåê Ë∑®ÁÄèË¶ΩÂô®ÂêåÊ≠•ÊèêÈÜí\n\n' +
                        'Ê™¢Ê∏¨Âà∞ÊÇ®Âú®‰∏çÂêåÁÄèË¶ΩÂô®‰ΩøÁî®Ê≠§ÊáâÁî®Á®ãÂºè„ÄÇ\n\n' +
                        'ÁÇ∫‰∫ÜÁ¢∫‰øùË≥áÊñô‰∏ÄËá¥ÊÄßÔºåÂª∫Ë≠∞ÊÇ®Ôºö\n' +
                        '1. ÂÆöÊúüÂú®‰∏çÂêåÁÄèË¶ΩÂô®ÈñìÂêåÊ≠•Ë≥áÊñô\n' +
                        '2. ‰ΩøÁî®„ÄåÂåØÂá∫/ÂåØÂÖ•„ÄçÂäüËÉΩ‰øùÊåÅË≥áÊñôÂêåÊ≠•\n\n' +
                        'ÊòØÂê¶Ë¶ÅÊü•ÁúãÂêåÊ≠•ÂäüËÉΩÔºü'
                    );
                    
                    if (shouldShowReminder) {
                        // ÂàáÊèõÂà∞ÂåØÂÖ•È†ÅÈù¢
                        showTab('import');
                    }
                    
                    // Ë®òÈåÑ‰ªäÂ§©Â∑≤Á∂ìÊèêÈÜíÈÅé
                    localStorage.setItem('lastSyncReminder', today);
                }, 3000);
            }
        }

        // Ê™¢Êü•‰∏¶ÂæûÂÇô‰ªΩÊÅ¢Âæ©Ë≥áÊñô
        async function checkAndRestoreFromBackup() {
            try {
                // Ê™¢Êü•Áï∂ÂâçÊòØÂê¶ÊúâË≥áÊñô
                const currentRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                
                if (currentRecords.length === 0) {
                    console.log('Áï∂ÂâçÊ≤íÊúâË≥áÊñôÔºåÊ™¢Êü•ÊòØÂê¶ÊúâÂÇô‰ªΩÂèØ‰ª•ÊÅ¢Âæ©...');
                    
                    // Â∞ãÊâæÊúÄÊñ∞ÁöÑÂÇô‰ªΩ
                    const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                    
                    if (backupKeys.length > 0) {
                        // ÊåâÊôÇÈñìÊéíÂ∫èÔºåÈÅ∏ÊìáÊúÄÊñ∞ÁöÑÂÇô‰ªΩ
                        backupKeys.sort();
                        const latestBackupKey = backupKeys[backupKeys.length - 1];
                        const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
                        
                        if (backupData && backupData.records && backupData.records.length > 0) {
                            records = backupData.records;
                            localStorage.setItem('familyRecords', JSON.stringify(records));
                            
                            const backupTime = new Date(backupData.metadata.backupTime);
                            console.log(`ÂæûÂÇô‰ªΩÊÅ¢Âæ©‰∫Ü ${records.length} Á≠ÜË®òÈåÑÔºåÂÇô‰ªΩÊôÇÈñì: ${backupTime.toLocaleString('zh-TW')}`);
                            
                            // È°ØÁ§∫ÊÅ¢Âæ©ÈÄöÁü•
                            setTimeout(() => {
                                alert(`Ë≥áÊñôÂ∑≤ÂæûÂÇô‰ªΩÊÅ¢Âæ©ÔºÅ\n\nÊÅ¢Âæ©‰∫Ü ${records.length} Á≠ÜË®òÈåÑ\nÂÇô‰ªΩÊôÇÈñì: ${backupTime.toLocaleString('zh-TW')}\n\nÂª∫Ë≠∞ÊÇ®Á´ãÂç≥ÂåØÂá∫ÂÇô‰ªΩÊ™îÊ°à‰ª•Èò≤Ë≥áÊñôÂÜçÊ¨°‰∏üÂ§±„ÄÇ`);
                            }, 1000);
                        }
                    }
                }
            } catch (error) {
                console.warn('Ê™¢Êü•ÂÇô‰ªΩÊôÇÁôºÁîüÈåØË™§:', error);
            }
        }

        // ÂæûÊ™îÊ°àËºâÂÖ•Ë≥áÊñô
        async function loadDataFromFile() {
            try {
                console.log('ÈñãÂßãËºâÂÖ• data.json...');
                const response = await fetch('data.json');
                if (response.ok) {
                    const data = await response.json();
                    console.log('ÊàêÂäüËºâÂÖ• data.json:', data);
                    if (data.records && Array.isArray(data.records) && data.records.length > 0) {
                        // Â¶ÇÊûúÊ™îÊ°à‰∏≠ÊúâË≥áÊñôÔºå‰ΩøÁî®Ê™îÊ°àÁöÑË≥áÊñô‰∏¶ÂêåÊ≠•Âà∞ localStorage
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('Âæû data.json ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑÔºå‰∏¶ÂêåÊ≠•Âà∞ localStorage');
                        logRecordsDetail('Âæû data.json ËºâÂÖ•ÁöÑË®òÈåÑ'); // ‰ΩøÁî®Êñ∞ÁöÑË™øË©¶ÂáΩÊï∏
                    } else {
                        // Â¶ÇÊûúÊ™îÊ°à‰∏≠Ê≤íÊúâË≥áÊñôÔºåÂÑ™ÂÖà‰ΩøÁî® localStorage ÁöÑË≥áÊñô
                        const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                        if (localRecords.length > 0) {
                            records = localRecords;
                            console.log('data.json Ê≤íÊúâË≥áÊñôÔºåÂæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                        } else {
                            console.log('data.json Âíå localStorage ÈÉΩÊ≤íÊúâË≥áÊñô');
                        }
                    }
                } else {
                    console.log('data.json ËºâÂÖ•Â§±ÊïóÔºåÁãÄÊÖãÁ¢º:', response.status);
                    // Â¶ÇÊûúÊ™îÊ°à‰∏çÂ≠òÂú®ÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                    if (localRecords.length > 0) {
                        records = localRecords;
                        console.log('Âæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                    } else {
                        console.log('localStorage ‰πüÊ≤íÊúâË≥áÊñô');
                    }
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïËºâÂÖ• data.jsonÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•:', error);
                // Â¶ÇÊûúËºâÂÖ•Ê™îÊ°àÂ§±ÊïóÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                if (localRecords.length > 0) {
                    records = localRecords;
                    console.log('Âæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                }
            }
        }

        // ÂêåÊ≠•Ë≥áÊñô‰æÜÊ∫ê
        async function syncDataBetweenSources() {
            try {
                // Ê™¢Êü• localStorage ‰∏≠ÊòØÂê¶ÊúâË≥áÊñô
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                
                // Â¶ÇÊûú localStorage ÊúâË≥áÊñô‰ΩÜ records ÊòØÁ©∫ÁöÑÔºå‰ΩøÁî® localStorage ÁöÑË≥áÊñô
                if (localRecords.length > 0 && records.length === 0) {
                    records = localRecords;
                    console.log('Âæû localStorage ÂêåÊ≠•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑÂà∞Ë®òÊÜ∂È´î');
                    
                    // ÂêåÊôÇÊõ¥Êñ∞ data.json
                    await updateDataJsonFile();
                }
                // Â¶ÇÊûúË®òÊÜ∂È´îÊúâË≥áÊñô‰ΩÜ localStorage ÊòØÁ©∫ÁöÑÔºåÂêåÊ≠•Âà∞ localStorage
                else if (records.length > 0 && localRecords.length === 0) {
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    console.log('ÂæûË®òÊÜ∂È´îÂêåÊ≠•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑÂà∞ localStorage');
                }
                // Â¶ÇÊûúÂÖ©ÈÇäÈÉΩÊúâË≥áÊñôÔºåÊØîËºÉ‰∏¶‰ΩøÁî®ËºÉÊñ∞ÁöÑ
                else if (records.length > 0 && localRecords.length > 0) {
                    // ÊØîËºÉË®òÈåÑÊï∏ÈáèÔºå‰ΩøÁî®ËºÉÂ§öÁöÑ
                    if (localRecords.length > records.length) {
                        records = localRecords;
                        console.log('localStorage ÊúâÊõ¥Â§öË®òÈåÑÔºåÂêåÊ≠•Âà∞Ë®òÊÜ∂È´î');
                    } else if (records.length > localRecords.length) {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('Ë®òÊÜ∂È´îÊúâÊõ¥Â§öË®òÈåÑÔºåÂêåÊ≠•Âà∞ localStorage');
                    }
                }
            } catch (error) {
                console.warn('Ë≥áÊñôÂêåÊ≠•ÈÅéÁ®ã‰∏≠ÁôºÁîüÈåØË™§:', error);
            }
        }

        // Êõ¥Êñ∞ data.json Ê™îÊ°à
        async function updateDataJsonFile() {
            try {
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: new Date().toISOString(),
                        version: "1.0",
                        description: "ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑË≥áÊñô"
                    }
                };
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâÊõ¥Êñ∞ÁöÑ data.json Ê™îÊ°à
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // ÈùúÈªò‰∏ãËºâ
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Â∑≤Êõ¥Êñ∞ data.json Ê™îÊ°à');
            } catch (error) {
                console.warn('ÁÑ°Ê≥ïÊõ¥Êñ∞ data.json Ê™îÊ°à:', error);
            }
        }

        // Ê∑ªÂä†Á§∫‰æãÊï∏Êìö
        function addSampleData() {
            const today = new Date();
            const sampleRecords = [
                {
                    id: 'sample-1',
                    member: 'Kelvin',
                    type: 'expense',
                    amount: 1200,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'ÊâãÊ©üË≤ª',
                    description: 'ÊâãÊ©üË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-2',
                    member: 'Phuong',
                    type: 'expense',
                    amount: 1598,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'Á∂≤Ë∑ØË≤ª',
                    description: 'Á∂≤Ë∑ØË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-3',
                    member: 'ÂÆ∂Áî®',
                    type: 'income',
                    amount: 50000,
                    mainCategory: 'Ëñ™Ë≥á',
                    subCategory: '',
                    description: 'Kelvin Ëñ™Ë≥á',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-4',
                    member: 'ÂÆ∂Áî®',
                    type: 'expense',
                    amount: 15000,
                    mainCategory: 'Â±Ö‰Ωè',
                    subCategory: 'ÊàøÁßü',
                    description: 'ÊàøÁßü',
                    date: today.toISOString().split('T')[0]
                }
            ];
            
            records = records.concat(sampleRecords);
            saveRecords();
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
        }

        // Áµ±‰∏ÄÁöÑÊó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∏ÔºåÈÅøÂÖçÊôÇÂçÄÂïèÈ°å
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setTodayDate() {
            const today = formatDateToYYYYMMDD(new Date());
            document.getElementById('date').value = today;
        }

        // Êõ¥Êñ∞ÊàêÂì°ÁØ©ÈÅ∏ÈÅ∏È†Ö
        function updateMemberFilterOptions() {
            const memberFilterSelect = document.getElementById('memberFilter');
            if (!memberFilterSelect) return;
            
            // Ê∏ÖÈô§ÁèæÊúâÈÅ∏È†ÖÔºà‰øùÁïô"ÊâÄÊúâÊàêÂì°"ÈÅ∏È†ÖÔºâ
            memberFilterSelect.innerHTML = '<option value="">ÊâÄÊúâÊàêÂì°</option>';
            
            // Ê†πÊìö familyMembers Êï∏ÁµÑÂãïÊÖãÁîüÊàêÈÅ∏È†Ö
            familyMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberFilterSelect.appendChild(option);
            });
            
            console.log('ÊàêÂì°ÁØ©ÈÅ∏ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞:', familyMembers);
        }

        // Á¢∫‰øùÊâÄÊúâÊàêÂì°ÈÅ∏È†ÖÈÉΩÊ≠£Á¢∫Ë®≠ÁΩÆ
        function ensureMemberOptions() {
            // Êõ¥Êñ∞Êñ∞Â¢ûË°®ÂñÆÁöÑÊàêÂì°ÈÅ∏È†Ö
            const memberSelect = document.getElementById('member');
            if (memberSelect) {
                const currentOptions = Array.from(memberSelect.options).map(opt => opt.value);
                const expectedOptions = ['', ...familyMembers];
                const isComplete = expectedOptions.every(opt => currentOptions.includes(opt));
                
                if (!isComplete || memberSelect.options.length !== expectedOptions.length) {
                    memberSelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        memberSelect.appendChild(option);
                    });
                    console.log('Êñ∞Â¢ûË°®ÂñÆÊàêÂì°ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞:', familyMembers);
                }
            }
            
            // Êõ¥Êñ∞Á∑®ËºØË°®ÂñÆÁöÑÊàêÂì°ÈÅ∏È†Ö
            const editMemberSelect = document.getElementById('editMember');
            if (editMemberSelect) {
                const currentOptions = Array.from(editMemberSelect.options).map(opt => opt.value);
                const isComplete = familyMembers.every(member => currentOptions.includes(member));
                
                if (!isComplete || editMemberSelect.options.length !== familyMembers.length) {
                    editMemberSelect.innerHTML = '';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        editMemberSelect.appendChild(option);
                    });
                    console.log('Á∑®ËºØË°®ÂñÆÊàêÂì°ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞:', familyMembers);
                }
            }
            
            // Êõ¥Êñ∞Âà™Èô§ÁØ©ÈÅ∏ÁöÑÊàêÂì°ÈÅ∏È†Ö
            const deleteMemberFilter = document.getElementById('deleteMemberFilter');
            if (deleteMemberFilter) {
                const currentOptions = Array.from(deleteMemberFilter.options).map(opt => opt.value);
                const expectedOptions = ['', ...familyMembers];
                const isComplete = expectedOptions.every(opt => currentOptions.includes(opt));
                
                if (!isComplete || deleteMemberFilter.options.length !== expectedOptions.length) {
                    deleteMemberFilter.innerHTML = '<option value="">ÊâÄÊúâÊàêÂì°</option>';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        deleteMemberFilter.appendChild(option);
                    });
                    console.log('Âà™Èô§ÁØ©ÈÅ∏ÊàêÂì°ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞:', familyMembers);
                }
            }
        }

        function updateCategoryOptions() {
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');

            function updateMainCategories(amountInput, mainCategorySelect) {
                const amount = parseFloat(amountInput.value) || 0;
                // Â¶ÇÊûúÈáëÈ°çÁÇ∫0ÊàñÁ©∫ÔºåÈªòË™çÈ°ØÁ§∫ÊîØÂá∫È°ûÂà•ÔºàÂõ†ÁÇ∫Â§ßÈÉ®ÂàÜË®òÈåÑÈÉΩÊòØÊîØÂá∫Ôºâ
                const type = (amount === 0 || isNaN(amount)) ? 'expense' : (amount >= 0 ? 'income' : 'expense');
                mainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
                
                console.log('updateMainCategories called:', { amount, type, inputValue: amountInput.value });
                
                if (type === 'income') {
                    // Êî∂ÂÖ•È°ûÂà•
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    
                } else if (type === 'expense') {
                    // Áç≤ÂèñÊâÄÊúâÊîØÂá∫È°ûÂà•ÔºàÊéíÈô§"ÂÖ∂‰ªñ"Ôºâ
                    const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñÊîØÂá∫');
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
                    const otherOption = document.createElement('option');
                    otherOption.value = 'ÂÖ∂‰ªñ';
                    otherOption.textContent = 'ÂÖ∂‰ªñ';
                    mainCategorySelect.appendChild(otherOption);
                    
                }
                
                console.log('‰∏ªÈ°ûÂà•ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞ÔºåÊï∏Èáè:', mainCategorySelect.options.length);
            }

            // È°ûÂûãÈÅ∏ÊìáÂô®ËÆäÂåñÊôÇÊõ¥Êñ∞‰∏ªÈ°ûÂà•ÈÅ∏È†Ö
            const typeSelect = document.getElementById('type');
            typeSelect.addEventListener('change', () => {
                const type = typeSelect.value;
                updateMainCategoriesByType(type, mainCategorySelect);
            });
            
            // ÂàùÂßãÂåñÊôÇ‰πüË™øÁî®‰∏ÄÊ¨°ÔºåÁ¢∫‰øùÈ†ÅÈù¢Âä†ËºâÊôÇÊúâÊ≠£Á¢∫ÁöÑÁãÄÊÖã
            console.log('ÂàùÂßãÂåñÈ°ûÂà•ÈÅ∏ÊìáÂô®...');
            updateMainCategoriesByType('', mainCategorySelect);

            // Á¢∫‰øùÊàêÂì°ÈÅ∏È†Ö‰πüÊ≠£Á¢∫Ë®≠ÁΩÆ
            ensureMemberOptions();

            // Á∑®ËºØË°®ÂñÆÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            editTypeSelect.addEventListener('change', () => {
                updateEditMainCategories();
            });
        }

        // Êõ¥Êñ∞Á∑®ËºØË°®ÂñÆÁöÑ‰∏ªÈ°ûÂà•ÈÅ∏È†ÖÔºà‰∏ÄËá¥ÊÄßÊ∏ÖÂñÆÔºâ
        function updateEditMainCategories() {
            const editMainCategorySelect = document.getElementById('editMainCategory');
            
            editMainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            
            // Êî∂ÂÖ•È°ûÂà•
            const incomeOption = document.createElement('option');
            incomeOption.value = '--- Êî∂ÂÖ•È°ûÂà• ---';
            incomeOption.textContent = '--- Êî∂ÂÖ•È°ûÂà• ---';
            incomeOption.disabled = true;
            incomeOption.style.fontWeight = 'bold';
            incomeOption.style.color = '#666';
            editMainCategorySelect.appendChild(incomeOption);
            
            categories.income.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                editMainCategorySelect.appendChild(option);
            });
            
            // ÊîØÂá∫È°ûÂà•
            const expenseOption = document.createElement('option');
            expenseOption.value = '--- ÊîØÂá∫È°ûÂà• ---';
            expenseOption.textContent = '--- ÊîØÂá∫È°ûÂà• ---';
            expenseOption.disabled = true;
            expenseOption.style.fontWeight = 'bold';
            expenseOption.style.color = '#666';
            editMainCategorySelect.appendChild(expenseOption);
            
            const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñÊîØÂá∫');
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                editMainCategorySelect.appendChild(option);
            });
            
            // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
            const otherOption = document.createElement('option');
            otherOption.value = 'ÂÖ∂‰ªñ';
            otherOption.textContent = 'ÂÖ∂‰ªñ';
            editMainCategorySelect.appendChild(otherOption);
            
        }

        // ËôïÁêÜÈ°ûÂûãËÆäÂåñ
        function handleTypeChange() {
            const typeSelect = document.getElementById('type');
            const mainCategorySelect = document.getElementById('mainCategory');
            const amountInput = document.getElementById('amount');
            
            const type = typeSelect.value;
            
            // Ê†πÊìöÈ°ûÂûãÊõ¥Êñ∞‰∏ªÈ°ûÂà•ÈÅ∏È†Ö
            updateMainCategoriesByType(type, mainCategorySelect);
            
            // Ê†πÊìöÈ°ûÂûãË®≠ÁΩÆÈáëÈ°çÊèêÁ§∫
            if (type === 'income') {
                amountInput.placeholder = 'Ë´ãËº∏ÂÖ•Ê≠£Êï∏ÈáëÈ°ç';
            } else if (type === 'expense') {
                amountInput.placeholder = 'Ë´ãËº∏ÂÖ•Ê≠£Êï∏ÈáëÈ°ç';
            } else {
                amountInput.placeholder = 'Ë´ãËº∏ÂÖ•ÈáëÈ°ç';
            }
        }

        // Ê†πÊìöÈ°ûÂûãÊõ¥Êñ∞‰∏ªÈ°ûÂà•ÈÅ∏È†ÖÔºà‰∏ÄËá¥ÊÄßÊ∏ÖÂñÆÔºâ
        function updateMainCategoriesByType(type, mainCategorySelect) {
            mainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            
            // Êî∂ÂÖ•È°ûÂà•
            const incomeOption = document.createElement('option');
            incomeOption.value = '--- Êî∂ÂÖ•È°ûÂà• ---';
            incomeOption.textContent = '--- Êî∂ÂÖ•È°ûÂà• ---';
            incomeOption.disabled = true;
            incomeOption.style.fontWeight = 'bold';
            incomeOption.style.color = '#666';
            mainCategorySelect.appendChild(incomeOption);
            
            categories.income.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            });
            
            // ÊîØÂá∫È°ûÂà•
            const expenseOption = document.createElement('option');
            expenseOption.value = '--- ÊîØÂá∫È°ûÂà• ---';
            expenseOption.textContent = '--- ÊîØÂá∫È°ûÂà• ---';
            expenseOption.disabled = true;
            expenseOption.style.fontWeight = 'bold';
            expenseOption.style.color = '#666';
            mainCategorySelect.appendChild(expenseOption);
            
            const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñÊîØÂá∫');
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            });
            
            // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
            const otherOption = document.createElement('option');
            otherOption.value = 'ÂÖ∂‰ªñ';
            otherOption.textContent = 'ÂÖ∂‰ªñ';
            mainCategorySelect.appendChild(otherOption);
            
        }

        // ËôïÁêÜ‰∏ªÈ°ûÂà•ËÆäÂåñ
        function handleMainCategoryChange() {
            const mainCategorySelect = document.getElementById('mainCategory');
            const customInput = document.getElementById('customMainCategory');
            
            if (mainCategorySelect.value === 'ÂÖ∂‰ªñ') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // ËôïÁêÜÁ∑®ËºØË°®ÂñÆ‰∏ªÈ°ûÂà•ËÆäÂåñÔºàÂ∑≤ÁßªÈô§Ëá™ÂÆöÁæ©ÂäüËÉΩÔºâ
        function handleEditMainCategoryChange() {
            // Á∑®ËºØË°®ÂñÆ‰∏çÂÜçÊîØÊåÅËá™ÂÆöÁæ©‰∏ªÈ°ûÂà•
        }

        function showTab(tabName) {
            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
            document.getElementById(tabName).classList.add('active');
            
            // Ê∑ªÂä†ÈÅ∏‰∏≠Ê®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'dashboard' ? 'Á∏ΩË¶Ω' : 
                                           tabName === 'list' ? 'ÂàóË°®' :
                                           tabName === 'calendar' ? 'Êó•ÊõÜ' :
                                           tabName === 'add' ? 'Êñ∞Â¢û' :
                                           tabName === 'import' ? 'ÂåØÂÖ•' : '')) {
                    tab.classList.add('active');
                }
            });

            // Â¶ÇÊûúÂàáÊèõÂà∞Êó•ÊõÜÈ†ÅÈù¢ÔºåÊõ¥Êñ∞Êó•ÊõÜ
            if (tabName === 'calendar') {
                setTimeout(() => {
                    updateCalendar();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞Êñ∞Â¢ûÈ†ÅÈù¢ÔºåÁ¢∫‰øùÊàêÂì°ÈÅ∏È†ÖÂÆåÊï¥
            if (tabName === 'add') {
                setTimeout(() => {
                    ensureMemberOptions();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞ÂúñË°®È†ÅÈù¢ÔºåÂàùÂßãÂåñÂúñË°®
            if (tabName === 'charts') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞ÂåØÂÖ•È†ÅÈù¢ÔºåÊõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
            if (tabName === 'import') {
                updateDataStats();
            }
        }

        function updateStats() {
            const totalIncome = records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            
            // Ë®àÁÆóÁèæÈáëÊîØÂá∫
            const cashExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ÁèæÈáë')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆó‰ø°Áî®Âç°ÊîØÂá∫
            const creditExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === '‰ø°Áî®Âç°')
                .reduce((sum, record) => sum + record.amount, 0);
            
            
            // Ë®àÁÆóÁèæÈáëÈ§òÈ°çÔºàÂåÖÂê´ÊâÄÊúâÁèæÈáëÈ°ûÂà•Ôºâ
            const cashBalance = records
                .filter(record => record.subCategory === 'ÁèæÈáë' || record.subCategory === '')
                .reduce((sum, record) => {
                    if (record.type === 'income') {
                        return sum + record.amount; // ÁèæÈáëÊî∂ÂÖ•ÁÇ∫Ê≠£
                    } else if (record.type === 'expense') {
                        return sum - record.amount; // ÁèæÈáëÊîØÂá∫ÁÇ∫Ë≤†
                    }
                    return sum;
                }, 0);

            // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫
            document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
            document.getElementById('cashExpense').textContent = `$${cashExpense.toLocaleString()}`;
            document.getElementById('creditExpense').textContent = `$${creditExpense.toLocaleString()}`;
            document.getElementById('cashBalance').textContent = `$${cashBalance.toLocaleString()}`;
            
            // Ë™øË©¶Ë≥áË®ä
            console.log('Áµ±Ë®àÊõ¥Êñ∞:');
            console.log('- Á∏ΩÊî∂ÂÖ• (type=income):', totalIncome);
            console.log('- Á∏ΩÊîØÂá∫ (type=expense):', totalExpense);
            console.log('- ÁèæÈáëÊîØÂá∫:', cashExpense);
            console.log('- ‰ø°Áî®Âç°ÊîØÂá∫:', creditExpense);
            console.log('- ÁèæÈáëÈ§òÈ°ç (ÁèæÈáëÈ°ûÂà•Áµ±Ë®à):', cashBalance);
            
            // Ë©≥Á¥∞Ë™øË©¶ÁèæÈáëÈ§òÈ°çË®àÁÆó
            const cashRecords = records.filter(record => record.subCategory === 'ÁèæÈáë' || record.subCategory === '');
            const cashIncome = cashRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
            const cashExpenseOnly = cashRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
            
            console.log('ÁèæÈáëÈ§òÈ°çË©≥Á¥∞Ë®àÁÆó:');
            console.log('- ÁèæÈáëË®òÈåÑÁ∏ΩÊï∏:', cashRecords.length);
            console.log('- ÁèæÈáëÊî∂ÂÖ•:', cashIncome);
            console.log('- ÁèæÈáëÊîØÂá∫:', cashExpenseOnly);
            console.log('- Ë®àÁÆóÁµêÊûú:', cashIncome - cashExpenseOnly);
            
            // Ë©≥Á¥∞Ë™øË©¶ÊîØÂá∫Ë®òÈåÑ
            const expenseRecords = records.filter(record => record.type === 'expense');
            console.log('ÊîØÂá∫Ë®òÈåÑË©≥ÊÉÖ:');
            expenseRecords.forEach((record, index) => {
                console.log(`${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} (${record.subCategory}) - ${record.date}`);
            });
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁï∞Â∏∏Â§ßÁöÑÈáëÈ°ç
            const largeAmounts = expenseRecords.filter(record => record.amount > 10000);
            if (largeAmounts.length > 0) {
                console.log('‚ö†Ô∏è ÁôºÁèæÁï∞Â∏∏Â§ßÈáëÈ°çÁöÑÊîØÂá∫Ë®òÈåÑ:');
                largeAmounts.forEach(record => {
                    console.log(`- ${record.member} - ${record.mainCategory} - $${record.amount} (${record.subCategory}) - ${record.date}`);
                });
            }
            
            // Ë©≥Á¥∞Ë™øË©¶Êî∂ÂÖ•Ë®òÈåÑ
            const incomeRecords = records.filter(record => record.type === 'income');
            const householdRecords = records.filter(record => record.member === 'ÂÆ∂Áî®');
            
            console.log('Êî∂ÂÖ•Ë®òÈåÑË©≥ÊÉÖ:');
            console.log('- type=income ÁöÑË®òÈåÑ:', incomeRecords);
            console.log('- member=ÂÆ∂Áî® ÁöÑË®òÈåÑ:', householdRecords);
            
            // Ê™¢Êü•ÊòØÂê¶Êúâ‰∏ç‰∏ÄËá¥ÁöÑË®òÈåÑ
            const inconsistentRecords = records.filter(record => 
                (record.type === 'income' && record.member !== 'ÂÆ∂Áî®') ||
                (record.member === 'ÂÆ∂Áî®' && record.type !== 'income')
            );
            
            if (inconsistentRecords.length > 0) {
                console.warn('ÁôºÁèæ‰∏ç‰∏ÄËá¥ÁöÑÊî∂ÂÖ•Ë®òÈåÑ:', inconsistentRecords);
            }

            // Êõ¥Êñ∞ÂêÑÊàêÂì°Áµ±Ë®à
            updateMemberStats();
        }

        function updateMemberStats() {
            const memberStatsContainer = document.getElementById('memberStats');
            memberStatsContainer.innerHTML = '';

            console.log('updateMemberStats: Á∏ΩË®òÈåÑÊï∏', records.length);
            console.log('updateMemberStats: Ë®òÈåÑÂÖßÂÆπ', records);

            familyMembers.forEach(member => {
                const memberRecords = records.filter(record => record.member === member);
                console.log(`${member} ÁöÑË®òÈåÑ:`, memberRecords);
                
                let memberIncome, memberExpense, memberBalance;
                
                // Ë®àÁÆóÊâÄÊúâÊàêÂì°ÁöÑÊî∂ÂÖ•ÂíåÊîØÂá∫
                memberIncome = memberRecords
                    .filter(record => record.type === 'income')
                    .reduce((sum, record) => sum + record.amount, 0);
                memberExpense = memberRecords
                    .filter(record => record.type === 'expense')
                    .reduce((sum, record) => sum + record.amount, 0);
                memberBalance = memberIncome - memberExpense;
                
                console.log(`${member} Áµ±Ë®à: Êî∂ÂÖ•=${memberIncome}, ÊîØÂá∫=${memberExpense}, È§òÈ°ç=${memberBalance}`);

                const memberCard = document.createElement('div');
                memberCard.className = 'stat-card';
                memberCard.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                memberCard.style.cursor = 'pointer';
                memberCard.innerHTML = `
                    <h4>${member}</h4>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <small>Êî∂ÂÖ•: $${memberIncome.toLocaleString()}</small><br>
                            <small>ÊîØÂá∫: $${memberExpense.toLocaleString()}</small>
                        </div>
                        <div style="font-weight: bold; color: ${memberBalance >= 0 ? '#51cf66' : '#ff6b6b'};">
                            $${memberBalance.toLocaleString()}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        ÈªûÊìäÊü•ÁúãË©≥Á¥∞Ë®òÈåÑ
                    </div>
                `;
                
                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
                memberCard.addEventListener('click', () => {
                    showMemberRecords(member);
                });
                
                memberStatsContainer.appendChild(memberCard);
            });
        }

        // È°ØÁ§∫ÊàêÂì°Ë©≥Á¥∞Ë®òÈåÑ
        function showMemberRecords(member) {
            const memberRecords = records.filter(record => record.member === member);
            
            if (memberRecords.length === 0) {
                alert(`${member} ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ„ÄÇ`);
                return;
            }
            
            // Ë®àÁÆóÊàêÂì°È§òÈ°çÔºàËàá updateMemberStats ÈÇèËºØ‰∏ÄËá¥Ôºâ
            const memberIncome = memberRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            const memberExpense = memberRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalAmount = memberIncome - memberExpense;
            
            // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
            updateFilterTabs('member');
            
            // È°ØÁ§∫ÊàêÂì°Ë®òÈåÑ
            displayRecords(memberRecords, `${member} ÁöÑË®òÈåÑ (ÂÖ± ${memberRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫Á∏ΩÊîØÂá∫Ë®òÈåÑ
        function showExpenseRecords() {
            console.log('showExpenseRecords Ë¢´Ë™øÁî®');
            console.log('Áï∂ÂâçË®òÈåÑÁ∏ΩÊï∏:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            console.log('Áï∂ÂâçÊúà‰ªΩ:', currentMonth, 'Áï∂ÂâçÂπ¥‰ªΩ:', currentYear);
            
            // È°ØÁ§∫ÊâÄÊúâÊîØÂá∫Ë®òÈåÑÔºàÂåÖÂê´ÂÆ∂Áî®Ôºâ
            const expenseRecords = records.filter(record => {
                const isExpense = record.type === 'expense';
                console.log(`Ë®òÈåÑ ${record.id}: ÊàêÂì°=${record.member}, È°ûÂûã=${record.type}, ÊòØÊîØÂá∫=${isExpense}`);
                return isExpense;
            });
            
            console.log('ÁØ©ÈÅ∏ÂæåÁöÑÊîØÂá∫Ë®òÈåÑ:', expenseRecords);
            
            const totalAmount = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('expense');
            displayRecords(expenseRecords, `Áï∂ÊúàÁ∏ΩÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${expenseRecords.length} Á≠ÜÔºå$${(-totalAmount).toLocaleString()})`);
        }

        // È°ØÁ§∫ÁèæÈáëÊîØÂá∫Ë®òÈåÑ
        function showCashExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const cashExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ÁèæÈáë' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = cashExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('cash');
            displayRecords(cashExpenseRecords, `Áï∂ÊúàÁèæÈáëÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${cashExpenseRecords.length} Á≠ÜÔºå$${(-totalAmount).toLocaleString()})`);
        }

        // È°ØÁ§∫‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ
        function showCreditExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const creditExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === '‰ø°Áî®Âç°' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = creditExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('credit');
            displayRecords(creditExpenseRecords, `Áï∂Êúà‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${creditExpenseRecords.length} Á≠ÜÔºå$${(-totalAmount).toLocaleString()})`);
        }

        // È°ØÁ§∫Á∏ΩÊî∂ÂÖ•Ë®òÈåÑ
        function showIncomeRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const incomeRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'income' && 
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('income');
            displayRecords(incomeRecords, `Áï∂ÊúàÁ∏ΩÊî∂ÂÖ•Ë®òÈåÑ (ÂÖ± ${incomeRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫ÂÖ®ÈÉ®Ë®òÈåÑ
        function showAllRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const allRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalIncome = allRecords.filter(r => r.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = allRecords.filter(r => r.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const netAmount = totalIncome - totalExpense;
            
            // Ë™øË©¶‰ø°ÊÅØ
            console.log('Áï∂ÊúàÂÖ®ÈÉ®Ë®òÈåÑË®àÁÆó:');
            console.log('- Ë®òÈåÑÁ∏ΩÊï∏:', allRecords.length);
            console.log('- Êî∂ÂÖ•Ë®òÈåÑ:', totalIncome);
            console.log('- ÊîØÂá∫Ë®òÈåÑ:', totalExpense);
            console.log('- Ê∑®È°çË®àÁÆó:', totalIncome, '-', totalExpense, '=', netAmount);
            
            updateFilterTabs('all');
            displayRecords(allRecords, `Áï∂ÊúàÂÖ®ÈÉ®Ë®òÈåÑ (ÂÖ± ${allRecords.length} Á≠ÜÔºå$${netAmount.toLocaleString()})`);
        }

        // ÊåâÊàêÂì°ÁØ©ÈÅ∏Ë®òÈåÑ
        function filterByMember() {
            const selectedMember = document.getElementById('memberFilter').value;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // Áç≤ÂèñÁï∂ÂâçÊúà‰ªΩÁöÑË®òÈåÑ
            const currentMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            let filteredRecords;
            if (selectedMember === '') {
                // Â¶ÇÊûúÊ≤íÊúâÈÅ∏ÊìáÊàêÂì°ÔºåÈ°ØÁ§∫ÊâÄÊúâË®òÈåÑ
                filteredRecords = currentMonthRecords;
            } else {
                // ÁØ©ÈÅ∏ÁâπÂÆöÊàêÂì°ÁöÑË®òÈåÑ
                filteredRecords = currentMonthRecords.filter(record => record.member === selectedMember);
            }
            
            // Ë®àÁÆóÁ∏ΩÈáëÈ°ç
            const totalAmount = filteredRecords.reduce((sum, record) => {
                if (record.type === 'expense') {
                    return sum - record.amount; // ÊîØÂá∫ÁÇ∫Ë≤†Êï∏
                } else if (record.type === 'income') {
                    return sum + record.amount; // Êî∂ÂÖ•ÁÇ∫Ê≠£Êï∏
                }
                return sum;
            }, 0);
            
            // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
            updateFilterTabs('member');
            
            // È°ØÁ§∫ÁØ©ÈÅ∏ÁµêÊûú
            const title = selectedMember === '' ? 
                `Áï∂ÊúàÂÖ®ÈÉ®Ë®òÈåÑ (ÂÖ± ${filteredRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})` :
                `${selectedMember} ÁöÑË®òÈåÑ (ÂÖ± ${filteredRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`;
            
            displayRecords(filteredRecords, title);
        }

        // Ê∏ÖÈô§ÊàêÂì°ÁØ©ÈÅ∏
        function clearMemberFilter() {
            document.getElementById('memberFilter').value = '';
            showAllRecords(); // ÂõûÂà∞È°ØÁ§∫ÂÖ®ÈÉ®Ë®òÈåÑ
        }

        // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
        function updateFilterTabs(activeType) {
            const tabs = document.querySelectorAll('.filter-tab');
            console.log('Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã:', activeType, 'Ê®ôÁ±§Êï∏Èáè:', tabs.length);
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('ÁßªÈô§activeÈ°ûÂà•:', tab.textContent);
            });
            
            if (activeType === 'all') {
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    console.log('Ë®≠ÁΩÆÂÖ®ÈÉ®Ë®òÈåÑÁÇ∫active:', tabs[0].textContent);
                }
            } else if (activeType === 'expense') {
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊîØÂá∫ÁÇ∫active:', tabs[1].textContent);
                }
            } else if (activeType === 'cash') {
                if (tabs[2]) {
                    tabs[2].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁèæÈáëÊîØÂá∫ÁÇ∫active:', tabs[2].textContent);
                }
            } else if (activeType === 'credit') {
                if (tabs[3]) {
                    tabs[3].classList.add('active');
                    console.log('Ë®≠ÁΩÆ‰ø°Áî®Âç°ÊîØÂá∫ÁÇ∫active:', tabs[3].textContent);
                }
            } else if (activeType === 'income') {
                if (tabs[4]) {
                    tabs[4].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊî∂ÂÖ•ÁÇ∫active:', tabs[4].textContent);
                }
            } else if (activeType === 'member') {
                // ÊàêÂì°Ë®òÈåÑ‰∏çÈ°ØÁ§∫‰ªª‰ΩïÊ®ôÁ±§È†ÅÁÇ∫ active
                console.log('ÊàêÂì°Ë®òÈåÑÔºöÊ∏ÖÈô§ÊâÄÊúâÊ®ôÁ±§È†ÅÁöÑ active ÁãÄÊÖã');
            }
        }

        // È°ØÁ§∫Ë®òÈåÑÁöÑÈÄöÁî®ÂáΩÊï∏
        function displayRecords(recordsToShow, title) {
            console.log('displayRecords Ë¢´Ë™øÁî®');
            console.log('Ë¶ÅÈ°ØÁ§∫ÁöÑË®òÈåÑÊï∏Èáè:', recordsToShow.length);
            console.log('Ê®ôÈ°å:', title);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', recordsToShow);
            
            if (recordsToShow.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑË¶ÅÈ°ØÁ§∫ÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã');
                document.getElementById('recentRecords').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ</p>
                    </div>
                `;
                return;
            }
            
            // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let recordsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #333; margin-bottom: 15px;">${title}</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            recordsToShow.forEach(record => {
                let amount, amountClass, prefix, bgColor, textColor;
                
                if (record.type === 'income') {
                    amount = record.amount;
                    amountClass = 'income';
                    prefix = '+';
                    bgColor = 'rgba(81, 207, 102, 0.1)';
                    textColor = '#51cf66';
                } else {
                    amount = -record.amount;
                    amountClass = 'expense';
                    prefix = '-';
                    bgColor = 'rgba(255, 107, 107, 0.1)';
                    textColor = '#ff6b6b';
                }
                
                recordsHtml += `
                    <div class="record-item ${amountClass}" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; background: ${bgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.member} - ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}</strong>
                                <br>
                                <small style="color: #666;">${record.description || 'ÁÑ°ÊèèËø∞'}</small>
                                <br>
                                <small style="color: #999;">${record.date}</small>
                            </div>
                            <div style="font-weight: bold; color: ${textColor};">
                                ${prefix}$${record.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('recentRecords').innerHTML = recordsHtml;
        }

        function updateRecentRecords() {
            const recentRecords = records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentRecords');
            container.innerHTML = '';
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            recentRecords.forEach(record => {
                const recordElement = createRecordElement(record);
                container.appendChild(recordElement);
            });
        }

        function updateAllRecords() {
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        function createRecordElement(record) {
            const div = document.createElement('div');
            div.className = `record-item ${record.type}`;
            
            let amountClass, amountPrefix;
            if (record.type === 'income') {
                amountClass = 'income';
                amountPrefix = '+';
            } else {
                amountClass = 'expense';
                amountPrefix = '-';
            }
            const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
            
            div.innerHTML = `
                <div class="record-info">
                    <h4>${record.member} - ${categoryText}</h4>
                    <p>${record.description || 'ÁÑ°ÊèèËø∞'}</p>
                    <p>${new Date(record.date).toLocaleDateString('zh-TW')}</p>
                </div>
                <div class="record-amount ${amountClass}">
                    ${amountPrefix}$${record.amount.toLocaleString()}
                </div>
                <div class="record-actions">
                    <button class="btn btn-small" onclick="editRecord('${record.id}')">Á∑®ËºØ</button>
                    <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')">Âà™Èô§</button>
                </div>
            `;
            
            return div;
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            
            calendarTitle.textContent = `${currentYear}Âπ¥${currentMonth + 1}Êúà`;
            
            // Ê∏ÖÁ©∫Êó•ÊõÜ
            calendarGrid.innerHTML = '';
            
            // Ê∑ªÂä†ÊòüÊúüÊ®ôÈ°å
            const weekDays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.background = '#f8f9fa';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Áç≤ÂèñÁï∂ÊúàÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂæå‰∏ÄÂ§©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ÁîüÊàê42Â§©Ôºà6ÈÄ±Ôºâ
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentMonth) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = formatDateToYYYYMMDD(date);
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-records" id="day-records-${dateStr}"></div>
                `;
                dayElement.id = `day-${dateStr}`;
                
                dayElement.onclick = () => showDayRecords(date);
                calendarGrid.appendChild(dayElement);
            }
            
            // Êõ¥Êñ∞ÊØèÊó•Ë®òÈåÑ
            updateDayRecords();
        }

        function updateDayRecords() {
            // ÂÖàÊ∏ÖÁ©∫ÊâÄÊúâÊó•ÊúüÁöÑË®òÈåÑ
            for (let i = 0; i < 42; i++) {
                const startDate = new Date(currentYear, currentMonth, 1);
                startDate.setDate(startDate.getDate() - startDate.getDay() + i);
                const dayRecordsElement = document.getElementById(`day-records-${formatDateToYYYYMMDD(startDate)}`);
                if (dayRecordsElement) {
                    dayRecordsElement.innerHTML = '';
                }
            }
            
            // ÊåâÊó•ÊúüÂíåÊàêÂì°ÂàÜÁµÑË®àÁÆóÁ∏ΩÈ°ç
            const dayMemberTotals = {};
            records.forEach(record => {
                const date = record.date;
                const member = record.member;
                let amount;
                if (record.type === 'income') {
                    amount = record.amount; // Êî∂ÂÖ•ÁÇ∫Ê≠£Êï∏
                } else {
                    amount = -record.amount; // ÊîØÂá∫ÁÇ∫Ë≤†Êï∏
                }
                
                if (!dayMemberTotals[date]) {
                    dayMemberTotals[date] = {};
                }
                if (!dayMemberTotals[date][member]) {
                    dayMemberTotals[date][member] = 0;
                }
                dayMemberTotals[date][member] += amount;
            });
            
            // È°ØÁ§∫ÊØèÂÄãÊàêÂì°ÁöÑÁï∂Êó•Á∏ΩÈ°ç
            Object.keys(dayMemberTotals).forEach(date => {
                const dayRecordsElement = document.getElementById(`day-records-${date}`);
                if (dayRecordsElement) {
                    const memberTotals = dayMemberTotals[date];
                    Object.keys(memberTotals).forEach(member => {
                        const total = memberTotals[member];
                        if (total !== 0) {
                            const recordClass = total > 0 ? 'day-income' : 'day-expense';
                            const prefix = total > 0 ? '+' : '';
                            
                            const recordDiv = document.createElement('div');
                            recordDiv.className = recordClass;
                            recordDiv.textContent = `${member}: ${prefix}$${Math.abs(total).toLocaleString()}`;
                            dayRecordsElement.appendChild(recordDiv);
                        }
                    });
                }
            });
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function showDayRecords(date) {
            const dayRecords = records.filter(record => record.date === formatDateToYYYYMMDD(date));
            
            if (dayRecords.length === 0) {
                // ‰∏çÈ°ØÁ§∫ÊèêÈÜíÔºåÁõ¥Êé•ËøîÂõû
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} ÁöÑË®òÈåÑÔºö\n\n`;
            dayRecords.forEach(record => {
                let prefix;
                if (record.type === 'income') {
                    prefix = '+';
                } else {
                    prefix = '-';
                }
                const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
                message += `${record.member} - ${categoryText}: ${prefix}$${record.amount}\n`;
                if (record.description) {
                    message += `  ÊèèËø∞: ${record.description}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberFilter = document.getElementById('memberFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredRecords = records.filter(record => {
                const matchesSearch = !searchTerm || 
                    record.member.toLowerCase().includes(searchTerm) ||
                    record.mainCategory.toLowerCase().includes(searchTerm) ||
                    (record.subCategory && record.subCategory.toLowerCase().includes(searchTerm)) ||
                    record.description.toLowerCase().includes(searchTerm);
                
                const matchesMember = !memberFilter || record.member === memberFilter;
                
                const matchesType = !typeFilter || record.type === typeFilter;
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                return matchesSearch && matchesMember && matchesType && matchesDate;
            });
            
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ</p>';
                return;
            }
            
            filteredRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        // Ë°®ÂñÆÊèê‰∫§
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('member').value;
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            let mainCategory = document.getElementById('mainCategory').value;
            const customMainCategory = document.getElementById('customMainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const date = document.getElementById('date').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!type) {
                alert('Ë´ãÈÅ∏ÊìáÈ°ûÂûãÔºÅ');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºàÂøÖÈ†àÂ§ßÊñº0ÔºâÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÈÅ∏Êìá‰∫Ü"ÂÖ∂‰ªñ"Ôºå‰ΩøÁî®Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
            if (mainCategory === 'ÂÖ∂‰ªñ') {
                if (!customMainCategory.trim()) {
                    alert('Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•ÔºÅ');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            // È°ûÂûãÁõ¥Êé•ÂæûË°®ÂñÆÁç≤ÂèñÔºå‰∏çÈúÄË¶ÅÈ°çÂ§ñÂà§Êñ∑
            console.log('Ë®òÈåÑÈ°ûÂûã:', type, 'ÈáëÈ°ç:', amount, '‰∏ªÈ°ûÂà•:', mainCategory);
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Ë®≠ÁÇ∫‰ªäÂ§©ÁöÑÁµêÊùüÊôÇÈñì
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const finalAmount = Math.abs(amount);
            console.log('ÂâµÂª∫Ë®òÈåÑ:', { type, originalAmount: amount, finalAmount, mainCategory });
            
            const record = {
                id: Date.now().toString(),
                member: member,
                type: type,
                amount: finalAmount, // ÈÄÄË≤ª‰øùÊåÅÂéüÂßãÈáëÈ°çÔºåÂÖ∂‰ªñÂ≠òÂÑ≤ÁµïÂ∞çÂÄº
                mainCategory: mainCategory,
                subCategory: subCategory,
                description: document.getElementById('description').value,
                date: date
            };
            
            records.push(record);
            saveRecords();
            
            // ÈáçÁΩÆË°®ÂñÆ
            this.reset();
            
            setTodayDate();
            
            // Á¢∫‰øùÊâÄÊúâÊàêÂì°ÈÅ∏È†ÖÈÉΩÊ≠£Á¢∫Ë®≠ÁΩÆ
            ensureMemberOptions();
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
            updateDataStats(); // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
            
            alert('Ë®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ');
        });

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            // Á¢∫‰øùÁ∑®ËºØË°®ÂñÆÁöÑÊàêÂì°ÈÅ∏È†ÖÂÆåÊï¥
            ensureMemberOptions();
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMember').value = record.member;
            document.getElementById('editType').value = record.type;
            document.getElementById('editAmount').value = record.amount;
            
            // Ë®≠ÁΩÆ‰∏ªÈ°ûÂà•ÔºàÂè™ÊîØÊåÅÈ†êÂÆöÁæ©ÈÅ∏È†ÖÔºâ
                document.getElementById('editMainCategory').value = record.mainCategory;
            
            document.getElementById('editSubCategory').value = record.subCategory;
            document.getElementById('editDescription').value = record.description;
            document.getElementById('editDate').value = record.date;
            
            // Êõ¥Êñ∞È°ûÂà•ÈÅ∏È†Ö
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');
            const editSubCategorySelect = document.getElementById('editSubCategory');
            
            // Êõ¥Êñ∞‰∏ªÈ°ûÂà•Ôºà‰ΩøÁî®‰∏ÄËá¥ÊÄßÊ∏ÖÂñÆÔºâ
            updateEditMainCategories();
            
            // Êõ¥Êñ∞‰ªòÊ¨æÊñπÂºèÈÅ∏È†Ö
            editSubCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            
            // Ê∑ªÂä†ÈÄöÁî®‰ªòÊ¨æÊñπÂºèÈÅ∏È†Ö
            const paymentMethods = ['‰ø°Áî®Âç°', 'ÁèæÈáë'];
            paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                editSubCategorySelect.appendChild(option);
            });
            
            // Â¶ÇÊûúÊòØÊîØÂá∫È°ûÂûã‰∏îÊúâÂ≠êÈ°ûÂà•Ôºå‰πüÊ∑ªÂä†Â≠êÈ°ûÂà•ÈÅ∏È†Ö
            const mainCategory = editMainCategorySelect.value;
            if (type === 'expense' && mainCategory && categories.expense[mainCategory]) {
                // Ê∑ªÂä†ÂàÜÈöîÁ∑ö
                const separatorOption = document.createElement('option');
                separatorOption.value = '---';
                separatorOption.textContent = '--- Â≠êÈ°ûÂà• ---';
                separatorOption.disabled = true;
                separatorOption.style.fontWeight = 'bold';
                separatorOption.style.color = '#666';
                editSubCategorySelect.appendChild(separatorOption);
                
                categories.expense[mainCategory].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    editSubCategorySelect.appendChild(option);
                });
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('editMember').value;
            const type = document.getElementById('editType').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const mainCategory = document.getElementById('editMainCategory').value;
            const subCategory = document.getElementById('editSubCategory').value;
            const date = document.getElementById('editDate').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!type) {
                alert('Ë´ãÈÅ∏ÊìáÈ°ûÂûãÔºÅ');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                records[recordIndex] = {
                    id: id,
                    member: member,
                    type: type,
                    amount: amount,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    description: document.getElementById('editDescription').value,
                    date: date
                };
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats(); // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
                closeModal();
                
                alert('Ë®òÈåÑÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
        });

        function deleteRecord(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')) {
                records = records.filter(record => record.id !== id);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats(); // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
                alert('Ë®òÈåÑÂ∑≤Âà™Èô§ÔºÅ');
            }
        }

        function saveRecords() {
            try {
            // ÂØ´ÂÖ• localStorage
            localStorage.setItem('familyRecords', JSON.stringify(records));
            
                // Ë®òÈåÑÊúÄÂæå‰øùÂ≠òÊôÇÈñì
                const saveTime = new Date().toISOString();
                localStorage.setItem('lastSaveTime', saveTime);
                
                // Ë®òÈåÑ‰øùÂ≠òÊ¨°Êï∏
                const saveCount = parseInt(localStorage.getItem('saveCount') || '0') + 1;
                localStorage.setItem('saveCount', saveCount.toString());
                
                console.log(`Ë®òÈåÑÂ∑≤‰øùÂ≠òÂà∞ localStorage (Á¨¨ ${saveCount} Ê¨°‰øùÂ≠ò)`);
                
                // ÂÆöÊúüËá™ÂãïÂÇô‰ªΩÂà∞ data.jsonÔºàÊØè3Ê¨°Êìç‰ΩúÂÇô‰ªΩ‰∏ÄÊ¨°Ôºâ
                if (saveCount % 3 === 0) {
                    console.log(`Â∑≤ÈÄ≤Ë°å ${saveCount} Ê¨°Êìç‰ΩúÔºåËá™ÂãïÂÇô‰ªΩ data.json`);
                saveToDataJson();
                }
                
                // ÂâµÂª∫È°çÂ§ñÁöÑÂÇô‰ªΩÔºàÊØè10Ê¨°Êìç‰ΩúÔºâ
                if (saveCount % 10 === 0) {
                    createAutoBackup();
                }

                // Êõ¥Êñ∞Ë™øË©¶‰ø°ÊÅØ
                updateDebugInfo();
                
                // È°ØÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫ÔºàÂèØÈÅ∏Ôºâ
                if (saveCount % 5 === 0) {
                    console.log(`‚úÖ Ë≥áÊñôÂ∑≤Ëá™Âãï‰øùÂ≠ò ${saveCount} Ê¨°`);
                }
                
            } catch (error) {
                console.error('‰øùÂ≠òË®òÈåÑÊôÇÁôºÁîüÈåØË™§:', error);
                alert('‰øùÂ≠òË®òÈåÑÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÊ™¢Êü•ÁÄèË¶ΩÂô®ÊéßÂà∂Âè∞„ÄÇ');
            }
        }

        // ÂØ´ÂÖ• data.json Ê™îÊ°àÔºàÈÄöÈÅé‰∏ãËºâÊñπÂºèÔºâ
        function saveToDataJson() {
            try {
                const now = new Date();
                const dataToSave = {
                    records: records,
                    settings: {
                        version: "1.0",
                        lastUpdated: now.toISOString()
                    }
                };
                
                // Ë®òÈåÑÂÇô‰ªΩÊôÇÈñì
                localStorage.setItem('lastBackupTime', now.toLocaleString('zh-TW'));
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâ data.json Ê™îÊ°à
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // ÈùúÈªò‰∏ãËºâÔºà‰∏çÈ°ØÁ§∫‰∏ãËºâÂ∞çË©±Ê°ÜÔºâ
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ÊàêÂäüÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à');
                
                // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫
                updateDataStats();
            } catch (error) {
                console.warn('ÁÑ°Ê≥ïÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à:', error, '‰ΩÜ localStorage Â∑≤‰øùÂ≠ò');
            }
        }

        // ÂòóË©¶Áõ¥Êé•ÂØ´ÂÖ•Êú¨Âú∞Ê™îÊ°àÔºàÈúÄË¶ÅÁî®Êà∂ÊéàÊ¨äÔºâ
        async function saveToLocalFile() {
            try {
                // Ê™¢Êü•ÊòØÂê¶ÊîØÊè¥ File System Access API
                if ('showSaveFilePicker' in window) {
                    const now = new Date();
                    const dataToSave = {
                        records: records,
                        metadata: {
                            version: "1.0",
                            lastUpdated: now.toISOString(),
                            recordCount: records.length
                        }
                    };
                    
                    // Ë´ãÊ±ÇÁî®Êà∂ÈÅ∏Êìá‰øùÂ≠ò‰ΩçÁΩÆ
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: `family_backup_${formatDateToYYYYMMDD(now)}.json`,
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    
                    // ÂØ´ÂÖ•Ê™îÊ°à
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(dataToSave, null, 2));
                    await writable.close();
                    
                    alert(`Ê™îÊ°àÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞Êú¨Âú∞ÔºÅ\n\nÊ™îÊ°à‰ΩçÁΩÆ: ${fileHandle.name}\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü`);
                    console.log('Ê™îÊ°àÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞:', fileHandle.name);
                    
                } else {
                    // ‰∏çÊîØÊè¥ File System Access APIÔºåÂõûÈÄÄÂà∞‰∏ãËºâÊñπÂºè
                    console.log('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ File System Access APIÔºå‰ΩøÁî®‰∏ãËºâÊñπÂºè');
                    saveToDataJson();
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Áî®Êà∂ÂèñÊ∂à‰∫ÜÊ™îÊ°à‰øùÂ≠ò');
                } else {
                    console.error('‰øùÂ≠òÊ™îÊ°àÂ§±Êïó:', error);
                    alert('‰øùÂ≠òÊ™îÊ°àÂ§±ÊïóÔºÅË´ãÊ™¢Êü•ÁÄèË¶ΩÂô®Ê¨äÈôêÊàñ‰ΩøÁî®‰∏ãËºâÊñπÂºè„ÄÇ');
                }
            }
        }

        // Áç≤Âèñ GitHub Token
        function getGitHubToken() {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                const newToken = prompt(
                    'Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ GitHub Personal Access Token:\n\n' +
                    'Â¶Ç‰ΩïÁç≤Âèñ Token:\n' +
                    '1. ÂâçÂæÄ GitHub Settings > Developer settings > Personal access tokens\n' +
                    '2. ÂâµÂª∫Êñ∞ tokenÔºåÈÅ∏Êìá "repo" Ê¨äÈôê\n' +
                    '3. Ë§áË£Ω token ‰∏¶Ë≤ºÂà∞ÈÄôË£°\n\n' +
                    'Token Â∞áÂÆâÂÖ®Âú∞ÂÑ≤Â≠òÂú®ÁÄèË¶ΩÂô®ÁöÑ localStorage ‰∏≠\n\n' +
                    '‚ö†Ô∏è Ê≥®ÊÑèÔºöË´ãÁ¢∫‰øùË§áË£ΩÂÆåÊï¥ÁöÑTokenÔºå‰∏çË¶ÅÂåÖÂê´Â§öÈ§òÁöÑÁ©∫Ê†ºÊàñÊèõË°åÁ¨¶'
                );
                if (newToken) {
                    // Ê∏ÖÁêÜTokenÔºöÁßªÈô§ÂâçÂæåÁ©∫Ê†ºÂíåÊèõË°åÁ¨¶
                    const cleanToken = newToken.trim().replace(/\s/g, '');
                    
                    // È©óË≠âTokenÊ†ºÂºè
                    if (cleanToken.length < 20) {
                        alert('‚ùå Token Èï∑Â∫¶Â§™Áü≠ÔºåË´ãÊ™¢Êü•ÊòØÂê¶Ë§áË£ΩÂÆåÊï¥');
                        return null;
                    }
                    
                    // GitHub Token Ê†ºÂºèÔºöghp_ ÈñãÈ†≠ÔºåÂåÖÂê´Â≠óÊØçÊï∏Â≠óÂíåÂ∫ïÁ∑ö
                    if (!cleanToken.startsWith('ghp_') && !cleanToken.startsWith('gho_') && !cleanToken.startsWith('ghu_') && !cleanToken.startsWith('ghs_') && !cleanToken.startsWith('ghr_')) {
                        alert('‚ùå Token Ê†ºÂºè‰∏çÊ≠£Á¢∫ÔºåGitHub Token ÊáâË©≤‰ª• ghp_„ÄÅgho_„ÄÅghu_„ÄÅghs_ Êàñ ghr_ ÈñãÈ†≠');
                        return null;
                    }
                    
                    localStorage.setItem('githubToken', cleanToken);
                    return cleanToken;
                }
                return null;
            }
            return token;
        }

        // Ê∏ÖÈô§ GitHub Token
        function clearGitHubToken() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Â∑≤‰øùÂ≠òÁöÑ GitHub Token ÂóéÔºü\n\nÊ∏ÖÈô§ÂæåÈúÄË¶ÅÈáçÊñ∞Ëº∏ÂÖ• Token ÊâçËÉΩ‰ΩøÁî® GitHub Â≠òÊ™îÂäüËÉΩ„ÄÇ')) {
                localStorage.removeItem('githubToken');
                alert('‚úÖ GitHub Token Â∑≤Ê∏ÖÈô§ÔºÅ\n\n‰∏ãÊ¨°‰ΩøÁî® GitHub ÂäüËÉΩÊôÇÊúÉÈáçÊñ∞ÊèêÁ§∫Ëº∏ÂÖ• Token„ÄÇ');
            }
        }

        // Ê∏¨Ë©¶ GitHub Token
        async function testGitHubToken() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                // Ê∏¨Ë©¶APIË™øÁî®
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const repoData = await response.json();
                    alert(`‚úÖ Token Ê∏¨Ë©¶ÊàêÂäüÔºÅ\n\nÂÄâÂ∫´: ${repoData.full_name}\nÊ¨äÈôê: ${repoData.permissions ? Object.keys(repoData.permissions).filter(p => repoData.permissions[p]).join(', ') : 'Êú™Áü•'}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(`API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('Token Ê∏¨Ë©¶Â§±Êïó:', error);
                alert(`‚ùå Token Ê∏¨Ë©¶Â§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}\n\nË´ãÊ™¢Êü• Token ÊòØÂê¶Ê≠£Á¢∫ÊàñÂÄâÂ∫´Ë∑ØÂæëÊòØÂê¶Ê≠£Á¢∫„ÄÇ`);
            }
        }

        // Áç≤Âèñ GitHub ÂÄâÂ∫´‰ø°ÊÅØ
        function getGitHubRepoInfo() {
            const hostname = window.location.hostname;
            const pathname = window.location.pathname;
            
            if (hostname.includes('github.io')) {
                const parts = pathname.split('/').filter(part => part);
                const username = hostname.split('.')[0];
                const repoName = parts[0] || 'familyCost';
                return `${username}/${repoName}`;
            }
            
            // Â¶ÇÊûú‰∏çÊòØ GitHub PagesÔºåËÆìÁî®Êà∂ÊâãÂãïËº∏ÂÖ•
            const repoInfo = prompt('Ë´ãËº∏ÂÖ• GitHub ÂÄâÂ∫´Ë∑ØÂæë (Ê†ºÂºè: username/repository):');
            return repoInfo;
        }

        // Â≠òÊ™îÂà∞ GitHub Ê™îÊ°à
        async function saveToGitHubFile() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: now.toISOString(),
                        version: "1.0",
                        description: "ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑË≥áÊñô",
                        recordCount: records.length
                    }
                };
                
                // ÂÖàÁç≤ÂèñÁèæÊúâÊ™îÊ°àÁöÑ SHA
                const getResponse = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Êõ¥Êñ∞Ê™îÊ°à
                const updateData = {
                    message: `Update family records - ${now.toLocaleString('zh-TW')}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))),
                    branch: 'main'
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (response.ok) {
                    alert(`‚úÖ GitHub Ê™îÊ°àÂ≠òÊ™îÊàêÂäüÔºÅ\n\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÂ≠òÊ™îÊôÇÈñì: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Ê™îÊ°àÂ≠òÊ™îÊàêÂäü');
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Ê™îÊ°àÂ≠òÊ™îÂ§±Êïó:', error);
                alert(`‚ùå GitHub Ê™îÊ°àÂ≠òÊ™îÂ§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}\n\nË´ãÊ™¢Êü• Token Ê¨äÈôêÂíåÂÄâÂ∫´Ë∑ØÂæë„ÄÇ`);
            }
        }

        // Âæû GitHub Ê™îÊ°àËºâÂÖ•
        async function loadFromGitHubFile() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = JSON.parse(atob(fileData.content));
                    
                    if (content.records && Array.isArray(content.records)) {
                        records = content.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        
                        // Êõ¥Êñ∞È°ØÁ§∫
                        updateStats();
                        updateMemberStats();
                        updateAllRecords();
                        updateCalendar();
                        updateDataStats();
                        updateDebugInfo();
                        
                        alert(`‚úÖ Âæû GitHub ËºâÂÖ•ÊàêÂäüÔºÅ\n\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÊúÄÂæåÊõ¥Êñ∞: ${content.metadata?.lastUpdated ? new Date(content.metadata.lastUpdated).toLocaleString('zh-TW') : 'Êú™Áü•'}`);
                    } else {
                        alert('‚ùå GitHub Ê™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅ');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('Âæû GitHub ËºâÂÖ•Â§±Êïó:', error);
                alert(`‚ùå Âæû GitHub ËºâÂÖ•Â§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}`);
            }
        }

        // Â≠òÊ™îÁÇ∫ GitHub Issue
        async function saveToGitHubIssue() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const issueTitle = `ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑÂÇô‰ªΩ - ${now.toLocaleString('zh-TW')}`;
                const issueBody = `## ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑÂÇô‰ªΩ\n\n**ÂÇô‰ªΩÊôÇÈñì:** ${now.toLocaleString('zh-TW')}\n**Ë®òÈåÑÊï∏Èáè:** ${records.length} Á≠Ü\n\n### Ë®òÈåÑÊëòË¶Å\n\`\`\`json\n${JSON.stringify(records, null, 2)}\n\`\`\`\n\n---\n*Ê≠§ Issue Áî±ÂÆ∂Â∫≠Êî∂ÊîØÁÆ°ÁêÜÁ≥ªÁµ±Ëá™ÂãïÂâµÂª∫*`;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/issues`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            title: issueTitle,
                            body: issueBody,
                            labels: ['backup', 'family-records']
                        })
                    }
                );
                
                if (response.ok) {
                    const issueData = await response.json();
                    alert(`‚úÖ GitHub Issue Â≠òÊ™îÊàêÂäüÔºÅ\n\nIssue #${issueData.number}\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÂ≠òÊ™îÊôÇÈñì: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Issue Â≠òÊ™îÊàêÂäü:', issueData.number);
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Issue Â≠òÊ™îÂ§±Êïó:', error);
                alert(`‚ùå GitHub Issue Â≠òÊ™îÂ§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}`);
            }
        }

        // Âæû GitHub Issues ËºâÂÖ•
        async function loadFromGitHubIssues() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/issues?labels=backup,family-records&state=all`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const issues = await response.json();
                    
                    if (issues.length === 0) {
                        alert('‚ùå Ê≤íÊúâÊâæÂà∞ÂÇô‰ªΩ IssueÔºÅ');
                        return;
                    }
                    
                    // È°ØÁ§∫ÂèØÁî®ÁöÑÂÇô‰ªΩ
                    const backupList = issues.map(issue => 
                        `#${issue.number} - ${issue.title} (${new Date(issue.created_at).toLocaleString('zh-TW')})`
                    ).join('\n');
                    
                    const selectedIssue = prompt(
                        `ÊâæÂà∞ ${issues.length} ÂÄãÂÇô‰ªΩ IssueÔºö\n\n${backupList}\n\nË´ãËº∏ÂÖ•Ë¶ÅËºâÂÖ•ÁöÑ Issue Á∑®Ëôü:`
                    );
                    
                    if (selectedIssue) {
                        const issueNumber = parseInt(selectedIssue.replace('#', ''));
                        const issue = issues.find(i => i.number === issueNumber);
                        
                        if (issue) {
                            // Âæû Issue ÂÖßÂÆπ‰∏≠ÊèêÂèñ JSON Êï∏Êìö
                            const body = issue.body;
                            const jsonMatch = body.match(/```json\n([\s\S]*?)\n```/);
                            
                            if (jsonMatch) {
                                const recordsData = JSON.parse(jsonMatch[1]);
                                if (Array.isArray(recordsData)) {
                                    records = recordsData;
                                    localStorage.setItem('familyRecords', JSON.stringify(records));
                                    
                                    // Êõ¥Êñ∞È°ØÁ§∫
                                    updateStats();
                                    updateMemberStats();
                                    updateAllRecords();
                                    updateCalendar();
                                    updateDataStats();
                                    updateDebugInfo();
                                    
                                    alert(`‚úÖ Âæû GitHub Issue #${issueNumber} ËºâÂÖ•ÊàêÂäüÔºÅ\n\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü`);
                                } else {
                                    alert('‚ùå Issue ‰∏≠ÁöÑÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅ');
                                }
                            } else {
                                alert('‚ùå ÁÑ°Ê≥ïÂæû Issue ‰∏≠ÊèêÂèñÊï∏ÊìöÔºÅ');
                            }
                        } else {
                            alert('‚ùå Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑ IssueÔºÅ');
                        }
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('Âæû GitHub Issues ËºâÂÖ•Â§±Êïó:', error);
                alert(`‚ùå Âæû GitHub Issues ËºâÂÖ•Â§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}`);
            }
        }

        // ÂâµÂª∫ GitHub Release
        async function createGitHubRelease() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const tagName = `v${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
                const releaseName = `ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑÂÇô‰ªΩ - ${now.toLocaleString('zh-TW')}`;
                const releaseBody = `## ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑÂÇô‰ªΩ\n\n**ÂÇô‰ªΩÊôÇÈñì:** ${now.toLocaleString('zh-TW')}\n**Ë®òÈåÑÊï∏Èáè:** ${records.length} Á≠Ü\n\n### Áµ±Ë®àÊëòË¶Å\n- Á∏ΩÊî∂ÂÖ•: $${records.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0).toLocaleString()}\n- Á∏ΩÊîØÂá∫: $${records.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0).toLocaleString()}\n\n---\n*Ê≠§ Release Áî±ÂÆ∂Â∫≠Êî∂ÊîØÁÆ°ÁêÜÁ≥ªÁµ±Ëá™ÂãïÂâµÂª∫*`;
                
                // ÂâµÂª∫ data.json Ê™îÊ°àÂÖßÂÆπ
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: now.toISOString(),
                        version: "1.0",
                        description: "ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑË≥áÊñô",
                        recordCount: records.length
                    }
                };
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/releases`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            tag_name: tagName,
                            name: releaseName,
                            body: releaseBody,
                            draft: false,
                            prerelease: false
                        })
                    }
                );
                
                if (response.ok) {
                    const releaseData = await response.json();
                    alert(`‚úÖ GitHub Release ÂâµÂª∫ÊàêÂäüÔºÅ\n\nRelease: ${releaseData.tag_name}\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÂâµÂª∫ÊôÇÈñì: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Release ÂâµÂª∫ÊàêÂäü:', releaseData.tag_name);
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Release ÂâµÂª∫Â§±Êïó:', error);
                alert(`‚ùå GitHub Release ÂâµÂª∫Â§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}`);
            }
        }

        // GitHub Pages Ëß£Ê±∫ÊñπÊ°àÔºö‰ΩøÁî® GitHub API Êõ¥Êñ∞Ê™îÊ°à
        async function saveToGitHub() {
            try {
                // Ê™¢Êü•ÊòØÂê¶Âú® GitHub Pages Áí∞Â¢É
                if (!window.location.hostname.includes('github.io')) {
                    alert('Ê≠§ÂäüËÉΩÂÉÖÂú® GitHub Pages Áí∞Â¢É‰∏≠ÂèØÁî®ÔºÅ\n\nË´ã‰ΩøÁî®ÂÖ∂‰ªñÂÇô‰ªΩÊñπÂºè„ÄÇ');
                    return;
                }
                
                const now = new Date();
                const dataToSave = {
                    records: records,
                    metadata: {
                        version: "1.0",
                        lastUpdated: now.toISOString(),
                        recordCount: records.length,
                        updatedBy: "family-cost-app"
                    }
                };
                
                // ÊèêÁ§∫Áî®Êà∂ÈúÄË¶Å GitHub Token
                const token = prompt(
                    'Ë¶ÅÊõ¥Êñ∞ GitHub ‰∏äÁöÑ data.json Ê™îÊ°àÔºåÈúÄË¶ÅÊÇ®ÁöÑ GitHub Personal Access Token„ÄÇ\n\n' +
                    'Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ GitHub TokenÔºàÂ¶ÇÊûúÊ≤íÊúâÔºåË´ãÊåâÂèñÊ∂à‰ΩøÁî®‰∏ãËºâÊñπÂºèÔºâ:\n\n' +
                    'Â¶Ç‰ΩïÁç≤Âèñ Token:\n' +
                    '1. ÂâçÂæÄ GitHub Settings > Developer settings > Personal access tokens\n' +
                    '2. ÂâµÂª∫Êñ∞ tokenÔºåÈÅ∏Êìá "repo" Ê¨äÈôê\n' +
                    '3. Ë§áË£Ω token ‰∏¶Ë≤ºÂà∞ÈÄôË£°'
                );
                
                if (!token) {
                    console.log('Áî®Êà∂ÂèñÊ∂à‰∫Ü GitHub Êõ¥Êñ∞Ôºå‰ΩøÁî®‰∏ãËºâÊñπÂºè');
                    saveToDataJson();
                    return;
                }
                
                // Áç≤ÂèñÁï∂ÂâçÊ™îÊ°àÂÖßÂÆπÔºàÁî®ÊñºË®àÁÆó SHAÔºâ
                const response = await fetch('data.json');
                let currentSha = null;
                if (response.ok) {
                    const currentData = await response.json();
                    // ÈÄôË£°ÈúÄË¶Å GitHub API ‰æÜÁç≤Âèñ SHAÔºå‰ΩÜÊàëÂÄëÂÖàÂòóË©¶Êõ¥Êñ∞
                }
                
                // Ê∫ñÂÇô GitHub API Ë´ãÊ±Ç
                const githubData = {
                    message: `Update family records backup - ${now.toLocaleString('zh-TW')}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))), // Base64 Á∑®Á¢º
                    branch: 'main' // Êàñ 'master'ÔºåÊ†πÊìöÊÇ®ÁöÑÈ†êË®≠ÂàÜÊîØ
                };
                
                // Â¶ÇÊûúÊúâÁèæÊúâ SHAÔºåÊ∑ªÂä†Âà∞Ë´ãÊ±Ç‰∏≠
                if (currentSha) {
                    githubData.sha = currentSha;
                }
                
                const apiResponse = await fetch(
                    `https://api.github.com/repos/${getGitHubRepoPath()}/contents/data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(githubData)
                    }
                );
                
                if (apiResponse.ok) {
                    alert(`GitHub Ê™îÊ°àÊõ¥Êñ∞ÊàêÂäüÔºÅ\n\nË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\nÊõ¥Êñ∞ÊôÇÈñì: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Ê™îÊ°àÊõ¥Êñ∞ÊàêÂäü');
                } else {
                    const errorData = await apiResponse.json();
                    throw new Error(`GitHub API ÈåØË™§: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Êõ¥Êñ∞Â§±Êïó:', error);
                alert(`GitHub Êõ¥Êñ∞Â§±ÊïóÔºÅ\n\nÈåØË™§: ${error.message}\n\nÂ∞á‰ΩøÁî®‰∏ãËºâÊñπÂºè‰ΩúÁÇ∫ÂÇôÈÅ∏„ÄÇ`);
                saveToDataJson();
            }
        }
        
        // Áç≤Âèñ GitHub ÂÄâÂ∫´Ë∑ØÂæë
        function getGitHubRepoPath() {
            const hostname = window.location.hostname;
            const pathname = window.location.pathname;
            
            // Âæû URL Ëß£ÊûêÂÄâÂ∫´Ë∑ØÂæë
            // ‰æãÂ¶Ç: username.github.io/repo-name -> username/repo-name
            const parts = pathname.split('/').filter(part => part);
            if (parts.length >= 1) {
                const username = hostname.split('.')[0];
                return `${username}/${parts[0]}`;
            }
            
            return null;
        }

        // ÂâµÂª∫Ëá™ÂãïÂÇô‰ªΩ
        function createAutoBackup() {
            try {
                const now = new Date();
                const backupData = {
                    records: records,
                    metadata: {
                        backupTime: now.toISOString(),
                        version: "1.0",
                        purpose: "auto-backup",
                        recordCount: records.length
                    }
                };
                
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇô‰ªΩ
                const backupKey = `backup_${formatDateToYYYYMMDD(now)}_${now.getHours()}${now.getMinutes()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Âè™‰øùÁïôÊúÄËøë5ÂÄãÂÇô‰ªΩ
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                if (backupKeys.length > 5) {
                    backupKeys.sort();
                    for (let i = 0; i < backupKeys.length - 5; i++) {
                        localStorage.removeItem(backupKeys[i]);
                    }
                }
                
                console.log('Ëá™ÂãïÂÇô‰ªΩÂ∑≤ÂâµÂª∫:', backupKey);
                
            } catch (error) {
                console.warn('ÂâµÂª∫Ëá™ÂãïÂÇô‰ªΩÂ§±Êïó:', error);
            }
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            recurringExpenses.forEach(expense => {
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìË®òÈåÑ‰∫ÜÈÄôÂÄãÊúàÁöÑÂõ∫ÂÆöÊîØÂá∫
                const thisMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const existingRecord = records.find(record => 
                    record.member === expense.member &&
                    record.description.includes(expense.name) &&
                    record.date.startsWith(thisMonth)
                );
                
                // Â¶ÇÊûú‰ªäÂ§©ÊòØÂõ∫ÂÆöÊîØÂá∫ÁöÑÊó•Êúü‰∏îÈÇÑÊ≤íÊúâË®òÈåÑÔºåÈ°ØÁ§∫ÊèêÈÜí
                if (currentDay === expense.day && !existingRecord) {
                    const confirmAdd = confirm(`ÊèêÈÜíÔºö‰ªäÂ§©ÊòØ ${expense.name} ÁöÑÁπ≥Ë≤ªÊó•Ôºà$${expense.amount.toLocaleString()}ÔºâÔºåÊòØÂê¶Ë¶ÅÊñ∞Â¢ûÈÄôÁ≠ÜË®òÈåÑÔºü`);
                    if (confirmAdd) {
                        // Ê†πÊìöË≤ªÁî®ÂêçÁ®±Ê±∫ÂÆöÊ≠£Á¢∫ÁöÑÈ°ûÂà•
                        let mainCategory, subCategory;
                        if (expense.name === 'ÊàøÁßü') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøÁßü';
                        } else if (expense.name === 'ÊàøË≤∏') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøË≤∏';
                        } else if (expense.name === 'ÊâãÊ©üË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'ÊâãÊ©üË≤ª';
                        } else if (expense.name === 'Á∂≤Ë∑ØË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'Á∂≤Ë∑ØË≤ª';
                        }
                        
                        const record = {
                            id: Date.now().toString(),
                            member: expense.member,
                            type: 'expense',
                            amount: expense.amount,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            description: `${expense.name} - ${thisMonth}`,
                            date: today.toISOString().split('T')[0]
                        };
                        
                        records.push(record);
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        
                        alert(`${expense.name} Ë®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ`);
                    }
                }
            });
        }

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // CSV ÂåØÂÖ•ÂäüËÉΩ
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('CSV Ê™îÊ°àËß£ÊûêÈåØË™§Ôºö' + results.errors[0].message);
                        return;
                    }
                    processImportData(results.data);
                },
                error: function(error) {
                    alert('ËÆÄÂèñ CSV Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            });
        }

        // Excel ÂåØÂÖ•ÂäüËÉΩ
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ‰ΩøÁî® raw: false ‰æÜÁç≤ÂèñÊ†ºÂºèÂåñÁöÑÂÄº
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        dateNF: 'yyyy-mm-dd' // ÊåáÂÆöÊó•ÊúüÊ†ºÂºè
                    });
                    
                    console.log('Excel Ëß£ÊûêÁµêÊûú:', jsonData);
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Excel ËÆÄÂèñÈåØË™§:', error);
                    alert('ËÆÄÂèñ Excel Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ËôïÁêÜÂåØÂÖ•Êï∏Êìö
        function processImportData(data) {
            importData = [];
            const errors = [];
            const warnings = [];

            console.log('ÂéüÂßãÊï∏Êìö:', data);

            data.forEach((row, index) => {
                console.log(`ËôïÁêÜÁ¨¨ ${index + 1} Ë°å:`, row);
                const record = validateImportRecord(row, index + 1);
                if (record) {
                    importData.push(record);
                } else {
                    errors.push(`Á¨¨ ${index + 1} Ë°åÊï∏ÊìöÁÑ°Êïà`);
                }
            });

            if (errors.length > 0) {
                alert('ÁôºÁèæ‰ª•‰∏ãÈåØË™§Ôºö\n' + errors.join('\n') + '\n\nË´ãÊ™¢Êü•Êï∏ÊìöÊ†ºÂºèÊòØÂê¶Ê≠£Á¢∫„ÄÇ');
            }

            if (warnings.length > 0) {
                console.warn('Ë≠¶Âëä:', warnings);
            }

            showImportPreview();
        }

        // È©óË≠âÂåØÂÖ•Ë®òÈåÑ
        function validateImportRecord(row, rowNumber) {
            const requiredFields = ['ÊàêÂì°', 'ÈáëÈ°ç', '‰∏ªÈ°ûÂà•', 'Â≠êÈ°ûÂà•', 'ÊèèËø∞', 'Êó•Êúü'];
            const errors = [];
            
            console.log(`È©óË≠âÁ¨¨ ${rowNumber} Ë°å:`, row);
            
            // Ê™¢Êü•ÂøÖË¶ÅÊ¨Ñ‰Ωç
            for (let field of requiredFields) {
                if (!row[field] && row[field] !== 0) {
                    errors.push(`Áº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰ΩçÔºö${field}`);
                }
            }
            
            // È©óË≠â‰ªòÊ¨æÊñπÂºèÔºàÂ≠êÈ°ûÂà•Ôºâ
            const paymentMethod = row['Â≠êÈ°ûÂà•'];
            if (paymentMethod && !['‰ø°Áî®Âç°', 'ÁèæÈáë'].includes(paymentMethod)) {
                errors.push(`‰ªòÊ¨æÊñπÂºèÁÑ°ÊïàÔºö${paymentMethod} (ÊúâÊïàÂÄº: ‰ø°Áî®Âç°, ÁèæÈáë)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈåØË™§:`, errors);
                return null;
            }

            // È©óË≠âÊàêÂì°
            if (!familyMembers.includes(row['ÊàêÂì°'])) {
                errors.push(`ÊàêÂì°ÁÑ°ÊïàÔºö${row['ÊàêÂì°']} (ÊúâÊïàÂÄº: ${familyMembers.join(', ')})`);
            }

            // È©óË≠âÈáëÈ°ç
            let amountValue = row['ÈáëÈ°ç'];
            
            // Ê∏ÖÁêÜÈáëÈ°çÂ≠óÁ¨¶‰∏≤
            if (typeof amountValue === 'string') {
                // ÂÖàËôïÁêÜÊã¨ËôüÊ†ºÂºèÔºàÊúÉË®àÊ†ºÂºèÔºâ
                if (amountValue.includes('(') && amountValue.includes(')')) {
                    amountValue = '-' + amountValue.replace(/[()]/g, '');
                }
                
                // ÁßªÈô§Ë≤®Âπ£Á¨¶Ëôü„ÄÅÁ©∫Ê†ºÁ≠âÔºå‰ΩÜ‰øùÁïôË≤†ËôüÂíåÈÄóËôü
                amountValue = amountValue.toString().replace(/[¬•Ôø•\s]/g, '');
                
                // ÁßªÈô§ÂçÉÂàÜ‰ΩçÈÄóËôü
                amountValue = amountValue.replace(/,/g, '');
                
                // ÁßªÈô§ÁæéÂÖÉÁ¨¶ËôüÔºàÂú®ÈÄóËôüËôïÁêÜÂæåÔºâ
                amountValue = amountValue.replace(/\$/g, '');
            }
            
            const amount = parseFloat(amountValue);
            console.log(`Á¨¨ ${rowNumber} Ë°åÈáëÈ°çËß£Êûê:`, {
                'ÂéüÂßãÂÄº': row['ÈáëÈ°ç'],
                'Ê∏ÖÁêÜÂæå': amountValue,
                'Ëß£ÊûêÂæå': amount,
                'È°ûÂûã': typeof row['ÈáëÈ°ç']
            });
            
            if (isNaN(amount) || amount === 0) {
                errors.push(`ÈáëÈ°çÁÑ°ÊïàÔºö${row['ÈáëÈ°ç']} (Ê∏ÖÁêÜÂæå: ${amountValue}, Ëß£ÊûêÂæå: ${amount})`);
            }

            // Ê†πÊìöÈáëÈ°çÊ≠£Ë≤†Êï∏Âà§Êñ∑È°ûÂûã
            const type = amount > 0 ? 'income' : 'expense';
            const absAmount = Math.abs(amount); // ÂÖßÈÉ®Â≠òÂÑ≤‰ΩøÁî®ÁµïÂ∞çÂÄº

            // È©óË≠âÊó•Êúü
            let dateStr = row['Êó•Êúü'];
            // ËôïÁêÜ‰∏çÂêåÁöÑÊó•ÊúüÊ†ºÂºè
            if (typeof dateStr === 'string') {
                // Â¶ÇÊûúÊòØ Excel Êó•ÊúüÊï∏Â≠óÔºåËΩâÊèõÁÇ∫Êó•Êúü
                if (!isNaN(dateStr) && dateStr > 25569) { // Excel Êó•ÊúüËµ∑ÂßãÂÄº
                    const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                    dateStr = formatDateToYYYYMMDD(excelDate);
                } else {
                    // ËôïÁêÜÊñúÁ∑öÂàÜÈöîÁöÑÊó•ÊúüÊ†ºÂºè (2025/09/01 -> 2025-09-01)
                    dateStr = dateStr.replace(/\//g, '-');
                }
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                errors.push(`Êó•ÊúüÁÑ°ÊïàÔºö${row['Êó•Êúü']} (Ê†ºÂºè: YYYY-MM-DD)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈ©óË≠âÂ§±Êïó:`, errors);
                return null;
            }

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                member: row['ÊàêÂì°'],
                type: type,
                amount: absAmount,
                mainCategory: row['‰∏ªÈ°ûÂà•'],
                subCategory: row['Â≠êÈ°ûÂà•'],
                description: row['ÊèèËø∞'] || '',
                date: dateStr
            };
        }

        // È°ØÁ§∫ÂåØÂÖ•È†êË¶Ω
        function showImportPreview() {
            const previewDiv = document.getElementById('importPreview');
            const tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            importData.forEach((record, index) => {
                const row = document.createElement('tr');
                const isValid = validateRecord(record);
                
                let amountDisplay;
                if (record.type === 'income' || record.type === 'refund') {
                    amountDisplay = `+$${record.amount.toLocaleString()}`;
                } else {
                    amountDisplay = `-$${record.amount.toLocaleString()}`;
                }
                
                let color;
                if (record.type === 'income') {
                    color = '#51cf66';
                } else if (record.type === 'refund') {
                    color = '#28a745';
                } else if (record.type === 'creditPayment') {
                    color = '#ff6b35';
                } else {
                    color = '#ff6b6b';
                }
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${color}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                    <td class="${isValid ? 'status-valid' : 'status-invalid'}">
                        ${isValid ? '‚úì ÊúâÊïà' : '‚úó ÁÑ°Êïà'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // È©óË≠âË®òÈåÑ
        function validateRecord(record) {
            return familyMembers.includes(record.member) &&
                   ['income', 'expense'].includes(record.type) &&
                   record.amount > 0 &&
                   record.mainCategory &&
                   record.date;
        }

        // Á¢∫Ë™çÂåØÂÖ•
        function confirmImport() {
            const validRecords = importData.filter(record => validateRecord(record));
            
            if (validRecords.length === 0) {
                alert('Ê≤íÊúâÊúâÊïàÁöÑË®òÈåÑÂèØ‰ª•ÂåØÂÖ•ÔºÅ');
                return;
            }

            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicateCheck = checkForDuplicates(validRecords);
            const newRecords = duplicateCheck.newRecords;
            const duplicates = duplicateCheck.duplicates;

            if (duplicates.length > 0) {
                const duplicateInfo = duplicates.map(dup => 
                    `${dup.member} - ${dup.mainCategory} - $${dup.amount} - ${dup.date}`
                ).join('\n');
                
                if (newRecords.length === 0) {
                    alert(`ÊâÄÊúâË®òÈåÑÈÉΩÊòØÈáçË§áÁöÑÔºÅ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nË´ãÊ™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂåØÂÖ•ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ`);
                    return;
                } else {
                    const proceed = confirm(`ÁôºÁèæ ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑÔºåÂ∞áË∑≥ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nÁ¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜÊñ∞Ë®òÈåÑÂóéÔºü`);
                    if (!proceed) {
                        return;
                    }
                }
            }

            if (confirm(`Á¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÂóéÔºü`)) {
                records = records.concat(newRecords);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                
                // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
                checkAndSwitchTo2025();
                
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats(); // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
                
                let message = `ÊàêÂäüÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÔºÅ`;
                if (duplicates.length > 0) {
                    message += `\nË∑≥ÈÅé‰∫Ü ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑ„ÄÇ`;
                }
                alert(message);
                cancelImport();
            }
        }

        // Ê™¢Êü•ÈáçË§áË®òÈåÑ
        function checkForDuplicates(importRecords) {
            const newRecords = [];
            const duplicates = [];
            
            importRecords.forEach(importRecord => {
                // Ê™¢Êü•ÊòØÂê¶ËàáÁèæÊúâË®òÈåÑÈáçË§á
                const isDuplicate = records.some(existingRecord => {
                    return existingRecord.member === importRecord.member &&
                           existingRecord.amount === importRecord.amount &&
                           existingRecord.mainCategory === importRecord.mainCategory &&
                           existingRecord.subCategory === importRecord.subCategory &&
                           existingRecord.date === importRecord.date &&
                           existingRecord.description === importRecord.description;
                });
                
                if (isDuplicate) {
                    duplicates.push(importRecord);
                } else {
                    newRecords.push(importRecord);
                }
            });
            
            return { newRecords, duplicates };
        }

        // ÂèñÊ∂àÂåØÂÖ•
        function cancelImport() {
            importData = [];
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFile').value = '';
        }

        // ÂåØÂá∫ÁÇ∫ CSV
        function exportToCSV() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂåØÂá∫ÔºÅ');
                return;
            }

            const csvContent = convertToCSV(records);
            downloadFile(csvContent, 'family_records.csv', 'text/csv');
        }

        // ÂåØÂá∫ÁÇ∫ Excel
        function exportToExcel() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂåØÂá∫ÔºÅ');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(records.map(record => ({
                'ÊàêÂì°': record.member,
                'ÈáëÈ°ç': (record.type === 'income' || record.type === 'refund') ? record.amount : -record.amount,
                '‰∏ªÈ°ûÂà•': record.mainCategory,
                'Â≠êÈ°ûÂà•': record.subCategory,
                'ÊèèËø∞': record.description,
                'Êó•Êúü': record.date
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Êî∂ÊîØË®òÈåÑ');
            
            XLSX.writeFile(workbook, 'family_records.xlsx');
        }

        // ËΩâÊèõÁÇ∫ CSV Ê†ºÂºè
        function convertToCSV(data) {
            const headers = ['ÊàêÂì°', 'ÈáëÈ°ç', '‰∏ªÈ°ûÂà•', 'Â≠êÈ°ûÂà•', 'ÊèèËø∞', 'Êó•Êúü'];
            const csvRows = [headers.join(',')];
            
            data.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const values = [
                    record.member,
                    amount,
                    record.mainCategory,
                    record.subCategory,
                    `"${record.description}"`,
                    record.date
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // ‰∏ãËºâÊ™îÊ°à
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ÂâµÂª∫Á§∫‰æã Excel Ê™îÊ°à
        function createSampleExcel() {
            const sampleData = [
                {
                    'ÊàêÂì°': 'Kelvin',
                    'ÈáëÈ°ç': '-1,200',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊâãÊ©üË≤ª - 2025-01',
                    'Êó•Êúü': '2025-01-15'
                },
                {
                    'ÊàêÂì°': 'Phuong',
                    'ÈáëÈ°ç': '-1,598',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': 'ÁèæÈáë',
                    'ÊèèËø∞': 'Á∂≤Ë∑ØË≤ª - 2025-01',
                    'Êó•Êúü': '2025-01-15'
                },
                {
                    'ÊàêÂì°': 'ÂÆ∂Áî®',
                    'ÈáëÈ°ç': '-15,000',
                    '‰∏ªÈ°ûÂà•': 'Â±Ö‰Ωè',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊàøÁßü - 2025-01',
                    'Êó•Êúü': '2025-01-01'
                },
                {
                    'ÊàêÂì°': 'ÂÆ∂Áî®',
                    'ÈáëÈ°ç': '50,000',
                    '‰∏ªÈ°ûÂà•': 'Ëñ™Ë≥á',
                    'Â≠êÈ°ûÂà•': 'ÁèæÈáë',
                    'ÊèèËø∞': 'Kelvin Ëñ™Ë≥á',
                    'Êó•Êúü': '2025-01-05'
                },
                {
                    'ÊàêÂì°': 'Kelvin',
                    'ÈáëÈ°ç': '-1,979',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊâãÊ©üÊ¨†Ë≤ª',
                    'Êó•Êúü': '2025-01-20'
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(sampleData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Á§∫‰æãÊï∏Êìö');
            
            XLSX.writeFile(workbook, 'sample_family_records.xlsx');
            alert('Á§∫‰æã Excel Ê™îÊ°àÂ∑≤ÂâµÂª∫ÔºÅÊÇ®ÂèØ‰ª•‰∏ãËºâ‰∏¶‰øÆÊîπÂæåÈáçÊñ∞‰∏äÂÇ≥Ê∏¨Ë©¶„ÄÇ');
        }

        // ÊâãÂãï‰∏ãËºâ data.json ÂÇô‰ªΩ
        function downloadDataJson() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            const dataToSave = {
                records: records,
                settings: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString()
                }
            };
            
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`ÊàêÂäü‰∏ãËºâÂÇô‰ªΩÊ™îÊ°àÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ\nÊ™îÊ°àÂêç: family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`);
        }

        // ‰∏ãËºâ Excel Ê†ºÂºèÂÇô‰ªΩÔºàÂèØÈáçÊñ∞ÂåØÂÖ•Ôºâ
        function downloadExcelBackup() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            // Â∞áË®òÈåÑËΩâÊèõÁÇ∫ Excel Ê†ºÂºè
            const excelData = records.map(record => ({
                'ÊàêÂì°': record.member,
                'ÈáëÈ°ç': (record.type === 'income' || record.type === 'refund') ? record.amount : -record.amount,
                '‰∏ªÈ°ûÂà•': record.mainCategory,
                'Â≠êÈ°ûÂà•': record.subCategory || '',
                'ÊèèËø∞': record.description || '',
                'Êó•Êúü': record.date
            }));

            // ÂâµÂª∫ Excel Â∑•‰ΩúË°®
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑ');
            
            // ‰∏ãËºâÊ™îÊ°à
            const fileName = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`ÊàêÂäü‰∏ãËºâ Excel ÂÇô‰ªΩÊ™îÊ°àÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ\nÊ™îÊ°àÂêç: ${fileName}\n\nÊ≠§Ê™îÊ°àÂèØ‰ª•Áõ¥Êé•ÈáçÊñ∞ÂåØÂÖ•Á≥ªÁµ±„ÄÇ`);
        }

        // ‰øÆÂæ©Êî∂ÂÖ•Ë®òÈåÑ‰∏ç‰∏ÄËá¥ÂïèÈ°å
        function fixIncomeRecords() {
            let fixedCount = 0;
            
            records.forEach(record => {
                // Â¶ÇÊûú member ÊòØ 'ÂÆ∂Áî®'ÔºåÁ¢∫‰øù type ÊòØ 'income'
                if (record.member === 'ÂÆ∂Áî®' && record.type !== 'income') {
                    record.type = 'income';
                    fixedCount++;
                    console.log('‰øÆÂæ©Ë®òÈåÑ:', record);
                }
                // Ê≥®ÊÑèÔºö‰∏çÂÜçÂº∑Âà∂ÊâÄÊúâÊî∂ÂÖ•Ë®òÈåÑÈÉΩË®≠ÁÇ∫ÂÆ∂Áî®ÊàêÂì°
                // Âõ†ÁÇ∫ÂÖ∂‰ªñÊàêÂì°ÔºàKelvin„ÄÅPhuong„ÄÅRyanÔºâ‰πüÂèØËÉΩÊúâÊî∂ÂÖ•Ë®òÈåÑ
            });
            
            if (fixedCount > 0) {
                saveRecords();
                updateStats();
                updateDataStats();
                alert(`Â∑≤‰øÆÂæ© ${fixedCount} Á≠ÜÊî∂ÂÖ•Ë®òÈåÑÁöÑ‰∏ç‰∏ÄËá¥ÂïèÈ°åÔºÅ\n\nÁèæÂú®Á∏ΩÊî∂ÂÖ•ÊáâË©≤Ê≠£Á¢∫È°ØÁ§∫‰∫Ü„ÄÇ`);
            } else {
                alert('Ê≤íÊúâÁôºÁèæÈúÄË¶Å‰øÆÂæ©ÁöÑÊî∂ÂÖ•Ë®òÈåÑ„ÄÇ');
            }
        }

        // ÊâãÂãïÂêåÊ≠•Ë≥áÊñô
        async function manualDataSync() {
            try {
                console.log('ÈñãÂßãÊâãÂãïÂêåÊ≠•Ë≥áÊñô...');
                
                // ÈáçÊñ∞ËºâÂÖ• data.json
                await loadDataFromFile();
                
                // Âü∑Ë°åË≥áÊñôÂêåÊ≠•
                await syncDataBetweenSources();
                
                // Êõ¥Êñ∞È°ØÁ§∫
                updateDataStats();
                updateStats();
                updateMemberStats();
                showExpenseRecords(); // È°ØÁ§∫Áï∂ÊúàÊîØÂá∫Ë®òÈåÑ
                updateAllRecords();
                
                alert(`Ë≥áÊñôÂêåÊ≠•ÂÆåÊàêÔºÅ\nÁï∂ÂâçË®òÈåÑÊï∏Èáè: ${records.length} Á≠Ü\n\nÂ∑≤Á¢∫‰øù localStorage Âíå data.json ÁöÑË≥áÊñô‰∏ÄËá¥ÊÄß„ÄÇ`);
                
            } catch (error) {
                console.error('ÊâãÂãïÂêåÊ≠•Â§±Êïó:', error);
                alert('Ë≥áÊñôÂêåÊ≠•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ„ÄÇ');
            }
        }

        // ÂåØÂá∫ÂêåÊ≠•Ê™îÊ°àÔºàÂ∞àÁÇ∫Ë∑®ÁÄèË¶ΩÂô®ÂêåÊ≠•Ë®≠Ë®àÔºâ
        function exportForSync() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂêåÊ≠•ÔºÅ');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "cross-browser-sync",
                        recordCount: records.length
                    }
                };

                // ÂâµÂª∫‰∏¶‰∏ãËºâÂêåÊ≠•Ê™îÊ°à
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `family_sync_${formatDateToYYYYMMDD(now)}.json`;
                
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`ÂêåÊ≠•Ê™îÊ°àÂ∑≤ÂåØÂá∫ÔºÅ\n\nÊ™îÊ°àÂåÖÂê´ ${records.length} Á≠ÜË®òÈåÑ\nÊ™îÊ°àÂêç: family_sync_${formatDateToYYYYMMDD(now)}.json\n\nË´ãÂ∞áÊ≠§Ê™îÊ°àÂåØÂÖ•Âà∞ÂÖ∂‰ªñÁÄèË¶ΩÂô®‰∏≠„ÄÇ`);
                
            } catch (error) {
                console.error('ÂåØÂá∫ÂêåÊ≠•Ê™îÊ°àÂ§±Êïó:', error);
                alert('ÂåØÂá∫ÂêåÊ≠•Ê™îÊ°àÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ„ÄÇ');
            }
        }

        // ÂåØÂÖ•ÂêåÊ≠•Ê™îÊ°à
        function importSyncFile() {
            const fileInput = document.getElementById('syncFile');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            console.log('ÈñãÂßãÂåØÂÖ•ÂêåÊ≠•Ê™îÊ°à:', file.name, 'Â§ßÂ∞è:', file.size, 'bytes');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const syncData = JSON.parse(e.target.result);
                    
                    // È©óË≠âÊ™îÊ°àÊ†ºÂºè
                    if (!syncData.records || !Array.isArray(syncData.records)) {
                        alert('Ê™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅ\n\nÊ™îÊ°àÁº∫Â∞ë records Èô£ÂàóÔºåË´ãÁ¢∫‰øùÈÅ∏ÊìáÁöÑÊòØÂæûÊú¨Á≥ªÁµ±ÂåØÂá∫ÁöÑÂêåÊ≠•Ê™îÊ°à„ÄÇ');
                        return;
                    }
                    
                    // È©óË≠âË®òÈåÑÊ†ºÂºè
                    const invalidRecords = syncData.records.filter(record => 
                        !record.id || !record.member || !record.amount || !record.date
                    );
                    
                    if (invalidRecords.length > 0) {
                        alert(`Ê™îÊ°àÂåÖÂê´ ${invalidRecords.length} Á≠ÜÊ†ºÂºè‰∏çÊ≠£Á¢∫ÁöÑË®òÈåÑÔºÅ\n\nË´ãÁ¢∫‰øùÈÅ∏ÊìáÁöÑÊòØÊúâÊïàÁöÑÂêåÊ≠•Ê™îÊ°à„ÄÇ`);
                        return;
                    }

                    const importRecords = syncData.records;
                    const currentCount = records.length;
                    
                    console.log('ÂêåÊ≠•Ê™îÊ°àË≥áË®ä:');
                    console.log('- Ê™îÊ°àË®òÈåÑÊï∏:', importRecords.length);
                    console.log('- Áï∂ÂâçË®òÈåÑÊï∏:', currentCount);
                    console.log('- Ê™îÊ°àÂåØÂá∫ÊôÇÈñì:', syncData.metadata?.exportTime);
                    
                    // Ê™¢Êü•ÈáçË§áË®òÈåÑ
                    console.log('ÈñãÂßãÊ™¢Êü•ÈáçË§áË®òÈåÑ...');
                    const duplicateCheck = checkForDuplicates(importRecords);
                    const newRecords = duplicateCheck.newRecords;
                    const duplicates = duplicateCheck.duplicates;
                    
                    console.log('ÈáçË§áÊ™¢Êü•ÁµêÊûú:');
                    console.log('- Êñ∞Ë®òÈåÑÊï∏:', newRecords.length);
                    console.log('- ÈáçË§áË®òÈåÑÊï∏:', duplicates.length);

                    if (newRecords.length === 0) {
                        alert('Ê≤íÊúâÊñ∞ÁöÑË®òÈåÑÈúÄË¶ÅÂåØÂÖ•ÔºåÊâÄÊúâË®òÈåÑÈÉΩÂ∑≤Â≠òÂú®„ÄÇ');
                        fileInput.value = '';
                        return;
                    }

                    // Âêà‰ΩµË®òÈåÑ
                    console.log('ÈñãÂßãÂêà‰ΩµË®òÈåÑ...');
                    records = records.concat(newRecords);
                    console.log('Ë®òÈåÑÂêà‰ΩµÂÆåÊàêÔºåÁ∏ΩË®òÈåÑÊï∏:', records.length);
                    
                    console.log('‰øùÂ≠òË®òÈåÑÂà∞ localStorage...');
                    saveRecords();
                    console.log('Ë®òÈåÑ‰øùÂ≠òÂÆåÊàê');
                    
                    // Êõ¥Êñ∞È°ØÁ§∫
                    console.log('Êõ¥Êñ∞È°ØÁ§∫...');
                    updateDataStats();
                    updateStats();
                    updateMemberStats();
                    showExpenseRecords(); // È°ØÁ§∫Áï∂ÊúàÊîØÂá∫Ë®òÈåÑ
                    updateAllRecords();
                    console.log('È°ØÁ§∫Êõ¥Êñ∞ÂÆåÊàê');
                    
                    let message = `üéâ Ë∑®ÁÄèË¶ΩÂô®ÂêåÊ≠•ÂÆåÊàêÔºÅ\n\n`;
                    message += `‚úÖ ÂåØÂÖ• ${newRecords.length} Á≠ÜÊñ∞Ë®òÈåÑ\n`;
                    message += `‚è≠Ô∏è Ë∑≥ÈÅé ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑ\n`;
                    message += `üìä Á∏ΩË®òÈåÑÊï∏: ${records.length} Á≠Ü\n\n`;
                    message += `üåê ÁèæÂú®ÊâÄÊúâÁÄèË¶ΩÂô®ÈÉΩÊúâÁõ∏ÂêåÁöÑË≥áÊñô‰∫ÜÔºÅ\n\n`;
                    
                    if (syncData.metadata && syncData.metadata.exportTime) {
                        const exportTime = new Date(syncData.metadata.exportTime);
                        message += `üìÖ Ê™îÊ°àÂåØÂá∫ÊôÇÈñì: ${exportTime.toLocaleString('zh-TW')}\n\n`;
                    }
                    
                    message += `üí° Âª∫Ë≠∞ÔºöÂÆöÊúüÂú®‰∏çÂêåÁÄèË¶ΩÂô®ÈñìÂêåÊ≠•Ë≥áÊñô‰ª•‰øùÊåÅ‰∏ÄËá¥ÊÄß„ÄÇ`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('Ëß£ÊûêÂêåÊ≠•Ê™îÊ°àÂ§±Êïó:', error);
                    let errorMessage = 'Ê™îÊ°àËß£ÊûêÂ§±ÊïóÔºÅ\n\n';
                    
                    if (error.name === 'SyntaxError') {
                        errorMessage += 'ÈåØË™§ÂéüÂõ†ÔºöÊ™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫Ôºà‰∏çÊòØÊúâÊïàÁöÑ JSON Ê†ºÂºèÔºâ\n\n';
                        errorMessage += 'Ëß£Ê±∫ÊñπÊ≥ïÔºö\n';
                        errorMessage += '1. Á¢∫‰øùÈÅ∏ÊìáÁöÑÊòØÂæûÊú¨Á≥ªÁµ±ÂåØÂá∫ÁöÑÂêåÊ≠•Ê™îÊ°à\n';
                        errorMessage += '2. Ê™¢Êü•Ê™îÊ°àÊòØÂê¶ÂÆåÊï¥‰∏ãËºâ\n';
                        errorMessage += '3. ÂòóË©¶ÈáçÊñ∞ÂåØÂá∫ÂêåÊ≠•Ê™îÊ°à';
                    } else {
                        errorMessage += `ÈåØË™§Ë©≥ÊÉÖÔºö${error.message}\n\n`;
                        errorMessage += 'Ë´ãÊ™¢Êü•ÊéßÂà∂Âè∞Áç≤ÂèñÊõ¥Â§öË≥áË®ä';
                    }
                    
                    alert(errorMessage);
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }

        // ÊâãÂãïÂæûÂÇô‰ªΩÊÅ¢Âæ©Ë≥áÊñô
        function manualRestoreFromBackup() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
            
            if (backupKeys.length === 0) {
                alert('Ê≤íÊúâÊâæÂà∞‰ªª‰ΩïÂÇô‰ªΩÊ™îÊ°àÔºÅ');
                return;
            }
            
            // ÊåâÊôÇÈñìÊéíÂ∫èÔºåÈÅ∏ÊìáÊúÄÊñ∞ÁöÑÂÇô‰ªΩ
            backupKeys.sort();
            const latestBackupKey = backupKeys[backupKeys.length - 1];
            const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
            
            if (backupData && backupData.records && backupData.records.length > 0) {
                const confirmRestore = confirm(
                    `ÊâæÂà∞ÂÇô‰ªΩÊ™îÊ°àÔºÅ\n\n` +
                    `ÂÇô‰ªΩÊôÇÈñì: ${new Date(backupData.metadata.backupTime).toLocaleString('zh-TW')}\n` +
                    `Ë®òÈåÑÊï∏Èáè: ${backupData.records.length} Á≠Ü\n\n` +
                    `Á¢∫ÂÆöË¶ÅÊÅ¢Âæ©ÈÄôÂÄãÂÇô‰ªΩÂóéÔºü\nÔºàÈÄôÊúÉË¶ÜËìãÁï∂ÂâçÁöÑË≥áÊñôÔºâ`
                );
                
                if (confirmRestore) {
                    records = backupData.records;
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    
                    // Êõ¥Êñ∞È°ØÁ§∫
                    updateDataStats();
                    displayRecords();
                    
                    alert(`Ë≥áÊñôÊÅ¢Âæ©ÊàêÂäüÔºÅ\n\nÊÅ¢Âæ©‰∫Ü ${records.length} Á≠ÜË®òÈåÑ\nÂÇô‰ªΩÊôÇÈñì: ${new Date(backupData.metadata.backupTime).toLocaleString('zh-TW')}`);
                }
            } else {
                alert('ÂÇô‰ªΩÊ™îÊ°àÊêçÂ£ûÊàñÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºÅ');
            }
        }

        // È°ØÁ§∫ÂÇô‰ªΩË≥áË®ä
        function showBackupInfo() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
            
            if (backupKeys.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâËá™ÂãïÂÇô‰ªΩÊ™îÊ°à„ÄÇ\n\nÁ≥ªÁµ±ÊúÉÂú®ÊÇ®ÈÄ≤Ë°åÊìç‰ΩúÊôÇËá™ÂãïÂâµÂª∫ÂÇô‰ªΩ„ÄÇ');
                return;
            }
            
            let backupInfo = 'üìã ÂÇô‰ªΩÊ™îÊ°àË≥áË®äÔºö\n\n';
            
            backupKeys.sort().forEach((key, index) => {
                try {
                    const backupData = JSON.parse(localStorage.getItem(key));
                    const backupTime = new Date(backupData.metadata.backupTime);
                    backupInfo += `${index + 1}. ${key}\n`;
                    backupInfo += `   ÊôÇÈñì: ${backupTime.toLocaleString('zh-TW')}\n`;
                    backupInfo += `   Ë®òÈåÑÊï∏: ${backupData.records.length} Á≠Ü\n\n`;
                } catch (error) {
                    backupInfo += `${index + 1}. ${key} (ÊêçÂ£û)\n\n`;
                }
            });
            
            backupInfo += `üí° ÊèêÁ§∫Ôºö\n`;
            backupInfo += `‚Ä¢ Á≥ªÁµ±ÊúÉËá™Âãï‰øùÁïôÊúÄËøë 5 ÂÄãÂÇô‰ªΩ\n`;
            backupInfo += `‚Ä¢ ÊØè 5 Ê¨°Êìç‰ΩúÊúÉÂâµÂª∫‰∏ÄÊ¨°ÂÇô‰ªΩ\n`;
            backupInfo += `‚Ä¢ Âª∫Ë≠∞ÂÆöÊúüÂåØÂá∫ÂÇô‰ªΩÊ™îÊ°àÂà∞Êú¨Âú∞\n`;
            
            alert(backupInfo);
        }











        // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
        function updateDataStats() {
            const totalRecords = records.length;
            const incomeRecords = records.filter(r => r.type === 'income').length;
            const expenseRecords = records.filter(r => r.type === 'expense').length;
            const dataSize = (JSON.stringify(records).length / 1024).toFixed(2);
            const operationCount = parseInt(localStorage.getItem('backupCount') || '0');
            const lastBackup = localStorage.getItem('lastBackupTime') || 'Êú™ÂÇô‰ªΩ';

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('incomeRecords').textContent = incomeRecords;
            document.getElementById('expenseRecords').textContent = expenseRecords;
            document.getElementById('dataSize').textContent = dataSize + ' KB';
            document.getElementById('operationCount').textContent = operationCount;
            document.getElementById('lastBackup').textContent = lastBackup;
        }

        // È†êË¶ΩÂà™Èô§
        function previewDelete() {
            const memberFilter = document.getElementById('deleteMemberFilter').value;
            const typeFilter = document.getElementById('deleteTypeFilter').value;
            const dateFrom = document.getElementById('deleteDateFrom').value;
            const dateTo = document.getElementById('deleteDateTo').value;

            deleteData = records.filter(record => {
                const matchesMember = !memberFilter || record.member === memberFilter;
                const matchesType = !typeFilter || record.type === typeFilter;
                const matchesDateFrom = !dateFrom || record.date >= dateFrom;
                const matchesDateTo = !dateTo || record.date <= dateTo;

                return matchesMember && matchesType && matchesDateFrom && matchesDateTo;
            });

            if (deleteData.length === 0) {
                alert('Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑÂèØ‰ª•Âà™Èô§ÔºÅ');
                return;
            }

            showDeletePreview();
        }

        // È°ØÁ§∫Âà™Èô§È†êË¶Ω
        function showDeletePreview() {
            const previewDiv = document.getElementById('deletePreview');
            const tableBody = document.getElementById('deletePreviewTableBody');
            
            tableBody.innerHTML = '';
            
            deleteData.forEach((record, index) => {
                const row = document.createElement('tr');
                let amountDisplay;
                if (record.type === 'income' || record.type === 'refund') {
                    amountDisplay = `+$${record.amount.toLocaleString()}`;
                } else {
                    amountDisplay = `-$${record.amount.toLocaleString()}`;
                }
                
                let color;
                if (record.type === 'income') {
                    color = '#51cf66';
                } else if (record.type === 'refund') {
                    color = '#28a745';
                } else if (record.type === 'creditPayment') {
                    color = '#ff6b35';
                } else {
                    color = '#ff6b6b';
                }
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${color}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // Á¢∫Ë™çÂà™Èô§
        function confirmDelete() {
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                // Âæû records ‰∏≠ÁßªÈô§Ë¶ÅÂà™Èô§ÁöÑË®òÈåÑ
                records = records.filter(record => !deleteData.includes(record));
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats();
                cancelDelete();
                
                alert(`ÊàêÂäüÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÔºÅ`);
            }
        }

        // ÂèñÊ∂àÂà™Èô§
        function cancelDelete() {
            deleteData = [];
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteMemberFilter').value = '';
            document.getElementById('deleteTypeFilter').value = '';
            document.getElementById('deleteDateFrom').value = '';
            document.getElementById('deleteDateTo').value = '';
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö
        function clearAllData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•Ê∏ÖÁ©∫ÔºÅ');
                return;
            }

            const confirmMessage = `‚ö†Ô∏è Ë≠¶ÂëäÔºöÊÇ®Âç≥Â∞áÊ∏ÖÁ©∫ÊâÄÊúâ ${records.length} Á≠ÜË®òÈåÑÔºÅ\n\nÊ≠§Êìç‰ΩúÂ∞áÔºö\n- Âà™Èô§ÊâÄÊúâÊî∂ÊîØË®òÈåÑ\n- Ê∏ÖÁ©∫Áµ±Ë®àÊï∏Êìö\n- ÁÑ°Ê≥ïÂæ©Âéü\n\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm('ÊúÄÂæåÁ¢∫Ë™çÔºöÊÇ®ÁúüÁöÑË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÂóéÔºü\n\nË´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÔºàË´ãÊâãÂãïËº∏ÂÖ• YESÔºâ');
                
                if (doubleConfirm) {
                    const userInput = prompt('Ë´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÔºö');
                    
                    if (userInput === 'YES') {
                        records = [];
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                        updateDataStats();
                        
                        alert('ÊâÄÊúâÊï∏ÊìöÂ∑≤Ê∏ÖÁ©∫ÔºÅ');
                    } else {
                        alert('Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ');
                    }
                }
            }
        }

        // ÂÇô‰ªΩÊï∏Êìö
        function backupData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            dataBackup = JSON.parse(JSON.stringify(records));
            const backupData = {
                timestamp: new Date().toISOString(),
                records: dataBackup,
                count: records.length
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`Êï∏ÊìöÂÇô‰ªΩÂÆåÊàêÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
        }

        // ÈÇÑÂéüÊï∏Êìö
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.records || !Array.isArray(backupData.records)) {
                            alert('ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÔºÅ');
                            return;
                        }

                        const confirmMessage = `ÊâæÂà∞ÂÇô‰ªΩÊï∏ÊìöÔºö\n- ÂÇô‰ªΩÊôÇÈñìÔºö${backupData.timestamp}\n- Ë®òÈåÑÊï∏ÈáèÔºö${backupData.count}\n\nÁ¢∫ÂÆöË¶ÅÈÇÑÂéüÈÄô‰∫õÊï∏ÊìöÂóéÔºü\nÔºàÁï∂ÂâçÊï∏ÊìöÂ∞áË¢´Ë¶ÜËìãÔºâ`;
                        
                        if (confirm(confirmMessage)) {
                            records = backupData.records;
                            saveRecords();
                            updateStats();
                            updateRecentRecords();
                            updateAllRecords();
                            updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                            updateDataStats();
                            
                            alert(`Êï∏ÊìöÈÇÑÂéüÂÆåÊàêÔºÅ\nÈÇÑÂéü‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
                        }
                    } catch (error) {
                        alert('ËÆÄÂèñÂÇô‰ªΩÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== ÂúñË°®Áõ∏ÈóúÂáΩÊï∏ ====================

        // ÂàùÂßãÂåñÊâÄÊúâÂúñË°®
        function initializeCharts() {
            console.log('ÂàùÂßãÂåñÂúñË°®...');
            console.log('Áï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // Ê™¢Êü• Chart.js ÊòØÂê¶ËºâÂÖ•
            if (typeof Chart === 'undefined') {
                console.error('Chart.js Êú™ËºâÂÖ•');
                showErrorMessage('ÂúñË°®Â∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                return;
            }
            
            setCurrentMonth();
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÊï∏Êìö
            if (records.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑÊï∏ÊìöÔºåÈ°ØÁ§∫ÊèêÁ§∫‰ø°ÊÅØ');
                showNoDataMessage();
                return;
            }
            
            updateCharts();
        }

        // È°ØÁ§∫ÈåØË™§‰ø°ÊÅØ
        function showErrorMessage(message) {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <h4>‚ùå ÂúñË°®ËºâÂÖ•Â§±Êïó</h4>
                            <p>${message}</p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                                ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
                            </button>
                        </div>
                    `;
                }
            });
        }

        // È°ØÁ§∫ÁÑ°Êï∏ÊìöÊèêÁ§∫
        function showNoDataMessage() {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h4>üìä Êö´ÁÑ°Êï∏Êìö</h4>
                            <p>Ë´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÊî∂ÊîØË®òÈåÑÔºåÁÑ∂ÂæåÂÜçÊü•ÁúãÂúñË°®</p>
                            <button class="btn" onclick="showTab('add')" style="margin-top: 15px;">
                                ÂâçÂæÄÊñ∞Â¢ûË®òÈåÑ
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Ë®≠ÁΩÆÁï∂ÂâçÊúà‰ªΩÁÇ∫ÈªòË™çÈÅ∏‰∏≠
        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11
            const monthSelect = document.getElementById('chartMonth');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂúñË°®
        function updateCharts() {
            const year = parseInt(document.getElementById('chartYear').value);
            const month = parseInt(document.getElementById('chartMonth').value);
            
            console.log('Êõ¥Êñ∞ÂúñË°®:', { year, month });
            
            updateTrendChart(year, month);
            updateCategoryChart(year, month);
            updateMemberChart(year, month);
        }

        // ÈáçÊñ∞Êï¥ÁêÜÂúñË°®
        function refreshCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (memberChart) memberChart.destroy();
            
            updateCharts();
        }

        // Áç≤ÂèñÊåáÂÆöÊúà‰ªΩÁöÑÊï∏Êìö
        function getDataByMonth(year, month) {
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11ÔºåÈúÄË¶Å +1
                
                return recordYear === year && recordMonth === month;
            });
            
            return filteredRecords;
        }

        // Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®
        function updateTrendChart(year, month) {
            console.log('Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ trendChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('Ë∂®Âã¢ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processDailyTrendData(data, year, month);
            console.log('ËôïÁêÜÂæåÁöÑË∂®Âã¢ÂúñË°®Êï∏Êìö:', chartData);
            
            trendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊØèÊó•Êî∂ÊîØË∂®Âã¢`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }


        // Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®
        function updateCategoryChart(year, month) {
            console.log('Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('categoryChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ categoryChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('È°ûÂà•ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processCategoryData(data);
            console.log('ËôïÁêÜÂæåÁöÑÈ°ûÂà•ÂúñË°®Êï∏Êìö:', chartData);
            
            categoryChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊîØÂá∫È°ûÂà•Áµ±Ë®à`
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®
        function updateMemberChart(year, month) {
            console.log('Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('memberChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ memberChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (memberChart) {
                memberChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('ÊàêÂì°ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processMemberData(data);
            console.log('ËôïÁêÜÂæåÁöÑÊàêÂì°ÂúñË°®Êï∏Êìö:', chartData);
            
            memberChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            backgroundColor: 'rgba(81, 207, 102, 0.8)',
                            borderColor: '#51cf66',
                            borderWidth: 1
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊàêÂì°Êî∂ÊîØÂ∞çÊØî`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ËôïÁêÜÊØèÊó•Ë∂®Âã¢Êï∏Êìö
        function processDailyTrendData(data, year, month) {
            const groupedData = {};
            
            // Áç≤ÂèñË©≤ÊúàÁöÑÂ§©Êï∏
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // ÂàùÂßãÂåñÊâÄÊúâÂ§©Êï∏
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day).padStart(2, '0');
                groupedData[dayKey] = { income: 0, expense: 0 };
            }
            
            // ËôïÁêÜÂØ¶ÈöõÊï∏Êìö
            data.forEach(record => {
                const date = new Date(record.date);
                const day = String(date.getDate()).padStart(2, '0');
                
                if (record.type === 'income') {
                    groupedData[day].income += record.amount;
                } else {
                    groupedData[day].expense += record.amount;
                }
            });
            
            const labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
            const income = labels.map(day => groupedData[day].income);
            const expense = labels.map(day => groupedData[day].expense);
            
            return { labels, income, expense };
        }


        // ËôïÁêÜÈ°ûÂà•Êï∏Êìö
        function processCategoryData(data) {
            const categoryTotals = {};
            
            data.filter(record => record.type === 'expense').forEach(record => {
                const category = record.mainCategory;
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += record.amount;
            });
            
            // ÊåâÈáëÈ°çÊéíÂ∫è
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Âè™È°ØÁ§∫Ââç10ÂÄãÈ°ûÂà•
            
            const labels = sortedCategories.map(([category]) => category);
            const values = sortedCategories.map(([, amount]) => amount);
            
            return { labels, values };
        }

        // ËôïÁêÜÊàêÂì°Êï∏Êìö
        function processMemberData(data) {
            const memberTotals = {};
            
            data.forEach(record => {
                const member = record.member;
                
                if (!memberTotals[member]) {
                    memberTotals[member] = { income: 0, expense: 0 };
                }
                
                if (record.type === 'income') {
                    memberTotals[member].income += record.amount;
                } else {
                    memberTotals[member].expense += record.amount;
                }
            });
            
            // ÊåâÁÖßÊåáÂÆöÈ†ÜÂ∫èÊéíÂàóÔºöKelvin„ÄÅPhuong„ÄÅRyan„ÄÅÂÆ∂Áî®
            const orderedMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];
            const labels = orderedMembers.filter(member => memberTotals[member]);
            const income = labels.map(member => memberTotals[member].income);
            const expense = labels.map(member => memberTotals[member].expense);
            
            return { labels, income, expense };
        }

    </script>
</body>
</html>
