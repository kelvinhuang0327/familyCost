<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ”¶æ”¯å¹³å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .member-stats {
            margin-bottom: 30px;
        }

        .record-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .member-stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .member-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .record-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-item.income {
            border-left-color: #51cf66;
        }

        .record-item.expense {
            border-left-color: #ff6b6b;
        }

        .record-info {
            flex: 1;
        }

        .record-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-amount {
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #51cf66;
        }

        .record-amount.expense {
            color: #ff6b6b;
        }


        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-records {
            font-size: 12px;
            margin-top: 5px;
        }

        .day-income {
            color: #51cf66;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(81, 207, 102, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-expense {
            color: #ff6b6b;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .import-section, .export-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .import-section h3, .export-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-card h4 {
            margin-bottom: 10px;
            color: #4facfe;
        }

        .import-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-card li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .import-card input[type="file"] {
            display: none;
        }

        .import-card button {
            margin-top: 15px;
        }

        .import-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .preview-table .status-valid {
            color: #51cf66;
        }

        .preview-table .status-invalid {
            color: #ff6b6b;
        }

        .import-actions, .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-section h3 {
            color: white;
        }

        .export-section p {
            opacity: 0.9;
        }

        .backup-options {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .backup-options h4 {
            margin-bottom: 15px;
            color: white;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .backup-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .backup-info p {
            margin-bottom: 8px;
        }

        .member-filter-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .member-filter-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .member-filter-section select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            background: white;
            cursor: pointer;
        }

        .member-filter-section select:focus {
            outline: none;
            border-color: #51cf66;
            box-shadow: 0 0 0 2px rgba(81, 207, 102, 0.2);
        }

        .member-filter-section button {
            margin-left: 10px;
            padding: 8px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .member-filter-section button:hover {
            background: #5a6268;
        }

        .sync-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
        }

        .sync-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .sync-section p {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .sync-instructions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sync-recovery {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-recovery h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-recovery p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .sync-step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .sync-step h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-step p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .sync-tips {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .sync-tips h4 {
            margin-bottom: 10px;
            color: white;
        }

        .sync-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .sync-tips li {
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .fix-info {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 8px;
            font-style: italic;
        }

        .refund-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .refund-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .refund-instructions li {
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .refund-benefit {
            background: rgba(40, 167, 69, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #28a745;
        }

        .github-tips {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .sync-method {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .sync-method h5 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 14px;
        }
        
        .sync-method p {
            margin: 0 0 12px 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }
        
        .sync-btn {
            display: inline-block;
            padding: 8px 12px;
            margin: 2px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .github-btn {
            background: rgba(36, 41, 46, 0.8);
            border: 1px solid rgba(36, 41, 46, 0.9);
        }
        
        .github-btn:hover {
            background: rgba(36, 41, 46, 1);
            transform: translateY(-1px);
        }
        
        .qr-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .qr-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        
        .cloud-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .cloud-btn:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
            transform: translateY(-1px);
        }
        
        .link-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .link-btn:hover {
            background: linear-gradient(135deg, #3dd46b 0%, #32e7c7 100%);
            transform: translateY(-1px);
        }
        
        .email-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .email-btn:hover {
            background: linear-gradient(135deg, #f85d8a 0%, #fed030 100%);
            transform: translateY(-1px);
        }

        .github-tips p {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .github-tips ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .github-tips li {
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .github-tips em {
            font-style: italic;
            color: #fff;
        }

        .delete-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border: 1px solid #fed7d7;
        }

        .delete-section h3 {
            margin-bottom: 15px;
            color: #e53e3e;
        }

        .delete-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .delete-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .delete-card h4 {
            margin-bottom: 10px;
            color: #e53e3e;
        }

        .delete-card p {
            margin-bottom: 15px;
            color: #666;
        }

        #dataStats p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        #dataStats span {
            font-weight: bold;
            color: #e53e3e;
        }

        .filter-delete {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-delete select,
        .filter-delete input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e53e3e;
        }

        .delete-preview h4 {
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .delete-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* åœ–è¡¨é é¢æ¨£å¼ */
        .chart-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-amount {
                margin: 10px 0;
            }
            
            .record-amount.income {
                color: #51cf66;
            }
            
            .record-amount.expense {
                color: #ff6b6b;
            }
            

            .import-options {
                grid-template-columns: 1fr;
            }

            .import-actions, .export-actions {
                flex-direction: column;
            }

            .sync-instructions {
                grid-template-columns: 1fr;
            }

            .backup-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° å®¶åº­æ”¶æ”¯å¹³å°</h1>
            <p>è¼•é¬†ç®¡ç†æ‚¨çš„å®¶åº­è²¡å‹™</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š ç¸½è¦½</button>
            <button class="nav-tab" onclick="showTab('list')">ğŸ“‹ åˆ—è¡¨</button>
            <button class="nav-tab" onclick="showTab('calendar')">ğŸ“… æ—¥æ›†</button>
            <button class="nav-tab" onclick="showTab('charts')">ğŸ“ˆ åœ–è¡¨</button>
            <button class="nav-tab" onclick="showTab('add')">â• æ–°å¢</button>
            <button class="nav-tab" onclick="showTab('import')">ğŸ“¥ åŒ¯å…¥</button>
        </div>

        <div class="content">
            <!-- ç¸½è¦½é é¢ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalExpense">$0</h3>
                        <p>ç¸½æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashExpense">$0</h3>
                        <p>ç¾é‡‘æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="creditExpense">$0</h3>
                        <p>ä¿¡ç”¨å¡æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashBalance">$0</h3>
                        <p>ç¾é‡‘é¤˜é¡</p>
                    </div>
                </div>
                <div class="member-stats">
                    <h3>å„æˆå“¡æ”¶æ”¯çµ±è¨ˆ</h3>
                    <div class="member-stats-grid" id="memberStats"></div>
                </div>
                <div class="records-list">
                    <h3>è¨˜éŒ„æŸ¥çœ‹</h3>
                    <div class="record-filter-tabs">
                        <button class="filter-tab active" onclick="showAllRecords()">å…¨éƒ¨è¨˜éŒ„</button>
                        <button class="filter-tab" onclick="showExpenseRecords()">ç¸½æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showCashExpenseRecords()">ç¾é‡‘æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showCreditExpenseRecords()">ä¿¡ç”¨å¡æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showIncomeRecords()">ç¸½æ”¶å…¥</button>
                    </div>
                    <div class="member-filter-section">
                        <label for="memberFilter">æŒ‰æˆå“¡ç¯©é¸ï¼š</label>
                        <select id="memberFilter" onchange="filterByMember()">
                            <option value="">æ‰€æœ‰æˆå“¡</option>
                        </select>
                        <button onclick="clearMemberFilter()">æ¸…é™¤ç¯©é¸</button>
                    </div>
                    <div id="recentRecords"></div>
                </div>
            </div>

            <!-- åˆ—è¡¨é é¢ -->
            <div id="list" class="tab-content">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="æœå°‹è¨˜éŒ„..." onkeyup="filterRecords()">
                    <select id="memberFilter" onchange="filterRecords()">
                        <option value="">æ‰€æœ‰æˆå“¡</option>
                        <option value="Kelvin">Kelvin</option>
                        <option value="Phuong">Phuong</option>
                        <option value="Ryan">Ryan</option>
                        <option value="å®¶ç”¨">å®¶ç”¨</option>
                    </select>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option value="income">æ”¶å…¥</option>
                        <option value="expense">æ”¯å‡º</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRecords()">
                </div>
                <div class="records-list">
                    <div id="allRecords"></div>
                </div>
            </div>

            <!-- æ—¥æ›†é é¢ -->
            <div id="calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â€¹ ä¸Šæœˆ</button>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">ä¸‹æœˆ â€º</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- åœ–è¡¨é é¢ -->
            <div id="charts" class="tab-content">
                <div class="chart-controls">
                    <div class="chart-filter-bar">
                        <select id="chartYear" onchange="updateCharts()">
                            <option value="2024">2024å¹´</option>
                            <option value="2025" selected>2025å¹´</option>
                        </select>
                        <select id="chartMonth" onchange="updateCharts()">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                        <button class="btn" onclick="refreshCharts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                </div>

                <!-- æ”¶æ”¯è¶¨å‹¢åœ–è¡¨ -->
                <div class="chart-section">
                    <h3>ğŸ“ˆ æ”¶æ”¯è¶¨å‹¢</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- é¡åˆ¥çµ±è¨ˆåœ–è¡¨ -->
                <div class="chart-section">
                    <h3>ğŸ¥§ é¡åˆ¥çµ±è¨ˆ</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- æˆå“¡æ”¶æ”¯å°æ¯” -->
                <div class="chart-section">
                    <h3>ğŸ‘¥ æˆå“¡æ”¶æ”¯å°æ¯”</h3>
                    <div class="chart-container">
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢é é¢ -->
            <div id="add" class="tab-content">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="member">æˆå“¡</label>
                            <select id="member" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="å®¶ç”¨">å®¶ç”¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="type">é¡å‹</label>
                            <select id="type" required onchange="handleTypeChange()">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">é‡‘é¡</label>
                            <input type="number" id="amount" step="0.01" min="0" required placeholder="è«‹è¼¸å…¥é‡‘é¡">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mainCategory">ä¸»é¡åˆ¥</label>
                            <select id="mainCategory" required onchange="handleMainCategoryChange()">
                                <option value="">è«‹é¸æ“‡</option>
                            </select>
                            <input type="text" id="customMainCategory" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="subCategory">ä»˜æ¬¾æ–¹å¼</label>
                            <select id="subCategory" required>
                                <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <textarea id="description" rows="3" placeholder="è«‹è¼¸å…¥è©³ç´°æè¿°..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <button type="submit" class="btn">æ–°å¢è¨˜éŒ„</button>
                </form>
            </div>

            <!-- åŒ¯å…¥é é¢ -->
            <div id="import" class="tab-content">
                <div class="import-section">
                    <h3>ğŸ“¥ åŒ¯å…¥æ”¶æ”¯è¨˜éŒ„</h3>
                    <p>æ”¯æ´ CSV å’Œ Excel æª”æ¡ˆæ ¼å¼</p>
                    
                    <div class="import-options">
                        <div class="import-card">
                            <h4>ğŸ“„ CSV æª”æ¡ˆåŒ¯å…¥</h4>
                            <p>è«‹ç¢ºä¿ CSV æª”æ¡ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                            <ul>
                                <li>æˆå“¡ (Kelvin, Phuong, Ryan, å®¶ç”¨)</li>
                                <li>é‡‘é¡ (æ­£æ•¸=æ”¶å…¥, è² æ•¸=æ”¯å‡º)</li>
                                <li>ä¸»é¡åˆ¥</li>
                                <li>ä»˜æ¬¾æ–¹å¼ (ä¿¡ç”¨å¡/ç¾é‡‘)</li>
                                <li>æè¿°</li>
                                <li>æ—¥æœŸ (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVImport(event)">
                            <button class="btn" onclick="document.getElementById('csvFile').click()">é¸æ“‡ CSV æª”æ¡ˆ</button>
                        </div>
                        
                        <div class="import-card">
                            <h4>ğŸ“Š Excel æª”æ¡ˆåŒ¯å…¥</h4>
                            <p>è«‹ç¢ºä¿ Excel æª”æ¡ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                            <ul>
                                <li>æˆå“¡ (Kelvin, Phuong, Ryan, å®¶ç”¨)</li>
                                <li>é‡‘é¡ (æ­£æ•¸=æ”¶å…¥, è² æ•¸=æ”¯å‡º)</li>
                                <li>ä¸»é¡åˆ¥</li>
                                <li>ä»˜æ¬¾æ–¹å¼ (ä¿¡ç”¨å¡/ç¾é‡‘)</li>
                                <li>æè¿°</li>
                                <li>æ—¥æœŸ (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                            <button class="btn" onclick="document.getElementById('excelFile').click()">é¸æ“‡ Excel æª”æ¡ˆ</button>
                        </div>
                    </div>
                    
                    <div class="import-preview" id="importPreview" style="display: none;">
                        <h4>é è¦½åŒ¯å…¥æ•¸æ“š</h4>
                        <div class="preview-table">
                            <table id="previewTable">
                                <thead>
                                    <tr>
                                        <th>æˆå“¡</th>
                                        <th>é‡‘é¡</th>
                                        <th>ä¸»é¡åˆ¥</th>
                                        <th>ä»˜æ¬¾æ–¹å¼</th>
                                        <th>æè¿°</th>
                                        <th>æ—¥æœŸ</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="import-actions">
                            <button class="btn btn-success" onclick="confirmImport()">ç¢ºèªåŒ¯å…¥</button>
                            <button class="btn btn-danger" onclick="cancelImport()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>ğŸ“¤ åŒ¯å‡ºåŠŸèƒ½</h3>
                    <p>å°‡ç¾æœ‰è¨˜éŒ„åŒ¯å‡ºç‚º CSV æˆ– Excel æª”æ¡ˆ</p>
                    <div class="export-actions">
                        <button class="btn" onclick="exportToCSV()">åŒ¯å‡ºç‚º CSV</button>
                        <button class="btn" onclick="exportToExcel()">åŒ¯å‡ºç‚º Excel</button>
                        <button class="btn" onclick="createSampleExcel()">å‰µå»ºç¤ºä¾‹ Excel</button>
                        <button class="btn" onclick="downloadDataJson()">ğŸ“ ä¸‹è¼‰ data.json å‚™ä»½</button>
                        <button class="btn" onclick="downloadExcelBackup()">ğŸ“Š ä¸‹è¼‰ Excel å‚™ä»½</button>
                        <button class="btn" onclick="manualDataSync()">ğŸ”„ æ‰‹å‹•åŒæ­¥è³‡æ–™</button>
                    </div>
                    
                    <div class="backup-options">
                        <h4>ğŸ’¾ é€²éšå‚™ä»½é¸é …</h4>
                        <div class="backup-buttons">
                            <button class="btn btn-primary" onclick="saveToLocalFile()">ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°æª”æ¡ˆ</button>
                            <button class="btn btn-success" onclick="saveToGitHub()">ğŸ™ æ›´æ–° GitHub æª”æ¡ˆ</button>
                        </div>
                        <div class="backup-info">
                            <p><strong>æœ¬åœ°æª”æ¡ˆä¿å­˜ï¼š</strong>ç›´æ¥ä¿å­˜åˆ°æ‚¨çš„é›»è…¦ï¼ˆéœ€è¦ç¾ä»£ç€è¦½å™¨æ”¯æ´ï¼‰</p>
                            <p><strong>GitHub æ›´æ–°ï¼š</strong>ç›´æ¥æ›´æ–° GitHub ä¸Šçš„ data.json æª”æ¡ˆï¼ˆéœ€è¦ Personal Access Tokenï¼‰</p>
                        </div>
                    </div>
                </div>
                
                <div class="sync-section">
                    <h3>ğŸŒ è·¨ç€è¦½å™¨åŒæ­¥</h3>
                    <p><strong>âš ï¸ é‡è¦æé†’ï¼š</strong>ä¸åŒç€è¦½å™¨çš„è³‡æ–™æ˜¯ç¨ç«‹çš„ï¼Œéœ€è¦æ‰‹å‹•åŒæ­¥æ‰èƒ½ä¿æŒä¸€è‡´ï¼</p>
                    <div style="background: rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #ffc107; margin: 0 0 10px 0;">ğŸ’¡ å¿«é€ŸåŒæ­¥æ­¥é©Ÿï¼š</h4>
                        <ol style="margin: 0; padding-left: 20px; color: white;">
                            <li>åœ¨<strong>ç•¶å‰ç€è¦½å™¨</strong>ä¸­é»æ“Šã€ŒğŸ“¤ ä¸€éµåŒ¯å‡ºã€</li>
                            <li>ä¸‹è¼‰ç”Ÿæˆçš„æª”æ¡ˆ</li>
                            <li>åœ¨<strong>å…¶ä»–ç€è¦½å™¨</strong>ä¸­é»æ“Šã€ŒğŸ“¥ ä¸€éµåŒ¯å…¥ã€</li>
                            <li>é¸æ“‡å‰›æ‰ä¸‹è¼‰çš„æª”æ¡ˆ</li>
                            <li>å®Œæˆï¼è³‡æ–™å·²åŒæ­¥</li>
                        </ol>
                    </div>
                    <div class="sync-instructions">
                        <div class="sync-step">
                            <h4>ğŸ“¤ ä¸€éµåŒ¯å‡º</h4>
                            <p>ä¸‹è¼‰ç•¶å‰ç€è¦½å™¨çš„æ‰€æœ‰è³‡æ–™</p>
                            <button class="btn btn-primary" onclick="exportForSync()" style="font-size: 16px; padding: 12px 24px;">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                        </div>
                        <div class="sync-step">
                            <h4>ğŸ“¥ ä¸€éµåŒ¯å…¥</h4>
                            <p>åŒ¯å…¥å…¶ä»–ç€è¦½å™¨çš„è³‡æ–™æª”æ¡ˆ</p>
                            <input type="file" id="syncFile" accept=".json,.xlsx" style="display: none;" onchange="importSyncFile()">
                            <button class="btn btn-success" onclick="document.getElementById('syncFile').click()" style="font-size: 16px; padding: 12px 24px;">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                        </div>
                    </div>
                    <div class="sync-recovery">
                        <h4>ğŸ”„ è³‡æ–™æ¢å¾©</h4>
                        <p>å¦‚æœè³‡æ–™æ„å¤–ä¸Ÿå¤±ï¼Œå¯ä»¥å˜—è©¦å¾è‡ªå‹•å‚™ä»½æ¢å¾©</p>
                        <button class="btn btn-warning" onclick="manualRestoreFromBackup()">å¾å‚™ä»½æ¢å¾©è³‡æ–™</button>
                        <button class="btn btn-info" onclick="showBackupInfo()">æŸ¥çœ‹å‚™ä»½è³‡è¨Š</button>
                    </div>
                    
                    <div class="sync-recovery">
                        <h4>ğŸ”§ è³‡æ–™ä¿®å¾©</h4>
                        <p>å¦‚æœç¸½æ”¶å…¥é¡¯ç¤ºä¸æ­£ç¢ºï¼Œå¯ä»¥å˜—è©¦ä¿®å¾©æ”¶å…¥è¨˜éŒ„</p>
                        <button class="btn btn-danger" onclick="fixIncomeRecords()">ä¿®å¾©æ”¶å…¥è¨˜éŒ„</button>
                        <p class="fix-info">æ­¤åŠŸèƒ½æœƒçµ±ä¸€æ”¶å…¥è¨˜éŒ„çš„è­˜åˆ¥é‚è¼¯ï¼Œç¢ºä¿ç¸½æ”¶å…¥æ­£ç¢ºé¡¯ç¤º</p>
                    </div>
                    
                    <div class="sync-recovery">
                        <h4>ğŸ’° é€€è²»è¨˜éŒ„èªªæ˜</h4>
                        <div class="refund-instructions">
                            <p><strong>å¦‚ä½•è¨˜éŒ„é€€è²»ï¼ˆå¦‚ç‰™é†«é€€è²»ï¼‰ï¼š</strong></p>
                            <ol>
                                <li>é¸æ“‡æˆå“¡ï¼šRyan</li>
                                <li>è¼¸å…¥é‡‘é¡ï¼šæ­£æ•¸ï¼ˆä¾‹å¦‚ï¼š500ï¼‰</li>
                                <li>é¸æ“‡ä¸»é¡åˆ¥ï¼šğŸ’° é€€è²»</li>
                                <li>é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼šç¾é‡‘</li>
                                <li>æè¿°ï¼šç‰™é†«é€€è²»ï¼ˆæˆ–å…¶ä»–é€€è²»èªªæ˜ï¼‰</li>
                            </ol>
                            <p class="refund-benefit">
                                <strong>æ•ˆæœï¼š</strong><br>
                                âœ… ç¾é‡‘æµæœƒå¢åŠ ï¼ˆæ­£çš„ç¾é‡‘æµï¼‰<br>
                                âœ… Ryan çš„é¤˜é¡æœƒå¢åŠ <br>
                                âœ… ä¸æœƒå½±éŸ¿å®¶ç”¨çµ±è¨ˆ<br>
                                âœ… æ­£ç¢ºåæ˜ é€€è²»çš„æœƒè¨ˆæ€§è³ª
                            </p>
                        </div>
                    </div>
                    <div class="sync-tips">
                        <h4>ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                        <ul>
                            <li>å»ºè­°ä½¿ç”¨ JSON æ ¼å¼é€²è¡ŒåŒæ­¥ï¼Œç›¸å®¹æ€§æ›´å¥½</li>
                            <li>æ¯æ¬¡åŒæ­¥å‰å»ºè­°å…ˆå‚™ä»½ç¾æœ‰è³‡æ–™</li>
                            <li>åŒæ­¥æª”æ¡ˆæœƒè‡ªå‹•åˆä½µé‡è¤‡è¨˜éŒ„</li>
                        </ul>
                        
                        <h4>ğŸ” èª¿è©¦ä¿¡æ¯</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 12px;">
                            <p><strong>ç•¶å‰ç‹€æ…‹ï¼š</strong></p>
                            <p>è¨˜éŒ„æ•¸é‡: <span id="debugRecordCount">-</span> ç­†</p>
                            <p>æœ€å¾Œä¿å­˜: <span id="debugLastSave">-</span></p>
                            <p>localStorage: <span id="debugLocalStorage">-</span></p>
                            <button onclick="showDebugInfo()" style="margin-top: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">åˆ·æ–°èª¿è©¦ä¿¡æ¯</button>
                            <button onclick="checkAndFixSyncIssues()" style="padding: 5px 10px; background: rgba(0,123,255,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">æª¢æŸ¥åŒæ­¥å•é¡Œ</button>
                            <button onclick="forceSync()" style="padding: 5px 10px; background: rgba(255,193,7,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">å¼·åˆ¶åŒæ­¥</button>
                            <button onclick="fixMemberOptions()" style="padding: 5px 10px; background: rgba(40,167,69,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">ä¿®å¾©æˆå“¡é¸é …</button>
                            <button onclick="checkDataAnomalies()" style="padding: 5px 10px; background: rgba(220,53,69,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">æª¢æŸ¥æ•¸æ“šç•°å¸¸</button>
                            <button onclick="removeDuplicateRecords()" style="padding: 5px 10px; background: rgba(108,117,125,0.3); border: none; border-radius: 3px; color: white; cursor: pointer; margin-right: 10px;">æ¸…ç†é‡è¤‡è¨˜éŒ„</button>
                            <button onclick="migrateCategoryNames()" style="padding: 5px 10px; background: rgba(255,193,7,0.3); border: none; border-radius: 3px; color: white; cursor: pointer;">é·ç§»é¡åˆ¥åç¨±</button>
                        </div>
                        
                        <h4>ğŸ”„ å¤šç¨®åŒæ­¥æ–¹æ¡ˆ</h4>
                        <div class="sync-options">
                            <div class="sync-method">
                                <h5>ğŸ“± QRç¢¼åŒæ­¥ï¼ˆæ¨è–¦ï¼‰</h5>
                                <p>å¿«é€Ÿåœ¨æ‰‹æ©Ÿå’Œé›»è…¦é–“åŒæ­¥</p>
                                <button onclick="generateQRCode()" class="sync-btn qr-btn">ğŸ“± ç”ŸæˆQRç¢¼</button>
                                <button onclick="scanQRCode()" class="sync-btn qr-btn">ğŸ“· æƒæQRç¢¼</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>â˜ï¸ é›²ç«¯åŒæ­¥</h5>
                                <p>è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯å„²å­˜</p>
                                <button onclick="syncToCloud()" class="sync-btn cloud-btn">â˜ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
                                <button onclick="syncFromCloud()" class="sync-btn cloud-btn">â¬‡ï¸ å¾é›²ç«¯ä¸‹è¼‰</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>ğŸ”— é€£çµåŒæ­¥</h5>
                                <p>é€šéé€£çµåˆ†äº«è³‡æ–™</p>
                                <button onclick="generateSyncLink()" class="sync-btn link-btn">ğŸ”— ç”ŸæˆåŒæ­¥é€£çµ</button>
                                <button onclick="syncFromLink()" class="sync-btn link-btn">â¬‡ï¸ å¾é€£çµåŒæ­¥</button>
                            </div>
                            
                            <div class="sync-method">
                                <h5>ğŸ“§ éƒµä»¶åŒæ­¥</h5>
                                <p>é€šééƒµä»¶é™„ä»¶åŒæ­¥</p>
                                <button onclick="emailSyncData()" class="sync-btn email-btn">ğŸ“§ éƒµä»¶åŒæ­¥</button>
                            </div>
                        </div>
                        
                        <h4>ğŸŒ GitHub å­˜æª”æ©Ÿåˆ¶</h4>
                        <div class="github-tips">
                            <p><strong>GitHub æä¾›å¤šç¨®å­˜æª”æ©Ÿåˆ¶ï¼š</strong></p>
                            <div style="margin: 15px 0;">
                                <h5>ğŸ“ æª”æ¡ˆå­˜æª” (æ¨è–¦)</h5>
                                <p>ç›´æ¥æ›´æ–° GitHub å€‰åº«ä¸­çš„ data.json æª”æ¡ˆ</p>
                                <button onclick="saveToGitHubFile()" class="sync-btn github-btn">ğŸ“ å­˜æª”åˆ° GitHub</button>
                                <button onclick="loadFromGitHubFile()" class="sync-btn github-btn">ğŸ“¥ å¾ GitHub è¼‰å…¥</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5>ğŸ“ Issue å­˜æª”</h5>
                                <p>å°‡è³‡æ–™ä½œç‚º Issue æäº¤åˆ°å€‰åº«</p>
                                <button onclick="saveToGitHubIssue()" class="sync-btn github-btn">ğŸ“ å­˜æª”ç‚º Issue</button>
                                <button onclick="loadFromGitHubIssues()" class="sync-btn github-btn">ğŸ“‹ å¾ Issues è¼‰å…¥</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5>ğŸ·ï¸ Release å­˜æª”</h5>
                                <p>å‰µå»ºç‰ˆæœ¬ç™¼å¸ƒä¾†å­˜æª”é‡è¦è³‡æ–™</p>
                                <button onclick="createGitHubRelease()" class="sync-btn github-btn">ğŸ·ï¸ å‰µå»ºç‰ˆæœ¬å­˜æª”</button>
                            </div>
                            
                            <div style="background: rgba(255,193,7,0.2); padding: 10px; border-radius: 5px; margin-top: 15px;">
                                <p><strong>âš ï¸ æ³¨æ„ï¼š</strong>GitHub å­˜æª”éœ€è¦ Personal Access Token</p>
                                <p>è«‹åœ¨ GitHub Settings > Developer settings > Personal access tokens ä¸­å‰µå»º token</p>
                                <button onclick="clearGitHubToken()" class="sync-btn github-btn" style="margin-top: 10px;">ğŸ”„ é‡æ–°è¨­å®š Token</button>
                                <button onclick="testGitHubToken()" class="sync-btn github-btn" style="margin-top: 5px;">ğŸ§ª æ¸¬è©¦ Token</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="delete-section">
                    <h3>ğŸ—‘ï¸ ç§»é™¤è³‡æ–™åŠŸèƒ½</h3>
                    <p>ç®¡ç†æ‚¨çš„æ”¶æ”¯è¨˜éŒ„æ•¸æ“š</p>
                    
                    <div class="delete-options">
                        <div class="delete-card">
                            <h4>ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h4>
                            <div id="dataStats">
                                <p>ç¸½è¨˜éŒ„æ•¸ï¼š<span id="totalRecords">0</span></p>
                                <p>æ”¶å…¥è¨˜éŒ„ï¼š<span id="incomeRecords">0</span></p>
                                <p>æ”¯å‡ºè¨˜éŒ„ï¼š<span id="expenseRecords">0</span></p>
                                <p>æ•¸æ“šå¤§å°ï¼š<span id="dataSize">0 KB</span></p>
                                <p>æ“ä½œæ¬¡æ•¸ï¼š<span id="operationCount">0</span></p>
                                <p>æœ€å¾Œå‚™ä»½ï¼š<span id="lastBackup">æœªå‚™ä»½</span></p>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>ğŸ” ç¯©é¸åˆªé™¤</h4>
                            <p>æ ¹æ“šæ¢ä»¶åˆªé™¤è¨˜éŒ„</p>
                            <div class="filter-delete">
                            <select id="deleteMemberFilter">
                                <option value="">æ‰€æœ‰æˆå“¡</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="å®¶ç”¨">å®¶ç”¨</option>
                            </select>
                                <select id="deleteTypeFilter">
                                    <option value="">æ‰€æœ‰é¡å‹</option>
                                    <option value="income">æ”¶å…¥</option>
                                    <option value="expense">æ”¯å‡º</option>
                                </select>
                                <input type="date" id="deleteDateFrom" placeholder="é–‹å§‹æ—¥æœŸ">
                                <input type="date" id="deleteDateTo" placeholder="çµæŸæ—¥æœŸ">
                                <button class="btn btn-danger" onclick="previewDelete()">é è¦½åˆªé™¤</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>âš ï¸ å±éšªæ“ä½œ</h4>
                            <p>è«‹è¬¹æ…ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½</p>
                            <div class="danger-actions">
                                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
                                <button class="btn" onclick="backupData()">å‚™ä»½æ•¸æ“š</button>
                                <button class="btn" onclick="restoreData()">é‚„åŸæ•¸æ“š</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delete-preview" id="deletePreview" style="display: none;">
                        <h4>é è¦½å°‡è¦åˆªé™¤çš„è¨˜éŒ„</h4>
                        <div class="preview-table">
                            <table id="deletePreviewTable">
                                <thead>
                                    <tr>
                                        <th>æˆå“¡</th>
                                        <th>é‡‘é¡</th>
                                        <th>ä¸»é¡åˆ¥</th>
                                        <th>ä»˜æ¬¾æ–¹å¼</th>
                                        <th>æè¿°</th>
                                        <th>æ—¥æœŸ</th>
                                    </tr>
                                </thead>
                                <tbody id="deletePreviewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="delete-actions">
                            <button class="btn btn-danger" onclick="confirmDelete()">ç¢ºèªåˆªé™¤</button>
                            <button class="btn" onclick="cancelDelete()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨˜éŒ„çš„æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯è¨˜éŒ„</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMember">æˆå“¡</label>
                        <select id="editMember" required>
                            <option value="Kelvin">Kelvin</option>
                            <option value="Phuong">Phuong</option>
                            <option value="Ryan">Ryan</option>
                            <option value="å®¶ç”¨">å®¶ç”¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editType">é¡å‹</label>
                        <select id="editType" required>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">é‡‘é¡</label>
                        <input type="number" id="editAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="editMainCategory">ä¸»é¡åˆ¥</label>
                            <select id="editMainCategory" required>
                            </select>
                        </div>
                    <div class="form-group">
                        <label for="editSubCategory">ä»˜æ¬¾æ–¹å¼</label>
                        <select id="editSubCategory" required>
                            <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                            <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                            <option value="ç¾é‡‘">ç¾é‡‘</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">æè¿°</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editDate">æ—¥æœŸ</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ  CSV å’Œ Excel è§£æåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- æ·»åŠ  Chart.js åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script>
        // æ•¸æ“šå­˜å„²
        let records = JSON.parse(localStorage.getItem('familyRecords')) || [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // èª¿è©¦å‡½æ•¸ï¼šé¡¯ç¤ºè¨˜éŒ„è©³æƒ…
        function logRecordsDetail(title, recordsArray = records) {
            console.log(`\n=== ${title} ===`);
            console.log(`è¨˜éŒ„æ•¸é‡: ${recordsArray.length}`);
            
            if (recordsArray.length > 0) {
                console.log('è¨˜éŒ„è©³æƒ…:');
                recordsArray.forEach((record, index) => {
                    console.log(`${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} - ${record.date} (${record.type})`);
                });
                
                // çµ±è¨ˆä¿¡æ¯
                const incomeTotal = recordsArray.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
                const expenseTotal = recordsArray.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
                console.log(`\nçµ±è¨ˆæ‘˜è¦:`);
                console.log(`- æ”¶å…¥ç¸½é¡: $${incomeTotal.toLocaleString()}`);
                console.log(`- æ”¯å‡ºç¸½é¡: $${expenseTotal.toLocaleString()}`);
                console.log(`- æ·¨é¡: $${(incomeTotal - expenseTotal).toLocaleString()}`);
                
                // æŒ‰æˆå“¡çµ±è¨ˆ
                const memberStats = {};
                recordsArray.forEach(record => {
                    if (!memberStats[record.member]) {
                        memberStats[record.member] = { income: 0, expense: 0, count: 0 };
                    }
                    memberStats[record.member][record.type] += record.amount;
                    memberStats[record.member].count++;
                });
                
                console.log(`\næŒ‰æˆå“¡çµ±è¨ˆ:`);
                Object.keys(memberStats).forEach(member => {
                    const stats = memberStats[member];
                    console.log(`${member}: æ”¶å…¥ $${stats.income.toLocaleString()}, æ”¯å‡º $${stats.expense.toLocaleString()}, è¨˜éŒ„ ${stats.count} ç­†`);
                });
            } else {
                console.log('æ²’æœ‰è¨˜éŒ„');
            }
            console.log('================\n');
        }

        // å…¨å±€èª¿è©¦å‡½æ•¸ï¼Œå¯åœ¨æ§åˆ¶å°èª¿ç”¨
        window.showRecords = function() {
            logRecordsDetail('ç•¶å‰æ‰€æœ‰è¨˜éŒ„');
        };
        
        window.showMemberRecords = function(memberName) {
            if (memberName) {
                const memberRecords = records.filter(r => r.member === memberName);
                logRecordsDetail(`${memberName} çš„è¨˜éŒ„`, memberRecords);
            } else {
                console.log('è«‹æŒ‡å®šæˆå“¡åç¨±ï¼Œä¾‹å¦‚ï¼šshowMemberRecords("Kelvin")');
                console.log('å¯ç”¨æˆå“¡:', familyMembers);
            }
        };
        
        window.showRecordsByType = function(type) {
            if (type && ['income', 'expense'].includes(type)) {
                const typeRecords = records.filter(r => r.type === type);
                logRecordsDetail(`${type} é¡å‹è¨˜éŒ„`, typeRecords);
            } else {
                console.log('è«‹æŒ‡å®šé¡å‹ï¼Œä¾‹å¦‚ï¼šshowRecordsByType("income") æˆ– showRecordsByType("expense")');
            }
        };
        
        // æª¢æŸ¥æ˜¯å¦æœ‰2025å¹´çš„è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡åˆ‡æ›åˆ°2025å¹´
        function checkAndSwitchTo2025() {
            const has2025Records = records.some(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === 2025;
            });
            
            if (has2025Records) {
                currentYear = 2025;
                console.log('æª¢æ¸¬åˆ°2025å¹´è¨˜éŒ„ï¼Œåˆ‡æ›æ—¥æ›†åˆ°2025å¹´');
                updateCalendar();
            }
        }
        let importData = []; // å„²å­˜è¦åŒ¯å…¥çš„æ•¸æ“š
        let deleteData = []; // å„²å­˜è¦åˆªé™¤çš„æ•¸æ“š
        let dataBackup = null; // æ•¸æ“šå‚™ä»½
        
        // åœ–è¡¨ç›¸é—œè®Šæ•¸
        let trendChart = null;
        let categoryChart = null;
        let memberChart = null;

        // é¡åˆ¥é¸é …
        const categories = {
            income: ['æ”¶å…¥', 'ç¾é‡‘æµæ”¶å…¥'],
            expense: {
                'å¨›æ¨‚': [],
                'æ—¥å¸¸': [],
                'é¤é£²': [],
                'æ¥Šæ¢…': [],
                'äº¤é€š': [],
                'å…¶ä»–æ”¯å‡º': [],
                'é†«ç™‚': ['ç‰™é†«', 'è¨ºæ‰€', 'è—¥å“', 'å¥æª¢'],
                'ç¦®ç‰©': [],
                'å­¸è²»': [],
                'ç¾é‡‘æµæ”¯å‡º': []
            }
        };

        // å®¶åº­æˆå“¡
        const familyMembers = ['Kelvin', 'Phuong', 'Ryan', 'å®¶ç”¨'];

        // å›ºå®šæ”¯å‡ºæé†’
        const recurringExpenses = [
            { name: 'æˆ¿ç§Ÿ', amount: 15000, day: 1, member: 'å®¶ç”¨' },
            { name: 'æˆ¿è²¸', amount: 21454, day: 1, member: 'å®¶ç”¨' },
            { name: 'æ‰‹æ©Ÿè²»', amount: 1200, day: 15, member: 'Kelvin' },
            { name: 'ç¶²è·¯è²»', amount: 1598, day: 15, member: 'Phuong' }
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkCrossBrowserSync();
        });

        async function initializeApp() {
            console.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½å¯ä»¥æ¢å¾©
            await checkAndRestoreFromBackup();
            
            // å˜—è©¦å¾æª”æ¡ˆè®€å–è³‡æ–™
            await loadDataFromFile();
            
            // æª¢æŸ¥ä¸¦åŒæ­¥è³‡æ–™
            await syncDataBetweenSources();
            
            // é·ç§»èˆŠçš„æˆå“¡åç¨±
            migrateMemberNames();
            
            // é·ç§»æ”¯å‡ºé¡åˆ¥åç¨±
            migrateCategoryNames();
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰è¨˜éŒ„æ•¸é‡:', records.length);
            logRecordsDetail('åˆå§‹åŒ–å®Œæˆ - æ‰€æœ‰è¨˜éŒ„'); // ä½¿ç”¨æ–°çš„èª¿è©¦å‡½æ•¸
            
            updateCategoryOptions();
            updateMemberFilterOptions();
            ensureMemberOptions(); // ç¢ºä¿æ‰€æœ‰æˆå“¡é¸é …éƒ½æ­£ç¢ºè¨­ç½®
            updateStats();
            updateMemberStats();
            showAllRecords(); // é»˜èªé¡¯ç¤ºå…¨éƒ¨è¨˜éŒ„
            updateAllRecords();
            updateCalendar();
            setTodayDate();
            updateDataStats();
            
            // å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œä¸è‡ªå‹•æ·»åŠ ç¤ºä¾‹æ•¸æ“š
            // if (records.length === 0) {
            //     addSampleData();
            // }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ›åˆ°2025å¹´
            checkAndSwitchTo2025();
            
            console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
            
            // æ›´æ–°èª¿è©¦ä¿¡æ¯
            updateDebugInfo();
            
            // æª¢æŸ¥URLä¸­æ˜¯å¦æœ‰åŒæ­¥åƒæ•¸
            checkURLSync();
        }

        // æ›´æ–°èª¿è©¦ä¿¡æ¯
        function updateDebugInfo() {
            const debugRecordCount = document.getElementById('debugRecordCount');
            const debugLastSave = document.getElementById('debugLastSave');
            const debugLocalStorage = document.getElementById('debugLocalStorage');
            
            if (debugRecordCount) {
                debugRecordCount.textContent = records.length;
            }
            
            if (debugLastSave) {
                const lastSave = localStorage.getItem('lastSaveTime');
                const saveCount = localStorage.getItem('saveCount') || '0';
                debugLastSave.textContent = lastSave ? 
                    `${new Date(lastSave).toLocaleString('zh-TW')} (ç¬¬${saveCount}æ¬¡ä¿å­˜)` : 'æœªä¿å­˜';
            }
            
            if (debugLocalStorage) {
                const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                const localCount = localRecords.length;
                const memoryCount = records.length;
                const status = localCount === memoryCount ? 'âœ… åŒæ­¥' : 'âš ï¸ ä¸åŒæ­¥';
                debugLocalStorage.textContent = `${localCount} ç­†è¨˜éŒ„ (è¨˜æ†¶é«”: ${memoryCount}) ${status}`;
            }
        }

        // é¡¯ç¤ºè©³ç´°èª¿è©¦ä¿¡æ¯
        function showDebugInfo() {
            const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
            const lastSave = localStorage.getItem('lastSaveTime');
            const backupCount = localStorage.getItem('backupCount') || '0';
            
            let debugMessage = `ğŸ” èª¿è©¦ä¿¡æ¯\n\n`;
            debugMessage += `è¨˜æ†¶é«”è¨˜éŒ„æ•¸: ${records.length} ç­†\n`;
            debugMessage += `localStorageè¨˜éŒ„æ•¸: ${localRecords.length} ç­†\n`;
            debugMessage += `æœ€å¾Œä¿å­˜æ™‚é–“: ${lastSave ? new Date(lastSave).toLocaleString('zh-TW') : 'æœªä¿å­˜'}\n`;
            debugMessage += `å‚™ä»½è¨ˆæ•¸: ${backupCount}\n\n`;
            
            if (records.length !== localRecords.length) {
                debugMessage += `âš ï¸ è­¦å‘Šï¼šè¨˜æ†¶é«”èˆ‡localStorageè¨˜éŒ„æ•¸ä¸ä¸€è‡´ï¼\n`;
                debugMessage += `é€™å¯èƒ½æ˜¯åŒæ­¥å•é¡Œçš„åŸå› ã€‚\n\n`;
            }
            
            debugMessage += `æœ€è¿‘çš„è¨˜éŒ„ï¼š\n`;
            records.slice(-3).forEach((record, index) => {
                debugMessage += `${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} (${record.date})\n`;
            });
            
            alert(debugMessage);
            
            // æ›´æ–°èª¿è©¦ä¿¡æ¯é¡¯ç¤º
            updateDebugInfo();
        }

        // æª¢æŸ¥ä¸¦ä¿®å¾©è³‡æ–™åŒæ­¥å•é¡Œ
        function checkAndFixSyncIssues() {
            try {
                const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                const memoryCount = records.length;
                const localCount = localRecords.length;
                
                console.log('æª¢æŸ¥åŒæ­¥ç‹€æ…‹:');
                console.log('- è¨˜æ†¶é«”è¨˜éŒ„æ•¸:', memoryCount);
                console.log('- localStorageè¨˜éŒ„æ•¸:', localCount);
                
                let issues = [];
                let fixes = [];
                
                // æª¢æŸ¥è¨˜éŒ„æ•¸é‡ä¸ä¸€è‡´
                if (memoryCount !== localCount) {
                    issues.push(`è¨˜éŒ„æ•¸é‡ä¸ä¸€è‡´ (è¨˜æ†¶é«”: ${memoryCount}, localStorage: ${localCount})`);
                    if (localCount > memoryCount) {
                        records = localRecords;
                        fixes.push('å·²å¾ localStorage æ¢å¾©è¨˜éŒ„');
                    } else {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        fixes.push('å·²å°‡è¨˜æ†¶é«”è¨˜éŒ„åŒæ­¥åˆ° localStorage');
                    }
                }
                
                // æª¢æŸ¥æœ€å¾Œä¿å­˜æ™‚é–“
                const lastSave = localStorage.getItem('lastSaveTime');
                if (!lastSave) {
                    issues.push('ç¼ºå°‘æœ€å¾Œä¿å­˜æ™‚é–“è¨˜éŒ„');
                    localStorage.setItem('lastSaveTime', new Date().toISOString());
                    fixes.push('å·²è¨­ç½®æœ€å¾Œä¿å­˜æ™‚é–“');
                }
                
                // æª¢æŸ¥è¨˜éŒ„å®Œæ•´æ€§
                const invalidRecords = records.filter(record => 
                    !record.id || !record.member || !record.type || !record.amount || !record.date
                );
                if (invalidRecords.length > 0) {
                    issues.push(`ç™¼ç¾ ${invalidRecords.length} ç­†ä¸å®Œæ•´çš„è¨˜éŒ„`);
                    records = records.filter(record => 
                        record.id && record.member && record.type && record.amount && record.date
                    );
                    fixes.push(`å·²ç§»é™¤ ${invalidRecords.length} ç­†ä¸å®Œæ•´çš„è¨˜éŒ„`);
                }
                
                // é¡¯ç¤ºçµæœ
                if (issues.length === 0) {
                    alert('âœ… è³‡æ–™åŒæ­¥æª¢æŸ¥å®Œæˆï¼Œæ²’æœ‰ç™¼ç¾å•é¡Œï¼');
                } else {
                    const message = `ğŸ”§ è³‡æ–™åŒæ­¥æª¢æŸ¥å®Œæˆ\n\nç™¼ç¾å•é¡Œ:\n${issues.map(i => 'â€¢ ' + i).join('\n')}\n\nå·²ä¿®å¾©:\n${fixes.map(f => 'â€¢ ' + f).join('\n')}`;
                    alert(message);
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateStats();
                    updateMemberStats();
                    updateAllRecords();
                    updateCalendar();
                    updateDataStats();
                    updateDebugInfo();
                }
                
            } catch (error) {
                console.error('æª¢æŸ¥åŒæ­¥å•é¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('æª¢æŸ¥åŒæ­¥å•é¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
            }
        }

        // å¼·åˆ¶åŒæ­¥æ•¸æ“š
        function forceSync() {
            if (confirm('å¼·åˆ¶åŒæ­¥å°‡é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“šä¸¦ç¢ºä¿ä¸€è‡´æ€§ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                try {
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
                    
                    console.log('å¼·åˆ¶åŒæ­¥å‰ç‹€æ…‹:');
                    console.log('- è¨˜æ†¶é«”è¨˜éŒ„æ•¸:', records.length);
                    console.log('- localStorageè¨˜éŒ„æ•¸:', localRecords.length);
                    
                    // ä½¿ç”¨è¼ƒå¤šçš„æ•¸æ“šä½œç‚ºæ¬Šå¨ä¾†æº
                    if (localRecords.length >= records.length) {
                        records = localRecords;
                        console.log('ä½¿ç”¨ localStorage æ•¸æ“šä½œç‚ºæ¬Šå¨ä¾†æº');
                    } else {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('ä½¿ç”¨è¨˜æ†¶é«”æ•¸æ“šä¸¦åŒæ­¥åˆ° localStorage');
                    }
                    
                    // å¼·åˆ¶ä¿å­˜åˆ° localStorage
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    localStorage.setItem('lastSaveTime', new Date().toISOString());
                    localStorage.setItem('forceSyncTime', new Date().toISOString());
                    
                    // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
                    updateStats();
                    updateMemberStats();
                    updateAllRecords();
                    updateCalendar();
                    updateDataStats();
                    updateDebugInfo();
                    
                    // è‡ªå‹•å‚™ä»½
                    saveToDataJson();
                    
                    alert(`å¼·åˆ¶åŒæ­¥å®Œæˆï¼\n\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\nåŒæ­¥æ™‚é–“: ${new Date().toLocaleString('zh-TW')}\nå·²è‡ªå‹•å‚™ä»½åˆ° data.json`);
                    
                    console.log('å¼·åˆ¶åŒæ­¥å®Œæˆ');
                } catch (error) {
                    console.error('å¼·åˆ¶åŒæ­¥å¤±æ•—:', error);
                    alert('å¼·åˆ¶åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
                }
            }
        }

        // QRç¢¼åŒæ­¥åŠŸèƒ½
        function generateQRCode() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒæ­¥ï¼');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "qr-sync",
                        recordCount: records.length
                    }
                };

                // å£“ç¸®æ•¸æ“šä»¥æ¸›å°‘QRç¢¼å¤§å°
                const compressedData = JSON.stringify(syncData);
                
                // å‰µå»ºQRç¢¼
                const qrContainer = document.createElement('div');
                qrContainer.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; max-height: 90%; overflow: auto;">
                            <h3>ğŸ“± QRç¢¼åŒæ­¥</h3>
                            <p>ç”¨æ‰‹æ©Ÿæƒææ­¤QRç¢¼ä¾†åŒæ­¥è³‡æ–™</p>
                            <div id="qrcode" style="margin: 20px 0;"></div>
                            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                                è¨˜éŒ„æ•¸é‡: ${records.length} ç­†<br>
                                ç”Ÿæˆæ™‚é–“: ${now.toLocaleString('zh-TW')}
                            </p>
                            <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">é—œé–‰</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(qrContainer);
                
                // ä½¿ç”¨ç°¡åŒ–çš„QRç¢¼ç”Ÿæˆï¼ˆåŸºæ–¼URLï¼‰
                const qrData = encodeURIComponent(JSON.stringify({
                    type: 'family_sync',
                    data: compressedData,
                    timestamp: now.getTime()
                }));
                
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${qrData}`;
                
                const qrElement = document.getElementById('qrcode');
                qrElement.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 300px; height: auto;">`;
                
            } catch (error) {
                console.error('ç”ŸæˆQRç¢¼å¤±æ•—:', error);
                alert('ç”ŸæˆQRç¢¼å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ•¸æ“šå¤§å°æˆ–ç¶²è·¯é€£ç·šã€‚');
            }
        }

        function scanQRCode() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // ç°¡åŒ–çš„QRç¢¼æƒæï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦QRç¢¼æƒæåº«ï¼‰
                alert('QRç¢¼æƒæåŠŸèƒ½éœ€è¦é¡å¤–çš„åº«æ”¯æŒã€‚\n\nå»ºè­°ä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©ŸæƒæQRç¢¼\n2. å°‡QRç¢¼åœ–ç‰‡ä¿å­˜å¾Œä½¿ç”¨åœ¨ç·šQRç¢¼æƒæå·¥å…·\n3. ä½¿ç”¨åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½åŒæ­¥è³‡æ–™');
            };
            input.click();
        }

        // é›²ç«¯åŒæ­¥åŠŸèƒ½
        function syncToCloud() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒæ­¥ï¼');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "cloud-sync",
                        recordCount: records.length,
                        device: navigator.userAgent
                    }
                };

                // å‰µå»ºå¯è®€çš„æª”æ¡ˆå
                const fileName = `family_data_${formatDateToYYYYMMDD(now)}.json`;
                
                // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`âœ… è³‡æ–™å·²æº–å‚™å¥½ä¸Šå‚³åˆ°é›²ç«¯ï¼\n\næª”æ¡ˆåç¨±: ${fileName}\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\n\nè«‹å°‡æ­¤æª”æ¡ˆä¸Šå‚³åˆ°æ‚¨çš„é›²ç«¯å„²å­˜æœå‹™ï¼ˆGoogle Driveã€OneDriveã€Dropboxç­‰ï¼‰ï¼Œç„¶å¾Œåœ¨å…¶ä»–è¨­å‚™ä¸Šä¸‹è¼‰åŒæ­¥ã€‚`);
                
            } catch (error) {
                console.error('é›²ç«¯åŒæ­¥æº–å‚™å¤±æ•—:', error);
                alert('æº–å‚™é›²ç«¯åŒæ­¥æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function syncFromCloud() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const syncData = JSON.parse(event.target.result);
                        
                        if (!syncData.records || !Array.isArray(syncData.records)) {
                            alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼è«‹ç¢ºä¿é¸æ“‡çš„æ˜¯æœ‰æ•ˆçš„åŒæ­¥æª”æ¡ˆã€‚');
                            return;
                        }
                        
                        const importRecords = syncData.records;
                        const currentCount = records.length;
                        
                        console.log('é›²ç«¯åŒæ­¥æª”æ¡ˆè³‡è¨Š:');
                        console.log('- æª”æ¡ˆè¨˜éŒ„æ•¸:', importRecords.length);
                        console.log('- ç•¶å‰è¨˜éŒ„æ•¸:', currentCount);
                        console.log('- æª”æ¡ˆåŒ¯å‡ºæ™‚é–“:', syncData.metadata?.exportTime);
                        
                        // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
                        const duplicateCheck = checkForDuplicates(importRecords);
                        const newRecords = duplicateCheck.newRecords;
                        const duplicates = duplicateCheck.duplicates;
                        
                        if (newRecords.length === 0) {
                            alert('æ²’æœ‰æ–°çš„è¨˜éŒ„éœ€è¦åŒæ­¥ï¼Œæ‰€æœ‰è¨˜éŒ„éƒ½å·²å­˜åœ¨ã€‚');
                            return;
                        }
                        
                        // åˆä½µè¨˜éŒ„
                        records = records.concat(newRecords);
                        saveRecords();
                        
                        // æ›´æ–°é¡¯ç¤º
                        updateStats();
                        updateMemberStats();
                        updateAllRecords();
                        updateCalendar();
                        updateDataStats();
                        updateDebugInfo();
                        
                        const successMessage = `âœ… é›²ç«¯åŒæ­¥å®Œæˆï¼\n\nğŸ“Š åŒæ­¥çµæœ:\nâ€¢ æ–°å¢è¨˜éŒ„: ${newRecords.length} ç­†\nâ€¢ é‡è¤‡è¨˜éŒ„: ${duplicates.length} ç­†\nâ€¢ ç¸½è¨˜éŒ„æ•¸: ${records.length} ç­†\n\nğŸ•’ æª”æ¡ˆè³‡è¨Š:\nâ€¢ åŒ¯å‡ºæ™‚é–“: ${new Date(syncData.metadata?.exportTime).toLocaleString('zh-TW')}\nâ€¢ ä¾†æºè¨­å‚™: ${syncData.metadata?.device ? syncData.metadata.device.substring(0, 50) + '...' : 'æœªçŸ¥'}`;
                        
                        alert(successMessage);
                        
                    } catch (error) {
                        console.error('é›²ç«¯åŒæ­¥å¤±æ•—:', error);
                        if (error instanceof SyntaxError) {
                            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ æª”æ¡ˆä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼\nâ€¢ æª”æ¡ˆå·²æå£\nâ€¢ é¸æ“‡äº†éŒ¯èª¤çš„æª”æ¡ˆ\n\nè«‹ç¢ºä¿é¸æ“‡çš„æ˜¯å¾æœ¬ç³»çµ±åŒ¯å‡ºçš„åŒæ­¥æª”æ¡ˆã€‚');
                        } else {
                            alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æˆ–ç¨å¾Œå†è©¦ã€‚');
                        }
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // é€£çµåŒæ­¥åŠŸèƒ½
        function generateSyncLink() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒæ­¥ï¼');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "link-sync",
                        recordCount: records.length
                    }
                };

                // å£“ç¸®æ•¸æ“š
                const compressedData = btoa(JSON.stringify(syncData));
                
                // ç”ŸæˆåŒæ­¥é€£çµ
                const baseUrl = window.location.origin + window.location.pathname;
                const syncLink = `${baseUrl}?sync=${compressedData}`;
                
                // å‰µå»ºåˆ†äº«ç•Œé¢
                const shareContainer = document.createElement('div');
                shareContainer.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; max-height: 90%; overflow: auto;">
                            <h3>ğŸ”— åŒæ­¥é€£çµ</h3>
                            <p>è¤‡è£½æ­¤é€£çµåˆ†äº«çµ¦å…¶ä»–è¨­å‚™</p>
                            <textarea id="syncLinkText" readonly style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; word-break: break-all;">${syncLink}</textarea>
                            <div style="margin: 15px 0;">
                                <button onclick="copySyncLink()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">ğŸ“‹ è¤‡è£½é€£çµ</button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">é—œé–‰</button>
                            </div>
                            <p style="font-size: 12px; color: #666;">
                                è¨˜éŒ„æ•¸é‡: ${records.length} ç­†<br>
                                ç”Ÿæˆæ™‚é–“: ${now.toLocaleString('zh-TW')}<br>
                                é€£çµæœ‰æ•ˆæœŸ: 7å¤©
                            </p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(shareContainer);
                
                // å…¨åŸŸå‡½æ•¸ä¾›æŒ‰éˆ•èª¿ç”¨
                window.copySyncLink = function() {
                    const textArea = document.getElementById('syncLinkText');
                    textArea.select();
                    document.execCommand('copy');
                    alert('âœ… åŒæ­¥é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\n\nè«‹å°‡æ­¤é€£çµåˆ†äº«çµ¦å…¶ä»–è¨­å‚™æˆ–ç€è¦½å™¨ã€‚');
                };
                
            } catch (error) {
                console.error('ç”ŸæˆåŒæ­¥é€£çµå¤±æ•—:', error);
                alert('ç”ŸæˆåŒæ­¥é€£çµå¤±æ•—ï¼Œæ•¸æ“šå¯èƒ½éå¤§ã€‚è«‹ä½¿ç”¨å…¶ä»–åŒæ­¥æ–¹å¼ã€‚');
            }
        }

        function syncFromLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            
            if (!syncData) {
                alert('æ²’æœ‰æ‰¾åˆ°åŒæ­¥è³‡æ–™ï¼\n\nè«‹ç¢ºä¿ï¼š\nâ€¢ é€£çµåŒ…å«åŒæ­¥åƒæ•¸\nâ€¢ é€£çµæ²’æœ‰è¢«æˆªæ–·\nâ€¢ ä½¿ç”¨å®Œæ•´çš„åŒæ­¥é€£çµ');
                return;
            }
            
            try {
                // è§£å£“ç¸®æ•¸æ“š
                const decodedData = JSON.parse(atob(syncData));
                
                if (!decodedData.records || !Array.isArray(decodedData.records)) {
                    alert('åŒæ­¥è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼');
                    return;
                }
                
                const importRecords = decodedData.records;
                const currentCount = records.length;
                
                console.log('é€£çµåŒæ­¥è³‡æ–™è³‡è¨Š:');
                console.log('- æª”æ¡ˆè¨˜éŒ„æ•¸:', importRecords.length);
                console.log('- ç•¶å‰è¨˜éŒ„æ•¸:', currentCount);
                console.log('- æª”æ¡ˆåŒ¯å‡ºæ™‚é–“:', decodedData.metadata?.exportTime);
                
                // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
                const duplicateCheck = checkForDuplicates(importRecords);
                const newRecords = duplicateCheck.newRecords;
                const duplicates = duplicateCheck.duplicates;
                
                if (newRecords.length === 0) {
                    alert('æ²’æœ‰æ–°çš„è¨˜éŒ„éœ€è¦åŒæ­¥ï¼Œæ‰€æœ‰è¨˜éŒ„éƒ½å·²å­˜åœ¨ã€‚');
                    // æ¸…é™¤URLåƒæ•¸
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                // åˆä½µè¨˜éŒ„
                records = records.concat(newRecords);
                saveRecords();
                
                // æ›´æ–°é¡¯ç¤º
                updateStats();
                updateMemberStats();
                updateAllRecords();
                updateCalendar();
                updateDataStats();
                updateDebugInfo();
                
                const successMessage = `âœ… é€£çµåŒæ­¥å®Œæˆï¼\n\nğŸ“Š åŒæ­¥çµæœ:\nâ€¢ æ–°å¢è¨˜éŒ„: ${newRecords.length} ç­†\nâ€¢ é‡è¤‡è¨˜éŒ„: ${duplicates.length} ç­†\nâ€¢ ç¸½è¨˜éŒ„æ•¸: ${records.length} ç­†\n\nğŸ•’ æª”æ¡ˆè³‡è¨Š:\nâ€¢ åŒ¯å‡ºæ™‚é–“: ${new Date(decodedData.metadata?.exportTime).toLocaleString('zh-TW')}`;
                
                alert(successMessage);
                
                // æ¸…é™¤URLåƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('é€£çµåŒæ­¥å¤±æ•—:', error);
                alert('é€£çµåŒæ­¥å¤±æ•—ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ é€£çµå·²éæœŸæˆ–æå£\nâ€¢ æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º\nâ€¢ ç¶²è·¯é€£ç·šå•é¡Œ');
            }
        }

        // éƒµä»¶åŒæ­¥åŠŸèƒ½
        function emailSyncData() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒæ­¥ï¼');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "email-sync",
                        recordCount: records.length
                    }
                };

                // å‰µå»ºå¯è®€çš„æª”æ¡ˆå
                const fileName = `family_data_${formatDateToYYYYMMDD(now)}.json`;
                
                // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                
                // ç”Ÿæˆéƒµä»¶å…§å®¹
                const subject = encodeURIComponent(`å®¶åº­è¨˜å¸³åŒæ­¥æª”æ¡ˆ - ${now.toLocaleDateString('zh-TW')}`);
                const body = encodeURIComponent(`å®¶åº­è¨˜å¸³åŒæ­¥æª”æ¡ˆ

æª”æ¡ˆè³‡è¨Šï¼š
â€¢ è¨˜éŒ„æ•¸é‡ï¼š${records.length} ç­†
â€¢ åŒ¯å‡ºæ™‚é–“ï¼š${now.toLocaleString('zh-TW')}
â€¢ æª”æ¡ˆæ ¼å¼ï¼šJSON

ä½¿ç”¨èªªæ˜ï¼š
1. å°‡é™„ä»¶æª”æ¡ˆä¸‹è¼‰åˆ°å…¶ä»–è¨­å‚™
2. åœ¨å®¶åº­è¨˜å¸³ç³»çµ±ä¸­é¸æ“‡ã€Œå¾é›²ç«¯ä¸‹è¼‰ã€
3. é¸æ“‡æ­¤æª”æ¡ˆé€²è¡ŒåŒæ­¥

æ³¨æ„äº‹é …ï¼š
â€¢ è«‹å¦¥å–„ä¿ç®¡æ­¤æª”æ¡ˆ
â€¢ å»ºè­°å®šæœŸåŒæ­¥ä»¥ä¿æŒè³‡æ–™ä¸€è‡´æ€§
â€¢ å¦‚æœ‰å•é¡Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡

---
æ­¤éƒµä»¶ç”±å®¶åº­è¨˜å¸³ç³»çµ±è‡ªå‹•ç”Ÿæˆ`);
                
                const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
                
                alert(`âœ… åŒæ­¥æª”æ¡ˆå·²æº–å‚™å®Œæˆï¼\n\nğŸ“§ éƒµä»¶åŒæ­¥æ­¥é©Ÿï¼š\n1. é»æ“Šç¢ºå®šå¾Œæœƒé–‹å•Ÿéƒµä»¶ç¨‹å¼\n2. å°‡å‰›æ‰ä¸‹è¼‰çš„æª”æ¡ˆä½œç‚ºé™„ä»¶\n3. ç™¼é€çµ¦è‡ªå·±æˆ–å…¶ä»–è¨­å‚™\n4. åœ¨å…¶ä»–è¨­å‚™ä¸Šæ¥æ”¶éƒµä»¶ä¸¦ä¸‹è¼‰é™„ä»¶\n5. ä½¿ç”¨ã€Œå¾é›²ç«¯ä¸‹è¼‰ã€åŠŸèƒ½åŒæ­¥è³‡æ–™\n\næª”æ¡ˆåç¨±: ${fileName}`);
                
                // é–‹å•Ÿéƒµä»¶ç¨‹å¼
                window.open(mailtoLink);
                
            } catch (error) {
                console.error('éƒµä»¶åŒæ­¥æº–å‚™å¤±æ•—:', error);
                alert('æº–å‚™éƒµä»¶åŒæ­¥æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        // æª¢æŸ¥æ•¸æ“šç•°å¸¸
        function checkDataAnomalies() {
            console.log('ğŸ” é–‹å§‹æª¢æŸ¥æ•¸æ“šç•°å¸¸...');
            
            // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
            const duplicates = [];
            const seen = new Set();
            
            records.forEach((record, index) => {
                const key = `${record.member}-${record.amount}-${record.mainCategory}-${record.date}`;
                if (seen.has(key)) {
                    duplicates.push({ index, record, key });
                } else {
                    seen.add(key);
                }
            });
            
            if (duplicates.length > 0) {
                console.log('âš ï¸ ç™¼ç¾é‡è¤‡è¨˜éŒ„:', duplicates.length, 'ç­†');
                duplicates.forEach(dup => {
                    console.log(`é‡è¤‡è¨˜éŒ„ ${dup.index}:`, dup.record);
                });
            }
            
            // æª¢æŸ¥ç•°å¸¸é‡‘é¡
            const expenseRecords = records.filter(record => record.type === 'expense');
            const largeAmounts = expenseRecords.filter(record => record.amount > 10000);
            const negativeAmounts = expenseRecords.filter(record => record.amount < 0);
            
            console.log('ğŸ“Š é‡‘é¡çµ±è¨ˆ:');
            console.log('- ç¸½è¨˜éŒ„æ•¸:', records.length);
            console.log('- æ”¯å‡ºè¨˜éŒ„æ•¸:', expenseRecords.length);
            console.log('- ç•°å¸¸å¤§é‡‘é¡è¨˜éŒ„ (>$10,000):', largeAmounts.length);
            console.log('- è² æ•¸é‡‘é¡è¨˜éŒ„:', negativeAmounts.length);
            
            if (largeAmounts.length > 0) {
                console.log('å¤§é‡‘é¡è¨˜éŒ„è©³æƒ…:');
                largeAmounts.forEach(record => {
                    console.log(`- $${record.amount} - ${record.member} - ${record.mainCategory} - ${record.date}`);
                });
            }
            
            if (negativeAmounts.length > 0) {
                console.log('è² æ•¸é‡‘é¡è¨˜éŒ„è©³æƒ…:');
                negativeAmounts.forEach(record => {
                    console.log(`- $${record.amount} - ${record.member} - ${record.mainCategory} - ${record.date}`);
                });
            }
            
            // è¨ˆç®—ç¸½å’Œ
            const totalExpense = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            console.log('ğŸ’° ç¸½æ”¯å‡ºè¨ˆç®—:', totalExpense);
            
            return {
                duplicates: duplicates.length,
                largeAmounts: largeAmounts.length,
                negativeAmounts: negativeAmounts.length,
                totalExpense: totalExpense
            };
        }

        // é·ç§»èˆŠçš„æˆå“¡åç¨±
        function migrateMemberNames() {
            console.log('é–‹å§‹é·ç§»æˆå“¡åç¨±...');
            let migratedCount = 0;
            
            records.forEach(record => {
                if (record.member === 'å®¶ç”¨æ”¶å…¥' || record.member === 'å®¶ç”¨ç¾é‡‘æµ' || record.member === 'ç¾é‡‘æµ') {
                    record.member = 'å®¶ç”¨';
                    migratedCount++;
                    console.log('é·ç§»è¨˜éŒ„:', record);
                } else if (record.member === 'å®¶ç”¨æ”¯å‡º') {
                    record.member = 'å®¶ç”¨';
                    migratedCount++;
                    console.log('é·ç§»è¨˜éŒ„:', record);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`é·ç§»å®Œæˆ: æ›´æ–°äº† ${migratedCount} ç­†è¨˜éŒ„çš„æˆå“¡åç¨±`);
                saveRecords(); // ä¿å­˜é·ç§»å¾Œçš„æ•¸æ“š
            } else {
                console.log('æ²’æœ‰éœ€è¦é·ç§»çš„è¨˜éŒ„');
            }
        }

        // é·ç§»æ”¯å‡ºé¡åˆ¥åç¨±
        function migrateCategoryNames() {
            console.log('é–‹å§‹é·ç§»æ”¯å‡ºé¡åˆ¥åç¨±...');
            let migratedCount = 0;
            
            records.forEach(record => {
                if (record.mainCategory === 'å¥åº·') {
                    record.mainCategory = 'é†«ç™‚';
                    migratedCount++;
                    console.log(`é·ç§»æ”¯å‡ºé¡åˆ¥: å¥åº· -> é†«ç™‚ (è¨˜éŒ„ID: ${record.id})`);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`é·ç§»å®Œæˆ: æ›´æ–°äº† ${migratedCount} ç­†è¨˜éŒ„çš„æ”¯å‡ºé¡åˆ¥`);
                saveRecords(); // ä¿å­˜é·ç§»å¾Œçš„æ•¸æ“š
            } else {
                console.log('æ²’æœ‰éœ€è¦é·ç§»çš„æ”¯å‡ºé¡åˆ¥');
            }
        }

        // æ¸…ç†é‡è¤‡è¨˜éŒ„
        function removeDuplicateRecords() {
            console.log('ğŸ§¹ é–‹å§‹æ¸…ç†é‡è¤‡è¨˜éŒ„...');
            
            const originalCount = records.length;
            const seen = new Set();
            const uniqueRecords = [];
            
            records.forEach(record => {
                const key = `${record.member}-${record.amount}-${record.mainCategory}-${record.date}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueRecords.push(record);
                } else {
                    console.log('ç§»é™¤é‡è¤‡è¨˜éŒ„:', record);
                }
            });
            
            const removedCount = originalCount - uniqueRecords.length;
            
            if (removedCount > 0) {
                records = uniqueRecords;
                saveRecords();
                
                // æ›´æ–°é¡¯ç¤º
                updateStats();
                updateMemberStats();
                updateAllRecords();
                updateCalendar();
                updateDataStats();
                updateDebugInfo();
                
                alert(`âœ… é‡è¤‡è¨˜éŒ„æ¸…ç†å®Œæˆï¼\n\nç§»é™¤é‡è¤‡è¨˜éŒ„: ${removedCount} ç­†\nå‰©é¤˜è¨˜éŒ„: ${uniqueRecords.length} ç­†\n\nè«‹é‡æ–°æª¢æŸ¥çµ±è¨ˆæ•¸æ“šã€‚`);
                
                console.log(`æ¸…ç†å®Œæˆ: ç§»é™¤ ${removedCount} ç­†é‡è¤‡è¨˜éŒ„`);
            } else {
                alert('æ²’æœ‰ç™¼ç¾é‡è¤‡è¨˜éŒ„éœ€è¦æ¸…ç†ã€‚');
            }
        }

        // æ‰‹å‹•ä¿®å¾©æˆå“¡é¸é …
        function fixMemberOptions() {
            console.log('é–‹å§‹æ‰‹å‹•ä¿®å¾©æˆå“¡é¸é …...');
            
            // å¼·åˆ¶ä¿®å¾©æ‰€æœ‰æˆå“¡é¸é …
            const memberSelect = document.getElementById('member');
            if (memberSelect) {
                memberSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    memberSelect.appendChild(option);
                });
                console.log('æ–°å¢è¡¨å–®æˆå“¡é¸é …å·²å¼·åˆ¶ä¿®å¾©:', familyMembers);
            }
            
            const editMemberSelect = document.getElementById('editMember');
            if (editMemberSelect) {
                editMemberSelect.innerHTML = '';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    editMemberSelect.appendChild(option);
                });
                console.log('ç·¨è¼¯è¡¨å–®æˆå“¡é¸é …å·²å¼·åˆ¶ä¿®å¾©:', familyMembers);
            }
            
            const deleteMemberFilter = document.getElementById('deleteMemberFilter');
            if (deleteMemberFilter) {
                deleteMemberFilter.innerHTML = '<option value="">æ‰€æœ‰æˆå“¡</option>';
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    deleteMemberFilter.appendChild(option);
                });
                console.log('åˆªé™¤ç¯©é¸æˆå“¡é¸é …å·²å¼·åˆ¶ä¿®å¾©:', familyMembers);
            }
            
            alert(`âœ… æˆå“¡é¸é …å·²ä¿®å¾©ï¼\n\nä¿®å¾©çš„é¸é …ï¼š\n${familyMembers.join('\n')}\n\nè«‹æª¢æŸ¥æ–°å¢é é¢æ˜¯å¦æ­£å¸¸é¡¯ç¤ºã€‚`);
        }

        // æª¢æŸ¥URLåŒæ­¥åƒæ•¸
        function checkURLSync() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            
            if (syncData) {
                console.log('æª¢æ¸¬åˆ°URLåŒæ­¥åƒæ•¸ï¼Œæº–å‚™è‡ªå‹•åŒæ­¥...');
                
                // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
                setTimeout(() => {
                    if (confirm('æª¢æ¸¬åˆ°åŒæ­¥é€£çµï¼\n\næ˜¯å¦è¦ç«‹å³åŒæ­¥è³‡æ–™ï¼Ÿ\n\né€™å°‡æœƒåˆä½µæ–°çš„è¨˜éŒ„åˆ°ç•¶å‰è³‡æ–™ä¸­ã€‚')) {
                        syncFromLink();
                    } else {
                        // æ¸…é™¤URLåƒæ•¸
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }, 1000);
            }
        }

        // æª¢æŸ¥è·¨ç€è¦½å™¨åŒæ­¥ç‹€æ…‹
        function checkCrossBrowserSync() {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æé†’éç”¨æˆ¶
            const lastSyncReminder = localStorage.getItem('lastSyncReminder');
            const today = new Date().toDateString();
            
            // å¦‚æœä»Šå¤©é‚„æ²’æœ‰æé†’éï¼Œä¸”ç”¨æˆ¶æœ‰è¨˜éŒ„ï¼Œå‰‡é¡¯ç¤ºæé†’
            if (lastSyncReminder !== today && records.length > 0) {
                // å»¶é²é¡¯ç¤ºæé†’ï¼Œè®“é é¢å®Œå…¨è¼‰å…¥
                setTimeout(() => {
                    const shouldShowReminder = confirm(
                        'ğŸŒ è·¨ç€è¦½å™¨åŒæ­¥æé†’\n\n' +
                        'æª¢æ¸¬åˆ°æ‚¨åœ¨ä¸åŒç€è¦½å™¨ä½¿ç”¨æ­¤æ‡‰ç”¨ç¨‹å¼ã€‚\n\n' +
                        'ç‚ºäº†ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ï¼Œå»ºè­°æ‚¨ï¼š\n' +
                        '1. å®šæœŸåœ¨ä¸åŒç€è¦½å™¨é–“åŒæ­¥è³‡æ–™\n' +
                        '2. ä½¿ç”¨ã€ŒåŒ¯å‡º/åŒ¯å…¥ã€åŠŸèƒ½ä¿æŒè³‡æ–™åŒæ­¥\n\n' +
                        'æ˜¯å¦è¦æŸ¥çœ‹åŒæ­¥åŠŸèƒ½ï¼Ÿ'
                    );
                    
                    if (shouldShowReminder) {
                        // åˆ‡æ›åˆ°åŒ¯å…¥é é¢
                        showTab('import');
                    }
                    
                    // è¨˜éŒ„ä»Šå¤©å·²ç¶“æé†’é
                    localStorage.setItem('lastSyncReminder', today);
                }, 3000);
            }
        }

        // æª¢æŸ¥ä¸¦å¾å‚™ä»½æ¢å¾©è³‡æ–™
        async function checkAndRestoreFromBackup() {
            try {
                // æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰è³‡æ–™
                const currentRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                
                if (currentRecords.length === 0) {
                    console.log('ç•¶å‰æ²’æœ‰è³‡æ–™ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½å¯ä»¥æ¢å¾©...');
                    
                    // å°‹æ‰¾æœ€æ–°çš„å‚™ä»½
                    const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                    
                    if (backupKeys.length > 0) {
                        // æŒ‰æ™‚é–“æ’åºï¼Œé¸æ“‡æœ€æ–°çš„å‚™ä»½
                        backupKeys.sort();
                        const latestBackupKey = backupKeys[backupKeys.length - 1];
                        const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
                        
                        if (backupData && backupData.records && backupData.records.length > 0) {
                            records = backupData.records;
                            localStorage.setItem('familyRecords', JSON.stringify(records));
                            
                            const backupTime = new Date(backupData.metadata.backupTime);
                            console.log(`å¾å‚™ä»½æ¢å¾©äº† ${records.length} ç­†è¨˜éŒ„ï¼Œå‚™ä»½æ™‚é–“: ${backupTime.toLocaleString('zh-TW')}`);
                            
                            // é¡¯ç¤ºæ¢å¾©é€šçŸ¥
                            setTimeout(() => {
                                alert(`è³‡æ–™å·²å¾å‚™ä»½æ¢å¾©ï¼\n\næ¢å¾©äº† ${records.length} ç­†è¨˜éŒ„\nå‚™ä»½æ™‚é–“: ${backupTime.toLocaleString('zh-TW')}\n\nå»ºè­°æ‚¨ç«‹å³åŒ¯å‡ºå‚™ä»½æª”æ¡ˆä»¥é˜²è³‡æ–™å†æ¬¡ä¸Ÿå¤±ã€‚`);
                            }, 1000);
                        }
                    }
                }
            } catch (error) {
                console.warn('æª¢æŸ¥å‚™ä»½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // å¾æª”æ¡ˆè¼‰å…¥è³‡æ–™
        async function loadDataFromFile() {
            try {
                console.log('é–‹å§‹è¼‰å…¥ data.json...');
                const response = await fetch('data.json');
                if (response.ok) {
                    const data = await response.json();
                    console.log('æˆåŠŸè¼‰å…¥ data.json:', data);
                    if (data.records && Array.isArray(data.records) && data.records.length > 0) {
                        // å¦‚æœæª”æ¡ˆä¸­æœ‰è³‡æ–™ï¼Œä½¿ç”¨æª”æ¡ˆçš„è³‡æ–™ä¸¦åŒæ­¥åˆ° localStorage
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('å¾ data.json è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„ï¼Œä¸¦åŒæ­¥åˆ° localStorage');
                        logRecordsDetail('å¾ data.json è¼‰å…¥çš„è¨˜éŒ„'); // ä½¿ç”¨æ–°çš„èª¿è©¦å‡½æ•¸
                    } else {
                        // å¦‚æœæª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨ localStorage çš„è³‡æ–™
                        const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                        if (localRecords.length > 0) {
                            records = localRecords;
                            console.log('data.json æ²’æœ‰è³‡æ–™ï¼Œå¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                        } else {
                            console.log('data.json å’Œ localStorage éƒ½æ²’æœ‰è³‡æ–™');
                        }
                    }
                } else {
                    console.log('data.json è¼‰å…¥å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', response.status);
                    // å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                    if (localRecords.length > 0) {
                        records = localRecords;
                        console.log('å¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                    } else {
                        console.log('localStorage ä¹Ÿæ²’æœ‰è³‡æ–™');
                    }
                }
            } catch (error) {
                console.log('ç„¡æ³•è¼‰å…¥ data.jsonï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥:', error);
                // å¦‚æœè¼‰å…¥æª”æ¡ˆå¤±æ•—ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                if (localRecords.length > 0) {
                    records = localRecords;
                    console.log('å¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                }
            }
        }

        // åŒæ­¥è³‡æ–™ä¾†æº
        async function syncDataBetweenSources() {
            try {
                // æª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰è³‡æ–™
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                
                // å¦‚æœ localStorage æœ‰è³‡æ–™ä½† records æ˜¯ç©ºçš„ï¼Œä½¿ç”¨ localStorage çš„è³‡æ–™
                if (localRecords.length > 0 && records.length === 0) {
                    records = localRecords;
                    console.log('å¾ localStorage åŒæ­¥äº†', records.length, 'ç­†è¨˜éŒ„åˆ°è¨˜æ†¶é«”');
                    
                    // åŒæ™‚æ›´æ–° data.json
                    await updateDataJsonFile();
                }
                // å¦‚æœè¨˜æ†¶é«”æœ‰è³‡æ–™ä½† localStorage æ˜¯ç©ºçš„ï¼ŒåŒæ­¥åˆ° localStorage
                else if (records.length > 0 && localRecords.length === 0) {
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    console.log('å¾è¨˜æ†¶é«”åŒæ­¥äº†', records.length, 'ç­†è¨˜éŒ„åˆ° localStorage');
                }
                // å¦‚æœå…©é‚Šéƒ½æœ‰è³‡æ–™ï¼Œæ¯”è¼ƒä¸¦ä½¿ç”¨è¼ƒæ–°çš„
                else if (records.length > 0 && localRecords.length > 0) {
                    // æ¯”è¼ƒè¨˜éŒ„æ•¸é‡ï¼Œä½¿ç”¨è¼ƒå¤šçš„
                    if (localRecords.length > records.length) {
                        records = localRecords;
                        console.log('localStorage æœ‰æ›´å¤šè¨˜éŒ„ï¼ŒåŒæ­¥åˆ°è¨˜æ†¶é«”');
                    } else if (records.length > localRecords.length) {
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('è¨˜æ†¶é«”æœ‰æ›´å¤šè¨˜éŒ„ï¼ŒåŒæ­¥åˆ° localStorage');
                    }
                }
            } catch (error) {
                console.warn('è³‡æ–™åŒæ­¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ›´æ–° data.json æª”æ¡ˆ
        async function updateDataJsonFile() {
            try {
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: new Date().toISOString(),
                        version: "1.0",
                        description: "å®¶åº­æ”¶æ”¯è¨˜éŒ„è³‡æ–™"
                    }
                };
                
                // å‰µå»ºä¸¦ä¸‹è¼‰æ›´æ–°çš„ data.json æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // éœé»˜ä¸‹è¼‰
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('å·²æ›´æ–° data.json æª”æ¡ˆ');
            } catch (error) {
                console.warn('ç„¡æ³•æ›´æ–° data.json æª”æ¡ˆ:', error);
            }
        }

        // æ·»åŠ ç¤ºä¾‹æ•¸æ“š
        function addSampleData() {
            const today = new Date();
            const sampleRecords = [
                {
                    id: 'sample-1',
                    member: 'Kelvin',
                    type: 'expense',
                    amount: 1200,
                    mainCategory: 'æ—¥å¸¸',
                    subCategory: 'æ‰‹æ©Ÿè²»',
                    description: 'æ‰‹æ©Ÿè²»',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-2',
                    member: 'Phuong',
                    type: 'expense',
                    amount: 1598,
                    mainCategory: 'æ—¥å¸¸',
                    subCategory: 'ç¶²è·¯è²»',
                    description: 'ç¶²è·¯è²»',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-3',
                    member: 'å®¶ç”¨',
                    type: 'income',
                    amount: 50000,
                    mainCategory: 'è–ªè³‡',
                    subCategory: '',
                    description: 'Kelvin è–ªè³‡',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-4',
                    member: 'å®¶ç”¨',
                    type: 'expense',
                    amount: 15000,
                    mainCategory: 'å±…ä½',
                    subCategory: 'æˆ¿ç§Ÿ',
                    description: 'æˆ¿ç§Ÿ',
                    date: today.toISOString().split('T')[0]
                }
            ];
            
            records = records.concat(sampleRecords);
            saveRecords();
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
        }

        // çµ±ä¸€çš„æ—¥æœŸæ ¼å¼åŒ–å‡½æ•¸ï¼Œé¿å…æ™‚å€å•é¡Œ
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setTodayDate() {
            const today = formatDateToYYYYMMDD(new Date());
            document.getElementById('date').value = today;
        }

        // æ›´æ–°æˆå“¡ç¯©é¸é¸é …
        function updateMemberFilterOptions() {
            const memberFilterSelect = document.getElementById('memberFilter');
            if (!memberFilterSelect) return;
            
            // æ¸…é™¤ç¾æœ‰é¸é …ï¼ˆä¿ç•™"æ‰€æœ‰æˆå“¡"é¸é …ï¼‰
            memberFilterSelect.innerHTML = '<option value="">æ‰€æœ‰æˆå“¡</option>';
            
            // æ ¹æ“š familyMembers æ•¸çµ„å‹•æ…‹ç”Ÿæˆé¸é …
            familyMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberFilterSelect.appendChild(option);
            });
            
            console.log('æˆå“¡ç¯©é¸é¸é …å·²æ›´æ–°:', familyMembers);
        }

        // ç¢ºä¿æ‰€æœ‰æˆå“¡é¸é …éƒ½æ­£ç¢ºè¨­ç½®
        function ensureMemberOptions() {
            // æ›´æ–°æ–°å¢è¡¨å–®çš„æˆå“¡é¸é …
            const memberSelect = document.getElementById('member');
            if (memberSelect) {
                const currentOptions = Array.from(memberSelect.options).map(opt => opt.value);
                const expectedOptions = ['', ...familyMembers];
                const isComplete = expectedOptions.every(opt => currentOptions.includes(opt));
                
                if (!isComplete || memberSelect.options.length !== expectedOptions.length) {
                    memberSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        memberSelect.appendChild(option);
                    });
                    console.log('æ–°å¢è¡¨å–®æˆå“¡é¸é …å·²æ›´æ–°:', familyMembers);
                }
            }
            
            // æ›´æ–°ç·¨è¼¯è¡¨å–®çš„æˆå“¡é¸é …
            const editMemberSelect = document.getElementById('editMember');
            if (editMemberSelect) {
                const currentOptions = Array.from(editMemberSelect.options).map(opt => opt.value);
                const isComplete = familyMembers.every(member => currentOptions.includes(member));
                
                if (!isComplete || editMemberSelect.options.length !== familyMembers.length) {
                    editMemberSelect.innerHTML = '';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        editMemberSelect.appendChild(option);
                    });
                    console.log('ç·¨è¼¯è¡¨å–®æˆå“¡é¸é …å·²æ›´æ–°:', familyMembers);
                }
            }
            
            // æ›´æ–°åˆªé™¤ç¯©é¸çš„æˆå“¡é¸é …
            const deleteMemberFilter = document.getElementById('deleteMemberFilter');
            if (deleteMemberFilter) {
                const currentOptions = Array.from(deleteMemberFilter.options).map(opt => opt.value);
                const expectedOptions = ['', ...familyMembers];
                const isComplete = expectedOptions.every(opt => currentOptions.includes(opt));
                
                if (!isComplete || deleteMemberFilter.options.length !== expectedOptions.length) {
                    deleteMemberFilter.innerHTML = '<option value="">æ‰€æœ‰æˆå“¡</option>';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        deleteMemberFilter.appendChild(option);
                    });
                    console.log('åˆªé™¤ç¯©é¸æˆå“¡é¸é …å·²æ›´æ–°:', familyMembers);
                }
            }
        }

        function updateCategoryOptions() {
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');

            function updateMainCategories(amountInput, mainCategorySelect) {
                const amount = parseFloat(amountInput.value) || 0;
                // å¦‚æœé‡‘é¡ç‚º0æˆ–ç©ºï¼Œé»˜èªé¡¯ç¤ºæ”¯å‡ºé¡åˆ¥ï¼ˆå› ç‚ºå¤§éƒ¨åˆ†è¨˜éŒ„éƒ½æ˜¯æ”¯å‡ºï¼‰
                const type = (amount === 0 || isNaN(amount)) ? 'expense' : (amount >= 0 ? 'income' : 'expense');
                mainCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                
                console.log('updateMainCategories called:', { amount, type, inputValue: amountInput.value });
                
                if (type === 'income') {
                    // æ”¶å…¥é¡åˆ¥
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    
                } else if (type === 'expense') {
                    // ç²å–æ‰€æœ‰æ”¯å‡ºé¡åˆ¥ï¼ˆæ’é™¤"å…¶ä»–"ï¼‰
                    const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'å…¶ä»–æ”¯å‡º');
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    // æ·»åŠ "å…¶ä»–"é¸é …
                    const otherOption = document.createElement('option');
                    otherOption.value = 'å…¶ä»–';
                    otherOption.textContent = 'å…¶ä»–';
                    mainCategorySelect.appendChild(otherOption);
                    
                }
                
                console.log('ä¸»é¡åˆ¥é¸é …å·²æ›´æ–°ï¼Œæ•¸é‡:', mainCategorySelect.options.length);
            }

            // é¡å‹é¸æ“‡å™¨è®ŠåŒ–æ™‚æ›´æ–°ä¸»é¡åˆ¥é¸é …
            const typeSelect = document.getElementById('type');
            typeSelect.addEventListener('change', () => {
                const type = typeSelect.value;
                updateMainCategoriesByType(type, mainCategorySelect);
            });
            
            // åˆå§‹åŒ–æ™‚ä¹Ÿèª¿ç”¨ä¸€æ¬¡ï¼Œç¢ºä¿é é¢åŠ è¼‰æ™‚æœ‰æ­£ç¢ºçš„ç‹€æ…‹
            console.log('åˆå§‹åŒ–é¡åˆ¥é¸æ“‡å™¨...');
            updateMainCategoriesByType('', mainCategorySelect);

            // ç¢ºä¿æˆå“¡é¸é …ä¹Ÿæ­£ç¢ºè¨­ç½®
            ensureMemberOptions();

            // ç·¨è¼¯è¡¨å–®çš„äº‹ä»¶ç›£è½å™¨
            editTypeSelect.addEventListener('change', () => {
                updateEditMainCategories();
            });
        }

        // æ›´æ–°ç·¨è¼¯è¡¨å–®çš„ä¸»é¡åˆ¥é¸é …ï¼ˆä¸€è‡´æ€§æ¸…å–®ï¼‰
        function updateEditMainCategories() {
            const editMainCategorySelect = document.getElementById('editMainCategory');
            
            editMainCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            
            // æ”¶å…¥é¡åˆ¥
            const incomeOption = document.createElement('option');
            incomeOption.value = '--- æ”¶å…¥é¡åˆ¥ ---';
            incomeOption.textContent = '--- æ”¶å…¥é¡åˆ¥ ---';
            incomeOption.disabled = true;
            incomeOption.style.fontWeight = 'bold';
            incomeOption.style.color = '#666';
            editMainCategorySelect.appendChild(incomeOption);
            
            categories.income.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                editMainCategorySelect.appendChild(option);
            });
            
            // æ”¯å‡ºé¡åˆ¥
            const expenseOption = document.createElement('option');
            expenseOption.value = '--- æ”¯å‡ºé¡åˆ¥ ---';
            expenseOption.textContent = '--- æ”¯å‡ºé¡åˆ¥ ---';
            expenseOption.disabled = true;
            expenseOption.style.fontWeight = 'bold';
            expenseOption.style.color = '#666';
            editMainCategorySelect.appendChild(expenseOption);
            
            const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'å…¶ä»–æ”¯å‡º');
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                editMainCategorySelect.appendChild(option);
            });
            
            // æ·»åŠ "å…¶ä»–"é¸é …
            const otherOption = document.createElement('option');
            otherOption.value = 'å…¶ä»–';
            otherOption.textContent = 'å…¶ä»–';
            editMainCategorySelect.appendChild(otherOption);
            
        }

        // è™•ç†é¡å‹è®ŠåŒ–
        function handleTypeChange() {
            const typeSelect = document.getElementById('type');
            const mainCategorySelect = document.getElementById('mainCategory');
            const amountInput = document.getElementById('amount');
            
            const type = typeSelect.value;
            
            // æ ¹æ“šé¡å‹æ›´æ–°ä¸»é¡åˆ¥é¸é …
            updateMainCategoriesByType(type, mainCategorySelect);
            
            // æ ¹æ“šé¡å‹è¨­ç½®é‡‘é¡æç¤º
            if (type === 'income') {
                amountInput.placeholder = 'è«‹è¼¸å…¥æ­£æ•¸é‡‘é¡';
            } else if (type === 'expense') {
                amountInput.placeholder = 'è«‹è¼¸å…¥æ­£æ•¸é‡‘é¡';
            } else {
                amountInput.placeholder = 'è«‹è¼¸å…¥é‡‘é¡';
            }
        }

        // æ ¹æ“šé¡å‹æ›´æ–°ä¸»é¡åˆ¥é¸é …ï¼ˆä¸€è‡´æ€§æ¸…å–®ï¼‰
        function updateMainCategoriesByType(type, mainCategorySelect) {
            mainCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            
            // æ”¶å…¥é¡åˆ¥
            const incomeOption = document.createElement('option');
            incomeOption.value = '--- æ”¶å…¥é¡åˆ¥ ---';
            incomeOption.textContent = '--- æ”¶å…¥é¡åˆ¥ ---';
            incomeOption.disabled = true;
            incomeOption.style.fontWeight = 'bold';
            incomeOption.style.color = '#666';
            mainCategorySelect.appendChild(incomeOption);
            
            categories.income.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            });
            
            // æ”¯å‡ºé¡åˆ¥
            const expenseOption = document.createElement('option');
            expenseOption.value = '--- æ”¯å‡ºé¡åˆ¥ ---';
            expenseOption.textContent = '--- æ”¯å‡ºé¡åˆ¥ ---';
            expenseOption.disabled = true;
            expenseOption.style.fontWeight = 'bold';
            expenseOption.style.color = '#666';
            mainCategorySelect.appendChild(expenseOption);
            
            const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'å…¶ä»–æ”¯å‡º');
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            });
            
            // æ·»åŠ "å…¶ä»–"é¸é …
            const otherOption = document.createElement('option');
            otherOption.value = 'å…¶ä»–';
            otherOption.textContent = 'å…¶ä»–';
            mainCategorySelect.appendChild(otherOption);
            
        }

        // è™•ç†ä¸»é¡åˆ¥è®ŠåŒ–
        function handleMainCategoryChange() {
            const mainCategorySelect = document.getElementById('mainCategory');
            const customInput = document.getElementById('customMainCategory');
            
            if (mainCategorySelect.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // è™•ç†ç·¨è¼¯è¡¨å–®ä¸»é¡åˆ¥è®ŠåŒ–ï¼ˆå·²ç§»é™¤è‡ªå®šç¾©åŠŸèƒ½ï¼‰
        function handleEditMainCategoryChange() {
            // ç·¨è¼¯è¡¨å–®ä¸å†æ”¯æŒè‡ªå®šç¾©ä¸»é¡åˆ¥
        }

        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ é¸ä¸­æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'dashboard' ? 'ç¸½è¦½' : 
                                           tabName === 'list' ? 'åˆ—è¡¨' :
                                           tabName === 'calendar' ? 'æ—¥æ›†' :
                                           tabName === 'add' ? 'æ–°å¢' :
                                           tabName === 'import' ? 'åŒ¯å…¥' : '')) {
                    tab.classList.add('active');
                }
            });

            // å¦‚æœåˆ‡æ›åˆ°æ—¥æ›†é é¢ï¼Œæ›´æ–°æ—¥æ›†
            if (tabName === 'calendar') {
                setTimeout(() => {
                    updateCalendar();
                }, 100);
            }
            
            // å¦‚æœåˆ‡æ›åˆ°æ–°å¢é é¢ï¼Œç¢ºä¿æˆå“¡é¸é …å®Œæ•´
            if (tabName === 'add') {
                setTimeout(() => {
                    ensureMemberOptions();
                }, 100);
            }
            
            // å¦‚æœåˆ‡æ›åˆ°åœ–è¡¨é é¢ï¼Œåˆå§‹åŒ–åœ–è¡¨
            if (tabName === 'charts') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // å¦‚æœåˆ‡æ›åˆ°åŒ¯å…¥é é¢ï¼Œæ›´æ–°æ•¸æ“šçµ±è¨ˆ
            if (tabName === 'import') {
                updateDataStats();
            }
        }

        function updateStats() {
            const totalIncome = records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            
            // è¨ˆç®—ç¾é‡‘æ”¯å‡º
            const cashExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ç¾é‡‘')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // è¨ˆç®—ä¿¡ç”¨å¡æ”¯å‡º
            const creditExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ä¿¡ç”¨å¡')
                .reduce((sum, record) => sum + record.amount, 0);
            
            
            // è¨ˆç®—ç¾é‡‘é¤˜é¡ï¼ˆåŒ…å«æ‰€æœ‰ç¾é‡‘é¡åˆ¥ï¼‰
            const cashBalance = records
                .filter(record => record.subCategory === 'ç¾é‡‘' || record.subCategory === '')
                .reduce((sum, record) => {
                    if (record.type === 'income') {
                        return sum + record.amount; // ç¾é‡‘æ”¶å…¥ç‚ºæ­£
                    } else if (record.type === 'expense') {
                        return sum - record.amount; // ç¾é‡‘æ”¯å‡ºç‚ºè² 
                    }
                    return sum;
                }, 0);

            // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
            document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
            document.getElementById('cashExpense').textContent = `$${cashExpense.toLocaleString()}`;
            document.getElementById('creditExpense').textContent = `$${creditExpense.toLocaleString()}`;
            document.getElementById('cashBalance').textContent = `$${cashBalance.toLocaleString()}`;
            
            // èª¿è©¦è³‡è¨Š
            console.log('çµ±è¨ˆæ›´æ–°:');
            console.log('- ç¸½æ”¶å…¥ (type=income):', totalIncome);
            console.log('- ç¸½æ”¯å‡º (type=expense):', totalExpense);
            console.log('- ç¾é‡‘æ”¯å‡º:', cashExpense);
            console.log('- ä¿¡ç”¨å¡æ”¯å‡º:', creditExpense);
            console.log('- ç¾é‡‘é¤˜é¡ (ç¾é‡‘é¡åˆ¥çµ±è¨ˆ):', cashBalance);
            
            // è©³ç´°èª¿è©¦ç¾é‡‘é¤˜é¡è¨ˆç®—
            const cashRecords = records.filter(record => record.subCategory === 'ç¾é‡‘' || record.subCategory === '');
            const cashIncome = cashRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
            const cashExpenseOnly = cashRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
            
            console.log('ç¾é‡‘é¤˜é¡è©³ç´°è¨ˆç®—:');
            console.log('- ç¾é‡‘è¨˜éŒ„ç¸½æ•¸:', cashRecords.length);
            console.log('- ç¾é‡‘æ”¶å…¥:', cashIncome);
            console.log('- ç¾é‡‘æ”¯å‡º:', cashExpenseOnly);
            console.log('- è¨ˆç®—çµæœ:', cashIncome - cashExpenseOnly);
            
            // è©³ç´°èª¿è©¦æ”¯å‡ºè¨˜éŒ„
            const expenseRecords = records.filter(record => record.type === 'expense');
            console.log('æ”¯å‡ºè¨˜éŒ„è©³æƒ…:');
            expenseRecords.forEach((record, index) => {
                console.log(`${index + 1}. ${record.member} - ${record.mainCategory} - $${record.amount} (${record.subCategory}) - ${record.date}`);
            });
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç•°å¸¸å¤§çš„é‡‘é¡
            const largeAmounts = expenseRecords.filter(record => record.amount > 10000);
            if (largeAmounts.length > 0) {
                console.log('âš ï¸ ç™¼ç¾ç•°å¸¸å¤§é‡‘é¡çš„æ”¯å‡ºè¨˜éŒ„:');
                largeAmounts.forEach(record => {
                    console.log(`- ${record.member} - ${record.mainCategory} - $${record.amount} (${record.subCategory}) - ${record.date}`);
                });
            }
            
            // è©³ç´°èª¿è©¦æ”¶å…¥è¨˜éŒ„
            const incomeRecords = records.filter(record => record.type === 'income');
            const householdRecords = records.filter(record => record.member === 'å®¶ç”¨');
            
            console.log('æ”¶å…¥è¨˜éŒ„è©³æƒ…:');
            console.log('- type=income çš„è¨˜éŒ„:', incomeRecords);
            console.log('- member=å®¶ç”¨ çš„è¨˜éŒ„:', householdRecords);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„è¨˜éŒ„
            const inconsistentRecords = records.filter(record => 
                (record.type === 'income' && record.member !== 'å®¶ç”¨') ||
                (record.member === 'å®¶ç”¨' && record.type !== 'income')
            );
            
            if (inconsistentRecords.length > 0) {
                console.warn('ç™¼ç¾ä¸ä¸€è‡´çš„æ”¶å…¥è¨˜éŒ„:', inconsistentRecords);
            }

            // æ›´æ–°å„æˆå“¡çµ±è¨ˆ
            updateMemberStats();
        }

        function updateMemberStats() {
            const memberStatsContainer = document.getElementById('memberStats');
            memberStatsContainer.innerHTML = '';

            console.log('updateMemberStats: ç¸½è¨˜éŒ„æ•¸', records.length);
            console.log('updateMemberStats: è¨˜éŒ„å…§å®¹', records);

            familyMembers.forEach(member => {
                const memberRecords = records.filter(record => record.member === member);
                console.log(`${member} çš„è¨˜éŒ„:`, memberRecords);
                
                let memberIncome, memberExpense, memberBalance;
                
                // è¨ˆç®—æ‰€æœ‰æˆå“¡çš„æ”¶å…¥å’Œæ”¯å‡º
                memberIncome = memberRecords
                    .filter(record => record.type === 'income')
                    .reduce((sum, record) => sum + record.amount, 0);
                memberExpense = memberRecords
                    .filter(record => record.type === 'expense')
                    .reduce((sum, record) => sum + record.amount, 0);
                memberBalance = memberIncome - memberExpense;
                
                console.log(`${member} çµ±è¨ˆ: æ”¶å…¥=${memberIncome}, æ”¯å‡º=${memberExpense}, é¤˜é¡=${memberBalance}`);

                const memberCard = document.createElement('div');
                memberCard.className = 'stat-card';
                memberCard.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                memberCard.style.cursor = 'pointer';
                memberCard.innerHTML = `
                    <h4>${member}</h4>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <small>æ”¶å…¥: $${memberIncome.toLocaleString()}</small><br>
                            <small>æ”¯å‡º: $${memberExpense.toLocaleString()}</small>
                        </div>
                        <div style="font-weight: bold; color: ${memberBalance >= 0 ? '#51cf66' : '#ff6b6b'};">
                            $${memberBalance.toLocaleString()}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        é»æ“ŠæŸ¥çœ‹è©³ç´°è¨˜éŒ„
                    </div>
                `;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                memberCard.addEventListener('click', () => {
                    showMemberRecords(member);
                });
                
                memberStatsContainer.appendChild(memberCard);
            });
        }

        // é¡¯ç¤ºæˆå“¡è©³ç´°è¨˜éŒ„
        function showMemberRecords(member) {
            const memberRecords = records.filter(record => record.member === member);
            
            if (memberRecords.length === 0) {
                alert(`${member} ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„ã€‚`);
                return;
            }
            
            // è¨ˆç®—æˆå“¡é¤˜é¡ï¼ˆèˆ‡ updateMemberStats é‚è¼¯ä¸€è‡´ï¼‰
            const memberIncome = memberRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            const memberExpense = memberRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalAmount = memberIncome - memberExpense;
            
            // æ›´æ–°æ¨™ç±¤é ç‹€æ…‹
            updateFilterTabs('member');
            
            // é¡¯ç¤ºæˆå“¡è¨˜éŒ„
            displayRecords(memberRecords, `${member} çš„è¨˜éŒ„ (å…± ${memberRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºç¸½æ”¯å‡ºè¨˜éŒ„
        function showExpenseRecords() {
            console.log('showExpenseRecords è¢«èª¿ç”¨');
            console.log('ç•¶å‰è¨˜éŒ„ç¸½æ•¸:', records.length);
            console.log('è¨˜éŒ„å…§å®¹:', records);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            console.log('ç•¶å‰æœˆä»½:', currentMonth, 'ç•¶å‰å¹´ä»½:', currentYear);
            
            // é¡¯ç¤ºæ‰€æœ‰æ”¯å‡ºè¨˜éŒ„ï¼ˆåŒ…å«å®¶ç”¨ï¼‰
            const expenseRecords = records.filter(record => {
                const isExpense = record.type === 'expense';
                console.log(`è¨˜éŒ„ ${record.id}: æˆå“¡=${record.member}, é¡å‹=${record.type}, æ˜¯æ”¯å‡º=${isExpense}`);
                return isExpense;
            });
            
            console.log('ç¯©é¸å¾Œçš„æ”¯å‡ºè¨˜éŒ„:', expenseRecords);
            
            const totalAmount = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('expense');
            displayRecords(expenseRecords, `ç•¶æœˆç¸½æ”¯å‡ºè¨˜éŒ„ (å…± ${expenseRecords.length} ç­†ï¼Œ$${(-totalAmount).toLocaleString()})`);
        }

        // é¡¯ç¤ºç¾é‡‘æ”¯å‡ºè¨˜éŒ„
        function showCashExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const cashExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ç¾é‡‘' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = cashExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('cash');
            displayRecords(cashExpenseRecords, `ç•¶æœˆç¾é‡‘æ”¯å‡ºè¨˜éŒ„ (å…± ${cashExpenseRecords.length} ç­†ï¼Œ$${(-totalAmount).toLocaleString()})`);
        }

        // é¡¯ç¤ºä¿¡ç”¨å¡æ”¯å‡ºè¨˜éŒ„
        function showCreditExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const creditExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ä¿¡ç”¨å¡' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = creditExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('credit');
            displayRecords(creditExpenseRecords, `ç•¶æœˆä¿¡ç”¨å¡æ”¯å‡ºè¨˜éŒ„ (å…± ${creditExpenseRecords.length} ç­†ï¼Œ$${(-totalAmount).toLocaleString()})`);
        }

        // é¡¯ç¤ºç¸½æ”¶å…¥è¨˜éŒ„
        function showIncomeRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const incomeRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'income' && 
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('income');
            displayRecords(incomeRecords, `ç•¶æœˆç¸½æ”¶å…¥è¨˜éŒ„ (å…± ${incomeRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºå…¨éƒ¨è¨˜éŒ„
        function showAllRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const allRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalIncome = allRecords.filter(r => r.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = allRecords.filter(r => r.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const netAmount = totalIncome - totalExpense;
            
            // èª¿è©¦ä¿¡æ¯
            console.log('ç•¶æœˆå…¨éƒ¨è¨˜éŒ„è¨ˆç®—:');
            console.log('- è¨˜éŒ„ç¸½æ•¸:', allRecords.length);
            console.log('- æ”¶å…¥è¨˜éŒ„:', totalIncome);
            console.log('- æ”¯å‡ºè¨˜éŒ„:', totalExpense);
            console.log('- æ·¨é¡è¨ˆç®—:', totalIncome, '-', totalExpense, '=', netAmount);
            
            updateFilterTabs('all');
            displayRecords(allRecords, `ç•¶æœˆå…¨éƒ¨è¨˜éŒ„ (å…± ${allRecords.length} ç­†ï¼Œ$${netAmount.toLocaleString()})`);
        }

        // æŒ‰æˆå“¡ç¯©é¸è¨˜éŒ„
        function filterByMember() {
            const selectedMember = document.getElementById('memberFilter').value;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // ç²å–ç•¶å‰æœˆä»½çš„è¨˜éŒ„
            const currentMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            let filteredRecords;
            if (selectedMember === '') {
                // å¦‚æœæ²’æœ‰é¸æ“‡æˆå“¡ï¼Œé¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
                filteredRecords = currentMonthRecords;
            } else {
                // ç¯©é¸ç‰¹å®šæˆå“¡çš„è¨˜éŒ„
                filteredRecords = currentMonthRecords.filter(record => record.member === selectedMember);
            }
            
            // è¨ˆç®—ç¸½é‡‘é¡
            const totalAmount = filteredRecords.reduce((sum, record) => {
                if (record.type === 'expense') {
                    return sum - record.amount; // æ”¯å‡ºç‚ºè² æ•¸
                } else if (record.type === 'income') {
                    return sum + record.amount; // æ”¶å…¥ç‚ºæ­£æ•¸
                }
                return sum;
            }, 0);
            
            // æ›´æ–°æ¨™ç±¤é ç‹€æ…‹
            updateFilterTabs('member');
            
            // é¡¯ç¤ºç¯©é¸çµæœ
            const title = selectedMember === '' ? 
                `ç•¶æœˆå…¨éƒ¨è¨˜éŒ„ (å…± ${filteredRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})` :
                `${selectedMember} çš„è¨˜éŒ„ (å…± ${filteredRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`;
            
            displayRecords(filteredRecords, title);
        }

        // æ¸…é™¤æˆå“¡ç¯©é¸
        function clearMemberFilter() {
            document.getElementById('memberFilter').value = '';
            showAllRecords(); // å›åˆ°é¡¯ç¤ºå…¨éƒ¨è¨˜éŒ„
        }

        // æ›´æ–°æ¨™ç±¤é ç‹€æ…‹
        function updateFilterTabs(activeType) {
            const tabs = document.querySelectorAll('.filter-tab');
            console.log('æ›´æ–°æ¨™ç±¤é ç‹€æ…‹:', activeType, 'æ¨™ç±¤æ•¸é‡:', tabs.length);
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('ç§»é™¤activeé¡åˆ¥:', tab.textContent);
            });
            
            if (activeType === 'all') {
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    console.log('è¨­ç½®å…¨éƒ¨è¨˜éŒ„ç‚ºactive:', tabs[0].textContent);
                }
            } else if (activeType === 'expense') {
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    console.log('è¨­ç½®ç¸½æ”¯å‡ºç‚ºactive:', tabs[1].textContent);
                }
            } else if (activeType === 'cash') {
                if (tabs[2]) {
                    tabs[2].classList.add('active');
                    console.log('è¨­ç½®ç¾é‡‘æ”¯å‡ºç‚ºactive:', tabs[2].textContent);
                }
            } else if (activeType === 'credit') {
                if (tabs[3]) {
                    tabs[3].classList.add('active');
                    console.log('è¨­ç½®ä¿¡ç”¨å¡æ”¯å‡ºç‚ºactive:', tabs[3].textContent);
                }
            } else if (activeType === 'income') {
                if (tabs[4]) {
                    tabs[4].classList.add('active');
                    console.log('è¨­ç½®ç¸½æ”¶å…¥ç‚ºactive:', tabs[4].textContent);
                }
            } else if (activeType === 'member') {
                // æˆå“¡è¨˜éŒ„ä¸é¡¯ç¤ºä»»ä½•æ¨™ç±¤é ç‚º active
                console.log('æˆå“¡è¨˜éŒ„ï¼šæ¸…é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active ç‹€æ…‹');
            }
        }

        // é¡¯ç¤ºè¨˜éŒ„çš„é€šç”¨å‡½æ•¸
        function displayRecords(recordsToShow, title) {
            console.log('displayRecords è¢«èª¿ç”¨');
            console.log('è¦é¡¯ç¤ºçš„è¨˜éŒ„æ•¸é‡:', recordsToShow.length);
            console.log('æ¨™é¡Œ:', title);
            console.log('è¨˜éŒ„å…§å®¹:', recordsToShow);
            
            if (recordsToShow.length === 0) {
                console.log('æ²’æœ‰è¨˜éŒ„è¦é¡¯ç¤ºï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
                document.getElementById('recentRecords').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let recordsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #333; margin-bottom: 15px;">${title}</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            recordsToShow.forEach(record => {
                let amount, amountClass, prefix, bgColor, textColor;
                
                if (record.type === 'income') {
                    amount = record.amount;
                    amountClass = 'income';
                    prefix = '+';
                    bgColor = 'rgba(81, 207, 102, 0.1)';
                    textColor = '#51cf66';
                } else {
                    amount = -record.amount;
                    amountClass = 'expense';
                    prefix = '-';
                    bgColor = 'rgba(255, 107, 107, 0.1)';
                    textColor = '#ff6b6b';
                }
                
                recordsHtml += `
                    <div class="record-item ${amountClass}" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; background: ${bgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.member} - ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}</strong>
                                <br>
                                <small style="color: #666;">${record.description || 'ç„¡æè¿°'}</small>
                                <br>
                                <small style="color: #999;">${record.date}</small>
                            </div>
                            <div style="font-weight: bold; color: ${textColor};">
                                ${prefix}$${record.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('recentRecords').innerHTML = recordsHtml;
        }

        function updateRecentRecords() {
            const recentRecords = records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentRecords');
            container.innerHTML = '';
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            recentRecords.forEach(record => {
                const recordElement = createRecordElement(record);
                container.appendChild(recordElement);
            });
        }

        function updateAllRecords() {
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        function createRecordElement(record) {
            const div = document.createElement('div');
            div.className = `record-item ${record.type}`;
            
            let amountClass, amountPrefix;
            if (record.type === 'income') {
                amountClass = 'income';
                amountPrefix = '+';
            } else {
                amountClass = 'expense';
                amountPrefix = '-';
            }
            const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
            
            div.innerHTML = `
                <div class="record-info">
                    <h4>${record.member} - ${categoryText}</h4>
                    <p>${record.description || 'ç„¡æè¿°'}</p>
                    <p>${new Date(record.date).toLocaleDateString('zh-TW')}</p>
                </div>
                <div class="record-amount ${amountClass}">
                    ${amountPrefix}$${record.amount.toLocaleString()}
                </div>
                <div class="record-actions">
                    <button class="btn btn-small" onclick="editRecord('${record.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')">åˆªé™¤</button>
                </div>
            `;
            
            return div;
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            
            calendarTitle.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
            
            // æ¸…ç©ºæ—¥æ›†
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.background = '#f8f9fa';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // ç²å–ç•¶æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆ42å¤©ï¼ˆ6é€±ï¼‰
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentMonth) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = formatDateToYYYYMMDD(date);
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-records" id="day-records-${dateStr}"></div>
                `;
                dayElement.id = `day-${dateStr}`;
                
                dayElement.onclick = () => showDayRecords(date);
                calendarGrid.appendChild(dayElement);
            }
            
            // æ›´æ–°æ¯æ—¥è¨˜éŒ„
            updateDayRecords();
        }

        function updateDayRecords() {
            // å…ˆæ¸…ç©ºæ‰€æœ‰æ—¥æœŸçš„è¨˜éŒ„
            for (let i = 0; i < 42; i++) {
                const startDate = new Date(currentYear, currentMonth, 1);
                startDate.setDate(startDate.getDate() - startDate.getDay() + i);
                const dayRecordsElement = document.getElementById(`day-records-${formatDateToYYYYMMDD(startDate)}`);
                if (dayRecordsElement) {
                    dayRecordsElement.innerHTML = '';
                }
            }
            
            // æŒ‰æ—¥æœŸå’Œæˆå“¡åˆ†çµ„è¨ˆç®—ç¸½é¡
            const dayMemberTotals = {};
            records.forEach(record => {
                const date = record.date;
                const member = record.member;
                let amount;
                if (record.type === 'income') {
                    amount = record.amount; // æ”¶å…¥ç‚ºæ­£æ•¸
                } else {
                    amount = -record.amount; // æ”¯å‡ºç‚ºè² æ•¸
                }
                
                if (!dayMemberTotals[date]) {
                    dayMemberTotals[date] = {};
                }
                if (!dayMemberTotals[date][member]) {
                    dayMemberTotals[date][member] = 0;
                }
                dayMemberTotals[date][member] += amount;
            });
            
            // é¡¯ç¤ºæ¯å€‹æˆå“¡çš„ç•¶æ—¥ç¸½é¡
            Object.keys(dayMemberTotals).forEach(date => {
                const dayRecordsElement = document.getElementById(`day-records-${date}`);
                if (dayRecordsElement) {
                    const memberTotals = dayMemberTotals[date];
                    Object.keys(memberTotals).forEach(member => {
                        const total = memberTotals[member];
                        if (total !== 0) {
                            const recordClass = total > 0 ? 'day-income' : 'day-expense';
                            const prefix = total > 0 ? '+' : '';
                            
                            const recordDiv = document.createElement('div');
                            recordDiv.className = recordClass;
                            recordDiv.textContent = `${member}: ${prefix}$${Math.abs(total).toLocaleString()}`;
                            dayRecordsElement.appendChild(recordDiv);
                        }
                    });
                }
            });
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function showDayRecords(date) {
            const dayRecords = records.filter(record => record.date === formatDateToYYYYMMDD(date));
            
            if (dayRecords.length === 0) {
                // ä¸é¡¯ç¤ºæé†’ï¼Œç›´æ¥è¿”å›
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} çš„è¨˜éŒ„ï¼š\n\n`;
            dayRecords.forEach(record => {
                let prefix;
                if (record.type === 'income') {
                    prefix = '+';
                } else {
                    prefix = '-';
                }
                const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
                message += `${record.member} - ${categoryText}: ${prefix}$${record.amount}\n`;
                if (record.description) {
                    message += `  æè¿°: ${record.description}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberFilter = document.getElementById('memberFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredRecords = records.filter(record => {
                const matchesSearch = !searchTerm || 
                    record.member.toLowerCase().includes(searchTerm) ||
                    record.mainCategory.toLowerCase().includes(searchTerm) ||
                    (record.subCategory && record.subCategory.toLowerCase().includes(searchTerm)) ||
                    record.description.toLowerCase().includes(searchTerm);
                
                const matchesMember = !memberFilter || record.member === memberFilter;
                
                const matchesType = !typeFilter || record.type === typeFilter;
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                return matchesSearch && matchesMember && matchesType && matchesDate;
            });
            
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
                return;
            }
            
            filteredRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        // è¡¨å–®æäº¤
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ•¸æ“šé©—è­‰
            const member = document.getElementById('member').value;
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            let mainCategory = document.getElementById('mainCategory').value;
            const customMainCategory = document.getElementById('customMainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const date = document.getElementById('date').value;
            
            if (!member) {
                alert('è«‹é¸æ“‡æˆå“¡ï¼');
                return;
            }
            
            if (!type) {
                alert('è«‹é¸æ“‡é¡å‹ï¼');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼ˆå¿…é ˆå¤§æ–¼0ï¼‰ï¼');
                return;
            }
            
            if (!mainCategory) {
                alert('è«‹é¸æ“‡ä¸»é¡åˆ¥ï¼');
                return;
            }
            
            // å¦‚æœé¸æ“‡äº†"å…¶ä»–"ï¼Œä½¿ç”¨è‡ªå®šç¾©è¼¸å…¥
            if (mainCategory === 'å…¶ä»–') {
                if (!customMainCategory.trim()) {
                    alert('è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥ï¼');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼');
                return;
            }
            
            // é¡å‹ç›´æ¥å¾è¡¨å–®ç²å–ï¼Œä¸éœ€è¦é¡å¤–åˆ¤æ–·
            console.log('è¨˜éŒ„é¡å‹:', type, 'é‡‘é¡:', amount, 'ä¸»é¡åˆ¥:', mainCategory);
            
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ç‚ºæœªä¾†æ—¥æœŸ
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // è¨­ç‚ºä»Šå¤©çš„çµæŸæ™‚é–“
            
            if (selectedDate > today) {
                alert('ä¸èƒ½é¸æ“‡æœªä¾†çš„æ—¥æœŸï¼');
                return;
            }
            
            const finalAmount = Math.abs(amount);
            console.log('å‰µå»ºè¨˜éŒ„:', { type, originalAmount: amount, finalAmount, mainCategory });
            
            const record = {
                id: Date.now().toString(),
                member: member,
                type: type,
                amount: finalAmount, // é€€è²»ä¿æŒåŸå§‹é‡‘é¡ï¼Œå…¶ä»–å­˜å„²çµ•å°å€¼
                mainCategory: mainCategory,
                subCategory: subCategory,
                description: document.getElementById('description').value,
                date: date
            };
            
            records.push(record);
            saveRecords();
            
            // é‡ç½®è¡¨å–®
            this.reset();
            
            setTodayDate();
            
            // ç¢ºä¿æ‰€æœ‰æˆå“¡é¸é …éƒ½æ­£ç¢ºè¨­ç½®
            ensureMemberOptions();
            
            // æ›´æ–°é¡¯ç¤º
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
            updateDataStats(); // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
            
            alert('è¨˜éŒ„å·²æ–°å¢ï¼');
        });

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            // ç¢ºä¿ç·¨è¼¯è¡¨å–®çš„æˆå“¡é¸é …å®Œæ•´
            ensureMemberOptions();
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMember').value = record.member;
            document.getElementById('editType').value = record.type;
            document.getElementById('editAmount').value = record.amount;
            
            // è¨­ç½®ä¸»é¡åˆ¥ï¼ˆåªæ”¯æŒé å®šç¾©é¸é …ï¼‰
                document.getElementById('editMainCategory').value = record.mainCategory;
            
            document.getElementById('editSubCategory').value = record.subCategory;
            document.getElementById('editDescription').value = record.description;
            document.getElementById('editDate').value = record.date;
            
            // æ›´æ–°é¡åˆ¥é¸é …
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');
            const editSubCategorySelect = document.getElementById('editSubCategory');
            
            // æ›´æ–°ä¸»é¡åˆ¥ï¼ˆä½¿ç”¨ä¸€è‡´æ€§æ¸…å–®ï¼‰
            updateEditMainCategories();
            
            // æ›´æ–°ä»˜æ¬¾æ–¹å¼é¸é …
            editSubCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            
            // æ·»åŠ é€šç”¨ä»˜æ¬¾æ–¹å¼é¸é …
            const paymentMethods = ['ä¿¡ç”¨å¡', 'ç¾é‡‘'];
            paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                editSubCategorySelect.appendChild(option);
            });
            
            // å¦‚æœæ˜¯æ”¯å‡ºé¡å‹ä¸”æœ‰å­é¡åˆ¥ï¼Œä¹Ÿæ·»åŠ å­é¡åˆ¥é¸é …
            const mainCategory = editMainCategorySelect.value;
            if (type === 'expense' && mainCategory && categories.expense[mainCategory]) {
                // æ·»åŠ åˆ†éš”ç·š
                const separatorOption = document.createElement('option');
                separatorOption.value = '---';
                separatorOption.textContent = '--- å­é¡åˆ¥ ---';
                separatorOption.disabled = true;
                separatorOption.style.fontWeight = 'bold';
                separatorOption.style.color = '#666';
                editSubCategorySelect.appendChild(separatorOption);
                
                categories.expense[mainCategory].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    editSubCategorySelect.appendChild(option);
                });
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ•¸æ“šé©—è­‰
            const member = document.getElementById('editMember').value;
            const type = document.getElementById('editType').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const mainCategory = document.getElementById('editMainCategory').value;
            const subCategory = document.getElementById('editSubCategory').value;
            const date = document.getElementById('editDate').value;
            
            if (!member) {
                alert('è«‹é¸æ“‡æˆå“¡ï¼');
                return;
            }
            
            if (!type) {
                alert('è«‹é¸æ“‡é¡å‹ï¼');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼');
                return;
            }
            
            if (!mainCategory) {
                alert('è«‹é¸æ“‡ä¸»é¡åˆ¥ï¼');
                return;
            }
            
            if (!subCategory) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼');
                return;
            }
            
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ç‚ºæœªä¾†æ—¥æœŸ
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (selectedDate > today) {
                alert('ä¸èƒ½é¸æ“‡æœªä¾†çš„æ—¥æœŸï¼');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                records[recordIndex] = {
                    id: id,
                    member: member,
                    type: type,
                    amount: amount,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    description: document.getElementById('editDescription').value,
                    date: date
                };
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateDataStats(); // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
                closeModal();
                
                alert('è¨˜éŒ„å·²æ›´æ–°ï¼');
            }
        });

        function deleteRecord(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                records = records.filter(record => record.id !== id);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateDataStats(); // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
                alert('è¨˜éŒ„å·²åˆªé™¤ï¼');
            }
        }

        function saveRecords() {
            try {
            // å¯«å…¥ localStorage
            localStorage.setItem('familyRecords', JSON.stringify(records));
            
                // è¨˜éŒ„æœ€å¾Œä¿å­˜æ™‚é–“
                const saveTime = new Date().toISOString();
                localStorage.setItem('lastSaveTime', saveTime);
                
                // è¨˜éŒ„ä¿å­˜æ¬¡æ•¸
                const saveCount = parseInt(localStorage.getItem('saveCount') || '0') + 1;
                localStorage.setItem('saveCount', saveCount.toString());
                
                console.log(`è¨˜éŒ„å·²ä¿å­˜åˆ° localStorage (ç¬¬ ${saveCount} æ¬¡ä¿å­˜)`);
                
                // å®šæœŸè‡ªå‹•å‚™ä»½åˆ° data.jsonï¼ˆæ¯3æ¬¡æ“ä½œå‚™ä»½ä¸€æ¬¡ï¼‰
                if (saveCount % 3 === 0) {
                    console.log(`å·²é€²è¡Œ ${saveCount} æ¬¡æ“ä½œï¼Œè‡ªå‹•å‚™ä»½ data.json`);
                saveToDataJson();
                }
                
                // å‰µå»ºé¡å¤–çš„å‚™ä»½ï¼ˆæ¯10æ¬¡æ“ä½œï¼‰
                if (saveCount % 10 === 0) {
                    createAutoBackup();
                }

                // æ›´æ–°èª¿è©¦ä¿¡æ¯
                updateDebugInfo();
                
                // é¡¯ç¤ºä¿å­˜æˆåŠŸæç¤ºï¼ˆå¯é¸ï¼‰
                if (saveCount % 5 === 0) {
                    console.log(`âœ… è³‡æ–™å·²è‡ªå‹•ä¿å­˜ ${saveCount} æ¬¡`);
                }
                
            } catch (error) {
                console.error('ä¿å­˜è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('ä¿å­˜è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ã€‚');
            }
        }

        // å¯«å…¥ data.json æª”æ¡ˆï¼ˆé€šéä¸‹è¼‰æ–¹å¼ï¼‰
        function saveToDataJson() {
            try {
                const now = new Date();
                const dataToSave = {
                    records: records,
                    settings: {
                        version: "1.0",
                        lastUpdated: now.toISOString()
                    }
                };
                
                // è¨˜éŒ„å‚™ä»½æ™‚é–“
                localStorage.setItem('lastBackupTime', now.toLocaleString('zh-TW'));
                
                // å‰µå»ºä¸¦ä¸‹è¼‰ data.json æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // éœé»˜ä¸‹è¼‰ï¼ˆä¸é¡¯ç¤ºä¸‹è¼‰å°è©±æ¡†ï¼‰
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('æˆåŠŸç”Ÿæˆ data.json å‚™ä»½æª”æ¡ˆ');
                
                // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
                updateDataStats();
            } catch (error) {
                console.warn('ç„¡æ³•ç”Ÿæˆ data.json å‚™ä»½æª”æ¡ˆ:', error, 'ä½† localStorage å·²ä¿å­˜');
            }
        }

        // å˜—è©¦ç›´æ¥å¯«å…¥æœ¬åœ°æª”æ¡ˆï¼ˆéœ€è¦ç”¨æˆ¶æˆæ¬Šï¼‰
        async function saveToLocalFile() {
            try {
                // æª¢æŸ¥æ˜¯å¦æ”¯æ´ File System Access API
                if ('showSaveFilePicker' in window) {
                    const now = new Date();
                    const dataToSave = {
                        records: records,
                        metadata: {
                            version: "1.0",
                            lastUpdated: now.toISOString(),
                            recordCount: records.length
                        }
                    };
                    
                    // è«‹æ±‚ç”¨æˆ¶é¸æ“‡ä¿å­˜ä½ç½®
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: `family_backup_${formatDateToYYYYMMDD(now)}.json`,
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    
                    // å¯«å…¥æª”æ¡ˆ
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(dataToSave, null, 2));
                    await writable.close();
                    
                    alert(`æª”æ¡ˆå·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°ï¼\n\næª”æ¡ˆä½ç½®: ${fileHandle.name}\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†`);
                    console.log('æª”æ¡ˆå·²ä¿å­˜åˆ°æœ¬åœ°:', fileHandle.name);
                    
                } else {
                    // ä¸æ”¯æ´ File System Access APIï¼Œå›é€€åˆ°ä¸‹è¼‰æ–¹å¼
                    console.log('ç€è¦½å™¨ä¸æ”¯æ´ File System Access APIï¼Œä½¿ç”¨ä¸‹è¼‰æ–¹å¼');
                    saveToDataJson();
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('ç”¨æˆ¶å–æ¶ˆäº†æª”æ¡ˆä¿å­˜');
                } else {
                    console.error('ä¿å­˜æª”æ¡ˆå¤±æ•—:', error);
                    alert('ä¿å­˜æª”æ¡ˆå¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–ä½¿ç”¨ä¸‹è¼‰æ–¹å¼ã€‚');
                }
            }
        }

        // ç²å– GitHub Token
        function getGitHubToken() {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                const newToken = prompt(
                    'è«‹è¼¸å…¥æ‚¨çš„ GitHub Personal Access Token:\n\n' +
                    'å¦‚ä½•ç²å– Token:\n' +
                    '1. å‰å¾€ GitHub Settings > Developer settings > Personal access tokens\n' +
                    '2. å‰µå»ºæ–° tokenï¼Œé¸æ“‡ "repo" æ¬Šé™\n' +
                    '3. è¤‡è£½ token ä¸¦è²¼åˆ°é€™è£¡\n\n' +
                    'Token å°‡å®‰å…¨åœ°å„²å­˜åœ¨ç€è¦½å™¨çš„ localStorage ä¸­\n\n' +
                    'âš ï¸ æ³¨æ„ï¼šè«‹ç¢ºä¿è¤‡è£½å®Œæ•´çš„Tokenï¼Œä¸è¦åŒ…å«å¤šé¤˜çš„ç©ºæ ¼æˆ–æ›è¡Œç¬¦'
                );
                if (newToken) {
                    // æ¸…ç†Tokenï¼šç§»é™¤å‰å¾Œç©ºæ ¼å’Œæ›è¡Œç¬¦
                    const cleanToken = newToken.trim().replace(/\s/g, '');
                    
                    // é©—è­‰Tokenæ ¼å¼
                    if (cleanToken.length < 20) {
                        alert('âŒ Token é•·åº¦å¤ªçŸ­ï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¤‡è£½å®Œæ•´');
                        return null;
                    }
                    
                    // GitHub Token æ ¼å¼ï¼šghp_ é–‹é ­ï¼ŒåŒ…å«å­—æ¯æ•¸å­—å’Œåº•ç·š
                    if (!cleanToken.startsWith('ghp_') && !cleanToken.startsWith('gho_') && !cleanToken.startsWith('ghu_') && !cleanToken.startsWith('ghs_') && !cleanToken.startsWith('ghr_')) {
                        alert('âŒ Token æ ¼å¼ä¸æ­£ç¢ºï¼ŒGitHub Token æ‡‰è©²ä»¥ ghp_ã€gho_ã€ghu_ã€ghs_ æˆ– ghr_ é–‹é ­');
                        return null;
                    }
                    
                    localStorage.setItem('githubToken', cleanToken);
                    return cleanToken;
                }
                return null;
            }
            return token;
        }

        // æ¸…é™¤ GitHub Token
        function clearGitHubToken() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å·²ä¿å­˜çš„ GitHub Token å—ï¼Ÿ\n\næ¸…é™¤å¾Œéœ€è¦é‡æ–°è¼¸å…¥ Token æ‰èƒ½ä½¿ç”¨ GitHub å­˜æª”åŠŸèƒ½ã€‚')) {
                localStorage.removeItem('githubToken');
                alert('âœ… GitHub Token å·²æ¸…é™¤ï¼\n\nä¸‹æ¬¡ä½¿ç”¨ GitHub åŠŸèƒ½æ™‚æœƒé‡æ–°æç¤ºè¼¸å…¥ Tokenã€‚');
            }
        }

        // æ¸¬è©¦ GitHub Token
        async function testGitHubToken() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                // æ¸¬è©¦APIèª¿ç”¨
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const repoData = await response.json();
                    alert(`âœ… Token æ¸¬è©¦æˆåŠŸï¼\n\nå€‰åº«: ${repoData.full_name}\næ¬Šé™: ${repoData.permissions ? Object.keys(repoData.permissions).filter(p => repoData.permissions[p]).join(', ') : 'æœªçŸ¥'}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(`API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('Token æ¸¬è©¦å¤±æ•—:', error);
                alert(`âŒ Token æ¸¬è©¦å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè«‹æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢ºæˆ–å€‰åº«è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚`);
            }
        }

        // ç²å– GitHub å€‰åº«ä¿¡æ¯
        function getGitHubRepoInfo() {
            const hostname = window.location.hostname;
            const pathname = window.location.pathname;
            
            if (hostname.includes('github.io')) {
                const parts = pathname.split('/').filter(part => part);
                const username = hostname.split('.')[0];
                const repoName = parts[0] || 'familyCost';
                return `${username}/${repoName}`;
            }
            
            // å¦‚æœä¸æ˜¯ GitHub Pagesï¼Œè®“ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥
            const repoInfo = prompt('è«‹è¼¸å…¥ GitHub å€‰åº«è·¯å¾‘ (æ ¼å¼: username/repository):');
            return repoInfo;
        }

        // å­˜æª”åˆ° GitHub æª”æ¡ˆ
        async function saveToGitHubFile() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: now.toISOString(),
                        version: "1.0",
                        description: "å®¶åº­æ”¶æ”¯è¨˜éŒ„è³‡æ–™",
                        recordCount: records.length
                    }
                };
                
                // å…ˆç²å–ç¾æœ‰æª”æ¡ˆçš„ SHA
                const getResponse = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // æ›´æ–°æª”æ¡ˆ
                const updateData = {
                    message: `Update family records - ${now.toLocaleString('zh-TW')}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))),
                    branch: 'main'
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (response.ok) {
                    alert(`âœ… GitHub æª”æ¡ˆå­˜æª”æˆåŠŸï¼\n\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\nå­˜æª”æ™‚é–“: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub æª”æ¡ˆå­˜æª”æˆåŠŸ');
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub æª”æ¡ˆå­˜æª”å¤±æ•—:', error);
                alert(`âŒ GitHub æª”æ¡ˆå­˜æª”å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè«‹æª¢æŸ¥ Token æ¬Šé™å’Œå€‰åº«è·¯å¾‘ã€‚`);
            }
        }

        // å¾ GitHub æª”æ¡ˆè¼‰å…¥
        async function loadFromGitHubFile() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/contents/data.json`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = JSON.parse(atob(fileData.content));
                    
                    if (content.records && Array.isArray(content.records)) {
                        records = content.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        
                        // æ›´æ–°é¡¯ç¤º
                        updateStats();
                        updateMemberStats();
                        updateAllRecords();
                        updateCalendar();
                        updateDataStats();
                        updateDebugInfo();
                        
                        alert(`âœ… å¾ GitHub è¼‰å…¥æˆåŠŸï¼\n\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\næœ€å¾Œæ›´æ–°: ${content.metadata?.lastUpdated ? new Date(content.metadata.lastUpdated).toLocaleString('zh-TW') : 'æœªçŸ¥'}`);
                    } else {
                        alert('âŒ GitHub æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('å¾ GitHub è¼‰å…¥å¤±æ•—:', error);
                alert(`âŒ å¾ GitHub è¼‰å…¥å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}`);
            }
        }

        // å­˜æª”ç‚º GitHub Issue
        async function saveToGitHubIssue() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const issueTitle = `å®¶åº­æ”¶æ”¯è¨˜éŒ„å‚™ä»½ - ${now.toLocaleString('zh-TW')}`;
                const issueBody = `## å®¶åº­æ”¶æ”¯è¨˜éŒ„å‚™ä»½\n\n**å‚™ä»½æ™‚é–“:** ${now.toLocaleString('zh-TW')}\n**è¨˜éŒ„æ•¸é‡:** ${records.length} ç­†\n\n### è¨˜éŒ„æ‘˜è¦\n\`\`\`json\n${JSON.stringify(records, null, 2)}\n\`\`\`\n\n---\n*æ­¤ Issue ç”±å®¶åº­æ”¶æ”¯ç®¡ç†ç³»çµ±è‡ªå‹•å‰µå»º*`;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/issues`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            title: issueTitle,
                            body: issueBody,
                            labels: ['backup', 'family-records']
                        })
                    }
                );
                
                if (response.ok) {
                    const issueData = await response.json();
                    alert(`âœ… GitHub Issue å­˜æª”æˆåŠŸï¼\n\nIssue #${issueData.number}\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\nå­˜æª”æ™‚é–“: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Issue å­˜æª”æˆåŠŸ:', issueData.number);
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Issue å­˜æª”å¤±æ•—:', error);
                alert(`âŒ GitHub Issue å­˜æª”å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}`);
            }
        }

        // å¾ GitHub Issues è¼‰å…¥
        async function loadFromGitHubIssues() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/issues?labels=backup,family-records&state=all`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const issues = await response.json();
                    
                    if (issues.length === 0) {
                        alert('âŒ æ²’æœ‰æ‰¾åˆ°å‚™ä»½ Issueï¼');
                        return;
                    }
                    
                    // é¡¯ç¤ºå¯ç”¨çš„å‚™ä»½
                    const backupList = issues.map(issue => 
                        `#${issue.number} - ${issue.title} (${new Date(issue.created_at).toLocaleString('zh-TW')})`
                    ).join('\n');
                    
                    const selectedIssue = prompt(
                        `æ‰¾åˆ° ${issues.length} å€‹å‚™ä»½ Issueï¼š\n\n${backupList}\n\nè«‹è¼¸å…¥è¦è¼‰å…¥çš„ Issue ç·¨è™Ÿ:`
                    );
                    
                    if (selectedIssue) {
                        const issueNumber = parseInt(selectedIssue.replace('#', ''));
                        const issue = issues.find(i => i.number === issueNumber);
                        
                        if (issue) {
                            // å¾ Issue å…§å®¹ä¸­æå– JSON æ•¸æ“š
                            const body = issue.body;
                            const jsonMatch = body.match(/```json\n([\s\S]*?)\n```/);
                            
                            if (jsonMatch) {
                                const recordsData = JSON.parse(jsonMatch[1]);
                                if (Array.isArray(recordsData)) {
                                    records = recordsData;
                                    localStorage.setItem('familyRecords', JSON.stringify(records));
                                    
                                    // æ›´æ–°é¡¯ç¤º
                                    updateStats();
                                    updateMemberStats();
                                    updateAllRecords();
                                    updateCalendar();
                                    updateDataStats();
                                    updateDebugInfo();
                                    
                                    alert(`âœ… å¾ GitHub Issue #${issueNumber} è¼‰å…¥æˆåŠŸï¼\n\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†`);
                                } else {
                                    alert('âŒ Issue ä¸­çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢ºï¼');
                                }
                            } else {
                                alert('âŒ ç„¡æ³•å¾ Issue ä¸­æå–æ•¸æ“šï¼');
                            }
                        } else {
                            alert('âŒ æ‰¾ä¸åˆ°æŒ‡å®šçš„ Issueï¼');
                        }
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('å¾ GitHub Issues è¼‰å…¥å¤±æ•—:', error);
                alert(`âŒ å¾ GitHub Issues è¼‰å…¥å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}`);
            }
        }

        // å‰µå»º GitHub Release
        async function createGitHubRelease() {
            try {
                const token = getGitHubToken();
                if (!token) return;
                
                const repoInfo = getGitHubRepoInfo();
                if (!repoInfo) return;
                
                const now = new Date();
                const tagName = `v${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
                const releaseName = `å®¶åº­æ”¶æ”¯è¨˜éŒ„å‚™ä»½ - ${now.toLocaleString('zh-TW')}`;
                const releaseBody = `## å®¶åº­æ”¶æ”¯è¨˜éŒ„å‚™ä»½\n\n**å‚™ä»½æ™‚é–“:** ${now.toLocaleString('zh-TW')}\n**è¨˜éŒ„æ•¸é‡:** ${records.length} ç­†\n\n### çµ±è¨ˆæ‘˜è¦\n- ç¸½æ”¶å…¥: $${records.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0).toLocaleString()}\n- ç¸½æ”¯å‡º: $${records.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0).toLocaleString()}\n\n---\n*æ­¤ Release ç”±å®¶åº­æ”¶æ”¯ç®¡ç†ç³»çµ±è‡ªå‹•å‰µå»º*`;
                
                // å‰µå»º data.json æª”æ¡ˆå…§å®¹
                const dataToSave = {
                    records: records,
                    metadata: {
                        lastUpdated: now.toISOString(),
                        version: "1.0",
                        description: "å®¶åº­æ”¶æ”¯è¨˜éŒ„è³‡æ–™",
                        recordCount: records.length
                    }
                };
                
                const response = await fetch(
                    `https://api.github.com/repos/${repoInfo}/releases`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            tag_name: tagName,
                            name: releaseName,
                            body: releaseBody,
                            draft: false,
                            prerelease: false
                        })
                    }
                );
                
                if (response.ok) {
                    const releaseData = await response.json();
                    alert(`âœ… GitHub Release å‰µå»ºæˆåŠŸï¼\n\nRelease: ${releaseData.tag_name}\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\nå‰µå»ºæ™‚é–“: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub Release å‰µå»ºæˆåŠŸ:', releaseData.tag_name);
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub Release å‰µå»ºå¤±æ•—:', error);
                alert(`âŒ GitHub Release å‰µå»ºå¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}`);
            }
        }

        // GitHub Pages è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ GitHub API æ›´æ–°æª”æ¡ˆ
        async function saveToGitHub() {
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨ GitHub Pages ç’°å¢ƒ
                if (!window.location.hostname.includes('github.io')) {
                    alert('æ­¤åŠŸèƒ½åƒ…åœ¨ GitHub Pages ç’°å¢ƒä¸­å¯ç”¨ï¼\n\nè«‹ä½¿ç”¨å…¶ä»–å‚™ä»½æ–¹å¼ã€‚');
                    return;
                }
                
                const now = new Date();
                const dataToSave = {
                    records: records,
                    metadata: {
                        version: "1.0",
                        lastUpdated: now.toISOString(),
                        recordCount: records.length,
                        updatedBy: "family-cost-app"
                    }
                };
                
                // æç¤ºç”¨æˆ¶éœ€è¦ GitHub Token
                const token = prompt(
                    'è¦æ›´æ–° GitHub ä¸Šçš„ data.json æª”æ¡ˆï¼Œéœ€è¦æ‚¨çš„ GitHub Personal Access Tokenã€‚\n\n' +
                    'è«‹è¼¸å…¥æ‚¨çš„ GitHub Tokenï¼ˆå¦‚æœæ²’æœ‰ï¼Œè«‹æŒ‰å–æ¶ˆä½¿ç”¨ä¸‹è¼‰æ–¹å¼ï¼‰:\n\n' +
                    'å¦‚ä½•ç²å– Token:\n' +
                    '1. å‰å¾€ GitHub Settings > Developer settings > Personal access tokens\n' +
                    '2. å‰µå»ºæ–° tokenï¼Œé¸æ“‡ "repo" æ¬Šé™\n' +
                    '3. è¤‡è£½ token ä¸¦è²¼åˆ°é€™è£¡'
                );
                
                if (!token) {
                    console.log('ç”¨æˆ¶å–æ¶ˆäº† GitHub æ›´æ–°ï¼Œä½¿ç”¨ä¸‹è¼‰æ–¹å¼');
                    saveToDataJson();
                    return;
                }
                
                // ç²å–ç•¶å‰æª”æ¡ˆå…§å®¹ï¼ˆç”¨æ–¼è¨ˆç®— SHAï¼‰
                const response = await fetch('data.json');
                let currentSha = null;
                if (response.ok) {
                    const currentData = await response.json();
                    // é€™è£¡éœ€è¦ GitHub API ä¾†ç²å– SHAï¼Œä½†æˆ‘å€‘å…ˆå˜—è©¦æ›´æ–°
                }
                
                // æº–å‚™ GitHub API è«‹æ±‚
                const githubData = {
                    message: `Update family records backup - ${now.toLocaleString('zh-TW')}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))), // Base64 ç·¨ç¢¼
                    branch: 'main' // æˆ– 'master'ï¼Œæ ¹æ“šæ‚¨çš„é è¨­åˆ†æ”¯
                };
                
                // å¦‚æœæœ‰ç¾æœ‰ SHAï¼Œæ·»åŠ åˆ°è«‹æ±‚ä¸­
                if (currentSha) {
                    githubData.sha = currentSha;
                }
                
                const apiResponse = await fetch(
                    `https://api.github.com/repos/${getGitHubRepoPath()}/contents/data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(githubData)
                    }
                );
                
                if (apiResponse.ok) {
                    alert(`GitHub æª”æ¡ˆæ›´æ–°æˆåŠŸï¼\n\nè¨˜éŒ„æ•¸é‡: ${records.length} ç­†\næ›´æ–°æ™‚é–“: ${now.toLocaleString('zh-TW')}`);
                    console.log('GitHub æª”æ¡ˆæ›´æ–°æˆåŠŸ');
                } else {
                    const errorData = await apiResponse.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('GitHub æ›´æ–°å¤±æ•—:', error);
                alert(`GitHub æ›´æ–°å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nå°‡ä½¿ç”¨ä¸‹è¼‰æ–¹å¼ä½œç‚ºå‚™é¸ã€‚`);
                saveToDataJson();
            }
        }
        
        // ç²å– GitHub å€‰åº«è·¯å¾‘
        function getGitHubRepoPath() {
            const hostname = window.location.hostname;
            const pathname = window.location.pathname;
            
            // å¾ URL è§£æå€‰åº«è·¯å¾‘
            // ä¾‹å¦‚: username.github.io/repo-name -> username/repo-name
            const parts = pathname.split('/').filter(part => part);
            if (parts.length >= 1) {
                const username = hostname.split('.')[0];
                return `${username}/${parts[0]}`;
            }
            
            return null;
        }

        // å‰µå»ºè‡ªå‹•å‚™ä»½
        function createAutoBackup() {
            try {
                const now = new Date();
                const backupData = {
                    records: records,
                    metadata: {
                        backupTime: now.toISOString(),
                        version: "1.0",
                        purpose: "auto-backup",
                        recordCount: records.length
                    }
                };
                
                // å„²å­˜åˆ° localStorage ä½œç‚ºå‚™ä»½
                const backupKey = `backup_${formatDateToYYYYMMDD(now)}_${now.getHours()}${now.getMinutes()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // åªä¿ç•™æœ€è¿‘5å€‹å‚™ä»½
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                if (backupKeys.length > 5) {
                    backupKeys.sort();
                    for (let i = 0; i < backupKeys.length - 5; i++) {
                        localStorage.removeItem(backupKeys[i]);
                    }
                }
                
                console.log('è‡ªå‹•å‚™ä»½å·²å‰µå»º:', backupKey);
                
            } catch (error) {
                console.warn('å‰µå»ºè‡ªå‹•å‚™ä»½å¤±æ•—:', error);
            }
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            recurringExpenses.forEach(expense => {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨˜éŒ„äº†é€™å€‹æœˆçš„å›ºå®šæ”¯å‡º
                const thisMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const existingRecord = records.find(record => 
                    record.member === expense.member &&
                    record.description.includes(expense.name) &&
                    record.date.startsWith(thisMonth)
                );
                
                // å¦‚æœä»Šå¤©æ˜¯å›ºå®šæ”¯å‡ºçš„æ—¥æœŸä¸”é‚„æ²’æœ‰è¨˜éŒ„ï¼Œé¡¯ç¤ºæé†’
                if (currentDay === expense.day && !existingRecord) {
                    const confirmAdd = confirm(`æé†’ï¼šä»Šå¤©æ˜¯ ${expense.name} çš„ç¹³è²»æ—¥ï¼ˆ$${expense.amount.toLocaleString()}ï¼‰ï¼Œæ˜¯å¦è¦æ–°å¢é€™ç­†è¨˜éŒ„ï¼Ÿ`);
                    if (confirmAdd) {
                        // æ ¹æ“šè²»ç”¨åç¨±æ±ºå®šæ­£ç¢ºçš„é¡åˆ¥
                        let mainCategory, subCategory;
                        if (expense.name === 'æˆ¿ç§Ÿ') {
                            mainCategory = 'å±…ä½';
                            subCategory = 'æˆ¿ç§Ÿ';
                        } else if (expense.name === 'æˆ¿è²¸') {
                            mainCategory = 'å±…ä½';
                            subCategory = 'æˆ¿è²¸';
                        } else if (expense.name === 'æ‰‹æ©Ÿè²»') {
                            mainCategory = 'æ—¥å¸¸';
                            subCategory = 'æ‰‹æ©Ÿè²»';
                        } else if (expense.name === 'ç¶²è·¯è²»') {
                            mainCategory = 'æ—¥å¸¸';
                            subCategory = 'ç¶²è·¯è²»';
                        }
                        
                        const record = {
                            id: Date.now().toString(),
                            member: expense.member,
                            type: 'expense',
                            amount: expense.amount,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            description: `${expense.name} - ${thisMonth}`,
                            date: today.toISOString().split('T')[0]
                        };
                        
                        records.push(record);
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        
                        alert(`${expense.name} è¨˜éŒ„å·²æ–°å¢ï¼`);
                    }
                }
            });
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // CSV åŒ¯å…¥åŠŸèƒ½
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('CSV æª”æ¡ˆè§£æéŒ¯èª¤ï¼š' + results.errors[0].message);
                        return;
                    }
                    processImportData(results.data);
                },
                error: function(error) {
                    alert('è®€å– CSV æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            });
        }

        // Excel åŒ¯å…¥åŠŸèƒ½
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ä½¿ç”¨ raw: false ä¾†ç²å–æ ¼å¼åŒ–çš„å€¼
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        dateNF: 'yyyy-mm-dd' // æŒ‡å®šæ—¥æœŸæ ¼å¼
                    });
                    
                    console.log('Excel è§£æçµæœ:', jsonData);
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Excel è®€å–éŒ¯èª¤:', error);
                    alert('è®€å– Excel æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // è™•ç†åŒ¯å…¥æ•¸æ“š
        function processImportData(data) {
            importData = [];
            const errors = [];
            const warnings = [];

            console.log('åŸå§‹æ•¸æ“š:', data);

            data.forEach((row, index) => {
                console.log(`è™•ç†ç¬¬ ${index + 1} è¡Œ:`, row);
                const record = validateImportRecord(row, index + 1);
                if (record) {
                    importData.push(record);
                } else {
                    errors.push(`ç¬¬ ${index + 1} è¡Œæ•¸æ“šç„¡æ•ˆ`);
                }
            });

            if (errors.length > 0) {
                alert('ç™¼ç¾ä»¥ä¸‹éŒ¯èª¤ï¼š\n' + errors.join('\n') + '\n\nè«‹æª¢æŸ¥æ•¸æ“šæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
            }

            if (warnings.length > 0) {
                console.warn('è­¦å‘Š:', warnings);
            }

            showImportPreview();
        }

        // é©—è­‰åŒ¯å…¥è¨˜éŒ„
        function validateImportRecord(row, rowNumber) {
            const requiredFields = ['æˆå“¡', 'é‡‘é¡', 'ä¸»é¡åˆ¥', 'å­é¡åˆ¥', 'æè¿°', 'æ—¥æœŸ'];
            const errors = [];
            
            console.log(`é©—è­‰ç¬¬ ${rowNumber} è¡Œ:`, row);
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            for (let field of requiredFields) {
                if (!row[field] && row[field] !== 0) {
                    errors.push(`ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${field}`);
                }
            }
            
            // é©—è­‰ä»˜æ¬¾æ–¹å¼ï¼ˆå­é¡åˆ¥ï¼‰
            const paymentMethod = row['å­é¡åˆ¥'];
            if (paymentMethod && !['ä¿¡ç”¨å¡', 'ç¾é‡‘'].includes(paymentMethod)) {
                errors.push(`ä»˜æ¬¾æ–¹å¼ç„¡æ•ˆï¼š${paymentMethod} (æœ‰æ•ˆå€¼: ä¿¡ç”¨å¡, ç¾é‡‘)`);
            }

            if (errors.length > 0) {
                console.error(`ç¬¬ ${rowNumber} è¡ŒéŒ¯èª¤:`, errors);
                return null;
            }

            // é©—è­‰æˆå“¡
            if (!familyMembers.includes(row['æˆå“¡'])) {
                errors.push(`æˆå“¡ç„¡æ•ˆï¼š${row['æˆå“¡']} (æœ‰æ•ˆå€¼: ${familyMembers.join(', ')})`);
            }

            // é©—è­‰é‡‘é¡
            let amountValue = row['é‡‘é¡'];
            
            // æ¸…ç†é‡‘é¡å­—ç¬¦ä¸²
            if (typeof amountValue === 'string') {
                // å…ˆè™•ç†æ‹¬è™Ÿæ ¼å¼ï¼ˆæœƒè¨ˆæ ¼å¼ï¼‰
                if (amountValue.includes('(') && amountValue.includes(')')) {
                    amountValue = '-' + amountValue.replace(/[()]/g, '');
                }
                
                // ç§»é™¤è²¨å¹£ç¬¦è™Ÿã€ç©ºæ ¼ç­‰ï¼Œä½†ä¿ç•™è² è™Ÿå’Œé€—è™Ÿ
                amountValue = amountValue.toString().replace(/[Â¥ï¿¥\s]/g, '');
                
                // ç§»é™¤åƒåˆ†ä½é€—è™Ÿ
                amountValue = amountValue.replace(/,/g, '');
                
                // ç§»é™¤ç¾å…ƒç¬¦è™Ÿï¼ˆåœ¨é€—è™Ÿè™•ç†å¾Œï¼‰
                amountValue = amountValue.replace(/\$/g, '');
            }
            
            const amount = parseFloat(amountValue);
            console.log(`ç¬¬ ${rowNumber} è¡Œé‡‘é¡è§£æ:`, {
                'åŸå§‹å€¼': row['é‡‘é¡'],
                'æ¸…ç†å¾Œ': amountValue,
                'è§£æå¾Œ': amount,
                'é¡å‹': typeof row['é‡‘é¡']
            });
            
            if (isNaN(amount) || amount === 0) {
                errors.push(`é‡‘é¡ç„¡æ•ˆï¼š${row['é‡‘é¡']} (æ¸…ç†å¾Œ: ${amountValue}, è§£æå¾Œ: ${amount})`);
            }

            // æ ¹æ“šé‡‘é¡æ­£è² æ•¸åˆ¤æ–·é¡å‹
            const type = amount > 0 ? 'income' : 'expense';
            const absAmount = Math.abs(amount); // å…§éƒ¨å­˜å„²ä½¿ç”¨çµ•å°å€¼

            // é©—è­‰æ—¥æœŸ
            let dateStr = row['æ—¥æœŸ'];
            // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
            if (typeof dateStr === 'string') {
                // å¦‚æœæ˜¯ Excel æ—¥æœŸæ•¸å­—ï¼Œè½‰æ›ç‚ºæ—¥æœŸ
                if (!isNaN(dateStr) && dateStr > 25569) { // Excel æ—¥æœŸèµ·å§‹å€¼
                    const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                    dateStr = formatDateToYYYYMMDD(excelDate);
                } else {
                    // è™•ç†æ–œç·šåˆ†éš”çš„æ—¥æœŸæ ¼å¼ (2025/09/01 -> 2025-09-01)
                    dateStr = dateStr.replace(/\//g, '-');
                }
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                errors.push(`æ—¥æœŸç„¡æ•ˆï¼š${row['æ—¥æœŸ']} (æ ¼å¼: YYYY-MM-DD)`);
            }

            if (errors.length > 0) {
                console.error(`ç¬¬ ${rowNumber} è¡Œé©—è­‰å¤±æ•—:`, errors);
                return null;
            }

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                member: row['æˆå“¡'],
                type: type,
                amount: absAmount,
                mainCategory: row['ä¸»é¡åˆ¥'],
                subCategory: row['å­é¡åˆ¥'],
                description: row['æè¿°'] || '',
                date: dateStr
            };
        }

        // é¡¯ç¤ºåŒ¯å…¥é è¦½
        function showImportPreview() {
            const previewDiv = document.getElementById('importPreview');
            const tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            importData.forEach((record, index) => {
                const row = document.createElement('tr');
                const isValid = validateRecord(record);
                
                let amountDisplay;
                if (record.type === 'income' || record.type === 'refund') {
                    amountDisplay = `+$${record.amount.toLocaleString()}`;
                } else {
                    amountDisplay = `-$${record.amount.toLocaleString()}`;
                }
                
                let color;
                if (record.type === 'income') {
                    color = '#51cf66';
                } else if (record.type === 'refund') {
                    color = '#28a745';
                } else if (record.type === 'creditPayment') {
                    color = '#ff6b35';
                } else {
                    color = '#ff6b6b';
                }
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${color}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                    <td class="${isValid ? 'status-valid' : 'status-invalid'}">
                        ${isValid ? 'âœ“ æœ‰æ•ˆ' : 'âœ— ç„¡æ•ˆ'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // é©—è­‰è¨˜éŒ„
        function validateRecord(record) {
            return familyMembers.includes(record.member) &&
                   ['income', 'expense'].includes(record.type) &&
                   record.amount > 0 &&
                   record.mainCategory &&
                   record.date;
        }

        // ç¢ºèªåŒ¯å…¥
        function confirmImport() {
            const validRecords = importData.filter(record => validateRecord(record));
            
            if (validRecords.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ï¼');
                return;
            }

            // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
            const duplicateCheck = checkForDuplicates(validRecords);
            const newRecords = duplicateCheck.newRecords;
            const duplicates = duplicateCheck.duplicates;

            if (duplicates.length > 0) {
                const duplicateInfo = duplicates.map(dup => 
                    `${dup.member} - ${dup.mainCategory} - $${dup.amount} - ${dup.date}`
                ).join('\n');
                
                if (newRecords.length === 0) {
                    alert(`æ‰€æœ‰è¨˜éŒ„éƒ½æ˜¯é‡è¤‡çš„ï¼\n\né‡è¤‡çš„è¨˜éŒ„ï¼š\n${duplicateInfo}\n\nè«‹æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ¯å…¥éé€™äº›è¨˜éŒ„ã€‚`);
                    return;
                } else {
                    const proceed = confirm(`ç™¼ç¾ ${duplicates.length} ç­†é‡è¤‡è¨˜éŒ„ï¼Œå°‡è·³éé€™äº›è¨˜éŒ„ã€‚\n\né‡è¤‡çš„è¨˜éŒ„ï¼š\n${duplicateInfo}\n\nç¢ºå®šè¦åŒ¯å…¥ ${newRecords.length} ç­†æ–°è¨˜éŒ„å—ï¼Ÿ`);
                    if (!proceed) {
                        return;
                    }
                }
            }

            if (confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${newRecords.length} ç­†è¨˜éŒ„å—ï¼Ÿ`)) {
                records = records.concat(newRecords);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ›åˆ°2025å¹´
                checkAndSwitchTo2025();
                
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateDataStats(); // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
                
                let message = `æˆåŠŸåŒ¯å…¥ ${newRecords.length} ç­†è¨˜éŒ„ï¼`;
                if (duplicates.length > 0) {
                    message += `\nè·³éäº† ${duplicates.length} ç­†é‡è¤‡è¨˜éŒ„ã€‚`;
                }
                alert(message);
                cancelImport();
            }
        }

        // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
        function checkForDuplicates(importRecords) {
            const newRecords = [];
            const duplicates = [];
            
            importRecords.forEach(importRecord => {
                // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰è¨˜éŒ„é‡è¤‡
                const isDuplicate = records.some(existingRecord => {
                    return existingRecord.member === importRecord.member &&
                           existingRecord.amount === importRecord.amount &&
                           existingRecord.mainCategory === importRecord.mainCategory &&
                           existingRecord.subCategory === importRecord.subCategory &&
                           existingRecord.date === importRecord.date &&
                           existingRecord.description === importRecord.description;
                });
                
                if (isDuplicate) {
                    duplicates.push(importRecord);
                } else {
                    newRecords.push(importRecord);
                }
            });
            
            return { newRecords, duplicates };
        }

        // å–æ¶ˆåŒ¯å…¥
        function cancelImport() {
            importData = [];
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFile').value = '';
        }

        // åŒ¯å‡ºç‚º CSV
        function exportToCSV() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            const csvContent = convertToCSV(records);
            downloadFile(csvContent, 'family_records.csv', 'text/csv');
        }

        // åŒ¯å‡ºç‚º Excel
        function exportToExcel() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(records.map(record => ({
                'æˆå“¡': record.member,
                'é‡‘é¡': (record.type === 'income' || record.type === 'refund') ? record.amount : -record.amount,
                'ä¸»é¡åˆ¥': record.mainCategory,
                'å­é¡åˆ¥': record.subCategory,
                'æè¿°': record.description,
                'æ—¥æœŸ': record.date
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'æ”¶æ”¯è¨˜éŒ„');
            
            XLSX.writeFile(workbook, 'family_records.xlsx');
        }

        // è½‰æ›ç‚º CSV æ ¼å¼
        function convertToCSV(data) {
            const headers = ['æˆå“¡', 'é‡‘é¡', 'ä¸»é¡åˆ¥', 'å­é¡åˆ¥', 'æè¿°', 'æ—¥æœŸ'];
            const csvRows = [headers.join(',')];
            
            data.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const values = [
                    record.member,
                    amount,
                    record.mainCategory,
                    record.subCategory,
                    `"${record.description}"`,
                    record.date
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // ä¸‹è¼‰æª”æ¡ˆ
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // å‰µå»ºç¤ºä¾‹ Excel æª”æ¡ˆ
        function createSampleExcel() {
            const sampleData = [
                {
                    'æˆå“¡': 'Kelvin',
                    'é‡‘é¡': '-1,200',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æ‰‹æ©Ÿè²» - 2025-01',
                    'æ—¥æœŸ': '2025-01-15'
                },
                {
                    'æˆå“¡': 'Phuong',
                    'é‡‘é¡': '-1,598',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ç¾é‡‘',
                    'æè¿°': 'ç¶²è·¯è²» - 2025-01',
                    'æ—¥æœŸ': '2025-01-15'
                },
                {
                    'æˆå“¡': 'å®¶ç”¨',
                    'é‡‘é¡': '-15,000',
                    'ä¸»é¡åˆ¥': 'å±…ä½',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æˆ¿ç§Ÿ - 2025-01',
                    'æ—¥æœŸ': '2025-01-01'
                },
                {
                    'æˆå“¡': 'å®¶ç”¨',
                    'é‡‘é¡': '50,000',
                    'ä¸»é¡åˆ¥': 'è–ªè³‡',
                    'å­é¡åˆ¥': 'ç¾é‡‘',
                    'æè¿°': 'Kelvin è–ªè³‡',
                    'æ—¥æœŸ': '2025-01-05'
                },
                {
                    'æˆå“¡': 'Kelvin',
                    'é‡‘é¡': '-1,979',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æ‰‹æ©Ÿæ¬ è²»',
                    'æ—¥æœŸ': '2025-01-20'
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(sampleData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ç¤ºä¾‹æ•¸æ“š');
            
            XLSX.writeFile(workbook, 'sample_family_records.xlsx');
            alert('ç¤ºä¾‹ Excel æª”æ¡ˆå·²å‰µå»ºï¼æ‚¨å¯ä»¥ä¸‹è¼‰ä¸¦ä¿®æ”¹å¾Œé‡æ–°ä¸Šå‚³æ¸¬è©¦ã€‚');
        }

        // æ‰‹å‹•ä¸‹è¼‰ data.json å‚™ä»½
        function downloadDataJson() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥å‚™ä»½ï¼');
                return;
            }

            const dataToSave = {
                records: records,
                settings: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString()
                }
            };
            
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`æˆåŠŸä¸‹è¼‰å‚™ä»½æª”æ¡ˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚\næª”æ¡ˆå: family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`);
        }

        // ä¸‹è¼‰ Excel æ ¼å¼å‚™ä»½ï¼ˆå¯é‡æ–°åŒ¯å…¥ï¼‰
        function downloadExcelBackup() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥å‚™ä»½ï¼');
                return;
            }

            // å°‡è¨˜éŒ„è½‰æ›ç‚º Excel æ ¼å¼
            const excelData = records.map(record => ({
                'æˆå“¡': record.member,
                'é‡‘é¡': (record.type === 'income' || record.type === 'refund') ? record.amount : -record.amount,
                'ä¸»é¡åˆ¥': record.mainCategory,
                'å­é¡åˆ¥': record.subCategory || '',
                'æè¿°': record.description || '',
                'æ—¥æœŸ': record.date
            }));

            // å‰µå»º Excel å·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'å®¶åº­æ”¶æ”¯è¨˜éŒ„');
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const fileName = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`æˆåŠŸä¸‹è¼‰ Excel å‚™ä»½æª”æ¡ˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚\næª”æ¡ˆå: ${fileName}\n\næ­¤æª”æ¡ˆå¯ä»¥ç›´æ¥é‡æ–°åŒ¯å…¥ç³»çµ±ã€‚`);
        }

        // ä¿®å¾©æ”¶å…¥è¨˜éŒ„ä¸ä¸€è‡´å•é¡Œ
        function fixIncomeRecords() {
            let fixedCount = 0;
            
            records.forEach(record => {
                // å¦‚æœ member æ˜¯ 'å®¶ç”¨'ï¼Œç¢ºä¿ type æ˜¯ 'income'
                if (record.member === 'å®¶ç”¨' && record.type !== 'income') {
                    record.type = 'income';
                    fixedCount++;
                    console.log('ä¿®å¾©è¨˜éŒ„:', record);
                }
                // æ³¨æ„ï¼šä¸å†å¼·åˆ¶æ‰€æœ‰æ”¶å…¥è¨˜éŒ„éƒ½è¨­ç‚ºå®¶ç”¨æˆå“¡
                // å› ç‚ºå…¶ä»–æˆå“¡ï¼ˆKelvinã€Phuongã€Ryanï¼‰ä¹Ÿå¯èƒ½æœ‰æ”¶å…¥è¨˜éŒ„
            });
            
            if (fixedCount > 0) {
                saveRecords();
                updateStats();
                updateDataStats();
                alert(`å·²ä¿®å¾© ${fixedCount} ç­†æ”¶å…¥è¨˜éŒ„çš„ä¸ä¸€è‡´å•é¡Œï¼\n\nç¾åœ¨ç¸½æ”¶å…¥æ‡‰è©²æ­£ç¢ºé¡¯ç¤ºäº†ã€‚`);
            } else {
                alert('æ²’æœ‰ç™¼ç¾éœ€è¦ä¿®å¾©çš„æ”¶å…¥è¨˜éŒ„ã€‚');
            }
        }

        // æ‰‹å‹•åŒæ­¥è³‡æ–™
        async function manualDataSync() {
            try {
                console.log('é–‹å§‹æ‰‹å‹•åŒæ­¥è³‡æ–™...');
                
                // é‡æ–°è¼‰å…¥ data.json
                await loadDataFromFile();
                
                // åŸ·è¡Œè³‡æ–™åŒæ­¥
                await syncDataBetweenSources();
                
                // æ›´æ–°é¡¯ç¤º
                updateDataStats();
                updateStats();
                updateMemberStats();
                showExpenseRecords(); // é¡¯ç¤ºç•¶æœˆæ”¯å‡ºè¨˜éŒ„
                updateAllRecords();
                
                alert(`è³‡æ–™åŒæ­¥å®Œæˆï¼\nç•¶å‰è¨˜éŒ„æ•¸é‡: ${records.length} ç­†\n\nå·²ç¢ºä¿ localStorage å’Œ data.json çš„è³‡æ–™ä¸€è‡´æ€§ã€‚`);
                
            } catch (error) {
                console.error('æ‰‹å‹•åŒæ­¥å¤±æ•—:', error);
                alert('è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
            }
        }

        // åŒ¯å‡ºåŒæ­¥æª”æ¡ˆï¼ˆå°ˆç‚ºè·¨ç€è¦½å™¨åŒæ­¥è¨­è¨ˆï¼‰
        function exportForSync() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒæ­¥ï¼');
                return;
            }

            try {
                const now = new Date();
                const syncData = {
                    records: records,
                    metadata: {
                        exportTime: now.toISOString(),
                        version: "1.0",
                        purpose: "cross-browser-sync",
                        recordCount: records.length
                    }
                };

                // å‰µå»ºä¸¦ä¸‹è¼‰åŒæ­¥æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(syncData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `family_sync_${formatDateToYYYYMMDD(now)}.json`;
                
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`åŒæ­¥æª”æ¡ˆå·²åŒ¯å‡ºï¼\n\næª”æ¡ˆåŒ…å« ${records.length} ç­†è¨˜éŒ„\næª”æ¡ˆå: family_sync_${formatDateToYYYYMMDD(now)}.json\n\nè«‹å°‡æ­¤æª”æ¡ˆåŒ¯å…¥åˆ°å…¶ä»–ç€è¦½å™¨ä¸­ã€‚`);
                
            } catch (error) {
                console.error('åŒ¯å‡ºåŒæ­¥æª”æ¡ˆå¤±æ•—:', error);
                alert('åŒ¯å‡ºåŒæ­¥æª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
            }
        }

        // åŒ¯å…¥åŒæ­¥æª”æ¡ˆ
        function importSyncFile() {
            const fileInput = document.getElementById('syncFile');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            console.log('é–‹å§‹åŒ¯å…¥åŒæ­¥æª”æ¡ˆ:', file.name, 'å¤§å°:', file.size, 'bytes');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const syncData = JSON.parse(e.target.result);
                    
                    // é©—è­‰æª”æ¡ˆæ ¼å¼
                    if (!syncData.records || !Array.isArray(syncData.records)) {
                        alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼\n\næª”æ¡ˆç¼ºå°‘ records é™£åˆ—ï¼Œè«‹ç¢ºä¿é¸æ“‡çš„æ˜¯å¾æœ¬ç³»çµ±åŒ¯å‡ºçš„åŒæ­¥æª”æ¡ˆã€‚');
                        return;
                    }
                    
                    // é©—è­‰è¨˜éŒ„æ ¼å¼
                    const invalidRecords = syncData.records.filter(record => 
                        !record.id || !record.member || !record.amount || !record.date
                    );
                    
                    if (invalidRecords.length > 0) {
                        alert(`æª”æ¡ˆåŒ…å« ${invalidRecords.length} ç­†æ ¼å¼ä¸æ­£ç¢ºçš„è¨˜éŒ„ï¼\n\nè«‹ç¢ºä¿é¸æ“‡çš„æ˜¯æœ‰æ•ˆçš„åŒæ­¥æª”æ¡ˆã€‚`);
                        return;
                    }

                    const importRecords = syncData.records;
                    const currentCount = records.length;
                    
                    console.log('åŒæ­¥æª”æ¡ˆè³‡è¨Š:');
                    console.log('- æª”æ¡ˆè¨˜éŒ„æ•¸:', importRecords.length);
                    console.log('- ç•¶å‰è¨˜éŒ„æ•¸:', currentCount);
                    console.log('- æª”æ¡ˆåŒ¯å‡ºæ™‚é–“:', syncData.metadata?.exportTime);
                    
                    // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
                    console.log('é–‹å§‹æª¢æŸ¥é‡è¤‡è¨˜éŒ„...');
                    const duplicateCheck = checkForDuplicates(importRecords);
                    const newRecords = duplicateCheck.newRecords;
                    const duplicates = duplicateCheck.duplicates;
                    
                    console.log('é‡è¤‡æª¢æŸ¥çµæœ:');
                    console.log('- æ–°è¨˜éŒ„æ•¸:', newRecords.length);
                    console.log('- é‡è¤‡è¨˜éŒ„æ•¸:', duplicates.length);

                    if (newRecords.length === 0) {
                        alert('æ²’æœ‰æ–°çš„è¨˜éŒ„éœ€è¦åŒ¯å…¥ï¼Œæ‰€æœ‰è¨˜éŒ„éƒ½å·²å­˜åœ¨ã€‚');
                        fileInput.value = '';
                        return;
                    }

                    // åˆä½µè¨˜éŒ„
                    console.log('é–‹å§‹åˆä½µè¨˜éŒ„...');
                    records = records.concat(newRecords);
                    console.log('è¨˜éŒ„åˆä½µå®Œæˆï¼Œç¸½è¨˜éŒ„æ•¸:', records.length);
                    
                    console.log('ä¿å­˜è¨˜éŒ„åˆ° localStorage...');
                    saveRecords();
                    console.log('è¨˜éŒ„ä¿å­˜å®Œæˆ');
                    
                    // æ›´æ–°é¡¯ç¤º
                    console.log('æ›´æ–°é¡¯ç¤º...');
                    updateDataStats();
                    updateStats();
                    updateMemberStats();
                    showExpenseRecords(); // é¡¯ç¤ºç•¶æœˆæ”¯å‡ºè¨˜éŒ„
                    updateAllRecords();
                    console.log('é¡¯ç¤ºæ›´æ–°å®Œæˆ');
                    
                    let message = `ğŸ‰ è·¨ç€è¦½å™¨åŒæ­¥å®Œæˆï¼\n\n`;
                    message += `âœ… åŒ¯å…¥ ${newRecords.length} ç­†æ–°è¨˜éŒ„\n`;
                    message += `â­ï¸ è·³é ${duplicates.length} ç­†é‡è¤‡è¨˜éŒ„\n`;
                    message += `ğŸ“Š ç¸½è¨˜éŒ„æ•¸: ${records.length} ç­†\n\n`;
                    message += `ğŸŒ ç¾åœ¨æ‰€æœ‰ç€è¦½å™¨éƒ½æœ‰ç›¸åŒçš„è³‡æ–™äº†ï¼\n\n`;
                    
                    if (syncData.metadata && syncData.metadata.exportTime) {
                        const exportTime = new Date(syncData.metadata.exportTime);
                        message += `ğŸ“… æª”æ¡ˆåŒ¯å‡ºæ™‚é–“: ${exportTime.toLocaleString('zh-TW')}\n\n`;
                    }
                    
                    message += `ğŸ’¡ å»ºè­°ï¼šå®šæœŸåœ¨ä¸åŒç€è¦½å™¨é–“åŒæ­¥è³‡æ–™ä»¥ä¿æŒä¸€è‡´æ€§ã€‚`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('è§£æåŒæ­¥æª”æ¡ˆå¤±æ•—:', error);
                    let errorMessage = 'æª”æ¡ˆè§£æå¤±æ•—ï¼\n\n';
                    
                    if (error.name === 'SyntaxError') {
                        errorMessage += 'éŒ¯èª¤åŸå› ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼ˆä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼‰\n\n';
                        errorMessage += 'è§£æ±ºæ–¹æ³•ï¼š\n';
                        errorMessage += '1. ç¢ºä¿é¸æ“‡çš„æ˜¯å¾æœ¬ç³»çµ±åŒ¯å‡ºçš„åŒæ­¥æª”æ¡ˆ\n';
                        errorMessage += '2. æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å®Œæ•´ä¸‹è¼‰\n';
                        errorMessage += '3. å˜—è©¦é‡æ–°åŒ¯å‡ºåŒæ­¥æª”æ¡ˆ';
                    } else {
                        errorMessage += `éŒ¯èª¤è©³æƒ…ï¼š${error.message}\n\n`;
                        errorMessage += 'è«‹æª¢æŸ¥æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Š';
                    }
                    
                    alert(errorMessage);
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }

        // æ‰‹å‹•å¾å‚™ä»½æ¢å¾©è³‡æ–™
        function manualRestoreFromBackup() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
            
            if (backupKeys.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°ä»»ä½•å‚™ä»½æª”æ¡ˆï¼');
                return;
            }
            
            // æŒ‰æ™‚é–“æ’åºï¼Œé¸æ“‡æœ€æ–°çš„å‚™ä»½
            backupKeys.sort();
            const latestBackupKey = backupKeys[backupKeys.length - 1];
            const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
            
            if (backupData && backupData.records && backupData.records.length > 0) {
                const confirmRestore = confirm(
                    `æ‰¾åˆ°å‚™ä»½æª”æ¡ˆï¼\n\n` +
                    `å‚™ä»½æ™‚é–“: ${new Date(backupData.metadata.backupTime).toLocaleString('zh-TW')}\n` +
                    `è¨˜éŒ„æ•¸é‡: ${backupData.records.length} ç­†\n\n` +
                    `ç¢ºå®šè¦æ¢å¾©é€™å€‹å‚™ä»½å—ï¼Ÿ\nï¼ˆé€™æœƒè¦†è“‹ç•¶å‰çš„è³‡æ–™ï¼‰`
                );
                
                if (confirmRestore) {
                    records = backupData.records;
                    localStorage.setItem('familyRecords', JSON.stringify(records));
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateDataStats();
                    displayRecords();
                    
                    alert(`è³‡æ–™æ¢å¾©æˆåŠŸï¼\n\næ¢å¾©äº† ${records.length} ç­†è¨˜éŒ„\nå‚™ä»½æ™‚é–“: ${new Date(backupData.metadata.backupTime).toLocaleString('zh-TW')}`);
                }
            } else {
                alert('å‚™ä»½æª”æ¡ˆæå£æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼');
            }
        }

        // é¡¯ç¤ºå‚™ä»½è³‡è¨Š
        function showBackupInfo() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
            
            if (backupKeys.length === 0) {
                alert('ç›®å‰æ²’æœ‰è‡ªå‹•å‚™ä»½æª”æ¡ˆã€‚\n\nç³»çµ±æœƒåœ¨æ‚¨é€²è¡Œæ“ä½œæ™‚è‡ªå‹•å‰µå»ºå‚™ä»½ã€‚');
                return;
            }
            
            let backupInfo = 'ğŸ“‹ å‚™ä»½æª”æ¡ˆè³‡è¨Šï¼š\n\n';
            
            backupKeys.sort().forEach((key, index) => {
                try {
                    const backupData = JSON.parse(localStorage.getItem(key));
                    const backupTime = new Date(backupData.metadata.backupTime);
                    backupInfo += `${index + 1}. ${key}\n`;
                    backupInfo += `   æ™‚é–“: ${backupTime.toLocaleString('zh-TW')}\n`;
                    backupInfo += `   è¨˜éŒ„æ•¸: ${backupData.records.length} ç­†\n\n`;
                } catch (error) {
                    backupInfo += `${index + 1}. ${key} (æå£)\n\n`;
                }
            });
            
            backupInfo += `ğŸ’¡ æç¤ºï¼š\n`;
            backupInfo += `â€¢ ç³»çµ±æœƒè‡ªå‹•ä¿ç•™æœ€è¿‘ 5 å€‹å‚™ä»½\n`;
            backupInfo += `â€¢ æ¯ 5 æ¬¡æ“ä½œæœƒå‰µå»ºä¸€æ¬¡å‚™ä»½\n`;
            backupInfo += `â€¢ å»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½æª”æ¡ˆåˆ°æœ¬åœ°\n`;
            
            alert(backupInfo);
        }











        // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
        function updateDataStats() {
            const totalRecords = records.length;
            const incomeRecords = records.filter(r => r.type === 'income').length;
            const expenseRecords = records.filter(r => r.type === 'expense').length;
            const dataSize = (JSON.stringify(records).length / 1024).toFixed(2);
            const operationCount = parseInt(localStorage.getItem('backupCount') || '0');
            const lastBackup = localStorage.getItem('lastBackupTime') || 'æœªå‚™ä»½';

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('incomeRecords').textContent = incomeRecords;
            document.getElementById('expenseRecords').textContent = expenseRecords;
            document.getElementById('dataSize').textContent = dataSize + ' KB';
            document.getElementById('operationCount').textContent = operationCount;
            document.getElementById('lastBackup').textContent = lastBackup;
        }

        // é è¦½åˆªé™¤
        function previewDelete() {
            const memberFilter = document.getElementById('deleteMemberFilter').value;
            const typeFilter = document.getElementById('deleteTypeFilter').value;
            const dateFrom = document.getElementById('deleteDateFrom').value;
            const dateTo = document.getElementById('deleteDateTo').value;

            deleteData = records.filter(record => {
                const matchesMember = !memberFilter || record.member === memberFilter;
                const matchesType = !typeFilter || record.type === typeFilter;
                const matchesDateFrom = !dateFrom || record.date >= dateFrom;
                const matchesDateTo = !dateTo || record.date <= dateTo;

                return matchesMember && matchesType && matchesDateFrom && matchesDateTo;
            });

            if (deleteData.length === 0) {
                alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„å¯ä»¥åˆªé™¤ï¼');
                return;
            }

            showDeletePreview();
        }

        // é¡¯ç¤ºåˆªé™¤é è¦½
        function showDeletePreview() {
            const previewDiv = document.getElementById('deletePreview');
            const tableBody = document.getElementById('deletePreviewTableBody');
            
            tableBody.innerHTML = '';
            
            deleteData.forEach((record, index) => {
                const row = document.createElement('tr');
                let amountDisplay;
                if (record.type === 'income' || record.type === 'refund') {
                    amountDisplay = `+$${record.amount.toLocaleString()}`;
                } else {
                    amountDisplay = `-$${record.amount.toLocaleString()}`;
                }
                
                let color;
                if (record.type === 'income') {
                    color = '#51cf66';
                } else if (record.type === 'refund') {
                    color = '#28a745';
                } else if (record.type === 'creditPayment') {
                    color = '#ff6b35';
                } else {
                    color = '#ff6b6b';
                }
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${color}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // ç¢ºèªåˆªé™¤
        function confirmDelete() {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${deleteData.length} ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                // å¾ records ä¸­ç§»é™¤è¦åˆªé™¤çš„è¨˜éŒ„
                records = records.filter(record => !deleteData.includes(record));
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateDataStats();
                cancelDelete();
                
                alert(`æˆåŠŸåˆªé™¤ ${deleteData.length} ç­†è¨˜éŒ„ï¼`);
            }
        }

        // å–æ¶ˆåˆªé™¤
        function cancelDelete() {
            deleteData = [];
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteMemberFilter').value = '';
            document.getElementById('deleteTypeFilter').value = '';
            document.getElementById('deleteDateFrom').value = '';
            document.getElementById('deleteDateTo').value = '';
        }

        // æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
        function clearAllData() {
            if (records.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥æ¸…ç©ºï¼');
                return;
            }

            const confirmMessage = `âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡æ¸…ç©ºæ‰€æœ‰ ${records.length} ç­†è¨˜éŒ„ï¼\n\næ­¤æ“ä½œå°‡ï¼š\n- åˆªé™¤æ‰€æœ‰æ”¶æ”¯è¨˜éŒ„\n- æ¸…ç©ºçµ±è¨ˆæ•¸æ“š\n- ç„¡æ³•å¾©åŸ\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm('æœ€å¾Œç¢ºèªï¼šæ‚¨çœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\n\nè«‹è¼¸å…¥ "YES" ä¾†ç¢ºèªï¼ˆè«‹æ‰‹å‹•è¼¸å…¥ YESï¼‰');
                
                if (doubleConfirm) {
                    const userInput = prompt('è«‹è¼¸å…¥ "YES" ä¾†ç¢ºèªæ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼š');
                    
                    if (userInput === 'YES') {
                        records = [];
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                        updateDataStats();
                        
                        alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©ºï¼');
                    } else {
                        alert('æ“ä½œå·²å–æ¶ˆã€‚');
                    }
                }
            }
        }

        // å‚™ä»½æ•¸æ“š
        function backupData() {
            if (records.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥å‚™ä»½ï¼');
                return;
            }

            dataBackup = JSON.parse(JSON.stringify(records));
            const backupData = {
                timestamp: new Date().toISOString(),
                records: dataBackup,
                count: records.length
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`æ•¸æ“šå‚™ä»½å®Œæˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚`);
        }

        // é‚„åŸæ•¸æ“š
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.records || !Array.isArray(backupData.records)) {
                            alert('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ï¼');
                            return;
                        }

                        const confirmMessage = `æ‰¾åˆ°å‚™ä»½æ•¸æ“šï¼š\n- å‚™ä»½æ™‚é–“ï¼š${backupData.timestamp}\n- è¨˜éŒ„æ•¸é‡ï¼š${backupData.count}\n\nç¢ºå®šè¦é‚„åŸé€™äº›æ•¸æ“šå—ï¼Ÿ\nï¼ˆç•¶å‰æ•¸æ“šå°‡è¢«è¦†è“‹ï¼‰`;
                        
                        if (confirm(confirmMessage)) {
                            records = backupData.records;
                            saveRecords();
                            updateStats();
                            updateRecentRecords();
                            updateAllRecords();
                            updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                            updateDataStats();
                            
                            alert(`æ•¸æ“šé‚„åŸå®Œæˆï¼\né‚„åŸäº† ${records.length} ç­†è¨˜éŒ„ã€‚`);
                        }
                    } catch (error) {
                        alert('è®€å–å‚™ä»½æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== åœ–è¡¨ç›¸é—œå‡½æ•¸ ====================

        // åˆå§‹åŒ–æ‰€æœ‰åœ–è¡¨
        function initializeCharts() {
            console.log('åˆå§‹åŒ–åœ–è¡¨...');
            console.log('ç•¶å‰è¨˜éŒ„æ•¸é‡:', records.length);
            console.log('è¨˜éŒ„å…§å®¹:', records);
            
            // æª¢æŸ¥ Chart.js æ˜¯å¦è¼‰å…¥
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªè¼‰å…¥');
                showErrorMessage('åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }
            
            setCurrentMonth();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
            if (records.length === 0) {
                console.log('æ²’æœ‰è¨˜éŒ„æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯');
                showNoDataMessage();
                return;
            }
            
            updateCharts();
        }

        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        function showErrorMessage(message) {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <h4>âŒ åœ–è¡¨è¼‰å…¥å¤±æ•—</h4>
                            <p>${message}</p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                                é‡æ–°æ•´ç†é é¢
                            </button>
                        </div>
                    `;
                }
            });
        }

        // é¡¯ç¤ºç„¡æ•¸æ“šæç¤º
        function showNoDataMessage() {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h4>ğŸ“Š æš«ç„¡æ•¸æ“š</h4>
                            <p>è«‹å…ˆæ–°å¢ä¸€äº›æ”¶æ”¯è¨˜éŒ„ï¼Œç„¶å¾Œå†æŸ¥çœ‹åœ–è¡¨</p>
                            <button class="btn" onclick="showTab('add')" style="margin-top: 15px;">
                                å‰å¾€æ–°å¢è¨˜éŒ„
                            </button>
                        </div>
                    `;
                }
            });
        }

        // è¨­ç½®ç•¶å‰æœˆä»½ç‚ºé»˜èªé¸ä¸­
        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() è¿”å› 0-11
            const monthSelect = document.getElementById('chartMonth');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateCharts() {
            const year = parseInt(document.getElementById('chartYear').value);
            const month = parseInt(document.getElementById('chartMonth').value);
            
            console.log('æ›´æ–°åœ–è¡¨:', { year, month });
            
            updateTrendChart(year, month);
            updateCategoryChart(year, month);
            updateMemberChart(year, month);
        }

        // é‡æ–°æ•´ç†åœ–è¡¨
        function refreshCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (memberChart) memberChart.destroy();
            
            updateCharts();
        }

        // ç²å–æŒ‡å®šæœˆä»½çš„æ•¸æ“š
        function getDataByMonth(year, month) {
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // getMonth() è¿”å› 0-11ï¼Œéœ€è¦ +1
                
                return recordYear === year && recordMonth === month;
            });
            
            return filteredRecords;
        }

        // æ›´æ–°æ”¶æ”¯è¶¨å‹¢åœ–è¡¨
        function updateTrendChart(year, month) {
            console.log('æ›´æ–°æ”¶æ”¯è¶¨å‹¢åœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° trendChart canvas å…ƒç´ ');
                return;
            }
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('è¶¨å‹¢åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processDailyTrendData(data, year, month);
            console.log('è™•ç†å¾Œçš„è¶¨å‹¢åœ–è¡¨æ•¸æ“š:', chartData);
            
            trendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: chartData.income,
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: chartData.expense,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æ¯æ—¥æ”¶æ”¯è¶¨å‹¢`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }


        // æ›´æ–°é¡åˆ¥çµ±è¨ˆåœ–è¡¨
        function updateCategoryChart(year, month) {
            console.log('æ›´æ–°é¡åˆ¥çµ±è¨ˆåœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('categoryChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° categoryChart canvas å…ƒç´ ');
                return;
            }
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('é¡åˆ¥åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processCategoryData(data);
            console.log('è™•ç†å¾Œçš„é¡åˆ¥åœ–è¡¨æ•¸æ“š:', chartData);
            
            categoryChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æ”¯å‡ºé¡åˆ¥çµ±è¨ˆ`
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°æˆå“¡æ”¶æ”¯å°æ¯”åœ–è¡¨
        function updateMemberChart(year, month) {
            console.log('æ›´æ–°æˆå“¡æ”¶æ”¯å°æ¯”åœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('memberChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° memberChart canvas å…ƒç´ ');
                return;
            }
            
            if (memberChart) {
                memberChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('æˆå“¡åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processMemberData(data);
            console.log('è™•ç†å¾Œçš„æˆå“¡åœ–è¡¨æ•¸æ“š:', chartData);
            
            memberChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: chartData.income,
                            backgroundColor: 'rgba(81, 207, 102, 0.8)',
                            borderColor: '#51cf66',
                            borderWidth: 1
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: chartData.expense,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æˆå“¡æ”¶æ”¯å°æ¯”`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // è™•ç†æ¯æ—¥è¶¨å‹¢æ•¸æ“š
        function processDailyTrendData(data, year, month) {
            const groupedData = {};
            
            // ç²å–è©²æœˆçš„å¤©æ•¸
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // åˆå§‹åŒ–æ‰€æœ‰å¤©æ•¸
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day).padStart(2, '0');
                groupedData[dayKey] = { income: 0, expense: 0 };
            }
            
            // è™•ç†å¯¦éš›æ•¸æ“š
            data.forEach(record => {
                const date = new Date(record.date);
                const day = String(date.getDate()).padStart(2, '0');
                
                if (record.type === 'income') {
                    groupedData[day].income += record.amount;
                } else {
                    groupedData[day].expense += record.amount;
                }
            });
            
            const labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
            const income = labels.map(day => groupedData[day].income);
            const expense = labels.map(day => groupedData[day].expense);
            
            return { labels, income, expense };
        }


        // è™•ç†é¡åˆ¥æ•¸æ“š
        function processCategoryData(data) {
            const categoryTotals = {};
            
            data.filter(record => record.type === 'expense').forEach(record => {
                const category = record.mainCategory;
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += record.amount;
            });
            
            // æŒ‰é‡‘é¡æ’åº
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // åªé¡¯ç¤ºå‰10å€‹é¡åˆ¥
            
            const labels = sortedCategories.map(([category]) => category);
            const values = sortedCategories.map(([, amount]) => amount);
            
            return { labels, values };
        }

        // è™•ç†æˆå“¡æ•¸æ“š
        function processMemberData(data) {
            const memberTotals = {};
            
            data.forEach(record => {
                const member = record.member;
                
                if (!memberTotals[member]) {
                    memberTotals[member] = { income: 0, expense: 0 };
                }
                
                if (record.type === 'income') {
                    memberTotals[member].income += record.amount;
                } else {
                    memberTotals[member].expense += record.amount;
                }
            });
            
            // æŒ‰ç…§æŒ‡å®šé †åºæ’åˆ—ï¼šKelvinã€Phuongã€Ryanã€å®¶ç”¨
            const orderedMembers = ['Kelvin', 'Phuong', 'Ryan', 'å®¶ç”¨'];
            const labels = orderedMembers.filter(member => memberTotals[member]);
            const income = labels.map(member => memberTotals[member].income);
            const expense = labels.map(member => memberTotals[member].expense);
            
            return { labels, income, expense };
        }

    </script>
</body>
</html>
