<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ”¶æ”¯å¹³å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .member-stats {
            margin-bottom: 30px;
        }

        .record-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .member-stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .member-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .record-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-item.income {
            border-left-color: #51cf66;
        }

        .record-item.expense {
            border-left-color: #ff6b6b;
        }

        .record-info {
            flex: 1;
        }

        .record-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-amount {
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #51cf66;
        }

        .record-amount.expense {
            color: #ff6b6b;
        }

        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-records {
            font-size: 12px;
            margin-top: 5px;
        }

        .day-income {
            color: #51cf66;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(81, 207, 102, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-expense {
            color: #ff6b6b;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .import-section, .export-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .import-section h3, .export-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-card h4 {
            margin-bottom: 10px;
            color: #4facfe;
        }

        .import-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-card li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .import-card input[type="file"] {
            display: none;
        }

        .import-card button {
            margin-top: 15px;
        }

        .import-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .preview-table .status-valid {
            color: #51cf66;
        }

        .preview-table .status-invalid {
            color: #ff6b6b;
        }

        .import-actions, .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-section h3 {
            color: white;
        }

        .export-section p {
            opacity: 0.9;
        }

        .delete-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border: 1px solid #fed7d7;
        }

        .delete-section h3 {
            margin-bottom: 15px;
            color: #e53e3e;
        }

        .delete-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .delete-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .delete-card h4 {
            margin-bottom: 10px;
            color: #e53e3e;
        }

        .delete-card p {
            margin-bottom: 15px;
            color: #666;
        }

        #dataStats p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        #dataStats span {
            font-weight: bold;
            color: #e53e3e;
        }

        .filter-delete {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-delete select,
        .filter-delete input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e53e3e;
        }

        .delete-preview h4 {
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .delete-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* åœ–è¡¨é é¢æ¨£å¼ */
        .chart-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-amount {
                margin: 10px 0;
            }

            .import-options {
                grid-template-columns: 1fr;
            }

            .import-actions, .export-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° å®¶åº­æ”¶æ”¯å¹³å°</h1>
            <p>è¼•é¬†ç®¡ç†æ‚¨çš„å®¶åº­è²¡å‹™</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š ç¸½è¦½</button>
            <button class="nav-tab" onclick="showTab('list')">ğŸ“‹ åˆ—è¡¨</button>
            <button class="nav-tab" onclick="showTab('calendar')">ğŸ“… æ—¥æ›†</button>
            <button class="nav-tab" onclick="showTab('charts')">ğŸ“ˆ åœ–è¡¨</button>
            <button class="nav-tab" onclick="showTab('add')">â• æ–°å¢</button>
            <button class="nav-tab" onclick="showTab('import')">ğŸ“¥ åŒ¯å…¥</button>
        </div>

        <div class="content">
            <!-- ç¸½è¦½é é¢ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalExpense">$0</h3>
                        <p>ç¸½æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashExpense">$0</h3>
                        <p>ç¾é‡‘æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="creditExpense">$0</h3>
                        <p>ä¿¡ç”¨å¡æ”¯å‡º</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="balance">$0</h3>
                        <p>ç¾é‡‘æµ</p>
                    </div>
                </div>
                <div class="member-stats">
                    <h3>å„æˆå“¡æ”¶æ”¯çµ±è¨ˆ</h3>
                    <div class="member-stats-grid" id="memberStats"></div>
                </div>
                <div class="records-list">
                    <h3>è¨˜éŒ„æŸ¥çœ‹</h3>
                    <div class="record-filter-tabs">
                        <button class="filter-tab active" onclick="showExpenseRecords()">ç¸½æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showCashExpenseRecords()">ç¾é‡‘æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showCreditExpenseRecords()">ä¿¡ç”¨å¡æ”¯å‡º</button>
                        <button class="filter-tab" onclick="showIncomeRecords()">ç¸½æ”¶å…¥</button>
                        <button class="filter-tab" onclick="showAllRecords()">å…¨éƒ¨è¨˜éŒ„</button>
                    </div>
                    <div id="recentRecords"></div>
                </div>
            </div>

            <!-- åˆ—è¡¨é é¢ -->
            <div id="list" class="tab-content">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="æœå°‹è¨˜éŒ„..." onkeyup="filterRecords()">
                    <select id="memberFilter" onchange="filterRecords()">
                        <option value="">æ‰€æœ‰æˆå“¡</option>
                        <option value="Kelvin">Kelvin</option>
                        <option value="Phuong">Phuong</option>
                        <option value="Ryan">Ryan</option>
                        <option value="å®¶ç”¨">å®¶ç”¨</option>
                    </select>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option value="income">æ”¶å…¥</option>
                        <option value="expense">æ”¯å‡º</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRecords()">
                </div>
                <div class="records-list">
                    <div id="allRecords"></div>
                </div>
            </div>

            <!-- æ—¥æ›†é é¢ -->
            <div id="calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â€¹ ä¸Šæœˆ</button>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">ä¸‹æœˆ â€º</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- åœ–è¡¨é é¢ -->
            <div id="charts" class="tab-content">
                <div class="chart-controls">
                    <div class="chart-filter-bar">
                        <select id="chartYear" onchange="updateCharts()">
                            <option value="2024">2024å¹´</option>
                            <option value="2025" selected>2025å¹´</option>
                        </select>
                        <select id="chartMonth" onchange="updateCharts()">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                        <button class="btn" onclick="refreshCharts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                </div>

                <!-- æ”¶æ”¯è¶¨å‹¢åœ–è¡¨ -->
                <div class="chart-section">
                    <h3>ğŸ“ˆ æ”¶æ”¯è¶¨å‹¢</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- é¡åˆ¥çµ±è¨ˆåœ–è¡¨ -->
                <div class="chart-section">
                    <h3>ğŸ¥§ é¡åˆ¥çµ±è¨ˆ</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- æˆå“¡æ”¶æ”¯å°æ¯” -->
                <div class="chart-section">
                    <h3>ğŸ‘¥ æˆå“¡æ”¶æ”¯å°æ¯”</h3>
                    <div class="chart-container">
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢é é¢ -->
            <div id="add" class="tab-content">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="member">æˆå“¡</label>
                            <select id="member" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="å®¶ç”¨">å®¶ç”¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">é‡‘é¡</label>
                            <input type="number" id="amount" step="0.01" required placeholder="æ­£æ•¸=æ”¶å…¥, è² æ•¸=æ”¯å‡º">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mainCategory">ä¸»é¡åˆ¥</label>
                            <select id="mainCategory" required onchange="handleMainCategoryChange()">
                                <option value="">è«‹é¸æ“‡</option>
                            </select>
                            <input type="text" id="customMainCategory" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="subCategory">ä»˜æ¬¾æ–¹å¼</label>
                            <select id="subCategory" required>
                                <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <textarea id="description" rows="3" placeholder="è«‹è¼¸å…¥è©³ç´°æè¿°..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <button type="submit" class="btn">æ–°å¢è¨˜éŒ„</button>
                </form>
            </div>

            <!-- åŒ¯å…¥é é¢ -->
            <div id="import" class="tab-content">
                <div class="import-section">
                    <h3>ğŸ“¥ åŒ¯å…¥æ”¶æ”¯è¨˜éŒ„</h3>
                    <p>æ”¯æ´ CSV å’Œ Excel æª”æ¡ˆæ ¼å¼</p>
                    
                    <div class="import-options">
                        <div class="import-card">
                            <h4>ğŸ“„ CSV æª”æ¡ˆåŒ¯å…¥</h4>
                            <p>è«‹ç¢ºä¿ CSV æª”æ¡ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                            <ul>
                                <li>æˆå“¡ (Kelvin, Phuong, Ryan, å®¶ç”¨)</li>
                                <li>é‡‘é¡ (æ­£æ•¸=æ”¶å…¥, è² æ•¸=æ”¯å‡º)</li>
                                <li>ä¸»é¡åˆ¥</li>
                                <li>ä»˜æ¬¾æ–¹å¼ (ä¿¡ç”¨å¡/ç¾é‡‘)</li>
                                <li>æè¿°</li>
                                <li>æ—¥æœŸ (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVImport(event)">
                            <button class="btn" onclick="document.getElementById('csvFile').click()">é¸æ“‡ CSV æª”æ¡ˆ</button>
                        </div>
                        
                        <div class="import-card">
                            <h4>ğŸ“Š Excel æª”æ¡ˆåŒ¯å…¥</h4>
                            <p>è«‹ç¢ºä¿ Excel æª”æ¡ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                            <ul>
                                <li>æˆå“¡ (Kelvin, Phuong, Ryan, å®¶ç”¨)</li>
                                <li>é‡‘é¡ (æ­£æ•¸=æ”¶å…¥, è² æ•¸=æ”¯å‡º)</li>
                                <li>ä¸»é¡åˆ¥</li>
                                <li>ä»˜æ¬¾æ–¹å¼ (ä¿¡ç”¨å¡/ç¾é‡‘)</li>
                                <li>æè¿°</li>
                                <li>æ—¥æœŸ (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                            <button class="btn" onclick="document.getElementById('excelFile').click()">é¸æ“‡ Excel æª”æ¡ˆ</button>
                        </div>
                    </div>
                    
                    <div class="import-preview" id="importPreview" style="display: none;">
                        <h4>é è¦½åŒ¯å…¥æ•¸æ“š</h4>
                        <div class="preview-table">
                            <table id="previewTable">
                                <thead>
                                    <tr>
                                        <th>æˆå“¡</th>
                                        <th>é‡‘é¡</th>
                                        <th>ä¸»é¡åˆ¥</th>
                                        <th>ä»˜æ¬¾æ–¹å¼</th>
                                        <th>æè¿°</th>
                                        <th>æ—¥æœŸ</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="import-actions">
                            <button class="btn btn-success" onclick="confirmImport()">ç¢ºèªåŒ¯å…¥</button>
                            <button class="btn btn-danger" onclick="cancelImport()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>ğŸ“¤ åŒ¯å‡ºåŠŸèƒ½</h3>
                    <p>å°‡ç¾æœ‰è¨˜éŒ„åŒ¯å‡ºç‚º CSV æˆ– Excel æª”æ¡ˆ</p>
                    <div class="export-actions">
                        <button class="btn" onclick="exportToCSV()">åŒ¯å‡ºç‚º CSV</button>
                        <button class="btn" onclick="exportToExcel()">åŒ¯å‡ºç‚º Excel</button>
                        <button class="btn" onclick="createSampleExcel()">å‰µå»ºç¤ºä¾‹ Excel</button>
                        <button class="btn" onclick="downloadDataJson()">ğŸ“ ä¸‹è¼‰ data.json å‚™ä»½</button>
                        <button class="btn" onclick="downloadExcelBackup()">ğŸ“Š ä¸‹è¼‰ Excel å‚™ä»½</button>
                    </div>
                </div>
                
                <div class="delete-section">
                    <h3>ğŸ—‘ï¸ ç§»é™¤è³‡æ–™åŠŸèƒ½</h3>
                    <p>ç®¡ç†æ‚¨çš„æ”¶æ”¯è¨˜éŒ„æ•¸æ“š</p>
                    
                    <div class="delete-options">
                        <div class="delete-card">
                            <h4>ğŸ”„ æ•¸æ“šåŒæ­¥</h4>
                            <div class="sync-info">
                                <p>åŒæ­¥ç‹€æ…‹ï¼š<span id="syncStatus">æª¢æŸ¥ä¸­...</span></p>
                                <p>æœ€å¾Œå‚™ä»½ï¼š<span id="lastBackup">æœªå‚™ä»½</span></p>
                                <p>æ•¸æ“šå¥åº·ï¼š<span id="dataHealth">æª¢æŸ¥ä¸­...</span></p>
                            </div>
                            <div class="sync-actions" style="margin-top: 15px;">
                                <button class="btn" onclick="manualSync()" style="margin-right: 10px;">ğŸ”„ ç«‹å³åŒæ­¥</button>
                                <button class="btn" onclick="clearCacheAndSync()" style="margin-right: 10px;">ğŸ—‘ï¸ æ¸…é™¤ç·©å­˜ä¸¦åŒæ­¥</button>
                                <button class="btn" onclick="checkDataHealth()" style="margin-right: 10px;">ğŸ” æ•¸æ“šå¥åº·æª¢æŸ¥</button>
                                <button class="btn" onclick="quickFix()" style="margin-right: 10px;">ğŸ”§ å¿«é€Ÿä¿®å¾©</button>
                                <button class="btn" onclick="toggleAutoSync()" id="autoSyncBtn">â¸ï¸ æš«åœè‡ªå‹•åŒæ­¥</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>ğŸ” ç¯©é¸åˆªé™¤</h4>
                            <p>æ ¹æ“šæ¢ä»¶åˆªé™¤è¨˜éŒ„</p>
                            <div class="filter-delete">
                            <select id="deleteMemberFilter">
                                <option value="">æ‰€æœ‰æˆå“¡</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="å®¶ç”¨">å®¶ç”¨</option>
                            </select>
                                <select id="deleteTypeFilter">
                                    <option value="">æ‰€æœ‰é¡å‹</option>
                                    <option value="income">æ”¶å…¥</option>
                                    <option value="expense">æ”¯å‡º</option>
                                </select>
                                <input type="date" id="deleteDateFrom" placeholder="é–‹å§‹æ—¥æœŸ">
                                <input type="date" id="deleteDateTo" placeholder="çµæŸæ—¥æœŸ">
                                <button class="btn btn-danger" onclick="previewDelete()">é è¦½åˆªé™¤</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>âš ï¸ å±éšªæ“ä½œ</h4>
                            <p>è«‹è¬¹æ…ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½</p>
                            <div class="danger-actions">
                                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
                                <button class="btn" onclick="backupData()">å‚™ä»½æ•¸æ“š</button>
                                <button class="btn" onclick="restoreData()">é‚„åŸæ•¸æ“š</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delete-preview" id="deletePreview" style="display: none;">
                        <h4>é è¦½å°‡è¦åˆªé™¤çš„è¨˜éŒ„</h4>
                        <div class="preview-table">
                            <table id="deletePreviewTable">
                                <thead>
                                    <tr>
                                        <th>æˆå“¡</th>
                                        <th>é‡‘é¡</th>
                                        <th>ä¸»é¡åˆ¥</th>
                                        <th>ä»˜æ¬¾æ–¹å¼</th>
                                        <th>æè¿°</th>
                                        <th>æ—¥æœŸ</th>
                                    </tr>
                                </thead>
                                <tbody id="deletePreviewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="delete-actions">
                            <button class="btn btn-danger" onclick="confirmDelete()">ç¢ºèªåˆªé™¤</button>
                            <button class="btn" onclick="cancelDelete()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨˜éŒ„çš„æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯è¨˜éŒ„</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMember">æˆå“¡</label>
                        <select id="editMember" required>
                            <option value="Kelvin">Kelvin</option>
                            <option value="Phuong">Phuong</option>
                            <option value="Ryan">Ryan</option>
                            <option value="å®¶ç”¨">å®¶ç”¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editType">é¡å‹</label>
                        <select id="editType" required>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">é‡‘é¡</label>
                        <input type="number" id="editAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="editMainCategory">ä¸»é¡åˆ¥</label>
                            <select id="editMainCategory" required onchange="handleEditMainCategoryChange()">
                            </select>
                            <input type="text" id="editCustomMainCategory" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥" style="display: none; margin-top: 10px;">
                        </div>
                    <div class="form-group">
                        <label for="editSubCategory">ä»˜æ¬¾æ–¹å¼</label>
                        <select id="editSubCategory" required>
                            <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                            <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                            <option value="ç¾é‡‘">ç¾é‡‘</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">æè¿°</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editDate">æ—¥æœŸ</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ  CSV å’Œ Excel è§£æåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- æ·»åŠ  Chart.js åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // æ•¸æ“šå­˜å„²
        let records = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // è·¨ç€è¦½å™¨æ•¸æ“šåŒæ­¥
        let syncInterval = null;
        let lastSyncTime = localStorage.getItem('lastSyncTime') || 0;

        // å¾æœå‹™å™¨åŒæ­¥æ•¸æ“š
        async function syncFromServer() {
            try {
                console.log('ğŸ”„ é–‹å§‹æª¢æŸ¥æœå‹™å™¨æ•¸æ“š...');
                const response = await fetch('http://localhost:3001/api/restore');
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ“¡ æœå‹™å™¨éŸ¿æ‡‰:', result);
                    
                    if (result.hasNewData) {
                        console.log('ğŸ”„ ç™¼ç¾æœå‹™å™¨æœ‰æ–°æ•¸æ“šï¼Œæ­£åœ¨åŒæ­¥...');
                        await loadDataFromFile();
                        updateAllDisplays();
                        localStorage.setItem('lastSyncTime', Date.now());
                        return true;
                    } else {
                        console.log('ğŸ“Š æœå‹™å™¨æ•¸æ“šå·²æ˜¯æœ€æ–°');
                        // å³ä½¿æ²’æœ‰æ–°æ•¸æ“šï¼Œä¹Ÿå¼·åˆ¶é‡æ–°è®€å–data.jsonä»¥ç¢ºä¿åŒæ­¥
                        await loadDataFromFile();
                        updateAllDisplays();
                        return false;
                    }
                } else {
                    console.warn('âš ï¸ æœå‹™å™¨éŸ¿æ‡‰éŒ¯èª¤:', response.status);
                }
            } catch (error) {
                console.warn('âš ï¸ æœå‹™å™¨åŒæ­¥å¤±æ•—:', error.message);
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œå˜—è©¦å¾æœ¬åœ°æ–‡ä»¶è®€å–
                try {
                    await loadDataFromFile();
                    console.log('ğŸ“ å·²å¾æœ¬åœ°æ–‡ä»¶è®€å–æ•¸æ“š');
                    return true;
                } catch (fileError) {
                    console.warn('âš ï¸ æœ¬åœ°æ–‡ä»¶è®€å–ä¹Ÿå¤±æ•—:', fileError.message);
                }
            }
            return false;
        }

        // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
        function updateAllDisplays() {
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
            updateMemberStats();
        }

        // å•Ÿå‹•è‡ªå‹•åŒæ­¥
        function startAutoSync() {
            // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡æœå‹™å™¨æ›´æ–°
            syncInterval = setInterval(async () => {
                console.log('ğŸ”„ è‡ªå‹•åŒæ­¥æª¢æŸ¥...');
                try {
                    const synced = await syncFromServer();
                    if (synced) {
                        console.log('âœ… è‡ªå‹•åŒæ­¥å®Œæˆ');
                        // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
                        const syncStatus = document.getElementById('syncStatus');
                        if (syncStatus) {
                            syncStatus.textContent = 'å·²åŒæ­¥';
                            setTimeout(() => {
                                syncStatus.textContent = 'é‹è¡Œä¸­';
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('âŒ è‡ªå‹•åŒæ­¥éŒ¯èª¤:', error);
                }
            }, 10000);

            console.log('ğŸ”„ è‡ªå‹•åŒæ­¥å·²å•Ÿå‹• (æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡)');
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡åŒæ­¥æª¢æŸ¥
            setTimeout(async () => {
                console.log('ğŸ”„ åˆå§‹åŒæ­¥æª¢æŸ¥...');
                try {
                    const synced = await syncFromServer();
                    if (synced) {
                        console.log('âœ… åˆå§‹åŒæ­¥å®Œæˆ');
                    }
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒæ­¥éŒ¯èª¤:', error);
                }
            }, 1000);
        }

        // åœæ­¢è‡ªå‹•åŒæ­¥
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('â¹ï¸ è‡ªå‹•åŒæ­¥å·²åœæ­¢');
            }
        }

        // æ‰‹å‹•åŒæ­¥
        async function manualSync() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'åŒæ­¥ä¸­...';
            
            try {
                console.log('ğŸ”„ æ‰‹å‹•åŒæ­¥é–‹å§‹...');
                const synced = await syncFromServer();
                if (synced) {
                    syncStatus.textContent = 'å·²åŒæ­¥';
                    alert('âœ… æ•¸æ“šåŒæ­¥å®Œæˆï¼');
                    console.log('âœ… æ‰‹å‹•åŒæ­¥æˆåŠŸ');
                } else {
                    syncStatus.textContent = 'å·²æ˜¯æœ€æ–°';
                    alert('ğŸ“Š æ•¸æ“šå·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                    console.log('ğŸ“Š æ•¸æ“šå·²æ˜¯æœ€æ–°');
                }
            } catch (error) {
                syncStatus.textContent = 'åŒæ­¥å¤±æ•—';
                alert('âŒ åŒæ­¥å¤±æ•—ï¼š' + error.message);
                console.error('âŒ æ‰‹å‹•åŒæ­¥å¤±æ•—:', error);
            }
        }

        // æ¸…é™¤ç·©å­˜ä¸¦åŒæ­¥
        async function clearCacheAndSync() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'æ¸…é™¤ç·©å­˜ä¸­...';
            
            try {
                console.log('ğŸ—‘ï¸ æ¸…é™¤localStorageç·©å­˜...');
                
                // æ¸…é™¤localStorageä¸­çš„èˆŠæ•¸æ“š
                localStorage.removeItem('familyRecords');
                localStorage.removeItem('lastSyncTime');
                localStorage.removeItem('lastGitHubBackup');
                localStorage.removeItem('lastLocalBackup');
                
                console.log('âœ… ç·©å­˜å·²æ¸…é™¤');
                
                // å¼·åˆ¶å¾æœå‹™å™¨é‡æ–°è®€å–æ•¸æ“š
                console.log('ğŸ”„ å¾æœå‹™å™¨é‡æ–°è®€å–æ•¸æ“š...');
                await loadDataFromFile();
                
                // æ›´æ–°æ‰€æœ‰UIé¡¯ç¤º
                console.log('ğŸ”„ æ›´æ–°UIé¡¯ç¤º...');
                updateStats();
                updateRecentRecords();
                updateCalendar();
                updateDataStats();
                updateMemberStats();
                updateAllRecords();
                showExpenseRecords(); // é¡¯ç¤ºæ”¯å‡ºè¨˜éŒ„
                
                syncStatus.textContent = 'å·²åŒæ­¥';
                alert('âœ… ç·©å­˜å·²æ¸…é™¤ï¼Œæ•¸æ“šå·²é‡æ–°åŒæ­¥ï¼');
                console.log('âœ… æ¸…é™¤ç·©å­˜ä¸¦åŒæ­¥æˆåŠŸï¼Œè¨˜éŒ„æ•¸é‡:', records.length);
                
            } catch (error) {
                syncStatus.textContent = 'åŒæ­¥å¤±æ•—';
                alert('âŒ æ¸…é™¤ç·©å­˜å¤±æ•—ï¼š' + error.message);
                console.error('âŒ æ¸…é™¤ç·©å­˜å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›è‡ªå‹•åŒæ­¥
        function toggleAutoSync() {
            const btn = document.getElementById('autoSyncBtn');
            const syncStatus = document.getElementById('syncStatus');
            
            if (syncInterval) {
                // åœæ­¢è‡ªå‹•åŒæ­¥
                stopAutoSync();
                btn.textContent = 'â–¶ï¸ å•Ÿå‹•è‡ªå‹•åŒæ­¥';
                btn.style.backgroundColor = '#28a745';
                syncStatus.textContent = 'å·²æš«åœ';
            } else {
                // å•Ÿå‹•è‡ªå‹•åŒæ­¥
                startAutoSync();
                btn.textContent = 'â¸ï¸ æš«åœè‡ªå‹•åŒæ­¥';
                btn.style.backgroundColor = '#ffc107';
                syncStatus.textContent = 'é‹è¡Œä¸­';
            }
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            const btn = document.getElementById('autoSyncBtn');
            
            if (syncInterval) {
                syncStatus.textContent = 'é‹è¡Œä¸­';
                btn.textContent = 'â¸ï¸ æš«åœè‡ªå‹•åŒæ­¥';
                btn.style.backgroundColor = '#ffc107';
            } else {
                syncStatus.textContent = 'å·²æš«åœ';
                btn.textContent = 'â–¶ï¸ å•Ÿå‹•è‡ªå‹•åŒæ­¥';
                btn.style.backgroundColor = '#28a745';
            }
        }

        // GitHubè‡ªå‹•å‚™ä»½åŠŸèƒ½
        async function backupToGitHub() {
            try {
                console.log('é–‹å§‹è‡ªå‹•å‚™ä»½åˆ°GitHub...');
                
                // ç›´æ¥èª¿ç”¨å¾Œç«¯APIå‚™ä»½
                const response = await fetch('http://localhost:3001/api/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        records: records,
                        timestamp: new Date().toISOString(),
                        count: records.length
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… æˆåŠŸå‚™ä»½åˆ°GitHub:', result.message);
                    localStorage.setItem('lastGitHubBackup', new Date().toISOString());
                    updateDataStats();
                    return true;
                } else {
                    const errorData = await response.json();
                    console.warn('âš ï¸ å‚™ä»½å¤±æ•—:', errorData.message);
                    localStorage.setItem('lastLocalBackup', new Date().toISOString());
                    return false;
                }
                
            } catch (error) {
                console.warn('âš ï¸ GitHubå‚™ä»½å¤±æ•—:', error.message);
                localStorage.setItem('lastLocalBackup', new Date().toISOString());
                return false;
            }
        }

        // å¾GitHubé‚„åŸæ•¸æ“š
        async function restoreFromGitHub() {
            try {
                console.log('æª¢æŸ¥GitHubä¸Šçš„æœ€æ–°æ•¸æ“š...');
                
                // ç›´æ¥èª¿ç”¨å¾Œç«¯APIæª¢æŸ¥
                const response = await fetch('http://localhost:3001/api/restore');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.hasNewData) {
                        console.log('ç™¼ç¾GitHubä¸Šæœ‰æ–°æ•¸æ“šï¼Œæ­£åœ¨åŒæ­¥...');
                        
                        // é‡æ–°è¼‰å…¥data.json
                        await loadDataFromFile();
                        
                        console.log('âœ… æˆåŠŸå¾GitHubé‚„åŸæ•¸æ“š');
                        return true;
                    } else {
                        console.log('GitHubæ•¸æ“šå·²æ˜¯æœ€æ–°');
                        return false;
                    }
                } else {
                    console.warn('âš ï¸ é‚„åŸæª¢æŸ¥å¤±æ•—:', response.status);
                    return false;
                }
                
            } catch (error) {
                console.warn('âš ï¸ GitHubé‚„åŸå¤±æ•—:', error.message);
                return false;
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰2025å¹´çš„è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡åˆ‡æ›åˆ°2025å¹´
        function checkAndSwitchTo2025() {
            const has2025Records = records.some(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === 2025;
            });
            
            if (has2025Records) {
                currentYear = 2025;
                console.log('æª¢æ¸¬åˆ°2025å¹´è¨˜éŒ„ï¼Œåˆ‡æ›æ—¥æ›†åˆ°2025å¹´');
                updateCalendar();
            }
        }
        let importData = []; // å„²å­˜è¦åŒ¯å…¥çš„æ•¸æ“š
        let deleteData = []; // å„²å­˜è¦åˆªé™¤çš„æ•¸æ“š
        let dataBackup = null; // æ•¸æ“šå‚™ä»½
        
        // åœ–è¡¨ç›¸é—œè®Šæ•¸
        let trendChart = null;
        let categoryChart = null;
        let memberChart = null;

        // é¡åˆ¥é¸é …
        const categories = {
            income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡æ”¶ç›Š', 'æˆ¿ç§Ÿæ”¶å…¥', 'å€Ÿæ¬¾æ”¶å…¥', 'ä»£ä»˜æ”¶å…¥', 'å…¶ä»–æ”¶å…¥'],
            expense: {
                'å¨›æ¨‚': [],
                'æ—¥å¸¸': [],
                'é¤é£²': [],
                'æ¥Šæ¢…': [],
                'äº¤é€š': [],
                'å…¶ä»–': [],
                'å¥åº·': [],
                'ç¦®ç‰©': [],
                'å­¸è²»': []
            }
        };

        // å®¶åº­æˆå“¡
        const familyMembers = ['Kelvin', 'Phuong', 'Ryan', 'å®¶ç”¨'];

        // å›ºå®šæ”¯å‡ºæé†’
        const recurringExpenses = [
            { name: 'æˆ¿ç§Ÿ', amount: 15000, day: 1, member: 'å®¶ç”¨' },
            { name: 'æˆ¿è²¸', amount: 21454, day: 1, member: 'å®¶ç”¨' },
            { name: 'æ‰‹æ©Ÿè²»', amount: 1200, day: 15, member: 'Kelvin' },
            { name: 'ç¶²è·¯è²»', amount: 1598, day: 15, member: 'Phuong' }
        ];

        // Safariå…¼å®¹æ€§æª¢æ¸¬å’Œä¿®å¾©
        function detectAndFixSafari() {
            const userAgent = navigator.userAgent;
            const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');
            
            if (isSafari) {
                console.log('ğŸ æª¢æ¸¬åˆ°Safariï¼ŒåŸ·è¡Œå…¼å®¹æ€§ä¿®å¾©...');
                
                // æ¸…é™¤Safariç·©å­˜
                localStorage.removeItem('familyRecords');
                localStorage.removeItem('lastSyncTime');
                localStorage.removeItem('lastGitHubBackup');
                localStorage.removeItem('lastLocalBackup');
                
                // æ·»åŠ Safariå°ˆç”¨æç¤º
                const safariNotice = document.createElement('div');
                safariNotice.id = 'safari-notice';
                safariNotice.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #ff6b6b;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                safariNotice.innerHTML = `
                    ğŸ Safariæ¨¡å¼ | 
                    <button onclick="forceRefreshData()" style="background: white; color: #ff6b6b; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px;">
                        å¼·åˆ¶åˆ·æ–°
                    </button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                        âœ•
                    </button>
                `;
                document.body.appendChild(safariNotice);
                
                // 5ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    if (safariNotice.parentElement) {
                        safariNotice.remove();
                    }
                }, 5000);
                
                console.log('âœ… Safariå…¼å®¹æ€§ä¿®å¾©å®Œæˆ');
            }
            
            return isSafari;
        }

        // å¼·åˆ¶åˆ·æ–°æ•¸æ“šï¼ˆSafariå°ˆç”¨ï¼‰
        async function forceRefreshData() {
            console.log('ğŸ”„ Safariå¼·åˆ¶åˆ·æ–°æ•¸æ“š...');
            
            try {
                const timestamp = new Date().getTime();
                const url = `data.json?t=${timestamp}`;
                console.log(`ä½¿ç”¨å¼·åˆ¶åˆ·æ–°URL: ${url}`);
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        
                        // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        updateSyncStatus();
                        
                        console.log(`âœ… Safariå¼·åˆ¶åˆ·æ–°æˆåŠŸï¼Œè¼‰å…¥ ${records.length} ç­†è¨˜éŒ„`);
                        alert(`âœ… Safariå¼·åˆ¶åˆ·æ–°æˆåŠŸï¼\nè¼‰å…¥ ${records.length} ç­†è¨˜éŒ„`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ Safariå¼·åˆ¶åˆ·æ–°å¤±æ•—:', error);
                alert('âŒ Safariå¼·åˆ¶åˆ·æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥æœå‹™ç‹€æ…‹');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOMå·²è¼‰å…¥ï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // æª¢æ¸¬ä¸¦ä¿®å¾©Safari
            const isSafari = detectAndFixSafari();
            console.log('ğŸŒ ç€è¦½å™¨æª¢æ¸¬:', isSafari ? 'Safari' : 'å…¶ä»–');
            
            initializeApp();
        });

        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚åŒæ­¥æ•¸æ“š
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ‘ï¸ é é¢é‡æ–°å¯è¦‹ï¼Œç«‹å³åŒæ­¥æ•¸æ“š');
                syncFromServer().then(synced => {
                    if (synced) {
                        console.log('âœ… é é¢å¯è¦‹æ€§åŒæ­¥å®Œæˆ');
                    }
                });
            }
        });

        // é é¢ç²å¾—ç„¦é»æ™‚åŒæ­¥æ•¸æ“š
        window.addEventListener('focus', function() {
            console.log('ğŸ¯ é é¢ç²å¾—ç„¦é»ï¼Œæª¢æŸ¥æ•¸æ“šæ›´æ–°');
            syncFromServer().then(synced => {
                if (synced) {
                    console.log('âœ… ç„¦é»åŒæ­¥å®Œæˆ');
                }
            });
        });

        async function initializeApp() {
            console.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            // ç¸½æ˜¯å¾æœå‹™å™¨è®€å–æœ€æ–°æ•¸æ“š
            console.log('ğŸ”„ å¾æœå‹™å™¨è®€å–æœ€æ–°æ•¸æ“š...');
            await loadDataFromFile();
            
            // ç¢ºä¿recordsè®Šé‡å·²æ›´æ–°
            console.log('ğŸ”„ åˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰è¨˜éŒ„æ•¸é‡:', records.length);
            console.log('ğŸ”„ è¨˜éŒ„å…§å®¹:', records);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰GitHubæ›´æ–°ï¼Œä½†ä¸è¦è¦†è“‹å·²è¼‰å…¥çš„æ•¸æ“š
            console.log('ğŸ” æª¢æŸ¥GitHubæ›´æ–°...');
            try {
                const response = await fetch('http://localhost:3001/api/restore');
                if (response.ok) {
                    const result = await response.json();
                    if (result.hasNewData) {
                        console.log('ğŸ“Š GitHubæ•¸æ“šå·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€è¦†è“‹æœ¬åœ°æ•¸æ“š');
                    } else {
                        console.log('ğŸ“Š GitHubæ•¸æ“šå·²æ˜¯æœ€æ–°');
                    }
                } else {
                    console.log('ğŸ“Š GitHubæª¢æŸ¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š');
                }
            } catch (error) {
                console.log('ğŸ“Š GitHubæª¢æŸ¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š:', error.message);
            }
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰è¨˜éŒ„æ•¸é‡:', records.length);
            console.log('è¨˜éŒ„å…§å®¹:', records);
            
            // å•Ÿå‹•è·¨ç€è¦½å™¨è‡ªå‹•åŒæ­¥
            startAutoSync();
            
            updateCategoryOptions();
            updateStats();
            updateMemberStats();
            showExpenseRecords(); // é»˜èªé¡¯ç¤ºç•¶æœˆç¸½æ”¯å‡ºè¨˜éŒ„
            updateAllRecords();
            updateCalendar();
            setTodayDate();
            updateDataStats();
            updateSyncStatus(); // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
            
            // å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œä¸è‡ªå‹•æ·»åŠ ç¤ºä¾‹æ•¸æ“š
            // if (records.length === 0) {
            //     addSampleData();
            // }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ›åˆ°2025å¹´
            checkAndSwitchTo2025();
            
            console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
        }

        // å¾æª”æ¡ˆè¼‰å…¥è³‡æ–™
        async function loadDataFromFile() {
            try {
                console.log('é–‹å§‹è¼‰å…¥ data.json...');
                // å˜—è©¦å¤šç¨®æ–¹æ³•è®€å–data.json
                let data = null;
                
                // æ–¹æ³•1: ä½¿ç”¨fetch (å¸¶æ™‚é–“æˆ³å¼·åˆ¶åˆ·æ–°)
                try {
                    const timestamp = new Date().getTime();
                    const url = `data.json?t=${timestamp}`;
                    console.log(`ä½¿ç”¨URL: ${url}`);
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        data = await response.json();
                        console.log('âœ… ä½¿ç”¨fetchæˆåŠŸè¼‰å…¥ data.json');
                    } else {
                        console.log('âŒ fetchè¼‰å…¥å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', response.status);
                    }
                } catch (fetchError) {
                    console.log('âŒ fetchè¼‰å…¥å¤±æ•—:', fetchError.message);
                    
                    // æ–¹æ³•2: ä½¿ç”¨XMLHttpRequest (å¸¶æ™‚é–“æˆ³å¼·åˆ¶åˆ·æ–°)
                    try {
                        const timestamp = new Date().getTime();
                        const url = `data.json?t=${timestamp}`;
                        console.log(`ä½¿ç”¨XHR URL: ${url}`);
                        
                        data = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState === 4) {
                                    if (xhr.status === 200) {
                                        try {
                                            resolve(JSON.parse(xhr.responseText));
                                        } catch (e) {
                                            reject(e);
                                        }
                                    } else {
                                        reject(new Error(`HTTP ${xhr.status}`));
                                    }
                                }
                            };
                            xhr.send();
                        });
                        console.log('âœ… ä½¿ç”¨XMLHttpRequestæˆåŠŸè¼‰å…¥ data.json');
                    } catch (xhrError) {
                        console.log('âŒ XMLHttpRequestè¼‰å…¥å¤±æ•—:', xhrError.message);
                    }
                }
                
                if (data) {
                    console.log('æˆåŠŸè¼‰å…¥ data.json:', data);
                    if (data.records && Array.isArray(data.records)) {
                        // å¦‚æœæª”æ¡ˆä¸­æœ‰è³‡æ–™ï¼Œä½¿ç”¨æª”æ¡ˆçš„è³‡æ–™ä¸¦æ›´æ–°localStorage
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('å¾ data.json è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                        console.log('è¨˜éŒ„å…§å®¹:', records);
                        console.log('âœ… å·²åŒæ­¥åˆ°localStorage');
                        console.log('ğŸ”„ å…¨å±€recordsè®Šé‡å·²æ›´æ–°ç‚º:', records.length, 'ç­†è¨˜éŒ„');
                    } else {
                        // å¦‚æœæª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥
                        const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                        if (localRecords.length > 0) {
                            records = localRecords;
                            console.log('å¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                        } else {
                            records = []; // ç¢ºä¿recordsæ˜¯ç©ºæ•¸çµ„
                            console.log('data.json å’Œ localStorage éƒ½æ²’æœ‰è³‡æ–™ï¼Œrecordsè¨­ç‚ºç©ºæ•¸çµ„');
                        }
                    }
                } else {
                    console.log('data.json è¼‰å…¥å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', response.status);
                    // å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                    if (localRecords.length > 0) {
                        records = localRecords;
                        console.log('å¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                    } else {
                        records = []; // ç¢ºä¿recordsæ˜¯ç©ºæ•¸çµ„
                        console.log('localStorage ä¹Ÿæ²’æœ‰è³‡æ–™ï¼Œrecordsè¨­ç‚ºç©ºæ•¸çµ„');
                    }
                }
            } catch (error) {
                console.log('ç„¡æ³•è¼‰å…¥ data.jsonï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥:', error);
                // å¦‚æœè¼‰å…¥æª”æ¡ˆå¤±æ•—ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                if (localRecords.length > 0) {
                    records = localRecords;
                    console.log('å¾ localStorage è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                } else {
                    records = []; // ç¢ºä¿recordsæ˜¯ç©ºæ•¸çµ„
                    console.log('localStorage ä¹Ÿæ²’æœ‰è³‡æ–™ï¼Œrecordsè¨­ç‚ºç©ºæ•¸çµ„');
                }
            }
        }

        // æ·»åŠ ç¤ºä¾‹æ•¸æ“š
        function addSampleData() {
            const today = new Date();
            const sampleRecords = [
                {
                    id: 'sample-1',
                    member: 'Kelvin',
                    type: 'expense',
                    amount: 1200,
                    mainCategory: 'æ—¥å¸¸',
                    subCategory: 'æ‰‹æ©Ÿè²»',
                    description: 'æ‰‹æ©Ÿè²»',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-2',
                    member: 'Phuong',
                    type: 'expense',
                    amount: 1598,
                    mainCategory: 'æ—¥å¸¸',
                    subCategory: 'ç¶²è·¯è²»',
                    description: 'ç¶²è·¯è²»',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-3',
                    member: 'å®¶ç”¨',
                    type: 'income',
                    amount: 50000,
                    mainCategory: 'è–ªè³‡',
                    subCategory: '',
                    description: 'Kelvin è–ªè³‡',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-4',
                    member: 'å®¶ç”¨',
                    type: 'expense',
                    amount: 15000,
                    mainCategory: 'å±…ä½',
                    subCategory: 'æˆ¿ç§Ÿ',
                    description: 'æˆ¿ç§Ÿ',
                    date: today.toISOString().split('T')[0]
                }
            ];
            
            records = records.concat(sampleRecords);
            saveRecords();
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
        }

        // çµ±ä¸€çš„æ—¥æœŸæ ¼å¼åŒ–å‡½æ•¸ï¼Œé¿å…æ™‚å€å•é¡Œ
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setTodayDate() {
            const today = formatDateToYYYYMMDD(new Date());
            document.getElementById('date').value = today;
        }

        function updateCategoryOptions() {
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');

            function updateMainCategories(amountInput, mainCategorySelect) {
                const amount = parseFloat(amountInput.value) || 0;
                // å¦‚æœé‡‘é¡ç‚º0æˆ–ç©ºï¼Œé»˜èªé¡¯ç¤ºæ”¯å‡ºé¡åˆ¥ï¼ˆå› ç‚ºå¤§éƒ¨åˆ†è¨˜éŒ„éƒ½æ˜¯æ”¯å‡ºï¼‰
                const type = (amount === 0 || isNaN(amount)) ? 'expense' : (amount >= 0 ? 'income' : 'expense');
                mainCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                
                console.log('updateMainCategories called:', { amount, type, inputValue: amountInput.value });
                
                if (type === 'income') {
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                } else if (type === 'expense') {
                    // ç²å–æ‰€æœ‰æ”¯å‡ºé¡åˆ¥ï¼ˆæ’é™¤"å…¶ä»–"ï¼‰
                    const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'å…¶ä»–');
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    // æ·»åŠ "å…¶ä»–"é¸é …
                    const otherOption = document.createElement('option');
                    otherOption.value = 'å…¶ä»–';
                    otherOption.textContent = 'å…¶ä»–';
                    mainCategorySelect.appendChild(otherOption);
                }
                
                console.log('ä¸»é¡åˆ¥é¸é …å·²æ›´æ–°ï¼Œæ•¸é‡:', mainCategorySelect.options.length);
            }

            amountInput.addEventListener('input', () => {
                updateMainCategories(amountInput, mainCategorySelect);
            });
            
            // åˆå§‹åŒ–æ™‚ä¹Ÿèª¿ç”¨ä¸€æ¬¡ï¼Œç¢ºä¿é é¢åŠ è¼‰æ™‚æœ‰æ­£ç¢ºçš„ç‹€æ…‹
            console.log('åˆå§‹åŒ–é¡åˆ¥é¸æ“‡å™¨...');
            updateMainCategories(amountInput, mainCategorySelect);

            // ç·¨è¼¯è¡¨å–®çš„äº‹ä»¶ç›£è½å™¨ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼Œå› ç‚ºç·¨è¼¯è¡¨å–®ä»æœ‰é¡å‹é¸æ“‡å™¨ï¼‰
            editTypeSelect.addEventListener('change', () => {
                updateMainCategories(editTypeSelect, editMainCategorySelect);
            });
        }

        // è™•ç†ä¸»é¡åˆ¥è®ŠåŒ–
        function handleMainCategoryChange() {
            const mainCategorySelect = document.getElementById('mainCategory');
            const customInput = document.getElementById('customMainCategory');
            
            if (mainCategorySelect.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // è™•ç†ç·¨è¼¯è¡¨å–®ä¸»é¡åˆ¥è®ŠåŒ–
        function handleEditMainCategoryChange() {
            const mainCategorySelect = document.getElementById('editMainCategory');
            const customInput = document.getElementById('editCustomMainCategory');
            
            if (mainCategorySelect.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ é¸ä¸­æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'dashboard' ? 'ç¸½è¦½' : 
                                           tabName === 'list' ? 'åˆ—è¡¨' :
                                           tabName === 'calendar' ? 'æ—¥æ›†' :
                                           tabName === 'add' ? 'æ–°å¢' :
                                           tabName === 'import' ? 'åŒ¯å…¥' : '')) {
                    tab.classList.add('active');
                }
            });

            // å¦‚æœåˆ‡æ›åˆ°æ—¥æ›†é é¢ï¼Œæ›´æ–°æ—¥æ›†
            if (tabName === 'calendar') {
                setTimeout(() => {
                    updateCalendar();
                }, 100);
            }
            
            // å¦‚æœåˆ‡æ›åˆ°åœ–è¡¨é é¢ï¼Œåˆå§‹åŒ–åœ–è¡¨
            if (tabName === 'charts') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // å¦‚æœåˆ‡æ›åˆ°åŒ¯å…¥é é¢ï¼Œæ›´æ–°åŒæ­¥ç‹€æ…‹
            if (tabName === 'import') {
                updateSyncStatus();
            }
        }

        function updateStats() {
            const totalIncome = records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // è¨ˆç®—ç¾é‡‘æ”¯å‡º
            const cashExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ç¾é‡‘')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // è¨ˆç®—ä¿¡ç”¨å¡æ”¯å‡º
            const creditExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ä¿¡ç”¨å¡')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // è¨ˆç®—å®¶ç”¨æ”¶å…¥ï¼ˆç¾é‡‘æµï¼‰
            const householdIncome = records
                .filter(record => record.member === 'å®¶ç”¨' && record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // ç¾é‡‘æµ = å®¶ç”¨æ”¶å…¥ - ç¾é‡‘æ”¯å‡º
            const cashFlow = householdIncome - cashExpense;

            document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
            document.getElementById('cashExpense').textContent = `$${cashExpense.toLocaleString()}`;
            document.getElementById('creditExpense').textContent = `$${creditExpense.toLocaleString()}`;
            document.getElementById('balance').textContent = `$${cashFlow.toLocaleString()}`;

            // æ›´æ–°å„æˆå“¡çµ±è¨ˆ
            updateMemberStats();
        }

        function updateMemberStats() {
            const memberStatsContainer = document.getElementById('memberStats');
            memberStatsContainer.innerHTML = '';

            console.log('updateMemberStats: ç¸½è¨˜éŒ„æ•¸', records.length);
            console.log('updateMemberStats: è¨˜éŒ„å…§å®¹', records);

            familyMembers.forEach(member => {
                const memberRecords = records.filter(record => record.member === member);
                console.log(`${member} çš„è¨˜éŒ„:`, memberRecords);
                
                const memberIncome = memberRecords
                    .filter(record => record.type === 'income')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberExpense = memberRecords
                    .filter(record => record.type === 'expense')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberBalance = memberIncome - memberExpense;
                
                console.log(`${member} çµ±è¨ˆ: æ”¶å…¥=${memberIncome}, æ”¯å‡º=${memberExpense}, é¤˜é¡=${memberBalance}`);

                const memberCard = document.createElement('div');
                memberCard.className = 'stat-card';
                memberCard.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                memberCard.style.cursor = 'pointer';
                memberCard.innerHTML = `
                    <h4>${member}</h4>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <small>æ”¶å…¥: $${memberIncome.toLocaleString()}</small><br>
                            <small>æ”¯å‡º: $${memberExpense.toLocaleString()}</small>
                        </div>
                        <div style="font-weight: bold; color: ${memberBalance >= 0 ? '#51cf66' : '#ff6b6b'};">
                            $${memberBalance.toLocaleString()}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        é»æ“ŠæŸ¥çœ‹è©³ç´°è¨˜éŒ„
                    </div>
                `;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                memberCard.addEventListener('click', () => {
                    showMemberRecords(member);
                });
                
                memberStatsContainer.appendChild(memberCard);
            });
        }

        // é¡¯ç¤ºæˆå“¡è©³ç´°è¨˜éŒ„
        function showMemberRecords(member) {
            const memberRecords = records.filter(record => record.member === member);
            
            if (memberRecords.length === 0) {
                alert(`${member} ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„ã€‚`);
                return;
            }
            
            const totalAmount = memberRecords.reduce((sum, record) => sum + record.amount, 0);
            
            // æ›´æ–°æ¨™ç±¤é ç‹€æ…‹
            updateFilterTabs('member');
            
            // é¡¯ç¤ºæˆå“¡è¨˜éŒ„
            displayRecords(memberRecords, `${member} çš„è¨˜éŒ„ (å…± ${memberRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºç¸½æ”¯å‡ºè¨˜éŒ„
        function showExpenseRecords() {
            console.log('showExpenseRecords è¢«èª¿ç”¨');
            console.log('ç•¶å‰è¨˜éŒ„ç¸½æ•¸:', records.length);
            console.log('è¨˜éŒ„å…§å®¹:', records);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            console.log('ç•¶å‰æœˆä»½:', currentMonth, 'ç•¶å‰å¹´ä»½:', currentYear);
            
            // æš«æ™‚ç§»é™¤æ—¥æœŸç¯©é¸ï¼Œé¡¯ç¤ºæ‰€æœ‰æ”¯å‡ºè¨˜éŒ„
            const expenseRecords = records.filter(record => {
                const isExpense = record.type === 'expense';
                console.log(`è¨˜éŒ„ ${record.id}: æˆå“¡=${record.member}, æ˜¯æ”¯å‡º=${isExpense}`);
                return isExpense;
            });
            
            console.log('ç¯©é¸å¾Œçš„æ”¯å‡ºè¨˜éŒ„:', expenseRecords);
            
            const totalAmount = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('expense');
            displayRecords(expenseRecords, `ç¸½æ”¯å‡ºè¨˜éŒ„ (å…± ${expenseRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºç¾é‡‘æ”¯å‡ºè¨˜éŒ„
        function showCashExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const cashExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ç¾é‡‘' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = cashExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('cash');
            displayRecords(cashExpenseRecords, `ç•¶æœˆç¾é‡‘æ”¯å‡ºè¨˜éŒ„ (å…± ${cashExpenseRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºä¿¡ç”¨å¡æ”¯å‡ºè¨˜éŒ„
        function showCreditExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const creditExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ä¿¡ç”¨å¡' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = creditExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('credit');
            displayRecords(creditExpenseRecords, `ç•¶æœˆä¿¡ç”¨å¡æ”¯å‡ºè¨˜éŒ„ (å…± ${creditExpenseRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºç¸½æ”¶å…¥è¨˜éŒ„
        function showIncomeRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const incomeRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.member === 'å®¶ç”¨' && record.type === 'income' && 
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('income');
            displayRecords(incomeRecords, `ç•¶æœˆç¸½æ”¶å…¥è¨˜éŒ„ (å…± ${incomeRecords.length} ç­†ï¼Œ$${totalAmount.toLocaleString()})`);
        }

        // é¡¯ç¤ºå…¨éƒ¨è¨˜éŒ„
        function showAllRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const allRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalIncome = allRecords.filter(r => r.member === 'å®¶ç”¨' && r.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = allRecords.filter(r => r.member === 'å®¶ç”¨' && r.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const netAmount = totalIncome - totalExpense;
            
            updateFilterTabs('all');
            displayRecords(allRecords, `ç•¶æœˆå…¨éƒ¨è¨˜éŒ„ (å…± ${allRecords.length} ç­†ï¼Œ$${netAmount.toLocaleString()})`);
        }

        // æ›´æ–°æ¨™ç±¤é ç‹€æ…‹
        function updateFilterTabs(activeType) {
            const tabs = document.querySelectorAll('.filter-tab');
            console.log('æ›´æ–°æ¨™ç±¤é ç‹€æ…‹:', activeType, 'æ¨™ç±¤æ•¸é‡:', tabs.length);
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('ç§»é™¤activeé¡åˆ¥:', tab.textContent);
            });
            
            if (activeType === 'expense') {
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    console.log('è¨­ç½®ç¸½æ”¯å‡ºç‚ºactive:', tabs[0].textContent);
                }
            } else if (activeType === 'cash') {
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    console.log('è¨­ç½®ç¾é‡‘æ”¯å‡ºç‚ºactive:', tabs[1].textContent);
                }
            } else if (activeType === 'credit') {
                if (tabs[2]) {
                    tabs[2].classList.add('active');
                    console.log('è¨­ç½®ä¿¡ç”¨å¡æ”¯å‡ºç‚ºactive:', tabs[2].textContent);
                }
            } else if (activeType === 'income') {
                if (tabs[3]) {
                    tabs[3].classList.add('active');
                    console.log('è¨­ç½®ç¸½æ”¶å…¥ç‚ºactive:', tabs[3].textContent);
                }
            } else if (activeType === 'all') {
                if (tabs[4]) {
                    tabs[4].classList.add('active');
                    console.log('è¨­ç½®å…¨éƒ¨è¨˜éŒ„ç‚ºactive:', tabs[4].textContent);
                }
            }
            // member é¡å‹ä¸æ›´æ–°æ¨™ç±¤é ï¼Œä¿æŒç•¶å‰ç‹€æ…‹
        }

        // é¡¯ç¤ºè¨˜éŒ„çš„é€šç”¨å‡½æ•¸
        function displayRecords(recordsToShow, title) {
            console.log('displayRecords è¢«èª¿ç”¨');
            console.log('è¦é¡¯ç¤ºçš„è¨˜éŒ„æ•¸é‡:', recordsToShow.length);
            console.log('æ¨™é¡Œ:', title);
            console.log('è¨˜éŒ„å…§å®¹:', recordsToShow);
            
            if (recordsToShow.length === 0) {
                console.log('æ²’æœ‰è¨˜éŒ„è¦é¡¯ç¤ºï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
                document.getElementById('recentRecords').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let recordsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #333; margin-bottom: 15px;">${title}</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            recordsToShow.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const amountClass = record.type === 'income' ? 'income' : 'expense';
                const prefix = record.type === 'income' ? '+' : '-';
                
                recordsHtml += `
                    <div class="record-item ${amountClass}" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; background: ${record.type === 'income' ? 'rgba(81, 207, 102, 0.1)' : 'rgba(255, 107, 107, 0.1)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.member} - ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}</strong>
                                <br>
                                <small style="color: #666;">${record.description || 'ç„¡æè¿°'}</small>
                                <br>
                                <small style="color: #999;">${record.date}</small>
                            </div>
                            <div style="font-weight: bold; color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'};">
                                ${prefix}$${record.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('recentRecords').innerHTML = recordsHtml;
        }

        function updateRecentRecords() {
            const recentRecords = records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentRecords');
            container.innerHTML = '';
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            recentRecords.forEach(record => {
                const recordElement = createRecordElement(record);
                container.appendChild(recordElement);
            });
        }

        function updateAllRecords() {
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        function createRecordElement(record) {
            const div = document.createElement('div');
            div.className = `record-item ${record.type}`;
            
            const amountClass = record.type === 'income' ? 'income' : 'expense';
            const amountPrefix = record.type === 'income' ? '+' : '-';
            const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
            
            div.innerHTML = `
                <div class="record-info">
                    <h4>${record.member} - ${categoryText}</h4>
                    <p>${record.description || 'ç„¡æè¿°'}</p>
                    <p>${new Date(record.date).toLocaleDateString('zh-TW')}</p>
                </div>
                <div class="record-amount ${amountClass}">
                    ${amountPrefix}$${record.amount.toLocaleString()}
                </div>
                <div class="record-actions">
                    <button class="btn btn-small" onclick="editRecord('${record.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')">åˆªé™¤</button>
                </div>
            `;
            
            return div;
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            
            calendarTitle.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
            
            // æ¸…ç©ºæ—¥æ›†
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.background = '#f8f9fa';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // ç²å–ç•¶æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆ42å¤©ï¼ˆ6é€±ï¼‰
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentMonth) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = formatDateToYYYYMMDD(date);
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-records" id="day-records-${dateStr}"></div>
                `;
                dayElement.id = `day-${dateStr}`;
                
                dayElement.onclick = () => showDayRecords(date);
                calendarGrid.appendChild(dayElement);
            }
            
            // æ›´æ–°æ¯æ—¥è¨˜éŒ„
            updateDayRecords();
        }

        function updateDayRecords() {
            // å…ˆæ¸…ç©ºæ‰€æœ‰æ—¥æœŸçš„è¨˜éŒ„
            for (let i = 0; i < 42; i++) {
                const startDate = new Date(currentYear, currentMonth, 1);
                startDate.setDate(startDate.getDate() - startDate.getDay() + i);
                const dayRecordsElement = document.getElementById(`day-records-${formatDateToYYYYMMDD(startDate)}`);
                if (dayRecordsElement) {
                    dayRecordsElement.innerHTML = '';
                }
            }
            
            // æŒ‰æ—¥æœŸå’Œæˆå“¡åˆ†çµ„è¨ˆç®—ç¸½é¡
            const dayMemberTotals = {};
            records.forEach(record => {
                const date = record.date;
                const member = record.member;
                const amount = record.type === 'income' ? record.amount : -record.amount;
                
                if (!dayMemberTotals[date]) {
                    dayMemberTotals[date] = {};
                }
                if (!dayMemberTotals[date][member]) {
                    dayMemberTotals[date][member] = 0;
                }
                dayMemberTotals[date][member] += amount;
            });
            
            // é¡¯ç¤ºæ¯å€‹æˆå“¡çš„ç•¶æ—¥ç¸½é¡
            Object.keys(dayMemberTotals).forEach(date => {
                const dayRecordsElement = document.getElementById(`day-records-${date}`);
                if (dayRecordsElement) {
                    const memberTotals = dayMemberTotals[date];
                    Object.keys(memberTotals).forEach(member => {
                        const total = memberTotals[member];
                        if (total !== 0) {
                            const recordClass = total > 0 ? 'day-income' : 'day-expense';
                            const prefix = total > 0 ? '+' : '';
                            
                            const recordDiv = document.createElement('div');
                            recordDiv.className = recordClass;
                            recordDiv.textContent = `${member}: ${prefix}$${Math.abs(total).toLocaleString()}`;
                            dayRecordsElement.appendChild(recordDiv);
                        }
                    });
                }
            });
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function showDayRecords(date) {
            const dayRecords = records.filter(record => record.date === formatDateToYYYYMMDD(date));
            
            if (dayRecords.length === 0) {
                // ä¸é¡¯ç¤ºæé†’ï¼Œç›´æ¥è¿”å›
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} çš„è¨˜éŒ„ï¼š\n\n`;
            dayRecords.forEach(record => {
                const prefix = record.type === 'income' ? '+' : '-';
                const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
                message += `${record.member} - ${categoryText}: ${prefix}$${record.amount}\n`;
                if (record.description) {
                    message += `  æè¿°: ${record.description}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberFilter = document.getElementById('memberFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredRecords = records.filter(record => {
                const matchesSearch = !searchTerm || 
                    record.member.toLowerCase().includes(searchTerm) ||
                    record.mainCategory.toLowerCase().includes(searchTerm) ||
                    (record.subCategory && record.subCategory.toLowerCase().includes(searchTerm)) ||
                    record.description.toLowerCase().includes(searchTerm);
                
                const matchesMember = !memberFilter || record.member === memberFilter;
                
                const matchesType = !typeFilter || record.type === typeFilter;
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                return matchesSearch && matchesMember && matchesType && matchesDate;
            });
            
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
                return;
            }
            
            filteredRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        // è¡¨å–®æäº¤
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ•¸æ“šé©—è­‰
            const member = document.getElementById('member').value;
            const amount = parseFloat(document.getElementById('amount').value);
            let mainCategory = document.getElementById('mainCategory').value;
            const customMainCategory = document.getElementById('customMainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const date = document.getElementById('date').value;
            
            if (!member) {
                alert('è«‹é¸æ“‡æˆå“¡ï¼');
                return;
            }
            
            if (!amount || amount === 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼ˆæ­£æ•¸=æ”¶å…¥ï¼Œè² æ•¸=æ”¯å‡ºï¼‰ï¼');
                return;
            }
            
            if (!mainCategory) {
                alert('è«‹é¸æ“‡ä¸»é¡åˆ¥ï¼');
                return;
            }
            
            // å¦‚æœé¸æ“‡äº†"å…¶ä»–"ï¼Œä½¿ç”¨è‡ªå®šç¾©è¼¸å…¥
            if (mainCategory === 'å…¶ä»–') {
                if (!customMainCategory.trim()) {
                    alert('è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥ï¼');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼');
                return;
            }
            
            // æ ¹æ“šé‡‘é¡æ­£è² ç¢ºå®šé¡å‹
            const type = amount > 0 ? 'income' : 'expense';
            
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ç‚ºæœªä¾†æ—¥æœŸ
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // è¨­ç‚ºä»Šå¤©çš„çµæŸæ™‚é–“
            
            if (selectedDate > today) {
                alert('ä¸èƒ½é¸æ“‡æœªä¾†çš„æ—¥æœŸï¼');
                return;
            }
            
            const record = {
                id: Date.now().toString(),
                member: member,
                type: type,
                amount: Math.abs(amount), // å­˜å„²çµ•å°å€¼
                mainCategory: mainCategory,
                subCategory: subCategory,
                description: document.getElementById('description').value,
                date: date
            };
            
            records.push(record);
            saveRecords();
            
            // è‡ªå‹•å‚™ä»½åˆ°GitHub
            backupToGitHub().then(success => {
                if (success) {
                    console.log('âœ… æ–°å¢è¨˜éŒ„å¾Œè‡ªå‹•å‚™ä»½æˆåŠŸ');
                } else {
                    console.log('âš ï¸ æ–°å¢è¨˜éŒ„å¾Œè‡ªå‹•å‚™ä»½å¤±æ•—ï¼Œä½†æœ¬åœ°å·²ä¿å­˜');
                }
            });
            
            // é‡ç½®è¡¨å–®
            this.reset();
            setTodayDate();
            
            // æ›´æ–°é¡¯ç¤º
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
            updateSyncStatus(); // æ›´æ–°åŒæ­¥ç‹€æ…‹
            
            alert('è¨˜éŒ„å·²æ–°å¢ï¼');
        });

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMember').value = record.member;
            document.getElementById('editType').value = record.type;
            document.getElementById('editAmount').value = record.amount;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå®šç¾©ä¸»é¡åˆ¥
            const predefinedCategories = [...categories.income, ...Object.keys(categories.expense)];
            if (predefinedCategories.includes(record.mainCategory)) {
                document.getElementById('editMainCategory').value = record.mainCategory;
                document.getElementById('editCustomMainCategory').style.display = 'none';
                document.getElementById('editCustomMainCategory').value = '';
            } else {
                document.getElementById('editMainCategory').value = 'å…¶ä»–';
                document.getElementById('editCustomMainCategory').style.display = 'block';
                document.getElementById('editCustomMainCategory').value = record.mainCategory;
            }
            
            document.getElementById('editSubCategory').value = record.subCategory;
            document.getElementById('editDescription').value = record.description;
            document.getElementById('editDate').value = record.date;
            
            // æ›´æ–°é¡åˆ¥é¸é …
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');
            const editSubCategorySelect = document.getElementById('editSubCategory');
            
            // æ›´æ–°ä¸»é¡åˆ¥
            const type = editTypeSelect.value;
            editMainCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            if (type === 'income') {
                categories.income.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
            } else if (type === 'expense') {
                // ç²å–æ‰€æœ‰æ”¯å‡ºé¡åˆ¥ï¼ˆæ’é™¤"å…¶ä»–"ï¼‰
                const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'å…¶ä»–');
                expenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
                // æ·»åŠ "å…¶ä»–"é¸é …
                const otherOption = document.createElement('option');
                otherOption.value = 'å…¶ä»–';
                otherOption.textContent = 'å…¶ä»–';
                editMainCategorySelect.appendChild(otherOption);
            }
            
            // æ›´æ–°å­é¡åˆ¥
            const mainCategory = editMainCategorySelect.value;
            editSubCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            if (type === 'expense' && mainCategory && categories.expense[mainCategory]) {
                categories.expense[mainCategory].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    editSubCategorySelect.appendChild(option);
                });
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ•¸æ“šé©—è­‰
            const member = document.getElementById('editMember').value;
            const type = document.getElementById('editType').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            let mainCategory = document.getElementById('editMainCategory').value;
            const customMainCategory = document.getElementById('editCustomMainCategory').value;
            const subCategory = document.getElementById('editSubCategory').value;
            const date = document.getElementById('editDate').value;
            
            if (!member) {
                alert('è«‹é¸æ“‡æˆå“¡ï¼');
                return;
            }
            
            if (!type) {
                alert('è«‹é¸æ“‡é¡å‹ï¼');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼');
                return;
            }
            
            if (!mainCategory) {
                alert('è«‹é¸æ“‡ä¸»é¡åˆ¥ï¼');
                return;
            }
            
            // å¦‚æœé¸æ“‡äº†"å…¶ä»–"ï¼Œä½¿ç”¨è‡ªå®šç¾©è¼¸å…¥
            if (mainCategory === 'å…¶ä»–') {
                if (!customMainCategory.trim()) {
                    alert('è«‹è¼¸å…¥è‡ªå®šç¾©ä¸»é¡åˆ¥ï¼');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼');
                return;
            }
            
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ç‚ºæœªä¾†æ—¥æœŸ
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (selectedDate > today) {
                alert('ä¸èƒ½é¸æ“‡æœªä¾†çš„æ—¥æœŸï¼');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                records[recordIndex] = {
                    id: id,
                    member: member,
                    type: type,
                    amount: amount,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    description: document.getElementById('editDescription').value,
                    date: date
                };
                
                saveRecords();
                
                // è‡ªå‹•å‚™ä»½åˆ°GitHub
                backupToGitHub().then(success => {
                    if (success) {
                        console.log('âœ… ç·¨è¼¯è¨˜éŒ„å¾Œè‡ªå‹•å‚™ä»½æˆåŠŸ');
                    } else {
                        console.log('âš ï¸ ç·¨è¼¯è¨˜éŒ„å¾Œè‡ªå‹•å‚™ä»½å¤±æ•—ï¼Œä½†æœ¬åœ°å·²ä¿å­˜');
                    }
                });
                
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateSyncStatus(); // æ›´æ–°åŒæ­¥ç‹€æ…‹
                closeModal();
                
                alert('è¨˜éŒ„å·²æ›´æ–°ï¼');
            }
        });

        function deleteRecord(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                records = records.filter(record => record.id !== id);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateSyncStatus(); // æ›´æ–°åŒæ­¥ç‹€æ…‹
                alert('è¨˜éŒ„å·²åˆªé™¤ï¼');
            }
        }

        function saveRecords() {
            // å¯«å…¥ localStorage
            localStorage.setItem('familyRecords', JSON.stringify(records));
            
            // å®šæœŸè‡ªå‹•å‚™ä»½åˆ° data.jsonï¼ˆæ¯10æ¬¡æ“ä½œå‚™ä»½ä¸€æ¬¡ï¼‰
            const backupCount = parseInt(localStorage.getItem('backupCount') || '0') + 1;
            localStorage.setItem('backupCount', backupCount.toString());
            
            if (backupCount % 10 === 0) {
                console.log(`å·²é€²è¡Œ ${backupCount} æ¬¡æ“ä½œï¼Œè‡ªå‹•å‚™ä»½ data.json`);
                saveToDataJson();
            }
        }

        // å¯«å…¥ data.json æª”æ¡ˆï¼ˆé€šéä¸‹è¼‰æ–¹å¼ï¼‰
        function saveToDataJson() {
            try {
                const now = new Date();
                const dataToSave = {
                    records: records,
                    settings: {
                        version: "1.0",
                        lastUpdated: now.toISOString()
                    }
                };
                
                // è¨˜éŒ„å‚™ä»½æ™‚é–“
                localStorage.setItem('lastBackupTime', now.toLocaleString('zh-TW'));
                
                // å‰µå»ºä¸¦ä¸‹è¼‰ data.json æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // éœé»˜ä¸‹è¼‰ï¼ˆä¸é¡¯ç¤ºä¸‹è¼‰å°è©±æ¡†ï¼‰
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('æˆåŠŸç”Ÿæˆ data.json å‚™ä»½æª”æ¡ˆ');
                
                // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
                updateDataStats();
            } catch (error) {
                console.warn('ç„¡æ³•ç”Ÿæˆ data.json å‚™ä»½æª”æ¡ˆ:', error, 'ä½† localStorage å·²ä¿å­˜');
            }
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            recurringExpenses.forEach(expense => {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨˜éŒ„äº†é€™å€‹æœˆçš„å›ºå®šæ”¯å‡º
                const thisMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const existingRecord = records.find(record => 
                    record.member === expense.member &&
                    record.description.includes(expense.name) &&
                    record.date.startsWith(thisMonth)
                );
                
                // å¦‚æœä»Šå¤©æ˜¯å›ºå®šæ”¯å‡ºçš„æ—¥æœŸä¸”é‚„æ²’æœ‰è¨˜éŒ„ï¼Œé¡¯ç¤ºæé†’
                if (currentDay === expense.day && !existingRecord) {
                    const confirmAdd = confirm(`æé†’ï¼šä»Šå¤©æ˜¯ ${expense.name} çš„ç¹³è²»æ—¥ï¼ˆ$${expense.amount.toLocaleString()}ï¼‰ï¼Œæ˜¯å¦è¦æ–°å¢é€™ç­†è¨˜éŒ„ï¼Ÿ`);
                    if (confirmAdd) {
                        // æ ¹æ“šè²»ç”¨åç¨±æ±ºå®šæ­£ç¢ºçš„é¡åˆ¥
                        let mainCategory, subCategory;
                        if (expense.name === 'æˆ¿ç§Ÿ') {
                            mainCategory = 'å±…ä½';
                            subCategory = 'æˆ¿ç§Ÿ';
                        } else if (expense.name === 'æˆ¿è²¸') {
                            mainCategory = 'å±…ä½';
                            subCategory = 'æˆ¿è²¸';
                        } else if (expense.name === 'æ‰‹æ©Ÿè²»') {
                            mainCategory = 'æ—¥å¸¸';
                            subCategory = 'æ‰‹æ©Ÿè²»';
                        } else if (expense.name === 'ç¶²è·¯è²»') {
                            mainCategory = 'æ—¥å¸¸';
                            subCategory = 'ç¶²è·¯è²»';
                        }
                        
                        const record = {
                            id: Date.now().toString(),
                            member: expense.member,
                            type: 'expense',
                            amount: expense.amount,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            description: `${expense.name} - ${thisMonth}`,
                            date: today.toISOString().split('T')[0]
                        };
                        
                        records.push(record);
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        
                        alert(`${expense.name} è¨˜éŒ„å·²æ–°å¢ï¼`);
                    }
                }
            });
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // CSV åŒ¯å…¥åŠŸèƒ½
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('CSV æª”æ¡ˆè§£æéŒ¯èª¤ï¼š' + results.errors[0].message);
                        return;
                    }
                    processImportData(results.data);
                },
                error: function(error) {
                    alert('è®€å– CSV æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            });
        }

        // Excel åŒ¯å…¥åŠŸèƒ½
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ä½¿ç”¨ raw: false ä¾†ç²å–æ ¼å¼åŒ–çš„å€¼
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        dateNF: 'yyyy-mm-dd' // æŒ‡å®šæ—¥æœŸæ ¼å¼
                    });
                    
                    console.log('Excel è§£æçµæœ:', jsonData);
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Excel è®€å–éŒ¯èª¤:', error);
                    alert('è®€å– Excel æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // è™•ç†åŒ¯å…¥æ•¸æ“š
        function processImportData(data) {
            importData = [];
            const errors = [];
            const warnings = [];

            console.log('åŸå§‹æ•¸æ“š:', data);

            data.forEach((row, index) => {
                console.log(`è™•ç†ç¬¬ ${index + 1} è¡Œ:`, row);
                const record = validateImportRecord(row, index + 1);
                if (record) {
                    importData.push(record);
                } else {
                    errors.push(`ç¬¬ ${index + 1} è¡Œæ•¸æ“šç„¡æ•ˆ`);
                }
            });

            if (errors.length > 0) {
                alert('ç™¼ç¾ä»¥ä¸‹éŒ¯èª¤ï¼š\n' + errors.join('\n') + '\n\nè«‹æª¢æŸ¥æ•¸æ“šæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
            }

            if (warnings.length > 0) {
                console.warn('è­¦å‘Š:', warnings);
            }

            showImportPreview();
        }

        // é©—è­‰åŒ¯å…¥è¨˜éŒ„
        function validateImportRecord(row, rowNumber) {
            const requiredFields = ['æˆå“¡', 'é‡‘é¡', 'ä¸»é¡åˆ¥', 'å­é¡åˆ¥', 'æè¿°', 'æ—¥æœŸ'];
            const errors = [];
            
            console.log(`é©—è­‰ç¬¬ ${rowNumber} è¡Œ:`, row);
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            for (let field of requiredFields) {
                if (!row[field] && row[field] !== 0) {
                    errors.push(`ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${field}`);
                }
            }
            
            // é©—è­‰ä»˜æ¬¾æ–¹å¼ï¼ˆå­é¡åˆ¥ï¼‰
            const paymentMethod = row['å­é¡åˆ¥'];
            if (paymentMethod && !['ä¿¡ç”¨å¡', 'ç¾é‡‘'].includes(paymentMethod)) {
                errors.push(`ä»˜æ¬¾æ–¹å¼ç„¡æ•ˆï¼š${paymentMethod} (æœ‰æ•ˆå€¼: ä¿¡ç”¨å¡, ç¾é‡‘)`);
            }

            if (errors.length > 0) {
                console.error(`ç¬¬ ${rowNumber} è¡ŒéŒ¯èª¤:`, errors);
                return null;
            }

            // é©—è­‰æˆå“¡
            if (!familyMembers.includes(row['æˆå“¡'])) {
                errors.push(`æˆå“¡ç„¡æ•ˆï¼š${row['æˆå“¡']} (æœ‰æ•ˆå€¼: ${familyMembers.join(', ')})`);
            }

            // é©—è­‰é‡‘é¡
            let amountValue = row['é‡‘é¡'];
            
            // æ¸…ç†é‡‘é¡å­—ç¬¦ä¸²
            if (typeof amountValue === 'string') {
                // å…ˆè™•ç†æ‹¬è™Ÿæ ¼å¼ï¼ˆæœƒè¨ˆæ ¼å¼ï¼‰
                if (amountValue.includes('(') && amountValue.includes(')')) {
                    amountValue = '-' + amountValue.replace(/[()]/g, '');
                }
                
                // ç§»é™¤è²¨å¹£ç¬¦è™Ÿã€ç©ºæ ¼ç­‰ï¼Œä½†ä¿ç•™è² è™Ÿå’Œé€—è™Ÿ
                amountValue = amountValue.toString().replace(/[Â¥ï¿¥\s]/g, '');
                
                // ç§»é™¤åƒåˆ†ä½é€—è™Ÿ
                amountValue = amountValue.replace(/,/g, '');
                
                // ç§»é™¤ç¾å…ƒç¬¦è™Ÿï¼ˆåœ¨é€—è™Ÿè™•ç†å¾Œï¼‰
                amountValue = amountValue.replace(/\$/g, '');
            }
            
            const amount = parseFloat(amountValue);
            console.log(`ç¬¬ ${rowNumber} è¡Œé‡‘é¡è§£æ:`, {
                'åŸå§‹å€¼': row['é‡‘é¡'],
                'æ¸…ç†å¾Œ': amountValue,
                'è§£æå¾Œ': amount,
                'é¡å‹': typeof row['é‡‘é¡']
            });
            
            if (isNaN(amount) || amount === 0) {
                errors.push(`é‡‘é¡ç„¡æ•ˆï¼š${row['é‡‘é¡']} (æ¸…ç†å¾Œ: ${amountValue}, è§£æå¾Œ: ${amount})`);
            }

            // æ ¹æ“šé‡‘é¡æ­£è² æ•¸åˆ¤æ–·é¡å‹
            const type = amount > 0 ? 'income' : 'expense';
            const absAmount = Math.abs(amount); // å…§éƒ¨å­˜å„²ä½¿ç”¨çµ•å°å€¼

            // é©—è­‰æ—¥æœŸ
            let dateStr = row['æ—¥æœŸ'];
            // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
            if (typeof dateStr === 'string') {
                // å¦‚æœæ˜¯ Excel æ—¥æœŸæ•¸å­—ï¼Œè½‰æ›ç‚ºæ—¥æœŸ
                if (!isNaN(dateStr) && dateStr > 25569) { // Excel æ—¥æœŸèµ·å§‹å€¼
                    const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                    dateStr = formatDateToYYYYMMDD(excelDate);
                } else {
                    // è™•ç†æ–œç·šåˆ†éš”çš„æ—¥æœŸæ ¼å¼ (2025/09/01 -> 2025-09-01)
                    dateStr = dateStr.replace(/\//g, '-');
                }
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                errors.push(`æ—¥æœŸç„¡æ•ˆï¼š${row['æ—¥æœŸ']} (æ ¼å¼: YYYY-MM-DD)`);
            }

            if (errors.length > 0) {
                console.error(`ç¬¬ ${rowNumber} è¡Œé©—è­‰å¤±æ•—:`, errors);
                return null;
            }

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                member: row['æˆå“¡'],
                type: type,
                amount: absAmount,
                mainCategory: row['ä¸»é¡åˆ¥'],
                subCategory: row['å­é¡åˆ¥'],
                description: row['æè¿°'] || '',
                date: dateStr
            };
        }

        // é¡¯ç¤ºåŒ¯å…¥é è¦½
        function showImportPreview() {
            const previewDiv = document.getElementById('importPreview');
            const tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            importData.forEach((record, index) => {
                const row = document.createElement('tr');
                const isValid = validateRecord(record);
                
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                    <td class="${isValid ? 'status-valid' : 'status-invalid'}">
                        ${isValid ? 'âœ“ æœ‰æ•ˆ' : 'âœ— ç„¡æ•ˆ'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // é©—è­‰è¨˜éŒ„
        function validateRecord(record) {
            return familyMembers.includes(record.member) &&
                   ['income', 'expense'].includes(record.type) &&
                   record.amount > 0 &&
                   record.mainCategory &&
                   record.date;
        }

        // ç¢ºèªåŒ¯å…¥
        function confirmImport() {
            const validRecords = importData.filter(record => validateRecord(record));
            
            if (validRecords.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ï¼');
                return;
            }

            // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
            const duplicateCheck = checkForDuplicates(validRecords);
            const newRecords = duplicateCheck.newRecords;
            const duplicates = duplicateCheck.duplicates;

            if (duplicates.length > 0) {
                const duplicateInfo = duplicates.map(dup => 
                    `${dup.member} - ${dup.mainCategory} - $${dup.amount} - ${dup.date}`
                ).join('\n');
                
                if (newRecords.length === 0) {
                    alert(`æ‰€æœ‰è¨˜éŒ„éƒ½æ˜¯é‡è¤‡çš„ï¼\n\né‡è¤‡çš„è¨˜éŒ„ï¼š\n${duplicateInfo}\n\nè«‹æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ¯å…¥éé€™äº›è¨˜éŒ„ã€‚`);
                    return;
                } else {
                    const proceed = confirm(`ç™¼ç¾ ${duplicates.length} ç­†é‡è¤‡è¨˜éŒ„ï¼Œå°‡è·³éé€™äº›è¨˜éŒ„ã€‚\n\né‡è¤‡çš„è¨˜éŒ„ï¼š\n${duplicateInfo}\n\nç¢ºå®šè¦åŒ¯å…¥ ${newRecords.length} ç­†æ–°è¨˜éŒ„å—ï¼Ÿ`);
                    if (!proceed) {
                        return;
                    }
                }
            }

            if (confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${newRecords.length} ç­†è¨˜éŒ„å—ï¼Ÿ`)) {
                records = records.concat(newRecords);
                saveRecords();
                
                // è‡ªå‹•å‚™ä»½åˆ°GitHub
                backupToGitHub().then(success => {
                    if (success) {
                        console.log('âœ… åŒ¯å…¥æ•¸æ“šå¾Œè‡ªå‹•å‚™ä»½æˆåŠŸ');
                    } else {
                        console.log('âš ï¸ åŒ¯å…¥æ•¸æ“šå¾Œè‡ªå‹•å‚™ä»½å¤±æ•—ï¼Œä½†æœ¬åœ°å·²ä¿å­˜');
                    }
                });
                
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ›åˆ°2025å¹´
                checkAndSwitchTo2025();
                
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateSyncStatus(); // æ›´æ–°åŒæ­¥ç‹€æ…‹
                
                let message = `æˆåŠŸåŒ¯å…¥ ${newRecords.length} ç­†è¨˜éŒ„ï¼`;
                if (duplicates.length > 0) {
                    message += `\nè·³éäº† ${duplicates.length} ç­†é‡è¤‡è¨˜éŒ„ã€‚`;
                }
                alert(message);
                cancelImport();
            }
        }

        // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
        function checkForDuplicates(importRecords) {
            const newRecords = [];
            const duplicates = [];
            
            importRecords.forEach(importRecord => {
                // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰è¨˜éŒ„é‡è¤‡
                const isDuplicate = records.some(existingRecord => {
                    return existingRecord.member === importRecord.member &&
                           existingRecord.amount === importRecord.amount &&
                           existingRecord.mainCategory === importRecord.mainCategory &&
                           existingRecord.subCategory === importRecord.subCategory &&
                           existingRecord.date === importRecord.date &&
                           existingRecord.description === importRecord.description;
                });
                
                if (isDuplicate) {
                    duplicates.push(importRecord);
                } else {
                    newRecords.push(importRecord);
                }
            });
            
            return { newRecords, duplicates };
        }

        // å–æ¶ˆåŒ¯å…¥
        function cancelImport() {
            importData = [];
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFile').value = '';
        }

        // åŒ¯å‡ºç‚º CSV
        function exportToCSV() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            const csvContent = convertToCSV(records);
            downloadFile(csvContent, 'family_records.csv', 'text/csv');
        }

        // åŒ¯å‡ºç‚º Excel
        function exportToExcel() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(records.map(record => ({
                'æˆå“¡': record.member,
                'é‡‘é¡': record.type === 'income' ? record.amount : -record.amount,
                'ä¸»é¡åˆ¥': record.mainCategory,
                'å­é¡åˆ¥': record.subCategory,
                'æè¿°': record.description,
                'æ—¥æœŸ': record.date
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'æ”¶æ”¯è¨˜éŒ„');
            
            XLSX.writeFile(workbook, 'family_records.xlsx');
        }

        // è½‰æ›ç‚º CSV æ ¼å¼
        function convertToCSV(data) {
            const headers = ['æˆå“¡', 'é‡‘é¡', 'ä¸»é¡åˆ¥', 'å­é¡åˆ¥', 'æè¿°', 'æ—¥æœŸ'];
            const csvRows = [headers.join(',')];
            
            data.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const values = [
                    record.member,
                    amount,
                    record.mainCategory,
                    record.subCategory,
                    `"${record.description}"`,
                    record.date
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // ä¸‹è¼‰æª”æ¡ˆ
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // å‰µå»ºç¤ºä¾‹ Excel æª”æ¡ˆ
        function createSampleExcel() {
            const sampleData = [
                {
                    'æˆå“¡': 'Kelvin',
                    'é‡‘é¡': '-1,200',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æ‰‹æ©Ÿè²» - 2025-01',
                    'æ—¥æœŸ': '2025-01-15'
                },
                {
                    'æˆå“¡': 'Phuong',
                    'é‡‘é¡': '-1,598',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ç¾é‡‘',
                    'æè¿°': 'ç¶²è·¯è²» - 2025-01',
                    'æ—¥æœŸ': '2025-01-15'
                },
                {
                    'æˆå“¡': 'å®¶ç”¨',
                    'é‡‘é¡': '-15,000',
                    'ä¸»é¡åˆ¥': 'å±…ä½',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æˆ¿ç§Ÿ - 2025-01',
                    'æ—¥æœŸ': '2025-01-01'
                },
                {
                    'æˆå“¡': 'å®¶ç”¨',
                    'é‡‘é¡': '50,000',
                    'ä¸»é¡åˆ¥': 'è–ªè³‡',
                    'å­é¡åˆ¥': 'ç¾é‡‘',
                    'æè¿°': 'Kelvin è–ªè³‡',
                    'æ—¥æœŸ': '2025-01-05'
                },
                {
                    'æˆå“¡': 'Kelvin',
                    'é‡‘é¡': '-1,979',
                    'ä¸»é¡åˆ¥': 'æ—¥å¸¸',
                    'å­é¡åˆ¥': 'ä¿¡ç”¨å¡',
                    'æè¿°': 'æ‰‹æ©Ÿæ¬ è²»',
                    'æ—¥æœŸ': '2025-01-20'
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(sampleData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ç¤ºä¾‹æ•¸æ“š');
            
            XLSX.writeFile(workbook, 'sample_family_records.xlsx');
            alert('ç¤ºä¾‹ Excel æª”æ¡ˆå·²å‰µå»ºï¼æ‚¨å¯ä»¥ä¸‹è¼‰ä¸¦ä¿®æ”¹å¾Œé‡æ–°ä¸Šå‚³æ¸¬è©¦ã€‚');
        }

        // æ‰‹å‹•ä¸‹è¼‰ data.json å‚™ä»½
        function downloadDataJson() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥å‚™ä»½ï¼');
                return;
            }

            const dataToSave = {
                records: records,
                settings: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString()
                }
            };
            
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`æˆåŠŸä¸‹è¼‰å‚™ä»½æª”æ¡ˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚\næª”æ¡ˆå: family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`);
        }

        // ä¸‹è¼‰ Excel æ ¼å¼å‚™ä»½ï¼ˆå¯é‡æ–°åŒ¯å…¥ï¼‰
        function downloadExcelBackup() {
            if (records.length === 0) {
                alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥å‚™ä»½ï¼');
                return;
            }

            // å°‡è¨˜éŒ„è½‰æ›ç‚º Excel æ ¼å¼
            const excelData = records.map(record => ({
                'æˆå“¡': record.member,
                'é‡‘é¡': record.type === 'income' ? record.amount : -record.amount,
                'ä¸»é¡åˆ¥': record.mainCategory,
                'å­é¡åˆ¥': record.subCategory || '',
                'æè¿°': record.description || '',
                'æ—¥æœŸ': record.date
            }));

            // å‰µå»º Excel å·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'å®¶åº­æ”¶æ”¯è¨˜éŒ„');
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const fileName = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`æˆåŠŸä¸‹è¼‰ Excel å‚™ä»½æª”æ¡ˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚\næª”æ¡ˆå: ${fileName}\n\næ­¤æª”æ¡ˆå¯ä»¥ç›´æ¥é‡æ–°åŒ¯å…¥ç³»çµ±ã€‚`);
        }











        // æ›´æ–°æ•¸æ“šçµ±è¨ˆ
        // æ›´æ–°åŒæ­¥ç‹€æ…‹
        function updateSyncStatus() {
            // æª¢æŸ¥å‚™ä»½ç‹€æ…‹
            const lastGitHubBackup = localStorage.getItem('lastGitHubBackup');
            const lastLocalBackup = localStorage.getItem('lastLocalBackup');
            const lastBackupTime = localStorage.getItem('lastBackupTime');
            
            let backupStatus = 'æœªå‚™ä»½';
            if (lastGitHubBackup) {
                const backupDate = new Date(lastGitHubBackup);
                backupStatus = `GitHub: ${backupDate.toLocaleString('zh-TW')}`;
            } else if (lastLocalBackup) {
                const backupDate = new Date(lastLocalBackup);
                backupStatus = `æœ¬åœ°: ${backupDate.toLocaleString('zh-TW')}`;
            } else if (lastBackupTime) {
                backupStatus = lastBackupTime;
            }

            document.getElementById('lastBackup').textContent = backupStatus;
            
            // è‡ªå‹•æª¢æŸ¥æ•¸æ“šå¥åº·
            checkDataHealth();
        }

        // æ•¸æ“šå¥åº·æª¢æŸ¥
        function checkDataHealth() {
            console.log('ğŸ” é–‹å§‹æ•¸æ“šå¥åº·æª¢æŸ¥...');
            
            const healthIssues = [];
            const warnings = [];
            
            // æª¢æŸ¥è¨˜éŒ„æ•¸é‡
            if (records.length === 0) {
                healthIssues.push('âŒ æ²’æœ‰æ•¸æ“šè¨˜éŒ„');
            } else if (records.length > 1000) {
                warnings.push('âš ï¸ è¨˜éŒ„æ•¸é‡éå¤š (' + records.length + ' ç­†)');
            }
            
            // æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
            const invalidRecords = records.filter(record => 
                !record.id || !record.member || !record.type || !record.amount || !record.date
            );
            if (invalidRecords.length > 0) {
                healthIssues.push(`âŒ ç™¼ç¾ ${invalidRecords.length} ç­†ç„¡æ•ˆè¨˜éŒ„`);
            }
            
            // æª¢æŸ¥é‡è¤‡è¨˜éŒ„
            const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            if (duplicateIds.length > 0) {
                healthIssues.push(`âŒ ç™¼ç¾ ${duplicateIds.length} ç­†é‡è¤‡ID`);
            }
            
            // æª¢æŸ¥æ—¥æœŸæ ¼å¼
            const invalidDates = records.filter(record => {
                const date = new Date(record.date);
                return isNaN(date.getTime());
            });
            if (invalidDates.length > 0) {
                healthIssues.push(`âŒ ç™¼ç¾ ${invalidDates.length} ç­†ç„¡æ•ˆæ—¥æœŸ`);
            }
            
            // æª¢æŸ¥é‡‘é¡
            const invalidAmounts = records.filter(record => 
                isNaN(record.amount) || record.amount <= 0
            );
            if (invalidAmounts.length > 0) {
                healthIssues.push(`âŒ ç™¼ç¾ ${invalidAmounts.length} ç­†ç„¡æ•ˆé‡‘é¡`);
            }
            
            // æª¢æŸ¥localStorageåŒæ­¥
            const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
            if (localRecords.length !== records.length) {
                warnings.push('âš ï¸ localStorageèˆ‡å…§å­˜æ•¸æ“šä¸åŒæ­¥');
            }
            
            // æ›´æ–°å¥åº·ç‹€æ…‹é¡¯ç¤º
            let healthStatus = 'âœ… å¥åº·';
            let healthColor = '#28a745';
            
            if (healthIssues.length > 0) {
                healthStatus = `âŒ ${healthIssues.length} å€‹å•é¡Œ`;
                healthColor = '#dc3545';
            } else if (warnings.length > 0) {
                healthStatus = `âš ï¸ ${warnings.length} å€‹è­¦å‘Š`;
                healthColor = '#ffc107';
            }
            
            const healthElement = document.getElementById('dataHealth');
            if (healthElement) {
                healthElement.textContent = healthStatus;
                healthElement.style.color = healthColor;
            }
            
            // è¼¸å‡ºè©³ç´°å ±å‘Š
            console.log('ğŸ“Š æ•¸æ“šå¥åº·æª¢æŸ¥å ±å‘Š:');
            console.log(`ç¸½è¨˜éŒ„æ•¸: ${records.length}`);
            console.log(`å¥åº·å•é¡Œ: ${healthIssues.length}`);
            console.log(`è­¦å‘Š: ${warnings.length}`);
            
            if (healthIssues.length > 0) {
                console.log('âŒ å¥åº·å•é¡Œ:', healthIssues);
            }
            if (warnings.length > 0) {
                console.log('âš ï¸ è­¦å‘Š:', warnings);
            }
            
            return {
                healthy: healthIssues.length === 0,
                issues: healthIssues,
                warnings: warnings,
                totalRecords: records.length
            };
        }

        // å¿«é€Ÿä¿®å¾©åŠŸèƒ½
        async function quickFix() {
            console.log('ğŸ”§ é–‹å§‹å¿«é€Ÿä¿®å¾©...');
            
            const fixes = [];
            
            try {
                // 1. å¼·åˆ¶é‡æ–°è¼‰å…¥æ•¸æ“š
                console.log('ğŸ”„ æ­¥é©Ÿ1: å¼·åˆ¶é‡æ–°è¼‰å…¥æ•¸æ“š...');
                await loadDataFromFile();
                fixes.push('âœ… é‡æ–°è¼‰å…¥æ•¸æ“š');
                
                // 2. æª¢æŸ¥ä¸¦ä¿®å¾©é‡è¤‡ID
                console.log('ğŸ” æ­¥é©Ÿ2: æª¢æŸ¥é‡è¤‡ID...');
                const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
                if (duplicateIds.length > 0) {
                    // ç‚ºé‡è¤‡IDç”Ÿæˆæ–°çš„å”¯ä¸€ID
                    const idMap = new Map();
                    records.forEach(record => {
                        if (idMap.has(record.id)) {
                            record.id = Date.now() + Math.random().toString(36).substr(2, 9);
                        }
                        idMap.set(record.id, true);
                    });
                    fixes.push(`âœ… ä¿®å¾© ${duplicateIds.length} å€‹é‡è¤‡ID`);
                }
                
                // 3. æª¢æŸ¥ä¸¦ä¿®å¾©ç„¡æ•ˆè¨˜éŒ„
                console.log('ğŸ” æ­¥é©Ÿ3: æª¢æŸ¥ç„¡æ•ˆè¨˜éŒ„...');
                const originalLength = records.length;
                records = records.filter(record => 
                    record.id && record.member && record.type && record.amount && record.date
                );
                const removedCount = originalLength - records.length;
                if (removedCount > 0) {
                    fixes.push(`âœ… ç§»é™¤ ${removedCount} ç­†ç„¡æ•ˆè¨˜éŒ„`);
                }
                
                // 4. åŒæ­¥åˆ°localStorage
                console.log('ğŸ’¾ æ­¥é©Ÿ4: åŒæ­¥åˆ°localStorage...');
                localStorage.setItem('familyRecords', JSON.stringify(records));
                fixes.push('âœ… åŒæ­¥åˆ°localStorage');
                
                // 5. æ›´æ–°æ‰€æœ‰é¡¯ç¤º
                console.log('ğŸ”„ æ­¥é©Ÿ5: æ›´æ–°é¡¯ç¤º...');
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar();
                updateSyncStatus();
                fixes.push('âœ… æ›´æ–°æ‰€æœ‰é¡¯ç¤º');
                
                // 6. å˜—è©¦å‚™ä»½
                console.log('ğŸ“¦ æ­¥é©Ÿ6: å˜—è©¦å‚™ä»½...');
                try {
                    await backupToGitHub();
                    fixes.push('âœ… æˆåŠŸå‚™ä»½åˆ°GitHub');
                } catch (error) {
                    console.log('âš ï¸ GitHubå‚™ä»½å¤±æ•—ï¼Œå˜—è©¦æœ¬åœ°å‚™ä»½...');
                    saveToDataJson();
                    fixes.push('âœ… æœ¬åœ°å‚™ä»½æˆåŠŸ');
                }
                
                // é¡¯ç¤ºä¿®å¾©çµæœ
                const message = `ğŸ”§ å¿«é€Ÿä¿®å¾©å®Œæˆï¼\n\nä¿®å¾©é …ç›®ï¼š\n${fixes.join('\n')}\n\nç•¶å‰è¨˜éŒ„æ•¸ï¼š${records.length}`;
                alert(message);
                console.log('âœ… å¿«é€Ÿä¿®å¾©å®Œæˆ:', fixes);
                
            } catch (error) {
                console.error('âŒ å¿«é€Ÿä¿®å¾©å¤±æ•—:', error);
                alert('âŒ å¿«é€Ÿä¿®å¾©å¤±æ•—ï¼š' + error.message);
            }
        }

        // é è¦½åˆªé™¤
        function previewDelete() {
            const memberFilter = document.getElementById('deleteMemberFilter').value;
            const typeFilter = document.getElementById('deleteTypeFilter').value;
            const dateFrom = document.getElementById('deleteDateFrom').value;
            const dateTo = document.getElementById('deleteDateTo').value;

            deleteData = records.filter(record => {
                const matchesMember = !memberFilter || record.member === memberFilter;
                const matchesType = !typeFilter || record.type === typeFilter;
                const matchesDateFrom = !dateFrom || record.date >= dateFrom;
                const matchesDateTo = !dateTo || record.date <= dateTo;

                return matchesMember && matchesType && matchesDateFrom && matchesDateTo;
            });

            if (deleteData.length === 0) {
                alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„å¯ä»¥åˆªé™¤ï¼');
                return;
            }

            showDeletePreview();
        }

        // é¡¯ç¤ºåˆªé™¤é è¦½
        function showDeletePreview() {
            const previewDiv = document.getElementById('deletePreview');
            const tableBody = document.getElementById('deletePreviewTableBody');
            
            tableBody.innerHTML = '';
            
            deleteData.forEach((record, index) => {
                const row = document.createElement('tr');
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // ç¢ºèªåˆªé™¤
        function confirmDelete() {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${deleteData.length} ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                // å¾ records ä¸­ç§»é™¤è¦åˆªé™¤çš„è¨˜éŒ„
                records = records.filter(record => !deleteData.includes(record));
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                updateDataStats();
                cancelDelete();
                
                alert(`æˆåŠŸåˆªé™¤ ${deleteData.length} ç­†è¨˜éŒ„ï¼`);
            }
        }

        // å–æ¶ˆåˆªé™¤
        function cancelDelete() {
            deleteData = [];
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteMemberFilter').value = '';
            document.getElementById('deleteTypeFilter').value = '';
            document.getElementById('deleteDateFrom').value = '';
            document.getElementById('deleteDateTo').value = '';
        }

        // æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
        function clearAllData() {
            if (records.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥æ¸…ç©ºï¼');
                return;
            }

            const confirmMessage = `âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡æ¸…ç©ºæ‰€æœ‰ ${records.length} ç­†è¨˜éŒ„ï¼\n\næ­¤æ“ä½œå°‡ï¼š\n- åˆªé™¤æ‰€æœ‰æ”¶æ”¯è¨˜éŒ„\n- æ¸…ç©ºçµ±è¨ˆæ•¸æ“š\n- ç„¡æ³•å¾©åŸ\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm('æœ€å¾Œç¢ºèªï¼šæ‚¨çœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\n\nè«‹è¼¸å…¥ "YES" ä¾†ç¢ºèªï¼ˆè«‹æ‰‹å‹•è¼¸å…¥ YESï¼‰');
                
                if (doubleConfirm) {
                    const userInput = prompt('è«‹è¼¸å…¥ "YES" ä¾†ç¢ºèªæ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼š');
                    
                    if (userInput === 'YES') {
                        records = [];
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                        updateDataStats();
                        
                        alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©ºï¼');
                    } else {
                        alert('æ“ä½œå·²å–æ¶ˆã€‚');
                    }
                }
            }
        }

        // å‚™ä»½æ•¸æ“š
        function backupData() {
            if (records.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥å‚™ä»½ï¼');
                return;
            }

            dataBackup = JSON.parse(JSON.stringify(records));
            const backupData = {
                timestamp: new Date().toISOString(),
                records: dataBackup,
                count: records.length
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`æ•¸æ“šå‚™ä»½å®Œæˆï¼\nå‚™ä»½äº† ${records.length} ç­†è¨˜éŒ„ã€‚`);
        }

        // é‚„åŸæ•¸æ“š
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.records || !Array.isArray(backupData.records)) {
                            alert('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ï¼');
                            return;
                        }

                        const confirmMessage = `æ‰¾åˆ°å‚™ä»½æ•¸æ“šï¼š\n- å‚™ä»½æ™‚é–“ï¼š${backupData.timestamp}\n- è¨˜éŒ„æ•¸é‡ï¼š${backupData.count}\n\nç¢ºå®šè¦é‚„åŸé€™äº›æ•¸æ“šå—ï¼Ÿ\nï¼ˆç•¶å‰æ•¸æ“šå°‡è¢«è¦†è“‹ï¼‰`;
                        
                        if (confirm(confirmMessage)) {
                            records = backupData.records;
                            saveRecords();
                            updateStats();
                            updateRecentRecords();
                            updateAllRecords();
                            updateCalendar(); // ç¢ºä¿æ—¥æ›†æ›´æ–°
                            updateDataStats();
                            
                            alert(`æ•¸æ“šé‚„åŸå®Œæˆï¼\né‚„åŸäº† ${records.length} ç­†è¨˜éŒ„ã€‚`);
                        }
                    } catch (error) {
                        alert('è®€å–å‚™ä»½æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== åœ–è¡¨ç›¸é—œå‡½æ•¸ ====================

        // åˆå§‹åŒ–æ‰€æœ‰åœ–è¡¨
        function initializeCharts() {
            console.log('åˆå§‹åŒ–åœ–è¡¨...');
            console.log('ç•¶å‰è¨˜éŒ„æ•¸é‡:', records.length);
            console.log('è¨˜éŒ„å…§å®¹:', records);
            
            // æª¢æŸ¥ Chart.js æ˜¯å¦è¼‰å…¥
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªè¼‰å…¥');
                showErrorMessage('åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }
            
            setCurrentMonth();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
            if (records.length === 0) {
                console.log('æ²’æœ‰è¨˜éŒ„æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯');
                showNoDataMessage();
                return;
            }
            
            updateCharts();
        }

        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        function showErrorMessage(message) {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <h4>âŒ åœ–è¡¨è¼‰å…¥å¤±æ•—</h4>
                            <p>${message}</p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                                é‡æ–°æ•´ç†é é¢
                            </button>
                        </div>
                    `;
                }
            });
        }

        // é¡¯ç¤ºç„¡æ•¸æ“šæç¤º
        function showNoDataMessage() {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h4>ğŸ“Š æš«ç„¡æ•¸æ“š</h4>
                            <p>è«‹å…ˆæ–°å¢ä¸€äº›æ”¶æ”¯è¨˜éŒ„ï¼Œç„¶å¾Œå†æŸ¥çœ‹åœ–è¡¨</p>
                            <button class="btn" onclick="showTab('add')" style="margin-top: 15px;">
                                å‰å¾€æ–°å¢è¨˜éŒ„
                            </button>
                        </div>
                    `;
                }
            });
        }

        // è¨­ç½®ç•¶å‰æœˆä»½ç‚ºé»˜èªé¸ä¸­
        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() è¿”å› 0-11
            const monthSelect = document.getElementById('chartMonth');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateCharts() {
            const year = parseInt(document.getElementById('chartYear').value);
            const month = parseInt(document.getElementById('chartMonth').value);
            
            console.log('æ›´æ–°åœ–è¡¨:', { year, month });
            
            updateTrendChart(year, month);
            updateCategoryChart(year, month);
            updateMemberChart(year, month);
        }

        // é‡æ–°æ•´ç†åœ–è¡¨
        function refreshCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (memberChart) memberChart.destroy();
            
            updateCharts();
        }

        // ç²å–æŒ‡å®šæœˆä»½çš„æ•¸æ“š
        function getDataByMonth(year, month) {
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // getMonth() è¿”å› 0-11ï¼Œéœ€è¦ +1
                
                return recordYear === year && recordMonth === month;
            });
            
            return filteredRecords;
        }

        // æ›´æ–°æ”¶æ”¯è¶¨å‹¢åœ–è¡¨
        function updateTrendChart(year, month) {
            console.log('æ›´æ–°æ”¶æ”¯è¶¨å‹¢åœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° trendChart canvas å…ƒç´ ');
                return;
            }
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('è¶¨å‹¢åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processDailyTrendData(data, year, month);
            console.log('è™•ç†å¾Œçš„è¶¨å‹¢åœ–è¡¨æ•¸æ“š:', chartData);
            
            trendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: chartData.income,
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: chartData.expense,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æ¯æ—¥æ”¶æ”¯è¶¨å‹¢`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }


        // æ›´æ–°é¡åˆ¥çµ±è¨ˆåœ–è¡¨
        function updateCategoryChart(year, month) {
            console.log('æ›´æ–°é¡åˆ¥çµ±è¨ˆåœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('categoryChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° categoryChart canvas å…ƒç´ ');
                return;
            }
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('é¡åˆ¥åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processCategoryData(data);
            console.log('è™•ç†å¾Œçš„é¡åˆ¥åœ–è¡¨æ•¸æ“š:', chartData);
            
            categoryChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æ”¯å‡ºé¡åˆ¥çµ±è¨ˆ`
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°æˆå“¡æ”¶æ”¯å°æ¯”åœ–è¡¨
        function updateMemberChart(year, month) {
            console.log('æ›´æ–°æˆå“¡æ”¶æ”¯å°æ¯”åœ–è¡¨:', { year, month });
            
            const ctx = document.getElementById('memberChart');
            if (!ctx) {
                console.error('æ‰¾ä¸åˆ° memberChart canvas å…ƒç´ ');
                return;
            }
            
            if (memberChart) {
                memberChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('æˆå“¡åœ–è¡¨æ•¸æ“š:', data);
            
            const chartData = processMemberData(data);
            console.log('è™•ç†å¾Œçš„æˆå“¡åœ–è¡¨æ•¸æ“š:', chartData);
            
            memberChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: chartData.income,
                            backgroundColor: 'rgba(81, 207, 102, 0.8)',
                            borderColor: '#51cf66',
                            borderWidth: 1
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: chartData.expense,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´${month}æœˆ æˆå“¡æ”¶æ”¯å°æ¯”`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // è™•ç†æ¯æ—¥è¶¨å‹¢æ•¸æ“š
        function processDailyTrendData(data, year, month) {
            const groupedData = {};
            
            // ç²å–è©²æœˆçš„å¤©æ•¸
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // åˆå§‹åŒ–æ‰€æœ‰å¤©æ•¸
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day).padStart(2, '0');
                groupedData[dayKey] = { income: 0, expense: 0 };
            }
            
            // è™•ç†å¯¦éš›æ•¸æ“š
            data.forEach(record => {
                const date = new Date(record.date);
                const day = String(date.getDate()).padStart(2, '0');
                
                if (record.type === 'income') {
                    groupedData[day].income += record.amount;
                } else {
                    groupedData[day].expense += record.amount;
                }
            });
            
            const labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
            const income = labels.map(day => groupedData[day].income);
            const expense = labels.map(day => groupedData[day].expense);
            
            return { labels, income, expense };
        }


        // è™•ç†é¡åˆ¥æ•¸æ“š
        function processCategoryData(data) {
            const categoryTotals = {};
            
            data.filter(record => record.type === 'expense').forEach(record => {
                const category = record.mainCategory;
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += record.amount;
            });
            
            // æŒ‰é‡‘é¡æ’åº
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // åªé¡¯ç¤ºå‰10å€‹é¡åˆ¥
            
            const labels = sortedCategories.map(([category]) => category);
            const values = sortedCategories.map(([, amount]) => amount);
            
            return { labels, values };
        }

        // è™•ç†æˆå“¡æ•¸æ“š
        function processMemberData(data) {
            const memberTotals = {};
            
            data.forEach(record => {
                const member = record.member;
                
                if (!memberTotals[member]) {
                    memberTotals[member] = { income: 0, expense: 0 };
                }
                
                if (record.type === 'income') {
                    memberTotals[member].income += record.amount;
                } else {
                    memberTotals[member].expense += record.amount;
                }
            });
            
            // æŒ‰ç…§æŒ‡å®šé †åºæ’åˆ—ï¼šKelvinã€Phuongã€Ryanã€å®¶ç”¨
            const orderedMembers = ['Kelvin', 'Phuong', 'Ryan', 'å®¶ç”¨'];
            const labels = orderedMembers.filter(member => memberTotals[member]);
            const income = labels.map(member => memberTotals[member].income);
            const expense = labels.map(member => memberTotals[member].expense);
            
            return { labels, income, expense };
        }

    </script>
</body>
</html>
