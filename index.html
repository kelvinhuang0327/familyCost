<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Â∫≠Êî∂ÊîØÂπ≥Âè∞</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .member-stats {
            margin-bottom: 30px;
        }

        .record-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .member-stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .member-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .record-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-item.income {
            border-left-color: #51cf66;
        }

        .record-item.expense {
            border-left-color: #ff6b6b;
        }

        .record-info {
            flex: 1;
        }

        .record-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-amount {
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #51cf66;
        }

        .record-amount.expense {
            color: #ff6b6b;
        }

        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-records {
            font-size: 12px;
            margin-top: 5px;
        }

        .day-income {
            color: #51cf66;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(81, 207, 102, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-expense {
            color: #ff6b6b;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .import-section, .export-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .import-section h3, .export-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-card h4 {
            margin-bottom: 10px;
            color: #4facfe;
        }

        .import-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-card li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .import-card input[type="file"] {
            display: none;
        }

        .import-card button {
            margin-top: 15px;
        }

        .import-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .preview-table .status-valid {
            color: #51cf66;
        }

        .preview-table .status-invalid {
            color: #ff6b6b;
        }

        .import-actions, .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-section h3 {
            color: white;
        }

        .export-section p {
            opacity: 0.9;
        }

        .delete-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border: 1px solid #fed7d7;
        }

        .delete-section h3 {
            margin-bottom: 15px;
            color: #e53e3e;
        }

        .delete-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .delete-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .delete-card h4 {
            margin-bottom: 10px;
            color: #e53e3e;
        }

        .delete-card p {
            margin-bottom: 15px;
            color: #666;
        }

        #dataStats p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        #dataStats span {
            font-weight: bold;
            color: #e53e3e;
        }

        .filter-delete {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-delete select,
        .filter-delete input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e53e3e;
        }

        .delete-preview h4 {
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .delete-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* ÂúñË°®È†ÅÈù¢Ê®£Âºè */
        .chart-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-amount {
                margin: 10px 0;
            }

            .import-options {
                grid-template-columns: 1fr;
            }

            .import-actions, .export-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ ÂÆ∂Â∫≠Êî∂ÊîØÂπ≥Âè∞</h1>
            <p>ËºïÈ¨ÜÁÆ°ÁêÜÊÇ®ÁöÑÂÆ∂Â∫≠Ë≤°Âãô</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Á∏ΩË¶Ω</button>
            <button class="nav-tab" onclick="showTab('list')">üìã ÂàóË°®</button>
            <button class="nav-tab" onclick="showTab('calendar')">üìÖ Êó•ÊõÜ</button>
            <button class="nav-tab" onclick="showTab('charts')">üìà ÂúñË°®</button>
            <button class="nav-tab" onclick="showTab('add')">‚ûï Êñ∞Â¢û</button>
            <button class="nav-tab" onclick="showTab('import')">üì• ÂåØÂÖ•</button>
        </div>

        <div class="content">
            <!-- Á∏ΩË¶ΩÈ†ÅÈù¢ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalExpense">$0</h3>
                        <p>Á∏ΩÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="cashExpense">$0</h3>
                        <p>ÁèæÈáëÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="creditExpense">$0</h3>
                        <p>‰ø°Áî®Âç°ÊîØÂá∫</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="balance">$0</h3>
                        <p>ÁèæÈáëÊµÅ</p>
                    </div>
                </div>
                <div class="member-stats">
                    <h3>ÂêÑÊàêÂì°Êî∂ÊîØÁµ±Ë®à</h3>
                    <div class="member-stats-grid" id="memberStats"></div>
                </div>
                <div class="records-list">
                    <h3>Ë®òÈåÑÊü•Áúã</h3>
                    <div class="record-filter-tabs">
                        <button class="filter-tab active" onclick="showExpenseRecords()">Á∏ΩÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showCashExpenseRecords()">ÁèæÈáëÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showCreditExpenseRecords()">‰ø°Áî®Âç°ÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showIncomeRecords()">Á∏ΩÊî∂ÂÖ•</button>
                        <button class="filter-tab" onclick="showAllRecords()">ÂÖ®ÈÉ®Ë®òÈåÑ</button>
                    </div>
                    <div id="recentRecords"></div>
                </div>
            </div>

            <!-- ÂàóË°®È†ÅÈù¢ -->
            <div id="list" class="tab-content">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="ÊêúÂ∞ãË®òÈåÑ..." onkeyup="filterRecords()">
                    <select id="memberFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÊàêÂì°</option>
                        <option value="Kelvin">Kelvin</option>
                        <option value="Phuong">Phuong</option>
                        <option value="Ryan">Ryan</option>
                        <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                    </select>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                        <option value="income">Êî∂ÂÖ•</option>
                        <option value="expense">ÊîØÂá∫</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRecords()">
                </div>
                <div class="records-list">
                    <div id="allRecords"></div>
                </div>
            </div>

            <!-- Êó•ÊõÜÈ†ÅÈù¢ -->
            <div id="calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ ‰∏äÊúà</button>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">‰∏ãÊúà ‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- ÂúñË°®È†ÅÈù¢ -->
            <div id="charts" class="tab-content">
                <div class="chart-controls">
                    <div class="chart-filter-bar">
                        <select id="chartYear" onchange="updateCharts()">
                            <option value="2024">2024Âπ¥</option>
                            <option value="2025" selected>2025Âπ¥</option>
                        </select>
                        <select id="chartMonth" onchange="updateCharts()">
                            <option value="1">1Êúà</option>
                            <option value="2">2Êúà</option>
                            <option value="3">3Êúà</option>
                            <option value="4">4Êúà</option>
                            <option value="5">5Êúà</option>
                            <option value="6">6Êúà</option>
                            <option value="7">7Êúà</option>
                            <option value="8">8Êúà</option>
                            <option value="9">9Êúà</option>
                            <option value="10">10Êúà</option>
                            <option value="11">11Êúà</option>
                            <option value="12">12Êúà</option>
                        </select>
                        <button class="btn" onclick="refreshCharts()">üîÑ ÈáçÊñ∞Êï¥ÁêÜ</button>
                    </div>
                </div>

                <!-- Êî∂ÊîØË∂®Âã¢ÂúñË°® -->
                <div class="chart-section">
                    <h3>üìà Êî∂ÊîØË∂®Âã¢</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- È°ûÂà•Áµ±Ë®àÂúñË°® -->
                <div class="chart-section">
                    <h3>ü•ß È°ûÂà•Áµ±Ë®à</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- ÊàêÂì°Êî∂ÊîØÂ∞çÊØî -->
                <div class="chart-section">
                    <h3>üë• ÊàêÂì°Êî∂ÊîØÂ∞çÊØî</h3>
                    <div class="chart-container">
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÈ†ÅÈù¢ -->
            <div id="add" class="tab-content">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="member">ÊàêÂì°</label>
                            <select id="member" required>
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">ÈáëÈ°ç</label>
                            <input type="number" id="amount" step="0.01" required placeholder="Ê≠£Êï∏=Êî∂ÂÖ•, Ë≤†Êï∏=ÊîØÂá∫">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="mainCategory" required onchange="handleMainCategoryChange()">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                            </select>
                            <input type="text" id="customMainCategory" placeholder="Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="subCategory">‰ªòÊ¨æÊñπÂºè</label>
                            <select id="subCategory" required>
                                <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                                <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                                <option value="ÁèæÈáë">ÁèæÈáë</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">ÊèèËø∞</label>
                        <textarea id="description" rows="3" placeholder="Ë´ãËº∏ÂÖ•Ë©≥Á¥∞ÊèèËø∞..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Êó•Êúü</label>
                        <input type="date" id="date" required>
                    </div>
                    <button type="submit" class="btn">Êñ∞Â¢ûË®òÈåÑ</button>
                </form>
            </div>

            <!-- ÂåØÂÖ•È†ÅÈù¢ -->
            <div id="import" class="tab-content">
                <div class="import-section">
                    <h3>üì• ÂåØÂÖ•Êî∂ÊîØË®òÈåÑ</h3>
                    <p>ÊîØÊè¥ CSV Âíå Excel Ê™îÊ°àÊ†ºÂºè</p>
                    
                    <div class="import-options">
                        <div class="import-card">
                            <h4>üìÑ CSV Ê™îÊ°àÂåØÂÖ•</h4>
                            <p>Ë´ãÁ¢∫‰øù CSV Ê™îÊ°àÂåÖÂê´‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö</p>
                            <ul>
                                <li>ÊàêÂì° (Kelvin, Phuong, Ryan, ÂÆ∂Áî®)</li>
                                <li>ÈáëÈ°ç (Ê≠£Êï∏=Êî∂ÂÖ•, Ë≤†Êï∏=ÊîØÂá∫)</li>
                                <li>‰∏ªÈ°ûÂà•</li>
                                <li>‰ªòÊ¨æÊñπÂºè (‰ø°Áî®Âç°/ÁèæÈáë)</li>
                                <li>ÊèèËø∞</li>
                                <li>Êó•Êúü (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVImport(event)">
                            <button class="btn" onclick="document.getElementById('csvFile').click()">ÈÅ∏Êìá CSV Ê™îÊ°à</button>
                        </div>
                        
                        <div class="import-card">
                            <h4>üìä Excel Ê™îÊ°àÂåØÂÖ•</h4>
                            <p>Ë´ãÁ¢∫‰øù Excel Ê™îÊ°àÂåÖÂê´‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö</p>
                            <ul>
                                <li>ÊàêÂì° (Kelvin, Phuong, Ryan, ÂÆ∂Áî®)</li>
                                <li>ÈáëÈ°ç (Ê≠£Êï∏=Êî∂ÂÖ•, Ë≤†Êï∏=ÊîØÂá∫)</li>
                                <li>‰∏ªÈ°ûÂà•</li>
                                <li>‰ªòÊ¨æÊñπÂºè (‰ø°Áî®Âç°/ÁèæÈáë)</li>
                                <li>ÊèèËø∞</li>
                                <li>Êó•Êúü (YYYY-MM-DD)</li>
                            </ul>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                            <button class="btn" onclick="document.getElementById('excelFile').click()">ÈÅ∏Êìá Excel Ê™îÊ°à</button>
                        </div>
                    </div>
                    
                    <div class="import-preview" id="importPreview" style="display: none;">
                        <h4>È†êË¶ΩÂåØÂÖ•Êï∏Êìö</h4>
                        <div class="preview-table">
                            <table id="previewTable">
                                <thead>
                                    <tr>
                                        <th>ÊàêÂì°</th>
                                        <th>ÈáëÈ°ç</th>
                                        <th>‰∏ªÈ°ûÂà•</th>
                                        <th>‰ªòÊ¨æÊñπÂºè</th>
                                        <th>ÊèèËø∞</th>
                                        <th>Êó•Êúü</th>
                                        <th>ÁãÄÊÖã</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="import-actions">
                            <button class="btn btn-success" onclick="confirmImport()">Á¢∫Ë™çÂåØÂÖ•</button>
                            <button class="btn btn-danger" onclick="cancelImport()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>üì§ ÂåØÂá∫ÂäüËÉΩ</h3>
                    <p>Â∞áÁèæÊúâË®òÈåÑÂåØÂá∫ÁÇ∫ CSV Êàñ Excel Ê™îÊ°à</p>
                    <div class="export-actions">
                        <button class="btn" onclick="exportToCSV()">ÂåØÂá∫ÁÇ∫ CSV</button>
                        <button class="btn" onclick="exportToExcel()">ÂåØÂá∫ÁÇ∫ Excel</button>
                        <button class="btn" onclick="createSampleExcel()">ÂâµÂª∫Á§∫‰æã Excel</button>
                        <button class="btn" onclick="downloadDataJson()">üìÅ ‰∏ãËºâ data.json ÂÇô‰ªΩ</button>
                        <button class="btn" onclick="downloadExcelBackup()">üìä ‰∏ãËºâ Excel ÂÇô‰ªΩ</button>
                    </div>
                </div>
                
                <div class="delete-section">
                    <h3>üóëÔ∏è ÁßªÈô§Ë≥áÊñôÂäüËÉΩ</h3>
                    <p>ÁÆ°ÁêÜÊÇ®ÁöÑÊî∂ÊîØË®òÈåÑÊï∏Êìö</p>
                    
                    <div class="delete-options">
                        <div class="delete-card">
                            <h4>üîÑ Êï∏ÊìöÂêåÊ≠•</h4>
                            <div class="sync-info">
                                <p>ÂêåÊ≠•ÁãÄÊÖãÔºö<span id="syncStatus">Ê™¢Êü•‰∏≠...</span></p>
                                <p>ÊúÄÂæåÂÇô‰ªΩÔºö<span id="lastBackup">Êú™ÂÇô‰ªΩ</span></p>
                                <p>Êï∏ÊìöÂÅ•Â∫∑Ôºö<span id="dataHealth">Ê™¢Êü•‰∏≠...</span></p>
                            </div>
                            <div class="sync-actions" style="margin-top: 15px;">
                                <button class="btn" onclick="manualSync()" style="margin-right: 10px;">üîÑ Á´ãÂç≥ÂêåÊ≠•</button>
                                <button class="btn" onclick="clearCacheAndSync()" style="margin-right: 10px;">üóëÔ∏è Ê∏ÖÈô§Á∑©Â≠ò‰∏¶ÂêåÊ≠•</button>
                                <button class="btn" onclick="checkDataHealth()" style="margin-right: 10px;">üîç Êï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•</button>
                                <button class="btn" onclick="quickFix()" style="margin-right: 10px;">üîß Âø´ÈÄü‰øÆÂæ©</button>
                                <button class="btn" onclick="toggleAutoSync()" id="autoSyncBtn">‚è∏Ô∏è Êö´ÂÅúËá™ÂãïÂêåÊ≠•</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>üîç ÁØ©ÈÅ∏Âà™Èô§</h4>
                            <p>Ê†πÊìöÊ¢ù‰ª∂Âà™Èô§Ë®òÈåÑ</p>
                            <div class="filter-delete">
                            <select id="deleteMemberFilter">
                                <option value="">ÊâÄÊúâÊàêÂì°</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                            </select>
                                <select id="deleteTypeFilter">
                                    <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                                    <option value="income">Êî∂ÂÖ•</option>
                                    <option value="expense">ÊîØÂá∫</option>
                                </select>
                                <input type="date" id="deleteDateFrom" placeholder="ÈñãÂßãÊó•Êúü">
                                <input type="date" id="deleteDateTo" placeholder="ÁµêÊùüÊó•Êúü">
                                <button class="btn btn-danger" onclick="previewDelete()">È†êË¶ΩÂà™Èô§</button>
                            </div>
                        </div>
                        
                        <div class="delete-card">
                            <h4>‚ö†Ô∏è Âç±Èö™Êìç‰Ωú</h4>
                            <p>Ë´ãË¨πÊÖé‰ΩøÁî®‰ª•‰∏ãÂäüËÉΩ</p>
                            <div class="danger-actions">
                                <button class="btn btn-danger" onclick="clearAllData()">Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö</button>
                                <button class="btn" onclick="backupData()">ÂÇô‰ªΩÊï∏Êìö</button>
                                <button class="btn" onclick="restoreData()">ÈÇÑÂéüÊï∏Êìö</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delete-preview" id="deletePreview" style="display: none;">
                        <h4>È†êË¶ΩÂ∞áË¶ÅÂà™Èô§ÁöÑË®òÈåÑ</h4>
                        <div class="preview-table">
                            <table id="deletePreviewTable">
                                <thead>
                                    <tr>
                                        <th>ÊàêÂì°</th>
                                        <th>ÈáëÈ°ç</th>
                                        <th>‰∏ªÈ°ûÂà•</th>
                                        <th>‰ªòÊ¨æÊñπÂºè</th>
                                        <th>ÊèèËø∞</th>
                                        <th>Êó•Êúü</th>
                                    </tr>
                                </thead>
                                <tbody id="deletePreviewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="delete-actions">
                            <button class="btn btn-danger" onclick="confirmDelete()">Á¢∫Ë™çÂà™Èô§</button>
                            <button class="btn" onclick="cancelDelete()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØË®òÈåÑÁöÑÊ®°ÊÖãÊ°Ü -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Á∑®ËºØË®òÈåÑ</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMember">ÊàêÂì°</label>
                        <select id="editMember" required>
                            <option value="Kelvin">Kelvin</option>
                            <option value="Phuong">Phuong</option>
                            <option value="Ryan">Ryan</option>
                            <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editType">È°ûÂûã</label>
                        <select id="editType" required>
                            <option value="income">Êî∂ÂÖ•</option>
                            <option value="expense">ÊîØÂá∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">ÈáëÈ°ç</label>
                        <input type="number" id="editAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="editMainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="editMainCategory" required onchange="handleEditMainCategoryChange()">
                            </select>
                            <input type="text" id="editCustomMainCategory" placeholder="Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•" style="display: none; margin-top: 10px;">
                        </div>
                    <div class="form-group">
                        <label for="editSubCategory">‰ªòÊ¨æÊñπÂºè</label>
                        <select id="editSubCategory" required>
                            <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                            <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                            <option value="ÁèæÈáë">ÁèæÈáë</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">ÊèèËø∞</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editDate">Êó•Êúü</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">ÂÑ≤Â≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ê∑ªÂä† CSV Âíå Excel Ëß£ÊûêÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Ê∑ªÂä† Chart.js ÂúñË°®Â∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Êï∏ÊìöÂ≠òÂÑ≤
        let records = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Ë∑®ÁÄèË¶ΩÂô®Êï∏ÊìöÂêåÊ≠•
        let syncInterval = null;
        let lastSyncTime = localStorage.getItem('lastSyncTime') || 0;

        // ÂæûÊúçÂãôÂô®ÂêåÊ≠•Êï∏Êìö
        async function syncFromServer() {
            try {
                console.log('üîÑ ÈñãÂßãÊ™¢Êü•ÊúçÂãôÂô®Êï∏Êìö...');
                const response = await fetch('http://localhost:3001/api/restore');
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì° ÊúçÂãôÂô®ÈüøÊáâ:', result);
                    
                    if (result.hasNewData) {
                        console.log('üîÑ ÁôºÁèæÊúçÂãôÂô®ÊúâÊñ∞Êï∏ÊìöÔºåÊ≠£Âú®ÂêåÊ≠•...');
                        await loadDataFromFile();
                        updateAllDisplays();
                        localStorage.setItem('lastSyncTime', Date.now());
                        return true;
                    } else {
                        console.log('üìä ÊúçÂãôÂô®Êï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞');
                        // Âç≥‰ΩøÊ≤íÊúâÊñ∞Êï∏ÊìöÔºå‰πüÂº∑Âà∂ÈáçÊñ∞ËÆÄÂèñdata.json‰ª•Á¢∫‰øùÂêåÊ≠•
                        await loadDataFromFile();
                        updateAllDisplays();
                        return false;
                    }
                } else {
                    console.warn('‚ö†Ô∏è ÊúçÂãôÂô®ÈüøÊáâÈåØË™§:', response.status);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è ÊúçÂãôÂô®ÂêåÊ≠•Â§±Êïó:', error.message);
                // Â¶ÇÊûúAPI‰∏çÂèØÁî®ÔºåÂòóË©¶ÂæûÊú¨Âú∞Êñá‰ª∂ËÆÄÂèñ
                try {
                    await loadDataFromFile();
                    console.log('üìÅ Â∑≤ÂæûÊú¨Âú∞Êñá‰ª∂ËÆÄÂèñÊï∏Êìö');
                    return true;
                } catch (fileError) {
                    console.warn('‚ö†Ô∏è Êú¨Âú∞Êñá‰ª∂ËÆÄÂèñ‰πüÂ§±Êïó:', fileError.message);
                }
            }
            return false;
        }

        // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
        function updateAllDisplays() {
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
            updateMemberStats();
        }

        // ÂïüÂãïËá™ÂãïÂêåÊ≠•
        function startAutoSync() {
            // ÊØè10ÁßíÊ™¢Êü•‰∏ÄÊ¨°ÊúçÂãôÂô®Êõ¥Êñ∞
            syncInterval = setInterval(async () => {
                console.log('üîÑ Ëá™ÂãïÂêåÊ≠•Ê™¢Êü•...');
                try {
                    const synced = await syncFromServer();
                    if (synced) {
                        console.log('‚úÖ Ëá™ÂãïÂêåÊ≠•ÂÆåÊàê');
                        // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫
                        const syncStatus = document.getElementById('syncStatus');
                        if (syncStatus) {
                            syncStatus.textContent = 'Â∑≤ÂêåÊ≠•';
                            setTimeout(() => {
                                syncStatus.textContent = 'ÈÅãË°å‰∏≠';
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Ëá™ÂãïÂêåÊ≠•ÈåØË™§:', error);
                }
            }, 10000);

            console.log('üîÑ Ëá™ÂãïÂêåÊ≠•Â∑≤ÂïüÂãï (ÊØè10ÁßíÊ™¢Êü•‰∏ÄÊ¨°)');
            
            // Á´ãÂç≥Âü∑Ë°å‰∏ÄÊ¨°ÂêåÊ≠•Ê™¢Êü•
            setTimeout(async () => {
                console.log('üîÑ ÂàùÂßãÂêåÊ≠•Ê™¢Êü•...');
                try {
                    const synced = await syncFromServer();
                    if (synced) {
                        console.log('‚úÖ ÂàùÂßãÂêåÊ≠•ÂÆåÊàê');
                    }
                } catch (error) {
                    console.error('‚ùå ÂàùÂßãÂêåÊ≠•ÈåØË™§:', error);
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢Ëá™ÂãïÂêåÊ≠•
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('‚èπÔ∏è Ëá™ÂãïÂêåÊ≠•Â∑≤ÂÅúÊ≠¢');
            }
        }

        // ÊâãÂãïÂêåÊ≠•
        async function manualSync() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'ÂêåÊ≠•‰∏≠...';
            
            try {
                console.log('üîÑ ÊâãÂãïÂêåÊ≠•ÈñãÂßã...');
                const synced = await syncFromServer();
                if (synced) {
                    syncStatus.textContent = 'Â∑≤ÂêåÊ≠•';
                    alert('‚úÖ Êï∏ÊìöÂêåÊ≠•ÂÆåÊàêÔºÅ');
                    console.log('‚úÖ ÊâãÂãïÂêåÊ≠•ÊàêÂäü');
                } else {
                    syncStatus.textContent = 'Â∑≤ÊòØÊúÄÊñ∞';
                    alert('üìä Êï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨');
                    console.log('üìä Êï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞');
                }
            } catch (error) {
                syncStatus.textContent = 'ÂêåÊ≠•Â§±Êïó';
                alert('‚ùå ÂêåÊ≠•Â§±ÊïóÔºö' + error.message);
                console.error('‚ùå ÊâãÂãïÂêåÊ≠•Â§±Êïó:', error);
            }
        }

        // Ê∏ÖÈô§Á∑©Â≠ò‰∏¶ÂêåÊ≠•
        async function clearCacheAndSync() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'Ê∏ÖÈô§Á∑©Â≠ò‰∏≠...';
            
            try {
                console.log('üóëÔ∏è Ê∏ÖÈô§localStorageÁ∑©Â≠ò...');
                
                // Ê∏ÖÈô§localStorage‰∏≠ÁöÑËàäÊï∏Êìö
                localStorage.removeItem('familyRecords');
                localStorage.removeItem('lastSyncTime');
                localStorage.removeItem('lastGitHubBackup');
                localStorage.removeItem('lastLocalBackup');
                
                console.log('‚úÖ Á∑©Â≠òÂ∑≤Ê∏ÖÈô§');
                
                // Âº∑Âà∂ÂæûÊúçÂãôÂô®ÈáçÊñ∞ËÆÄÂèñÊï∏Êìö
                console.log('üîÑ ÂæûÊúçÂãôÂô®ÈáçÊñ∞ËÆÄÂèñÊï∏Êìö...');
                await loadDataFromFile();
                
                // Êõ¥Êñ∞ÊâÄÊúâUIÈ°ØÁ§∫
                console.log('üîÑ Êõ¥Êñ∞UIÈ°ØÁ§∫...');
                updateStats();
                updateRecentRecords();
                updateCalendar();
                updateDataStats();
                updateMemberStats();
                updateAllRecords();
                showExpenseRecords(); // È°ØÁ§∫ÊîØÂá∫Ë®òÈåÑ
                
                syncStatus.textContent = 'Â∑≤ÂêåÊ≠•';
                alert('‚úÖ Á∑©Â≠òÂ∑≤Ê∏ÖÈô§ÔºåÊï∏ÊìöÂ∑≤ÈáçÊñ∞ÂêåÊ≠•ÔºÅ');
                console.log('‚úÖ Ê∏ÖÈô§Á∑©Â≠ò‰∏¶ÂêåÊ≠•ÊàêÂäüÔºåË®òÈåÑÊï∏Èáè:', records.length);
                
            } catch (error) {
                syncStatus.textContent = 'ÂêåÊ≠•Â§±Êïó';
                alert('‚ùå Ê∏ÖÈô§Á∑©Â≠òÂ§±ÊïóÔºö' + error.message);
                console.error('‚ùå Ê∏ÖÈô§Á∑©Â≠òÂ§±Êïó:', error);
            }
        }

        // ÂàáÊèõËá™ÂãïÂêåÊ≠•
        function toggleAutoSync() {
            const btn = document.getElementById('autoSyncBtn');
            const syncStatus = document.getElementById('syncStatus');
            
            if (syncInterval) {
                // ÂÅúÊ≠¢Ëá™ÂãïÂêåÊ≠•
                stopAutoSync();
                btn.textContent = '‚ñ∂Ô∏è ÂïüÂãïËá™ÂãïÂêåÊ≠•';
                btn.style.backgroundColor = '#28a745';
                syncStatus.textContent = 'Â∑≤Êö´ÂÅú';
            } else {
                // ÂïüÂãïËá™ÂãïÂêåÊ≠•
                startAutoSync();
                btn.textContent = '‚è∏Ô∏è Êö´ÂÅúËá™ÂãïÂêåÊ≠•';
                btn.style.backgroundColor = '#ffc107';
                syncStatus.textContent = 'ÈÅãË°å‰∏≠';
            }
        }

        // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫
        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            const btn = document.getElementById('autoSyncBtn');
            
            if (syncInterval) {
                syncStatus.textContent = 'ÈÅãË°å‰∏≠';
                btn.textContent = '‚è∏Ô∏è Êö´ÂÅúËá™ÂãïÂêåÊ≠•';
                btn.style.backgroundColor = '#ffc107';
            } else {
                syncStatus.textContent = 'Â∑≤Êö´ÂÅú';
                btn.textContent = '‚ñ∂Ô∏è ÂïüÂãïËá™ÂãïÂêåÊ≠•';
                btn.style.backgroundColor = '#28a745';
            }
        }

        // GitHubËá™ÂãïÂÇô‰ªΩÂäüËÉΩ
        async function backupToGitHub() {
            try {
                console.log('ÈñãÂßãËá™ÂãïÂÇô‰ªΩÂà∞GitHub...');
                
                // Áõ¥Êé•Ë™øÁî®ÂæåÁ´ØAPIÂÇô‰ªΩ
                const response = await fetch('http://localhost:3001/api/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        records: records,
                        timestamp: new Date().toISOString(),
                        count: records.length
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ ÊàêÂäüÂÇô‰ªΩÂà∞GitHub:', result.message);
                    localStorage.setItem('lastGitHubBackup', new Date().toISOString());
                    updateDataStats();
                    return true;
                } else {
                    const errorData = await response.json();
                    console.warn('‚ö†Ô∏è ÂÇô‰ªΩÂ§±Êïó:', errorData.message);
                    localStorage.setItem('lastLocalBackup', new Date().toISOString());
                    return false;
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è GitHubÂÇô‰ªΩÂ§±Êïó:', error.message);
                localStorage.setItem('lastLocalBackup', new Date().toISOString());
                return false;
            }
        }

        // ÂæûGitHubÈÇÑÂéüÊï∏Êìö
        async function restoreFromGitHub() {
            try {
                console.log('Ê™¢Êü•GitHub‰∏äÁöÑÊúÄÊñ∞Êï∏Êìö...');
                
                // Áõ¥Êé•Ë™øÁî®ÂæåÁ´ØAPIÊ™¢Êü•
                const response = await fetch('http://localhost:3001/api/restore');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.hasNewData) {
                        console.log('ÁôºÁèæGitHub‰∏äÊúâÊñ∞Êï∏ÊìöÔºåÊ≠£Âú®ÂêåÊ≠•...');
                        
                        // ÈáçÊñ∞ËºâÂÖ•data.json
                        await loadDataFromFile();
                        
                        console.log('‚úÖ ÊàêÂäüÂæûGitHubÈÇÑÂéüÊï∏Êìö');
                        return true;
                    } else {
                        console.log('GitHubÊï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞');
                        return false;
                    }
                } else {
                    console.warn('‚ö†Ô∏è ÈÇÑÂéüÊ™¢Êü•Â§±Êïó:', response.status);
                    return false;
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è GitHubÈÇÑÂéüÂ§±Êïó:', error.message);
                return false;
            }
        }
        
        // Ê™¢Êü•ÊòØÂê¶Êúâ2025Âπ¥ÁöÑË®òÈåÑÔºåÂ¶ÇÊûúÊúâÂâáÂàáÊèõÂà∞2025Âπ¥
        function checkAndSwitchTo2025() {
            const has2025Records = records.some(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === 2025;
            });
            
            if (has2025Records) {
                currentYear = 2025;
                console.log('Ê™¢Ê∏¨Âà∞2025Âπ¥Ë®òÈåÑÔºåÂàáÊèõÊó•ÊõÜÂà∞2025Âπ¥');
                updateCalendar();
            }
        }
        let importData = []; // ÂÑ≤Â≠òË¶ÅÂåØÂÖ•ÁöÑÊï∏Êìö
        let deleteData = []; // ÂÑ≤Â≠òË¶ÅÂà™Èô§ÁöÑÊï∏Êìö
        let dataBackup = null; // Êï∏ÊìöÂÇô‰ªΩ
        
        // ÂúñË°®Áõ∏ÈóúËÆäÊï∏
        let trendChart = null;
        let categoryChart = null;
        let memberChart = null;

        // È°ûÂà•ÈÅ∏È†Ö
        const categories = {
            income: ['Ëñ™Ë≥á', 'ÁçéÈáë', 'ÊäïË≥áÊî∂Áõä', 'ÊàøÁßüÊî∂ÂÖ•', 'ÂÄüÊ¨æÊî∂ÂÖ•', '‰ª£‰ªòÊî∂ÂÖ•', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
            expense: {
                'Â®õÊ®Ç': [],
                'Êó•Â∏∏': [],
                'È§êÈ£≤': [],
                'Ê•äÊ¢Ö': [],
                '‰∫§ÈÄö': [],
                'ÂÖ∂‰ªñ': [],
                'ÂÅ•Â∫∑': [],
                'Á¶ÆÁâ©': [],
                'Â≠∏Ë≤ª': []
            }
        };

        // ÂÆ∂Â∫≠ÊàêÂì°
        const familyMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];

        // Âõ∫ÂÆöÊîØÂá∫ÊèêÈÜí
        const recurringExpenses = [
            { name: 'ÊàøÁßü', amount: 15000, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊàøË≤∏', amount: 21454, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊâãÊ©üË≤ª', amount: 1200, day: 15, member: 'Kelvin' },
            { name: 'Á∂≤Ë∑ØË≤ª', amount: 1598, day: 15, member: 'Phuong' }
        ];

        // SafariÂÖºÂÆπÊÄßÊ™¢Ê∏¨Âíå‰øÆÂæ©
        function detectAndFixSafari() {
            const userAgent = navigator.userAgent;
            const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');
            
            if (isSafari) {
                console.log('üçé Ê™¢Ê∏¨Âà∞SafariÔºåÂü∑Ë°åÂÖºÂÆπÊÄß‰øÆÂæ©...');
                
                // Ê∏ÖÈô§SafariÁ∑©Â≠ò
                localStorage.removeItem('familyRecords');
                localStorage.removeItem('lastSyncTime');
                localStorage.removeItem('lastGitHubBackup');
                localStorage.removeItem('lastLocalBackup');
                
                // Ê∑ªÂä†SafariÂ∞àÁî®ÊèêÁ§∫
                const safariNotice = document.createElement('div');
                safariNotice.id = 'safari-notice';
                safariNotice.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #ff6b6b;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                safariNotice.innerHTML = `
                    üçé SafariÊ®°Âºè | 
                    <button onclick="forceRefreshData()" style="background: white; color: #ff6b6b; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px;">
                        Âº∑Âà∂Âà∑Êñ∞
                    </button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                        ‚úï
                    </button>
                `;
                document.body.appendChild(safariNotice);
                
                // 5ÁßíÂæåËá™ÂãïÈö±Ëóè
                setTimeout(() => {
                    if (safariNotice.parentElement) {
                        safariNotice.remove();
                    }
                }, 5000);
                
                console.log('‚úÖ SafariÂÖºÂÆπÊÄß‰øÆÂæ©ÂÆåÊàê');
            }
            
            return isSafari;
        }

        // Âº∑Âà∂Âà∑Êñ∞Êï∏ÊìöÔºàSafariÂ∞àÁî®Ôºâ
        async function forceRefreshData() {
            console.log('üîÑ SafariÂº∑Âà∂Âà∑Êñ∞Êï∏Êìö...');
            
            try {
                const timestamp = new Date().getTime();
                const url = `data.json?t=${timestamp}`;
                console.log(`‰ΩøÁî®Âº∑Âà∂Âà∑Êñ∞URL: ${url}`);
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        
                        // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        updateSyncStatus();
                        
                        console.log(`‚úÖ SafariÂº∑Âà∂Âà∑Êñ∞ÊàêÂäüÔºåËºâÂÖ• ${records.length} Á≠ÜË®òÈåÑ`);
                        alert(`‚úÖ SafariÂº∑Âà∂Âà∑Êñ∞ÊàêÂäüÔºÅ\nËºâÂÖ• ${records.length} Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå SafariÂº∑Âà∂Âà∑Êñ∞Â§±Êïó:', error);
                alert('‚ùå SafariÂº∑Âà∂Âà∑Êñ∞Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊúçÂãôÁãÄÊÖã');
            }
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMÂ∑≤ËºâÂÖ•ÔºåÈñãÂßãÂàùÂßãÂåñ...');
            
            // Ê™¢Ê∏¨‰∏¶‰øÆÂæ©Safari
            const isSafari = detectAndFixSafari();
            console.log('üåê ÁÄèË¶ΩÂô®Ê™¢Ê∏¨:', isSafari ? 'Safari' : 'ÂÖ∂‰ªñ');
            
            initializeApp();
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÊôÇÂêåÊ≠•Êï∏Êìö
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è È†ÅÈù¢ÈáçÊñ∞ÂèØË¶ãÔºåÁ´ãÂç≥ÂêåÊ≠•Êï∏Êìö');
                syncFromServer().then(synced => {
                    if (synced) {
                        console.log('‚úÖ È†ÅÈù¢ÂèØË¶ãÊÄßÂêåÊ≠•ÂÆåÊàê');
                    }
                });
            }
        });

        // È†ÅÈù¢Áç≤ÂæóÁÑ¶ÈªûÊôÇÂêåÊ≠•Êï∏Êìö
        window.addEventListener('focus', function() {
            console.log('üéØ È†ÅÈù¢Áç≤ÂæóÁÑ¶ÈªûÔºåÊ™¢Êü•Êï∏ÊìöÊõ¥Êñ∞');
            syncFromServer().then(synced => {
                if (synced) {
                    console.log('‚úÖ ÁÑ¶ÈªûÂêåÊ≠•ÂÆåÊàê');
                }
            });
        });

        async function initializeApp() {
            console.log('ÈñãÂßãÂàùÂßãÂåñÊáâÁî®Á®ãÂºè...');
            
            // Á∏ΩÊòØÂæûÊúçÂãôÂô®ËÆÄÂèñÊúÄÊñ∞Êï∏Êìö
            console.log('üîÑ ÂæûÊúçÂãôÂô®ËÆÄÂèñÊúÄÊñ∞Êï∏Êìö...');
            await loadDataFromFile();
            
            // Á¢∫‰øùrecordsËÆäÈáèÂ∑≤Êõ¥Êñ∞
            console.log('üîÑ ÂàùÂßãÂåñÂÆåÊàêÔºåÁï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('üîÑ Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâGitHubÊõ¥Êñ∞Ôºå‰ΩÜ‰∏çË¶ÅË¶ÜËìãÂ∑≤ËºâÂÖ•ÁöÑÊï∏Êìö
            console.log('üîç Ê™¢Êü•GitHubÊõ¥Êñ∞...');
            try {
                const response = await fetch('http://localhost:3001/api/restore');
                if (response.ok) {
                    const result = await response.json();
                    if (result.hasNewData) {
                        console.log('üìä GitHubÊï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞ÔºåÁÑ°ÈúÄË¶ÜËìãÊú¨Âú∞Êï∏Êìö');
                    } else {
                        console.log('üìä GitHubÊï∏ÊìöÂ∑≤ÊòØÊúÄÊñ∞');
                    }
                } else {
                    console.log('üìä GitHubÊ™¢Êü•Â§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Êï∏Êìö');
                }
            } catch (error) {
                console.log('üìä GitHubÊ™¢Êü•Â§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Êï∏Êìö:', error.message);
            }
            
            console.log('ÂàùÂßãÂåñÂÆåÊàêÔºåÁï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // ÂïüÂãïË∑®ÁÄèË¶ΩÂô®Ëá™ÂãïÂêåÊ≠•
            startAutoSync();
            
            updateCategoryOptions();
            updateStats();
            updateMemberStats();
            showExpenseRecords(); // ÈªòË™çÈ°ØÁ§∫Áï∂ÊúàÁ∏ΩÊîØÂá∫Ë®òÈåÑ
            updateAllRecords();
            updateCalendar();
            setTodayDate();
            updateDataStats();
            updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫
            
            // Â¶ÇÊûúÊ≤íÊúâË®òÈåÑÔºå‰∏çËá™ÂãïÊ∑ªÂä†Á§∫‰æãÊï∏Êìö
            // if (records.length === 0) {
            //     addSampleData();
            // }
            
            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
            checkAndSwitchTo2025();
            
            console.log('ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂÆåÊàê');
        }

        // ÂæûÊ™îÊ°àËºâÂÖ•Ë≥áÊñô
        async function loadDataFromFile() {
            try {
                console.log('ÈñãÂßãËºâÂÖ• data.json...');
                // ÂòóË©¶Â§öÁ®ÆÊñπÊ≥ïËÆÄÂèñdata.json
                let data = null;
                
                // ÊñπÊ≥ï1: ‰ΩøÁî®fetch (Â∏∂ÊôÇÈñìÊà≥Âº∑Âà∂Âà∑Êñ∞)
                try {
                    const timestamp = new Date().getTime();
                    const url = `data.json?t=${timestamp}`;
                    console.log(`‰ΩøÁî®URL: ${url}`);
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        data = await response.json();
                        console.log('‚úÖ ‰ΩøÁî®fetchÊàêÂäüËºâÂÖ• data.json');
                    } else {
                        console.log('‚ùå fetchËºâÂÖ•Â§±ÊïóÔºåÁãÄÊÖãÁ¢º:', response.status);
                    }
                } catch (fetchError) {
                    console.log('‚ùå fetchËºâÂÖ•Â§±Êïó:', fetchError.message);
                    
                    // ÊñπÊ≥ï2: ‰ΩøÁî®XMLHttpRequest (Â∏∂ÊôÇÈñìÊà≥Âº∑Âà∂Âà∑Êñ∞)
                    try {
                        const timestamp = new Date().getTime();
                        const url = `data.json?t=${timestamp}`;
                        console.log(`‰ΩøÁî®XHR URL: ${url}`);
                        
                        data = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState === 4) {
                                    if (xhr.status === 200) {
                                        try {
                                            resolve(JSON.parse(xhr.responseText));
                                        } catch (e) {
                                            reject(e);
                                        }
                                    } else {
                                        reject(new Error(`HTTP ${xhr.status}`));
                                    }
                                }
                            };
                            xhr.send();
                        });
                        console.log('‚úÖ ‰ΩøÁî®XMLHttpRequestÊàêÂäüËºâÂÖ• data.json');
                    } catch (xhrError) {
                        console.log('‚ùå XMLHttpRequestËºâÂÖ•Â§±Êïó:', xhrError.message);
                    }
                }
                
                if (data) {
                    console.log('ÊàêÂäüËºâÂÖ• data.json:', data);
                    if (data.records && Array.isArray(data.records)) {
                        // Â¶ÇÊûúÊ™îÊ°à‰∏≠ÊúâË≥áÊñôÔºå‰ΩøÁî®Ê™îÊ°àÁöÑË≥áÊñô‰∏¶Êõ¥Êñ∞localStorage
                        records = data.records;
                        localStorage.setItem('familyRecords', JSON.stringify(records));
                        console.log('Âæû data.json ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                        console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
                        console.log('‚úÖ Â∑≤ÂêåÊ≠•Âà∞localStorage');
                        console.log('üîÑ ÂÖ®Â±ÄrecordsËÆäÈáèÂ∑≤Êõ¥Êñ∞ÁÇ∫:', records.length, 'Á≠ÜË®òÈåÑ');
                    } else {
                        // Â¶ÇÊûúÊ™îÊ°à‰∏≠Ê≤íÊúâË≥áÊñôÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•
                        const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                        if (localRecords.length > 0) {
                            records = localRecords;
                            console.log('Âæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                        } else {
                            records = []; // Á¢∫‰øùrecordsÊòØÁ©∫Êï∏ÁµÑ
                            console.log('data.json Âíå localStorage ÈÉΩÊ≤íÊúâË≥áÊñôÔºårecordsË®≠ÁÇ∫Á©∫Êï∏ÁµÑ');
                        }
                    }
                } else {
                    console.log('data.json ËºâÂÖ•Â§±ÊïóÔºåÁãÄÊÖãÁ¢º:', response.status);
                    // Â¶ÇÊûúÊ™îÊ°à‰∏çÂ≠òÂú®ÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•
                    const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                    if (localRecords.length > 0) {
                        records = localRecords;
                        console.log('Âæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                    } else {
                        records = []; // Á¢∫‰øùrecordsÊòØÁ©∫Êï∏ÁµÑ
                        console.log('localStorage ‰πüÊ≤íÊúâË≥áÊñôÔºårecordsË®≠ÁÇ∫Á©∫Êï∏ÁµÑ');
                    }
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïËºâÂÖ• data.jsonÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•:', error);
                // Â¶ÇÊûúËºâÂÖ•Ê™îÊ°àÂ§±ÊïóÔºåÂòóË©¶Âæû localStorage ËºâÂÖ•
                const localRecords = JSON.parse(localStorage.getItem('familyRecords')) || [];
                if (localRecords.length > 0) {
                    records = localRecords;
                    console.log('Âæû localStorage ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                } else {
                    records = []; // Á¢∫‰øùrecordsÊòØÁ©∫Êï∏ÁµÑ
                    console.log('localStorage ‰πüÊ≤íÊúâË≥áÊñôÔºårecordsË®≠ÁÇ∫Á©∫Êï∏ÁµÑ');
                }
            }
        }

        // Ê∑ªÂä†Á§∫‰æãÊï∏Êìö
        function addSampleData() {
            const today = new Date();
            const sampleRecords = [
                {
                    id: 'sample-1',
                    member: 'Kelvin',
                    type: 'expense',
                    amount: 1200,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'ÊâãÊ©üË≤ª',
                    description: 'ÊâãÊ©üË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-2',
                    member: 'Phuong',
                    type: 'expense',
                    amount: 1598,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'Á∂≤Ë∑ØË≤ª',
                    description: 'Á∂≤Ë∑ØË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-3',
                    member: 'ÂÆ∂Áî®',
                    type: 'income',
                    amount: 50000,
                    mainCategory: 'Ëñ™Ë≥á',
                    subCategory: '',
                    description: 'Kelvin Ëñ™Ë≥á',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-4',
                    member: 'ÂÆ∂Áî®',
                    type: 'expense',
                    amount: 15000,
                    mainCategory: 'Â±Ö‰Ωè',
                    subCategory: 'ÊàøÁßü',
                    description: 'ÊàøÁßü',
                    date: today.toISOString().split('T')[0]
                }
            ];
            
            records = records.concat(sampleRecords);
            saveRecords();
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
        }

        // Áµ±‰∏ÄÁöÑÊó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∏ÔºåÈÅøÂÖçÊôÇÂçÄÂïèÈ°å
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setTodayDate() {
            const today = formatDateToYYYYMMDD(new Date());
            document.getElementById('date').value = today;
        }

        function updateCategoryOptions() {
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');

            function updateMainCategories(amountInput, mainCategorySelect) {
                const amount = parseFloat(amountInput.value) || 0;
                // Â¶ÇÊûúÈáëÈ°çÁÇ∫0ÊàñÁ©∫ÔºåÈªòË™çÈ°ØÁ§∫ÊîØÂá∫È°ûÂà•ÔºàÂõ†ÁÇ∫Â§ßÈÉ®ÂàÜË®òÈåÑÈÉΩÊòØÊîØÂá∫Ôºâ
                const type = (amount === 0 || isNaN(amount)) ? 'expense' : (amount >= 0 ? 'income' : 'expense');
                mainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
                
                console.log('updateMainCategories called:', { amount, type, inputValue: amountInput.value });
                
                if (type === 'income') {
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                } else if (type === 'expense') {
                    // Áç≤ÂèñÊâÄÊúâÊîØÂá∫È°ûÂà•ÔºàÊéíÈô§"ÂÖ∂‰ªñ"Ôºâ
                    const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñ');
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
                    const otherOption = document.createElement('option');
                    otherOption.value = 'ÂÖ∂‰ªñ';
                    otherOption.textContent = 'ÂÖ∂‰ªñ';
                    mainCategorySelect.appendChild(otherOption);
                }
                
                console.log('‰∏ªÈ°ûÂà•ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞ÔºåÊï∏Èáè:', mainCategorySelect.options.length);
            }

            amountInput.addEventListener('input', () => {
                updateMainCategories(amountInput, mainCategorySelect);
            });
            
            // ÂàùÂßãÂåñÊôÇ‰πüË™øÁî®‰∏ÄÊ¨°ÔºåÁ¢∫‰øùÈ†ÅÈù¢Âä†ËºâÊôÇÊúâÊ≠£Á¢∫ÁöÑÁãÄÊÖã
            console.log('ÂàùÂßãÂåñÈ°ûÂà•ÈÅ∏ÊìáÂô®...');
            updateMainCategories(amountInput, mainCategorySelect);

            // Á∑®ËºØË°®ÂñÆÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®Ôºà‰øùÊåÅÂéüÊúâÈÇèËºØÔºåÂõ†ÁÇ∫Á∑®ËºØË°®ÂñÆ‰ªçÊúâÈ°ûÂûãÈÅ∏ÊìáÂô®Ôºâ
            editTypeSelect.addEventListener('change', () => {
                updateMainCategories(editTypeSelect, editMainCategorySelect);
            });
        }

        // ËôïÁêÜ‰∏ªÈ°ûÂà•ËÆäÂåñ
        function handleMainCategoryChange() {
            const mainCategorySelect = document.getElementById('mainCategory');
            const customInput = document.getElementById('customMainCategory');
            
            if (mainCategorySelect.value === 'ÂÖ∂‰ªñ') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // ËôïÁêÜÁ∑®ËºØË°®ÂñÆ‰∏ªÈ°ûÂà•ËÆäÂåñ
        function handleEditMainCategoryChange() {
            const mainCategorySelect = document.getElementById('editMainCategory');
            const customInput = document.getElementById('editCustomMainCategory');
            
            if (mainCategorySelect.value === 'ÂÖ∂‰ªñ') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        function showTab(tabName) {
            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
            document.getElementById(tabName).classList.add('active');
            
            // Ê∑ªÂä†ÈÅ∏‰∏≠Ê®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'dashboard' ? 'Á∏ΩË¶Ω' : 
                                           tabName === 'list' ? 'ÂàóË°®' :
                                           tabName === 'calendar' ? 'Êó•ÊõÜ' :
                                           tabName === 'add' ? 'Êñ∞Â¢û' :
                                           tabName === 'import' ? 'ÂåØÂÖ•' : '')) {
                    tab.classList.add('active');
                }
            });

            // Â¶ÇÊûúÂàáÊèõÂà∞Êó•ÊõÜÈ†ÅÈù¢ÔºåÊõ¥Êñ∞Êó•ÊõÜ
            if (tabName === 'calendar') {
                setTimeout(() => {
                    updateCalendar();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞ÂúñË°®È†ÅÈù¢ÔºåÂàùÂßãÂåñÂúñË°®
            if (tabName === 'charts') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞ÂåØÂÖ•È†ÅÈù¢ÔºåÊõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
            if (tabName === 'import') {
                updateSyncStatus();
            }
        }

        function updateStats() {
            const totalIncome = records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆóÁèæÈáëÊîØÂá∫
            const cashExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ÁèæÈáë')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆó‰ø°Áî®Âç°ÊîØÂá∫
            const creditExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === '‰ø°Áî®Âç°')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆóÂÆ∂Áî®Êî∂ÂÖ•ÔºàÁèæÈáëÊµÅÔºâ
            const householdIncome = records
                .filter(record => record.member === 'ÂÆ∂Áî®' && record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // ÁèæÈáëÊµÅ = ÂÆ∂Áî®Êî∂ÂÖ• - ÁèæÈáëÊîØÂá∫
            const cashFlow = householdIncome - cashExpense;

            document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
            document.getElementById('cashExpense').textContent = `$${cashExpense.toLocaleString()}`;
            document.getElementById('creditExpense').textContent = `$${creditExpense.toLocaleString()}`;
            document.getElementById('balance').textContent = `$${cashFlow.toLocaleString()}`;

            // Êõ¥Êñ∞ÂêÑÊàêÂì°Áµ±Ë®à
            updateMemberStats();
        }

        function updateMemberStats() {
            const memberStatsContainer = document.getElementById('memberStats');
            memberStatsContainer.innerHTML = '';

            console.log('updateMemberStats: Á∏ΩË®òÈåÑÊï∏', records.length);
            console.log('updateMemberStats: Ë®òÈåÑÂÖßÂÆπ', records);

            familyMembers.forEach(member => {
                const memberRecords = records.filter(record => record.member === member);
                console.log(`${member} ÁöÑË®òÈåÑ:`, memberRecords);
                
                const memberIncome = memberRecords
                    .filter(record => record.type === 'income')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberExpense = memberRecords
                    .filter(record => record.type === 'expense')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberBalance = memberIncome - memberExpense;
                
                console.log(`${member} Áµ±Ë®à: Êî∂ÂÖ•=${memberIncome}, ÊîØÂá∫=${memberExpense}, È§òÈ°ç=${memberBalance}`);

                const memberCard = document.createElement('div');
                memberCard.className = 'stat-card';
                memberCard.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                memberCard.style.cursor = 'pointer';
                memberCard.innerHTML = `
                    <h4>${member}</h4>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <small>Êî∂ÂÖ•: $${memberIncome.toLocaleString()}</small><br>
                            <small>ÊîØÂá∫: $${memberExpense.toLocaleString()}</small>
                        </div>
                        <div style="font-weight: bold; color: ${memberBalance >= 0 ? '#51cf66' : '#ff6b6b'};">
                            $${memberBalance.toLocaleString()}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        ÈªûÊìäÊü•ÁúãË©≥Á¥∞Ë®òÈåÑ
                    </div>
                `;
                
                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
                memberCard.addEventListener('click', () => {
                    showMemberRecords(member);
                });
                
                memberStatsContainer.appendChild(memberCard);
            });
        }

        // È°ØÁ§∫ÊàêÂì°Ë©≥Á¥∞Ë®òÈåÑ
        function showMemberRecords(member) {
            const memberRecords = records.filter(record => record.member === member);
            
            if (memberRecords.length === 0) {
                alert(`${member} ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ„ÄÇ`);
                return;
            }
            
            const totalAmount = memberRecords.reduce((sum, record) => sum + record.amount, 0);
            
            // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
            updateFilterTabs('member');
            
            // È°ØÁ§∫ÊàêÂì°Ë®òÈåÑ
            displayRecords(memberRecords, `${member} ÁöÑË®òÈåÑ (ÂÖ± ${memberRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫Á∏ΩÊîØÂá∫Ë®òÈåÑ
        function showExpenseRecords() {
            console.log('showExpenseRecords Ë¢´Ë™øÁî®');
            console.log('Áï∂ÂâçË®òÈåÑÁ∏ΩÊï∏:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            console.log('Áï∂ÂâçÊúà‰ªΩ:', currentMonth, 'Áï∂ÂâçÂπ¥‰ªΩ:', currentYear);
            
            // Êö´ÊôÇÁßªÈô§Êó•ÊúüÁØ©ÈÅ∏ÔºåÈ°ØÁ§∫ÊâÄÊúâÊîØÂá∫Ë®òÈåÑ
            const expenseRecords = records.filter(record => {
                const isExpense = record.type === 'expense';
                console.log(`Ë®òÈåÑ ${record.id}: ÊàêÂì°=${record.member}, ÊòØÊîØÂá∫=${isExpense}`);
                return isExpense;
            });
            
            console.log('ÁØ©ÈÅ∏ÂæåÁöÑÊîØÂá∫Ë®òÈåÑ:', expenseRecords);
            
            const totalAmount = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('expense');
            displayRecords(expenseRecords, `Á∏ΩÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${expenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫ÁèæÈáëÊîØÂá∫Ë®òÈåÑ
        function showCashExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const cashExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ÁèæÈáë' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = cashExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('cash');
            displayRecords(cashExpenseRecords, `Áï∂ÊúàÁèæÈáëÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${cashExpenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ
        function showCreditExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const creditExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === '‰ø°Áî®Âç°' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = creditExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('credit');
            displayRecords(creditExpenseRecords, `Áï∂Êúà‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${creditExpenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫Á∏ΩÊî∂ÂÖ•Ë®òÈåÑ
        function showIncomeRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const incomeRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.member === 'ÂÆ∂Áî®' && record.type === 'income' && 
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('income');
            displayRecords(incomeRecords, `Áï∂ÊúàÁ∏ΩÊî∂ÂÖ•Ë®òÈåÑ (ÂÖ± ${incomeRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫ÂÖ®ÈÉ®Ë®òÈåÑ
        function showAllRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const allRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalIncome = allRecords.filter(r => r.member === 'ÂÆ∂Áî®' && r.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = allRecords.filter(r => r.member === 'ÂÆ∂Áî®' && r.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const netAmount = totalIncome - totalExpense;
            
            updateFilterTabs('all');
            displayRecords(allRecords, `Áï∂ÊúàÂÖ®ÈÉ®Ë®òÈåÑ (ÂÖ± ${allRecords.length} Á≠ÜÔºå$${netAmount.toLocaleString()})`);
        }

        // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
        function updateFilterTabs(activeType) {
            const tabs = document.querySelectorAll('.filter-tab');
            console.log('Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã:', activeType, 'Ê®ôÁ±§Êï∏Èáè:', tabs.length);
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('ÁßªÈô§activeÈ°ûÂà•:', tab.textContent);
            });
            
            if (activeType === 'expense') {
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊîØÂá∫ÁÇ∫active:', tabs[0].textContent);
                }
            } else if (activeType === 'cash') {
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁèæÈáëÊîØÂá∫ÁÇ∫active:', tabs[1].textContent);
                }
            } else if (activeType === 'credit') {
                if (tabs[2]) {
                    tabs[2].classList.add('active');
                    console.log('Ë®≠ÁΩÆ‰ø°Áî®Âç°ÊîØÂá∫ÁÇ∫active:', tabs[2].textContent);
                }
            } else if (activeType === 'income') {
                if (tabs[3]) {
                    tabs[3].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊî∂ÂÖ•ÁÇ∫active:', tabs[3].textContent);
                }
            } else if (activeType === 'all') {
                if (tabs[4]) {
                    tabs[4].classList.add('active');
                    console.log('Ë®≠ÁΩÆÂÖ®ÈÉ®Ë®òÈåÑÁÇ∫active:', tabs[4].textContent);
                }
            }
            // member È°ûÂûã‰∏çÊõ¥Êñ∞Ê®ôÁ±§È†ÅÔºå‰øùÊåÅÁï∂ÂâçÁãÄÊÖã
        }

        // È°ØÁ§∫Ë®òÈåÑÁöÑÈÄöÁî®ÂáΩÊï∏
        function displayRecords(recordsToShow, title) {
            console.log('displayRecords Ë¢´Ë™øÁî®');
            console.log('Ë¶ÅÈ°ØÁ§∫ÁöÑË®òÈåÑÊï∏Èáè:', recordsToShow.length);
            console.log('Ê®ôÈ°å:', title);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', recordsToShow);
            
            if (recordsToShow.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑË¶ÅÈ°ØÁ§∫ÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã');
                document.getElementById('recentRecords').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ</p>
                    </div>
                `;
                return;
            }
            
            // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let recordsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #333; margin-bottom: 15px;">${title}</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            recordsToShow.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const amountClass = record.type === 'income' ? 'income' : 'expense';
                const prefix = record.type === 'income' ? '+' : '-';
                
                recordsHtml += `
                    <div class="record-item ${amountClass}" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; background: ${record.type === 'income' ? 'rgba(81, 207, 102, 0.1)' : 'rgba(255, 107, 107, 0.1)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.member} - ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}</strong>
                                <br>
                                <small style="color: #666;">${record.description || 'ÁÑ°ÊèèËø∞'}</small>
                                <br>
                                <small style="color: #999;">${record.date}</small>
                            </div>
                            <div style="font-weight: bold; color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'};">
                                ${prefix}$${record.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('recentRecords').innerHTML = recordsHtml;
        }

        function updateRecentRecords() {
            const recentRecords = records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentRecords');
            container.innerHTML = '';
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            recentRecords.forEach(record => {
                const recordElement = createRecordElement(record);
                container.appendChild(recordElement);
            });
        }

        function updateAllRecords() {
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        function createRecordElement(record) {
            const div = document.createElement('div');
            div.className = `record-item ${record.type}`;
            
            const amountClass = record.type === 'income' ? 'income' : 'expense';
            const amountPrefix = record.type === 'income' ? '+' : '-';
            const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
            
            div.innerHTML = `
                <div class="record-info">
                    <h4>${record.member} - ${categoryText}</h4>
                    <p>${record.description || 'ÁÑ°ÊèèËø∞'}</p>
                    <p>${new Date(record.date).toLocaleDateString('zh-TW')}</p>
                </div>
                <div class="record-amount ${amountClass}">
                    ${amountPrefix}$${record.amount.toLocaleString()}
                </div>
                <div class="record-actions">
                    <button class="btn btn-small" onclick="editRecord('${record.id}')">Á∑®ËºØ</button>
                    <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')">Âà™Èô§</button>
                </div>
            `;
            
            return div;
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            
            calendarTitle.textContent = `${currentYear}Âπ¥${currentMonth + 1}Êúà`;
            
            // Ê∏ÖÁ©∫Êó•ÊõÜ
            calendarGrid.innerHTML = '';
            
            // Ê∑ªÂä†ÊòüÊúüÊ®ôÈ°å
            const weekDays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.background = '#f8f9fa';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Áç≤ÂèñÁï∂ÊúàÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂæå‰∏ÄÂ§©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ÁîüÊàê42Â§©Ôºà6ÈÄ±Ôºâ
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentMonth) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = formatDateToYYYYMMDD(date);
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-records" id="day-records-${dateStr}"></div>
                `;
                dayElement.id = `day-${dateStr}`;
                
                dayElement.onclick = () => showDayRecords(date);
                calendarGrid.appendChild(dayElement);
            }
            
            // Êõ¥Êñ∞ÊØèÊó•Ë®òÈåÑ
            updateDayRecords();
        }

        function updateDayRecords() {
            // ÂÖàÊ∏ÖÁ©∫ÊâÄÊúâÊó•ÊúüÁöÑË®òÈåÑ
            for (let i = 0; i < 42; i++) {
                const startDate = new Date(currentYear, currentMonth, 1);
                startDate.setDate(startDate.getDate() - startDate.getDay() + i);
                const dayRecordsElement = document.getElementById(`day-records-${formatDateToYYYYMMDD(startDate)}`);
                if (dayRecordsElement) {
                    dayRecordsElement.innerHTML = '';
                }
            }
            
            // ÊåâÊó•ÊúüÂíåÊàêÂì°ÂàÜÁµÑË®àÁÆóÁ∏ΩÈ°ç
            const dayMemberTotals = {};
            records.forEach(record => {
                const date = record.date;
                const member = record.member;
                const amount = record.type === 'income' ? record.amount : -record.amount;
                
                if (!dayMemberTotals[date]) {
                    dayMemberTotals[date] = {};
                }
                if (!dayMemberTotals[date][member]) {
                    dayMemberTotals[date][member] = 0;
                }
                dayMemberTotals[date][member] += amount;
            });
            
            // È°ØÁ§∫ÊØèÂÄãÊàêÂì°ÁöÑÁï∂Êó•Á∏ΩÈ°ç
            Object.keys(dayMemberTotals).forEach(date => {
                const dayRecordsElement = document.getElementById(`day-records-${date}`);
                if (dayRecordsElement) {
                    const memberTotals = dayMemberTotals[date];
                    Object.keys(memberTotals).forEach(member => {
                        const total = memberTotals[member];
                        if (total !== 0) {
                            const recordClass = total > 0 ? 'day-income' : 'day-expense';
                            const prefix = total > 0 ? '+' : '';
                            
                            const recordDiv = document.createElement('div');
                            recordDiv.className = recordClass;
                            recordDiv.textContent = `${member}: ${prefix}$${Math.abs(total).toLocaleString()}`;
                            dayRecordsElement.appendChild(recordDiv);
                        }
                    });
                }
            });
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function showDayRecords(date) {
            const dayRecords = records.filter(record => record.date === formatDateToYYYYMMDD(date));
            
            if (dayRecords.length === 0) {
                // ‰∏çÈ°ØÁ§∫ÊèêÈÜíÔºåÁõ¥Êé•ËøîÂõû
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} ÁöÑË®òÈåÑÔºö\n\n`;
            dayRecords.forEach(record => {
                const prefix = record.type === 'income' ? '+' : '-';
                const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
                message += `${record.member} - ${categoryText}: ${prefix}$${record.amount}\n`;
                if (record.description) {
                    message += `  ÊèèËø∞: ${record.description}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberFilter = document.getElementById('memberFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredRecords = records.filter(record => {
                const matchesSearch = !searchTerm || 
                    record.member.toLowerCase().includes(searchTerm) ||
                    record.mainCategory.toLowerCase().includes(searchTerm) ||
                    (record.subCategory && record.subCategory.toLowerCase().includes(searchTerm)) ||
                    record.description.toLowerCase().includes(searchTerm);
                
                const matchesMember = !memberFilter || record.member === memberFilter;
                
                const matchesType = !typeFilter || record.type === typeFilter;
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                return matchesSearch && matchesMember && matchesType && matchesDate;
            });
            
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ</p>';
                return;
            }
            
            filteredRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        // Ë°®ÂñÆÊèê‰∫§
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('member').value;
            const amount = parseFloat(document.getElementById('amount').value);
            let mainCategory = document.getElementById('mainCategory').value;
            const customMainCategory = document.getElementById('customMainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const date = document.getElementById('date').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!amount || amount === 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºàÊ≠£Êï∏=Êî∂ÂÖ•ÔºåË≤†Êï∏=ÊîØÂá∫ÔºâÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÈÅ∏Êìá‰∫Ü"ÂÖ∂‰ªñ"Ôºå‰ΩøÁî®Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
            if (mainCategory === 'ÂÖ∂‰ªñ') {
                if (!customMainCategory.trim()) {
                    alert('Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•ÔºÅ');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            // Ê†πÊìöÈáëÈ°çÊ≠£Ë≤†Á¢∫ÂÆöÈ°ûÂûã
            const type = amount > 0 ? 'income' : 'expense';
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Ë®≠ÁÇ∫‰ªäÂ§©ÁöÑÁµêÊùüÊôÇÈñì
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const record = {
                id: Date.now().toString(),
                member: member,
                type: type,
                amount: Math.abs(amount), // Â≠òÂÑ≤ÁµïÂ∞çÂÄº
                mainCategory: mainCategory,
                subCategory: subCategory,
                description: document.getElementById('description').value,
                date: date
            };
            
            records.push(record);
            saveRecords();
            
            // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub
            backupToGitHub().then(success => {
                if (success) {
                    console.log('‚úÖ Êñ∞Â¢ûË®òÈåÑÂæåËá™ÂãïÂÇô‰ªΩÊàêÂäü');
                } else {
                    console.log('‚ö†Ô∏è Êñ∞Â¢ûË®òÈåÑÂæåËá™ÂãïÂÇô‰ªΩÂ§±ÊïóÔºå‰ΩÜÊú¨Âú∞Â∑≤‰øùÂ≠ò');
                }
            });
            
            // ÈáçÁΩÆË°®ÂñÆ
            this.reset();
            setTodayDate();
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
            updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
            
            alert('Ë®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ');
        });

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMember').value = record.member;
            document.getElementById('editType').value = record.type;
            document.getElementById('editAmount').value = record.amount;
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•
            const predefinedCategories = [...categories.income, ...Object.keys(categories.expense)];
            if (predefinedCategories.includes(record.mainCategory)) {
                document.getElementById('editMainCategory').value = record.mainCategory;
                document.getElementById('editCustomMainCategory').style.display = 'none';
                document.getElementById('editCustomMainCategory').value = '';
            } else {
                document.getElementById('editMainCategory').value = 'ÂÖ∂‰ªñ';
                document.getElementById('editCustomMainCategory').style.display = 'block';
                document.getElementById('editCustomMainCategory').value = record.mainCategory;
            }
            
            document.getElementById('editSubCategory').value = record.subCategory;
            document.getElementById('editDescription').value = record.description;
            document.getElementById('editDate').value = record.date;
            
            // Êõ¥Êñ∞È°ûÂà•ÈÅ∏È†Ö
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');
            const editSubCategorySelect = document.getElementById('editSubCategory');
            
            // Êõ¥Êñ∞‰∏ªÈ°ûÂà•
            const type = editTypeSelect.value;
            editMainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            if (type === 'income') {
                categories.income.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
            } else if (type === 'expense') {
                // Áç≤ÂèñÊâÄÊúâÊîØÂá∫È°ûÂà•ÔºàÊéíÈô§"ÂÖ∂‰ªñ"Ôºâ
                const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñ');
                expenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
                // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
                const otherOption = document.createElement('option');
                otherOption.value = 'ÂÖ∂‰ªñ';
                otherOption.textContent = 'ÂÖ∂‰ªñ';
                editMainCategorySelect.appendChild(otherOption);
            }
            
            // Êõ¥Êñ∞Â≠êÈ°ûÂà•
            const mainCategory = editMainCategorySelect.value;
            editSubCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            if (type === 'expense' && mainCategory && categories.expense[mainCategory]) {
                categories.expense[mainCategory].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    editSubCategorySelect.appendChild(option);
                });
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('editMember').value;
            const type = document.getElementById('editType').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            let mainCategory = document.getElementById('editMainCategory').value;
            const customMainCategory = document.getElementById('editCustomMainCategory').value;
            const subCategory = document.getElementById('editSubCategory').value;
            const date = document.getElementById('editDate').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!type) {
                alert('Ë´ãÈÅ∏ÊìáÈ°ûÂûãÔºÅ');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÈÅ∏Êìá‰∫Ü"ÂÖ∂‰ªñ"Ôºå‰ΩøÁî®Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
            if (mainCategory === 'ÂÖ∂‰ªñ') {
                if (!customMainCategory.trim()) {
                    alert('Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•ÔºÅ');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                records[recordIndex] = {
                    id: id,
                    member: member,
                    type: type,
                    amount: amount,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    description: document.getElementById('editDescription').value,
                    date: date
                };
                
                saveRecords();
                
                // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub
                backupToGitHub().then(success => {
                    if (success) {
                        console.log('‚úÖ Á∑®ËºØË®òÈåÑÂæåËá™ÂãïÂÇô‰ªΩÊàêÂäü');
                    } else {
                        console.log('‚ö†Ô∏è Á∑®ËºØË®òÈåÑÂæåËá™ÂãïÂÇô‰ªΩÂ§±ÊïóÔºå‰ΩÜÊú¨Âú∞Â∑≤‰øùÂ≠ò');
                    }
                });
                
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
                closeModal();
                
                alert('Ë®òÈåÑÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
        });

        function deleteRecord(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')) {
                records = records.filter(record => record.id !== id);
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
                alert('Ë®òÈåÑÂ∑≤Âà™Èô§ÔºÅ');
            }
        }

        function saveRecords() {
            // ÂØ´ÂÖ• localStorage
            localStorage.setItem('familyRecords', JSON.stringify(records));
            
            // ÂÆöÊúüËá™ÂãïÂÇô‰ªΩÂà∞ data.jsonÔºàÊØè10Ê¨°Êìç‰ΩúÂÇô‰ªΩ‰∏ÄÊ¨°Ôºâ
            const backupCount = parseInt(localStorage.getItem('backupCount') || '0') + 1;
            localStorage.setItem('backupCount', backupCount.toString());
            
            if (backupCount % 10 === 0) {
                console.log(`Â∑≤ÈÄ≤Ë°å ${backupCount} Ê¨°Êìç‰ΩúÔºåËá™ÂãïÂÇô‰ªΩ data.json`);
                saveToDataJson();
            }
        }

        // ÂØ´ÂÖ• data.json Ê™îÊ°àÔºàÈÄöÈÅé‰∏ãËºâÊñπÂºèÔºâ
        function saveToDataJson() {
            try {
                const now = new Date();
                const dataToSave = {
                    records: records,
                    settings: {
                        version: "1.0",
                        lastUpdated: now.toISOString()
                    }
                };
                
                // Ë®òÈåÑÂÇô‰ªΩÊôÇÈñì
                localStorage.setItem('lastBackupTime', now.toLocaleString('zh-TW'));
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâ data.json Ê™îÊ°à
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // ÈùúÈªò‰∏ãËºâÔºà‰∏çÈ°ØÁ§∫‰∏ãËºâÂ∞çË©±Ê°ÜÔºâ
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ÊàêÂäüÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à');
                
                // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫
                updateDataStats();
            } catch (error) {
                console.warn('ÁÑ°Ê≥ïÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à:', error, '‰ΩÜ localStorage Â∑≤‰øùÂ≠ò');
            }
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            recurringExpenses.forEach(expense => {
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìË®òÈåÑ‰∫ÜÈÄôÂÄãÊúàÁöÑÂõ∫ÂÆöÊîØÂá∫
                const thisMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const existingRecord = records.find(record => 
                    record.member === expense.member &&
                    record.description.includes(expense.name) &&
                    record.date.startsWith(thisMonth)
                );
                
                // Â¶ÇÊûú‰ªäÂ§©ÊòØÂõ∫ÂÆöÊîØÂá∫ÁöÑÊó•Êúü‰∏îÈÇÑÊ≤íÊúâË®òÈåÑÔºåÈ°ØÁ§∫ÊèêÈÜí
                if (currentDay === expense.day && !existingRecord) {
                    const confirmAdd = confirm(`ÊèêÈÜíÔºö‰ªäÂ§©ÊòØ ${expense.name} ÁöÑÁπ≥Ë≤ªÊó•Ôºà$${expense.amount.toLocaleString()}ÔºâÔºåÊòØÂê¶Ë¶ÅÊñ∞Â¢ûÈÄôÁ≠ÜË®òÈåÑÔºü`);
                    if (confirmAdd) {
                        // Ê†πÊìöË≤ªÁî®ÂêçÁ®±Ê±∫ÂÆöÊ≠£Á¢∫ÁöÑÈ°ûÂà•
                        let mainCategory, subCategory;
                        if (expense.name === 'ÊàøÁßü') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøÁßü';
                        } else if (expense.name === 'ÊàøË≤∏') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøË≤∏';
                        } else if (expense.name === 'ÊâãÊ©üË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'ÊâãÊ©üË≤ª';
                        } else if (expense.name === 'Á∂≤Ë∑ØË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'Á∂≤Ë∑ØË≤ª';
                        }
                        
                        const record = {
                            id: Date.now().toString(),
                            member: expense.member,
                            type: 'expense',
                            amount: expense.amount,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            description: `${expense.name} - ${thisMonth}`,
                            date: today.toISOString().split('T')[0]
                        };
                        
                        records.push(record);
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        
                        alert(`${expense.name} Ë®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ`);
                    }
                }
            });
        }

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // CSV ÂåØÂÖ•ÂäüËÉΩ
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('CSV Ê™îÊ°àËß£ÊûêÈåØË™§Ôºö' + results.errors[0].message);
                        return;
                    }
                    processImportData(results.data);
                },
                error: function(error) {
                    alert('ËÆÄÂèñ CSV Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            });
        }

        // Excel ÂåØÂÖ•ÂäüËÉΩ
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ‰ΩøÁî® raw: false ‰æÜÁç≤ÂèñÊ†ºÂºèÂåñÁöÑÂÄº
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        dateNF: 'yyyy-mm-dd' // ÊåáÂÆöÊó•ÊúüÊ†ºÂºè
                    });
                    
                    console.log('Excel Ëß£ÊûêÁµêÊûú:', jsonData);
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Excel ËÆÄÂèñÈåØË™§:', error);
                    alert('ËÆÄÂèñ Excel Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ËôïÁêÜÂåØÂÖ•Êï∏Êìö
        function processImportData(data) {
            importData = [];
            const errors = [];
            const warnings = [];

            console.log('ÂéüÂßãÊï∏Êìö:', data);

            data.forEach((row, index) => {
                console.log(`ËôïÁêÜÁ¨¨ ${index + 1} Ë°å:`, row);
                const record = validateImportRecord(row, index + 1);
                if (record) {
                    importData.push(record);
                } else {
                    errors.push(`Á¨¨ ${index + 1} Ë°åÊï∏ÊìöÁÑ°Êïà`);
                }
            });

            if (errors.length > 0) {
                alert('ÁôºÁèæ‰ª•‰∏ãÈåØË™§Ôºö\n' + errors.join('\n') + '\n\nË´ãÊ™¢Êü•Êï∏ÊìöÊ†ºÂºèÊòØÂê¶Ê≠£Á¢∫„ÄÇ');
            }

            if (warnings.length > 0) {
                console.warn('Ë≠¶Âëä:', warnings);
            }

            showImportPreview();
        }

        // È©óË≠âÂåØÂÖ•Ë®òÈåÑ
        function validateImportRecord(row, rowNumber) {
            const requiredFields = ['ÊàêÂì°', 'ÈáëÈ°ç', '‰∏ªÈ°ûÂà•', 'Â≠êÈ°ûÂà•', 'ÊèèËø∞', 'Êó•Êúü'];
            const errors = [];
            
            console.log(`È©óË≠âÁ¨¨ ${rowNumber} Ë°å:`, row);
            
            // Ê™¢Êü•ÂøÖË¶ÅÊ¨Ñ‰Ωç
            for (let field of requiredFields) {
                if (!row[field] && row[field] !== 0) {
                    errors.push(`Áº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰ΩçÔºö${field}`);
                }
            }
            
            // È©óË≠â‰ªòÊ¨æÊñπÂºèÔºàÂ≠êÈ°ûÂà•Ôºâ
            const paymentMethod = row['Â≠êÈ°ûÂà•'];
            if (paymentMethod && !['‰ø°Áî®Âç°', 'ÁèæÈáë'].includes(paymentMethod)) {
                errors.push(`‰ªòÊ¨æÊñπÂºèÁÑ°ÊïàÔºö${paymentMethod} (ÊúâÊïàÂÄº: ‰ø°Áî®Âç°, ÁèæÈáë)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈåØË™§:`, errors);
                return null;
            }

            // È©óË≠âÊàêÂì°
            if (!familyMembers.includes(row['ÊàêÂì°'])) {
                errors.push(`ÊàêÂì°ÁÑ°ÊïàÔºö${row['ÊàêÂì°']} (ÊúâÊïàÂÄº: ${familyMembers.join(', ')})`);
            }

            // È©óË≠âÈáëÈ°ç
            let amountValue = row['ÈáëÈ°ç'];
            
            // Ê∏ÖÁêÜÈáëÈ°çÂ≠óÁ¨¶‰∏≤
            if (typeof amountValue === 'string') {
                // ÂÖàËôïÁêÜÊã¨ËôüÊ†ºÂºèÔºàÊúÉË®àÊ†ºÂºèÔºâ
                if (amountValue.includes('(') && amountValue.includes(')')) {
                    amountValue = '-' + amountValue.replace(/[()]/g, '');
                }
                
                // ÁßªÈô§Ë≤®Âπ£Á¨¶Ëôü„ÄÅÁ©∫Ê†ºÁ≠âÔºå‰ΩÜ‰øùÁïôË≤†ËôüÂíåÈÄóËôü
                amountValue = amountValue.toString().replace(/[¬•Ôø•\s]/g, '');
                
                // ÁßªÈô§ÂçÉÂàÜ‰ΩçÈÄóËôü
                amountValue = amountValue.replace(/,/g, '');
                
                // ÁßªÈô§ÁæéÂÖÉÁ¨¶ËôüÔºàÂú®ÈÄóËôüËôïÁêÜÂæåÔºâ
                amountValue = amountValue.replace(/\$/g, '');
            }
            
            const amount = parseFloat(amountValue);
            console.log(`Á¨¨ ${rowNumber} Ë°åÈáëÈ°çËß£Êûê:`, {
                'ÂéüÂßãÂÄº': row['ÈáëÈ°ç'],
                'Ê∏ÖÁêÜÂæå': amountValue,
                'Ëß£ÊûêÂæå': amount,
                'È°ûÂûã': typeof row['ÈáëÈ°ç']
            });
            
            if (isNaN(amount) || amount === 0) {
                errors.push(`ÈáëÈ°çÁÑ°ÊïàÔºö${row['ÈáëÈ°ç']} (Ê∏ÖÁêÜÂæå: ${amountValue}, Ëß£ÊûêÂæå: ${amount})`);
            }

            // Ê†πÊìöÈáëÈ°çÊ≠£Ë≤†Êï∏Âà§Êñ∑È°ûÂûã
            const type = amount > 0 ? 'income' : 'expense';
            const absAmount = Math.abs(amount); // ÂÖßÈÉ®Â≠òÂÑ≤‰ΩøÁî®ÁµïÂ∞çÂÄº

            // È©óË≠âÊó•Êúü
            let dateStr = row['Êó•Êúü'];
            // ËôïÁêÜ‰∏çÂêåÁöÑÊó•ÊúüÊ†ºÂºè
            if (typeof dateStr === 'string') {
                // Â¶ÇÊûúÊòØ Excel Êó•ÊúüÊï∏Â≠óÔºåËΩâÊèõÁÇ∫Êó•Êúü
                if (!isNaN(dateStr) && dateStr > 25569) { // Excel Êó•ÊúüËµ∑ÂßãÂÄº
                    const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                    dateStr = formatDateToYYYYMMDD(excelDate);
                } else {
                    // ËôïÁêÜÊñúÁ∑öÂàÜÈöîÁöÑÊó•ÊúüÊ†ºÂºè (2025/09/01 -> 2025-09-01)
                    dateStr = dateStr.replace(/\//g, '-');
                }
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                errors.push(`Êó•ÊúüÁÑ°ÊïàÔºö${row['Êó•Êúü']} (Ê†ºÂºè: YYYY-MM-DD)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈ©óË≠âÂ§±Êïó:`, errors);
                return null;
            }

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                member: row['ÊàêÂì°'],
                type: type,
                amount: absAmount,
                mainCategory: row['‰∏ªÈ°ûÂà•'],
                subCategory: row['Â≠êÈ°ûÂà•'],
                description: row['ÊèèËø∞'] || '',
                date: dateStr
            };
        }

        // È°ØÁ§∫ÂåØÂÖ•È†êË¶Ω
        function showImportPreview() {
            const previewDiv = document.getElementById('importPreview');
            const tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            importData.forEach((record, index) => {
                const row = document.createElement('tr');
                const isValid = validateRecord(record);
                
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                    <td class="${isValid ? 'status-valid' : 'status-invalid'}">
                        ${isValid ? '‚úì ÊúâÊïà' : '‚úó ÁÑ°Êïà'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // È©óË≠âË®òÈåÑ
        function validateRecord(record) {
            return familyMembers.includes(record.member) &&
                   ['income', 'expense'].includes(record.type) &&
                   record.amount > 0 &&
                   record.mainCategory &&
                   record.date;
        }

        // Á¢∫Ë™çÂåØÂÖ•
        function confirmImport() {
            const validRecords = importData.filter(record => validateRecord(record));
            
            if (validRecords.length === 0) {
                alert('Ê≤íÊúâÊúâÊïàÁöÑË®òÈåÑÂèØ‰ª•ÂåØÂÖ•ÔºÅ');
                return;
            }

            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicateCheck = checkForDuplicates(validRecords);
            const newRecords = duplicateCheck.newRecords;
            const duplicates = duplicateCheck.duplicates;

            if (duplicates.length > 0) {
                const duplicateInfo = duplicates.map(dup => 
                    `${dup.member} - ${dup.mainCategory} - $${dup.amount} - ${dup.date}`
                ).join('\n');
                
                if (newRecords.length === 0) {
                    alert(`ÊâÄÊúâË®òÈåÑÈÉΩÊòØÈáçË§áÁöÑÔºÅ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nË´ãÊ™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂåØÂÖ•ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ`);
                    return;
                } else {
                    const proceed = confirm(`ÁôºÁèæ ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑÔºåÂ∞áË∑≥ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nÁ¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜÊñ∞Ë®òÈåÑÂóéÔºü`);
                    if (!proceed) {
                        return;
                    }
                }
            }

            if (confirm(`Á¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÂóéÔºü`)) {
                records = records.concat(newRecords);
                saveRecords();
                
                // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub
                backupToGitHub().then(success => {
                    if (success) {
                        console.log('‚úÖ ÂåØÂÖ•Êï∏ÊìöÂæåËá™ÂãïÂÇô‰ªΩÊàêÂäü');
                    } else {
                        console.log('‚ö†Ô∏è ÂåØÂÖ•Êï∏ÊìöÂæåËá™ÂãïÂÇô‰ªΩÂ§±ÊïóÔºå‰ΩÜÊú¨Âú∞Â∑≤‰øùÂ≠ò');
                    }
                });
                
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                
                // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
                checkAndSwitchTo2025();
                
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
                
                let message = `ÊàêÂäüÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÔºÅ`;
                if (duplicates.length > 0) {
                    message += `\nË∑≥ÈÅé‰∫Ü ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑ„ÄÇ`;
                }
                alert(message);
                cancelImport();
            }
        }

        // Ê™¢Êü•ÈáçË§áË®òÈåÑ
        function checkForDuplicates(importRecords) {
            const newRecords = [];
            const duplicates = [];
            
            importRecords.forEach(importRecord => {
                // Ê™¢Êü•ÊòØÂê¶ËàáÁèæÊúâË®òÈåÑÈáçË§á
                const isDuplicate = records.some(existingRecord => {
                    return existingRecord.member === importRecord.member &&
                           existingRecord.amount === importRecord.amount &&
                           existingRecord.mainCategory === importRecord.mainCategory &&
                           existingRecord.subCategory === importRecord.subCategory &&
                           existingRecord.date === importRecord.date &&
                           existingRecord.description === importRecord.description;
                });
                
                if (isDuplicate) {
                    duplicates.push(importRecord);
                } else {
                    newRecords.push(importRecord);
                }
            });
            
            return { newRecords, duplicates };
        }

        // ÂèñÊ∂àÂåØÂÖ•
        function cancelImport() {
            importData = [];
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFile').value = '';
        }

        // ÂåØÂá∫ÁÇ∫ CSV
        function exportToCSV() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂåØÂá∫ÔºÅ');
                return;
            }

            const csvContent = convertToCSV(records);
            downloadFile(csvContent, 'family_records.csv', 'text/csv');
        }

        // ÂåØÂá∫ÁÇ∫ Excel
        function exportToExcel() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂåØÂá∫ÔºÅ');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(records.map(record => ({
                'ÊàêÂì°': record.member,
                'ÈáëÈ°ç': record.type === 'income' ? record.amount : -record.amount,
                '‰∏ªÈ°ûÂà•': record.mainCategory,
                'Â≠êÈ°ûÂà•': record.subCategory,
                'ÊèèËø∞': record.description,
                'Êó•Êúü': record.date
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Êî∂ÊîØË®òÈåÑ');
            
            XLSX.writeFile(workbook, 'family_records.xlsx');
        }

        // ËΩâÊèõÁÇ∫ CSV Ê†ºÂºè
        function convertToCSV(data) {
            const headers = ['ÊàêÂì°', 'ÈáëÈ°ç', '‰∏ªÈ°ûÂà•', 'Â≠êÈ°ûÂà•', 'ÊèèËø∞', 'Êó•Êúü'];
            const csvRows = [headers.join(',')];
            
            data.forEach(record => {
                const amount = record.type === 'income' ? record.amount : -record.amount;
                const values = [
                    record.member,
                    amount,
                    record.mainCategory,
                    record.subCategory,
                    `"${record.description}"`,
                    record.date
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // ‰∏ãËºâÊ™îÊ°à
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ÂâµÂª∫Á§∫‰æã Excel Ê™îÊ°à
        function createSampleExcel() {
            const sampleData = [
                {
                    'ÊàêÂì°': 'Kelvin',
                    'ÈáëÈ°ç': '-1,200',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊâãÊ©üË≤ª - 2025-01',
                    'Êó•Êúü': '2025-01-15'
                },
                {
                    'ÊàêÂì°': 'Phuong',
                    'ÈáëÈ°ç': '-1,598',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': 'ÁèæÈáë',
                    'ÊèèËø∞': 'Á∂≤Ë∑ØË≤ª - 2025-01',
                    'Êó•Êúü': '2025-01-15'
                },
                {
                    'ÊàêÂì°': 'ÂÆ∂Áî®',
                    'ÈáëÈ°ç': '-15,000',
                    '‰∏ªÈ°ûÂà•': 'Â±Ö‰Ωè',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊàøÁßü - 2025-01',
                    'Êó•Êúü': '2025-01-01'
                },
                {
                    'ÊàêÂì°': 'ÂÆ∂Áî®',
                    'ÈáëÈ°ç': '50,000',
                    '‰∏ªÈ°ûÂà•': 'Ëñ™Ë≥á',
                    'Â≠êÈ°ûÂà•': 'ÁèæÈáë',
                    'ÊèèËø∞': 'Kelvin Ëñ™Ë≥á',
                    'Êó•Êúü': '2025-01-05'
                },
                {
                    'ÊàêÂì°': 'Kelvin',
                    'ÈáëÈ°ç': '-1,979',
                    '‰∏ªÈ°ûÂà•': 'Êó•Â∏∏',
                    'Â≠êÈ°ûÂà•': '‰ø°Áî®Âç°',
                    'ÊèèËø∞': 'ÊâãÊ©üÊ¨†Ë≤ª',
                    'Êó•Êúü': '2025-01-20'
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(sampleData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Á§∫‰æãÊï∏Êìö');
            
            XLSX.writeFile(workbook, 'sample_family_records.xlsx');
            alert('Á§∫‰æã Excel Ê™îÊ°àÂ∑≤ÂâµÂª∫ÔºÅÊÇ®ÂèØ‰ª•‰∏ãËºâ‰∏¶‰øÆÊîπÂæåÈáçÊñ∞‰∏äÂÇ≥Ê∏¨Ë©¶„ÄÇ');
        }

        // ÊâãÂãï‰∏ãËºâ data.json ÂÇô‰ªΩ
        function downloadDataJson() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            const dataToSave = {
                records: records,
                settings: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString()
                }
            };
            
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`ÊàêÂäü‰∏ãËºâÂÇô‰ªΩÊ™îÊ°àÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ\nÊ™îÊ°àÂêç: family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`);
        }

        // ‰∏ãËºâ Excel Ê†ºÂºèÂÇô‰ªΩÔºàÂèØÈáçÊñ∞ÂåØÂÖ•Ôºâ
        function downloadExcelBackup() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            // Â∞áË®òÈåÑËΩâÊèõÁÇ∫ Excel Ê†ºÂºè
            const excelData = records.map(record => ({
                'ÊàêÂì°': record.member,
                'ÈáëÈ°ç': record.type === 'income' ? record.amount : -record.amount,
                '‰∏ªÈ°ûÂà•': record.mainCategory,
                'Â≠êÈ°ûÂà•': record.subCategory || '',
                'ÊèèËø∞': record.description || '',
                'Êó•Êúü': record.date
            }));

            // ÂâµÂª∫ Excel Â∑•‰ΩúË°®
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑ');
            
            // ‰∏ãËºâÊ™îÊ°à
            const fileName = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`ÊàêÂäü‰∏ãËºâ Excel ÂÇô‰ªΩÊ™îÊ°àÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ\nÊ™îÊ°àÂêç: ${fileName}\n\nÊ≠§Ê™îÊ°àÂèØ‰ª•Áõ¥Êé•ÈáçÊñ∞ÂåØÂÖ•Á≥ªÁµ±„ÄÇ`);
        }











        // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
        // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
        function updateSyncStatus() {
            // Ê™¢Êü•ÂÇô‰ªΩÁãÄÊÖã
            const lastGitHubBackup = localStorage.getItem('lastGitHubBackup');
            const lastLocalBackup = localStorage.getItem('lastLocalBackup');
            const lastBackupTime = localStorage.getItem('lastBackupTime');
            
            let backupStatus = 'Êú™ÂÇô‰ªΩ';
            if (lastGitHubBackup) {
                const backupDate = new Date(lastGitHubBackup);
                backupStatus = `GitHub: ${backupDate.toLocaleString('zh-TW')}`;
            } else if (lastLocalBackup) {
                const backupDate = new Date(lastLocalBackup);
                backupStatus = `Êú¨Âú∞: ${backupDate.toLocaleString('zh-TW')}`;
            } else if (lastBackupTime) {
                backupStatus = lastBackupTime;
            }

            document.getElementById('lastBackup').textContent = backupStatus;
            
            // Ëá™ÂãïÊ™¢Êü•Êï∏ÊìöÂÅ•Â∫∑
            checkDataHealth();
        }

        // Êï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•
        function checkDataHealth() {
            console.log('üîç ÈñãÂßãÊï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•...');
            
            const healthIssues = [];
            const warnings = [];
            
            // Ê™¢Êü•Ë®òÈåÑÊï∏Èáè
            if (records.length === 0) {
                healthIssues.push('‚ùå Ê≤íÊúâÊï∏ÊìöË®òÈåÑ');
            } else if (records.length > 1000) {
                warnings.push('‚ö†Ô∏è Ë®òÈåÑÊï∏ÈáèÈÅéÂ§ö (' + records.length + ' Á≠Ü)');
            }
            
            // Ê™¢Êü•Êï∏ÊìöÂÆåÊï¥ÊÄß
            const invalidRecords = records.filter(record => 
                !record.id || !record.member || !record.type || !record.amount || !record.date
            );
            if (invalidRecords.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidRecords.length} Á≠ÜÁÑ°ÊïàË®òÈåÑ`);
            }
            
            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            if (duplicateIds.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${duplicateIds.length} Á≠ÜÈáçË§áID`);
            }
            
            // Ê™¢Êü•Êó•ÊúüÊ†ºÂºè
            const invalidDates = records.filter(record => {
                const date = new Date(record.date);
                return isNaN(date.getTime());
            });
            if (invalidDates.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidDates.length} Á≠ÜÁÑ°ÊïàÊó•Êúü`);
            }
            
            // Ê™¢Êü•ÈáëÈ°ç
            const invalidAmounts = records.filter(record => 
                isNaN(record.amount) || record.amount <= 0
            );
            if (invalidAmounts.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidAmounts.length} Á≠ÜÁÑ°ÊïàÈáëÈ°ç`);
            }
            
            // Ê™¢Êü•localStorageÂêåÊ≠•
            const localRecords = JSON.parse(localStorage.getItem('familyRecords') || '[]');
            if (localRecords.length !== records.length) {
                warnings.push('‚ö†Ô∏è localStorageËàáÂÖßÂ≠òÊï∏Êìö‰∏çÂêåÊ≠•');
            }
            
            // Êõ¥Êñ∞ÂÅ•Â∫∑ÁãÄÊÖãÈ°ØÁ§∫
            let healthStatus = '‚úÖ ÂÅ•Â∫∑';
            let healthColor = '#28a745';
            
            if (healthIssues.length > 0) {
                healthStatus = `‚ùå ${healthIssues.length} ÂÄãÂïèÈ°å`;
                healthColor = '#dc3545';
            } else if (warnings.length > 0) {
                healthStatus = `‚ö†Ô∏è ${warnings.length} ÂÄãË≠¶Âëä`;
                healthColor = '#ffc107';
            }
            
            const healthElement = document.getElementById('dataHealth');
            if (healthElement) {
                healthElement.textContent = healthStatus;
                healthElement.style.color = healthColor;
            }
            
            // Ëº∏Âá∫Ë©≥Á¥∞Â†±Âëä
            console.log('üìä Êï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•Â†±Âëä:');
            console.log(`Á∏ΩË®òÈåÑÊï∏: ${records.length}`);
            console.log(`ÂÅ•Â∫∑ÂïèÈ°å: ${healthIssues.length}`);
            console.log(`Ë≠¶Âëä: ${warnings.length}`);
            
            if (healthIssues.length > 0) {
                console.log('‚ùå ÂÅ•Â∫∑ÂïèÈ°å:', healthIssues);
            }
            if (warnings.length > 0) {
                console.log('‚ö†Ô∏è Ë≠¶Âëä:', warnings);
            }
            
            return {
                healthy: healthIssues.length === 0,
                issues: healthIssues,
                warnings: warnings,
                totalRecords: records.length
            };
        }

        // Âø´ÈÄü‰øÆÂæ©ÂäüËÉΩ
        async function quickFix() {
            console.log('üîß ÈñãÂßãÂø´ÈÄü‰øÆÂæ©...');
            
            const fixes = [];
            
            try {
                // 1. Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö
                console.log('üîÑ Ê≠•È©ü1: Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö...');
                await loadDataFromFile();
                fixes.push('‚úÖ ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö');
                
                // 2. Ê™¢Êü•‰∏¶‰øÆÂæ©ÈáçË§áID
                console.log('üîç Ê≠•È©ü2: Ê™¢Êü•ÈáçË§áID...');
                const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
                if (duplicateIds.length > 0) {
                    // ÁÇ∫ÈáçË§áIDÁîüÊàêÊñ∞ÁöÑÂîØ‰∏ÄID
                    const idMap = new Map();
                    records.forEach(record => {
                        if (idMap.has(record.id)) {
                            record.id = Date.now() + Math.random().toString(36).substr(2, 9);
                        }
                        idMap.set(record.id, true);
                    });
                    fixes.push(`‚úÖ ‰øÆÂæ© ${duplicateIds.length} ÂÄãÈáçË§áID`);
                }
                
                // 3. Ê™¢Êü•‰∏¶‰øÆÂæ©ÁÑ°ÊïàË®òÈåÑ
                console.log('üîç Ê≠•È©ü3: Ê™¢Êü•ÁÑ°ÊïàË®òÈåÑ...');
                const originalLength = records.length;
                records = records.filter(record => 
                    record.id && record.member && record.type && record.amount && record.date
                );
                const removedCount = originalLength - records.length;
                if (removedCount > 0) {
                    fixes.push(`‚úÖ ÁßªÈô§ ${removedCount} Á≠ÜÁÑ°ÊïàË®òÈåÑ`);
                }
                
                // 4. ÂêåÊ≠•Âà∞localStorage
                console.log('üíæ Ê≠•È©ü4: ÂêåÊ≠•Âà∞localStorage...');
                localStorage.setItem('familyRecords', JSON.stringify(records));
                fixes.push('‚úÖ ÂêåÊ≠•Âà∞localStorage');
                
                // 5. Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                console.log('üîÑ Ê≠•È©ü5: Êõ¥Êñ∞È°ØÁ§∫...');
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar();
                updateSyncStatus();
                fixes.push('‚úÖ Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫');
                
                // 6. ÂòóË©¶ÂÇô‰ªΩ
                console.log('üì¶ Ê≠•È©ü6: ÂòóË©¶ÂÇô‰ªΩ...');
                try {
                    await backupToGitHub();
                    fixes.push('‚úÖ ÊàêÂäüÂÇô‰ªΩÂà∞GitHub');
                } catch (error) {
                    console.log('‚ö†Ô∏è GitHubÂÇô‰ªΩÂ§±ÊïóÔºåÂòóË©¶Êú¨Âú∞ÂÇô‰ªΩ...');
                    saveToDataJson();
                    fixes.push('‚úÖ Êú¨Âú∞ÂÇô‰ªΩÊàêÂäü');
                }
                
                // È°ØÁ§∫‰øÆÂæ©ÁµêÊûú
                const message = `üîß Âø´ÈÄü‰øÆÂæ©ÂÆåÊàêÔºÅ\n\n‰øÆÂæ©È†ÖÁõÆÔºö\n${fixes.join('\n')}\n\nÁï∂ÂâçË®òÈåÑÊï∏Ôºö${records.length}`;
                alert(message);
                console.log('‚úÖ Âø´ÈÄü‰øÆÂæ©ÂÆåÊàê:', fixes);
                
            } catch (error) {
                console.error('‚ùå Âø´ÈÄü‰øÆÂæ©Â§±Êïó:', error);
                alert('‚ùå Âø´ÈÄü‰øÆÂæ©Â§±ÊïóÔºö' + error.message);
            }
        }

        // È†êË¶ΩÂà™Èô§
        function previewDelete() {
            const memberFilter = document.getElementById('deleteMemberFilter').value;
            const typeFilter = document.getElementById('deleteTypeFilter').value;
            const dateFrom = document.getElementById('deleteDateFrom').value;
            const dateTo = document.getElementById('deleteDateTo').value;

            deleteData = records.filter(record => {
                const matchesMember = !memberFilter || record.member === memberFilter;
                const matchesType = !typeFilter || record.type === typeFilter;
                const matchesDateFrom = !dateFrom || record.date >= dateFrom;
                const matchesDateTo = !dateTo || record.date <= dateTo;

                return matchesMember && matchesType && matchesDateFrom && matchesDateTo;
            });

            if (deleteData.length === 0) {
                alert('Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑÂèØ‰ª•Âà™Èô§ÔºÅ');
                return;
            }

            showDeletePreview();
        }

        // È°ØÁ§∫Âà™Èô§È†êË¶Ω
        function showDeletePreview() {
            const previewDiv = document.getElementById('deletePreview');
            const tableBody = document.getElementById('deletePreviewTableBody');
            
            tableBody.innerHTML = '';
            
            deleteData.forEach((record, index) => {
                const row = document.createElement('tr');
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // Á¢∫Ë™çÂà™Èô§
        function confirmDelete() {
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                // Âæû records ‰∏≠ÁßªÈô§Ë¶ÅÂà™Èô§ÁöÑË®òÈåÑ
                records = records.filter(record => !deleteData.includes(record));
                
                saveRecords();
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats();
                cancelDelete();
                
                alert(`ÊàêÂäüÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÔºÅ`);
            }
        }

        // ÂèñÊ∂àÂà™Èô§
        function cancelDelete() {
            deleteData = [];
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteMemberFilter').value = '';
            document.getElementById('deleteTypeFilter').value = '';
            document.getElementById('deleteDateFrom').value = '';
            document.getElementById('deleteDateTo').value = '';
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö
        function clearAllData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•Ê∏ÖÁ©∫ÔºÅ');
                return;
            }

            const confirmMessage = `‚ö†Ô∏è Ë≠¶ÂëäÔºöÊÇ®Âç≥Â∞áÊ∏ÖÁ©∫ÊâÄÊúâ ${records.length} Á≠ÜË®òÈåÑÔºÅ\n\nÊ≠§Êìç‰ΩúÂ∞áÔºö\n- Âà™Èô§ÊâÄÊúâÊî∂ÊîØË®òÈåÑ\n- Ê∏ÖÁ©∫Áµ±Ë®àÊï∏Êìö\n- ÁÑ°Ê≥ïÂæ©Âéü\n\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm('ÊúÄÂæåÁ¢∫Ë™çÔºöÊÇ®ÁúüÁöÑË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÂóéÔºü\n\nË´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÔºàË´ãÊâãÂãïËº∏ÂÖ• YESÔºâ');
                
                if (doubleConfirm) {
                    const userInput = prompt('Ë´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÔºö');
                    
                    if (userInput === 'YES') {
                        records = [];
                        saveRecords();
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                        updateDataStats();
                        
                        alert('ÊâÄÊúâÊï∏ÊìöÂ∑≤Ê∏ÖÁ©∫ÔºÅ');
                    } else {
                        alert('Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ');
                    }
                }
            }
        }

        // ÂÇô‰ªΩÊï∏Êìö
        function backupData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            dataBackup = JSON.parse(JSON.stringify(records));
            const backupData = {
                timestamp: new Date().toISOString(),
                records: dataBackup,
                count: records.length
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`Êï∏ÊìöÂÇô‰ªΩÂÆåÊàêÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
        }

        // ÈÇÑÂéüÊï∏Êìö
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.records || !Array.isArray(backupData.records)) {
                            alert('ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÔºÅ');
                            return;
                        }

                        const confirmMessage = `ÊâæÂà∞ÂÇô‰ªΩÊï∏ÊìöÔºö\n- ÂÇô‰ªΩÊôÇÈñìÔºö${backupData.timestamp}\n- Ë®òÈåÑÊï∏ÈáèÔºö${backupData.count}\n\nÁ¢∫ÂÆöË¶ÅÈÇÑÂéüÈÄô‰∫õÊï∏ÊìöÂóéÔºü\nÔºàÁï∂ÂâçÊï∏ÊìöÂ∞áË¢´Ë¶ÜËìãÔºâ`;
                        
                        if (confirm(confirmMessage)) {
                            records = backupData.records;
                            saveRecords();
                            updateStats();
                            updateRecentRecords();
                            updateAllRecords();
                            updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                            updateDataStats();
                            
                            alert(`Êï∏ÊìöÈÇÑÂéüÂÆåÊàêÔºÅ\nÈÇÑÂéü‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
                        }
                    } catch (error) {
                        alert('ËÆÄÂèñÂÇô‰ªΩÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== ÂúñË°®Áõ∏ÈóúÂáΩÊï∏ ====================

        // ÂàùÂßãÂåñÊâÄÊúâÂúñË°®
        function initializeCharts() {
            console.log('ÂàùÂßãÂåñÂúñË°®...');
            console.log('Áï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // Ê™¢Êü• Chart.js ÊòØÂê¶ËºâÂÖ•
            if (typeof Chart === 'undefined') {
                console.error('Chart.js Êú™ËºâÂÖ•');
                showErrorMessage('ÂúñË°®Â∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                return;
            }
            
            setCurrentMonth();
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÊï∏Êìö
            if (records.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑÊï∏ÊìöÔºåÈ°ØÁ§∫ÊèêÁ§∫‰ø°ÊÅØ');
                showNoDataMessage();
                return;
            }
            
            updateCharts();
        }

        // È°ØÁ§∫ÈåØË™§‰ø°ÊÅØ
        function showErrorMessage(message) {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <h4>‚ùå ÂúñË°®ËºâÂÖ•Â§±Êïó</h4>
                            <p>${message}</p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                                ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
                            </button>
                        </div>
                    `;
                }
            });
        }

        // È°ØÁ§∫ÁÑ°Êï∏ÊìöÊèêÁ§∫
        function showNoDataMessage() {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h4>üìä Êö´ÁÑ°Êï∏Êìö</h4>
                            <p>Ë´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÊî∂ÊîØË®òÈåÑÔºåÁÑ∂ÂæåÂÜçÊü•ÁúãÂúñË°®</p>
                            <button class="btn" onclick="showTab('add')" style="margin-top: 15px;">
                                ÂâçÂæÄÊñ∞Â¢ûË®òÈåÑ
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Ë®≠ÁΩÆÁï∂ÂâçÊúà‰ªΩÁÇ∫ÈªòË™çÈÅ∏‰∏≠
        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11
            const monthSelect = document.getElementById('chartMonth');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂúñË°®
        function updateCharts() {
            const year = parseInt(document.getElementById('chartYear').value);
            const month = parseInt(document.getElementById('chartMonth').value);
            
            console.log('Êõ¥Êñ∞ÂúñË°®:', { year, month });
            
            updateTrendChart(year, month);
            updateCategoryChart(year, month);
            updateMemberChart(year, month);
        }

        // ÈáçÊñ∞Êï¥ÁêÜÂúñË°®
        function refreshCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (memberChart) memberChart.destroy();
            
            updateCharts();
        }

        // Áç≤ÂèñÊåáÂÆöÊúà‰ªΩÁöÑÊï∏Êìö
        function getDataByMonth(year, month) {
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11ÔºåÈúÄË¶Å +1
                
                return recordYear === year && recordMonth === month;
            });
            
            return filteredRecords;
        }

        // Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®
        function updateTrendChart(year, month) {
            console.log('Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ trendChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('Ë∂®Âã¢ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processDailyTrendData(data, year, month);
            console.log('ËôïÁêÜÂæåÁöÑË∂®Âã¢ÂúñË°®Êï∏Êìö:', chartData);
            
            trendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊØèÊó•Êî∂ÊîØË∂®Âã¢`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }


        // Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®
        function updateCategoryChart(year, month) {
            console.log('Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('categoryChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ categoryChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('È°ûÂà•ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processCategoryData(data);
            console.log('ËôïÁêÜÂæåÁöÑÈ°ûÂà•ÂúñË°®Êï∏Êìö:', chartData);
            
            categoryChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊîØÂá∫È°ûÂà•Áµ±Ë®à`
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®
        function updateMemberChart(year, month) {
            console.log('Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('memberChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ memberChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (memberChart) {
                memberChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('ÊàêÂì°ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processMemberData(data);
            console.log('ËôïÁêÜÂæåÁöÑÊàêÂì°ÂúñË°®Êï∏Êìö:', chartData);
            
            memberChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            backgroundColor: 'rgba(81, 207, 102, 0.8)',
                            borderColor: '#51cf66',
                            borderWidth: 1
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊàêÂì°Êî∂ÊîØÂ∞çÊØî`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ËôïÁêÜÊØèÊó•Ë∂®Âã¢Êï∏Êìö
        function processDailyTrendData(data, year, month) {
            const groupedData = {};
            
            // Áç≤ÂèñË©≤ÊúàÁöÑÂ§©Êï∏
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // ÂàùÂßãÂåñÊâÄÊúâÂ§©Êï∏
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day).padStart(2, '0');
                groupedData[dayKey] = { income: 0, expense: 0 };
            }
            
            // ËôïÁêÜÂØ¶ÈöõÊï∏Êìö
            data.forEach(record => {
                const date = new Date(record.date);
                const day = String(date.getDate()).padStart(2, '0');
                
                if (record.type === 'income') {
                    groupedData[day].income += record.amount;
                } else {
                    groupedData[day].expense += record.amount;
                }
            });
            
            const labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
            const income = labels.map(day => groupedData[day].income);
            const expense = labels.map(day => groupedData[day].expense);
            
            return { labels, income, expense };
        }


        // ËôïÁêÜÈ°ûÂà•Êï∏Êìö
        function processCategoryData(data) {
            const categoryTotals = {};
            
            data.filter(record => record.type === 'expense').forEach(record => {
                const category = record.mainCategory;
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += record.amount;
            });
            
            // ÊåâÈáëÈ°çÊéíÂ∫è
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Âè™È°ØÁ§∫Ââç10ÂÄãÈ°ûÂà•
            
            const labels = sortedCategories.map(([category]) => category);
            const values = sortedCategories.map(([, amount]) => amount);
            
            return { labels, values };
        }

        // ËôïÁêÜÊàêÂì°Êï∏Êìö
        function processMemberData(data) {
            const memberTotals = {};
            
            data.forEach(record => {
                const member = record.member;
                
                if (!memberTotals[member]) {
                    memberTotals[member] = { income: 0, expense: 0 };
                }
                
                if (record.type === 'income') {
                    memberTotals[member].income += record.amount;
                } else {
                    memberTotals[member].expense += record.amount;
                }
            });
            
            // ÊåâÁÖßÊåáÂÆöÈ†ÜÂ∫èÊéíÂàóÔºöKelvin„ÄÅPhuong„ÄÅRyan„ÄÅÂÆ∂Áî®
            const orderedMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];
            const labels = orderedMembers.filter(member => memberTotals[member]);
            const income = labels.map(member => memberTotals[member].income);
            const expense = labels.map(member => memberTotals[member].expense);
            
            return { labels, income, expense };
        }

    </script>
</body>
</html>
