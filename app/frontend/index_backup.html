<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ÂÆ∂Â∫≠Êî∂ÊîØÂπ≥Âè∞</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à - ÊâãÊ©üÁâà (iPhone 14 Pro: 393x852) */
        @media screen and (max-width: 480px) {
            body {
                padding: 0;
                margin: 0;
                height: 100vh;
                overflow: hidden;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .container {
                border-radius: 8px;
                margin: 0;
                padding-top: 105px !important;
                padding-bottom: 50px !important;
                background: white;
                height: 100vh;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .container::-webkit-scrollbar {
                width: 8px;
            }
            
            .container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            .container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }
            
            .container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .header {
                padding: 10px 15px !important;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
                color: white !important;
                border-radius: 0 !important;
                margin-bottom: 0 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1001 !important;
            }
            
            .header-content {
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
            }
            
            .header-main {
                margin-bottom: 0 !important;
            }
            
            .header h1 {
                font-size: 1.4em !important;
                margin-bottom: 3px !important;
                font-weight: bold !important;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            }
            
            .header p {
                font-size: 0.9em !important;
                opacity: 0.9 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
            
            /* ÊâãÊ©üÁâàÈö±Ëóèheader‰∏≠ÁöÑÁâàÊú¨‰ø°ÊÅØ */
            .version-info {
                display: none !important;
            }
            
            .nav-tabs {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 2px;
                padding: 5px;
                position: fixed !important;
                top: 75px !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                z-index: 1000 !important;
                border-bottom: 1px solid #dee2e6 !important;
            }
            
            .nav-tab {
                padding: 10px 8px !important;
                font-size: 0.75em !important;
                border-radius: 6px !important;
                flex: 1 !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 2px !important;
            }
            
            .nav-tab i {
                font-size: 1.2em !important;
                margin-bottom: 2px !important;
            }
            
            .nav-tab span {
                font-size: 0.7em !important;
                line-height: 1 !important;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .stats-section {
                margin-bottom: 15px;
            }
            
            .stats-section h3 {
                color: #333;
                font-size: 1.1em;
                margin-bottom: 8px;
                padding-left: 5px;
                border-left: 4px solid #667eea;
            }
            
            .stats,
            .stats-grid {
                display: flex !important;
                justify-content: flex-start !important;
                gap: 12px !important;
                padding: 10px 15px 5px 15px !important;
                flex-wrap: nowrap !important;
                align-items: center !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .stats::-webkit-scrollbar,
            .stats-grid::-webkit-scrollbar {
                height: 4px;
            }
            
            .stats::-webkit-scrollbar-track,
            .stats-grid::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .stats::-webkit-scrollbar-thumb,
            .stats-grid::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 2px;
            }
            
            .stats::-webkit-scrollbar-thumb:hover,
            .stats-grid::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .stat-card {
                padding: 12px !important;
                margin-bottom: 3px !important;
                min-width: 240px !important;
                width: 240px !important;
                flex-shrink: 0 !important;
                scroll-snap-align: center !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                border-radius: 10px !important;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
                transform: scale(0.95) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                z-index: 1 !important;
            }
            
            .stat-card:first-child {
                margin-left: 15px !important;
                transform: scale(0.95) !important;
                z-index: 1 !important;
            }
            
            .stat-card:last-child {
                margin-right: 15px !important;
                transform: scale(0.95) !important;
                z-index: 1 !important;
            }
            
            .stat-card:nth-child(2) {
                transform: scale(1) !important;
                z-index: 2 !important;
                box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2) !important;
            }
            
            .stat-card h3 {
                font-size: 1.2em !important;
                margin-bottom: 8px !important;
                color: white !important;
                font-weight: bold !important;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                text-align: center !important;
            }
            
            .stat-card .stat-value {
                font-size: 1.4em !important;
                color: white !important;
                font-weight: bold !important;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                text-align: center !important;
            }
            
            .stat-card p {
                color: rgba(255, 255, 255, 0.9) !important;
                font-size: 0.9em !important;
                margin: 0 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
                text-align: center !important;
            }
            
            .stat-card small {
                color: rgba(255, 255, 255, 0.7) !important;
                font-size: 0.75em !important;
                margin: 5px 0 0 0 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
                text-align: center !important;
                display: block !important;
                line-height: 1.2 !important;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .form-group label {
                font-size: 0.8em;
                margin-bottom: 3px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 16px; /* Èò≤Ê≠¢ iOS Á∏ÆÊîæ */
                border-radius: 6px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .form-row .form-group {
                min-width: auto;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.85em;
                border-radius: 6px;
                width: 100%;
                margin-bottom: 8px;
            }
            
            .btn-small {
                padding: 6px 10px;
                font-size: 0.75em;
            }
            
            .record-item {
                padding: 6px;
                margin-bottom: 4px;
                border-radius: 6px;
            }
            
            .record-info h4 {
                font-size: 0.85em;
            }
            
            .record-info p {
                font-size: 0.7em;
            }
            
            .record-amount {
                font-size: 1em;
            }
            
            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 0.5px !important;
                background: #f8f9fa !important;
                border-radius: 6px !important;
                padding: 3px !important;
                margin: 6px 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .calendar-day {
                padding: 2px 1px !important;
                font-size: 0.5em !important;
                background: white !important;
                border-radius: 3px !important;
                text-align: center !important;
                min-height: 24px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                width: 100% !important;
                min-width: 0 !important;
                overflow: hidden !important;
            }
            
            .calendar-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 10px !important;
                padding: 8px 0 !important;
            }
            
            .calendar-title {
                font-size: 1.1em !important;
                font-weight: bold !important;
                color: #333 !important;
                text-align: center !important;
                flex: 1 !important;
            }
            
            .calendar-nav {
                padding: 6px 10px !important;
                font-size: 0.75em !important;
                background: #007bff !important;
                color: white !important;
                border: none !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
            }
            
            .calendar-nav:hover {
                background: #0056b3 !important;
            }
            
            .day-number {
                font-size: 0.6em !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 0.3px !important;
                line-height: 1 !important;
                white-space: nowrap !important;
            }
            
            .day-records {
                font-size: 0.45em !important;
                color: #666 !important;
                text-align: center !important;
                line-height: 0.9 !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .day-income {
                color: #51cf66 !important;
                font-weight: 500 !important;
                font-size: 0.4em !important;
                margin: 0.2px 0 !important;
                line-height: 1 !important;
                white-space: nowrap !important;
            }
            
            .day-expense {
                color: #ff6b6b !important;
                font-weight: 500 !important;
                font-size: 0.4em !important;
                margin: 0.2px 0 !important;
                line-height: 1 !important;
                white-space: nowrap !important;
            }
            
            .calendar-day.today {
                background: #e3f2fd !important;
                border: 2px solid #2196f3 !important;
            }
            
            .calendar-day.has-records {
                background: #fff3e0 !important;
            }
            
            .calendar-weekdays {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 0.5px !important;
                margin-bottom: 2px !important;
                padding: 3px !important;
            }
            
            .calendar-weekday {
                text-align: center !important;
                font-size: 0.6em !important;
                font-weight: bold !important;
                color: #666 !important;
                padding: 2px 1px !important;
                background: #e9ecef !important;
                border-radius: 2px !important;
                line-height: 1 !important;
            }
            
            .chart-section {
                margin-bottom: 15px;
            }
            
            .chart-section canvas {
                max-height: 200px;
            }
            
            /* Á∑äÊπäÁöÑÊàêÂì°Áµ±Ë®à */
            .member-stats {
                margin-bottom: 15px;
            }
            
            .member-stats-grid {
                display: flex !important;
                overflow-x: auto !important;
                gap: -20px !important; /* Ë≤†ÈñìË∑ùÂâµÈÄ†ÈáçÁñäÊïàÊûú */
                padding: 20px 0 10px 0 !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
                align-items: center !important;
                scroll-behavior: smooth !important;
                grid-template-columns: none !important;
            }
            
            .member-stats-grid::-webkit-scrollbar {
                height: 4px;
            }
            
            .member-stats-grid::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .member-stats-grid::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 2px;
            }
            
            .member-stats-grid::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .member-stats .stat-card {
                padding: 12px !important;
                width: 240px !important;
                min-width: 240px !important;
                flex-shrink: 0 !important;
                scroll-snap-align: center !important;
                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%) !important;
                border-radius: 10px !important;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                z-index: 1 !important;
            }
            
            .member-stats .stat-card:first-child {
                margin-left: 15px;
                transform: scale(0.9);
                z-index: 0;
            }
            
            .member-stats .stat-card:last-child {
                margin-right: 15px;
                transform: scale(0.9);
                z-index: 0;
            }
            
            .member-stats .stat-card:nth-child(2) {
                transform: scale(1);
                z-index: 2;
                box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
            }
            
            .member-stats .stat-card:nth-child(3) {
                transform: scale(0.95);
                z-index: 1;
            }
            
            .member-stats .stat-card:nth-child(4) {
                transform: scale(0.9);
                z-index: 0;
            }
            
            .member-stats .stat-card h4 {
                font-size: 1.1em;
                margin-bottom: 8px;
                color: white;
                font-weight: bold;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                text-align: center;
            }
            
            .member-stats .stat-card small {
                font-size: 0.8em;
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                display: block;
                margin: 3px 0;
                text-align: center;
            }
            
            .member-stats .stat-card .balance {
                color: white;
                font-weight: bold;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                font-size: 1.2em;
                text-align: center;
                margin-top: 8px;
            }
            
            .member-stats .stat-card .view-details {
                text-align: center;
                margin-top: 8px;
                font-size: 0.8em;
                color: rgba(255, 255, 255, 0.8);
                text-decoration: underline;
                cursor: pointer;
            }
            
            /* Á∑äÊπäÁöÑË®òÈåÑÂàóË°® */
            /* Ë®òÈåÑÊü•ÁúãÂçÄÂ°äÊªëÂãïÊïàÊûú */
            .records-list {
                background: #f8f9fa !important;
                border-radius: 10px !important;
                padding: 12px !important;
                margin-bottom: 12px !important;
                max-height: 350px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            .records-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
                padding: 10px 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                max-height: 350px !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .records-container::-webkit-scrollbar {
                height: 4px;
            }
            
            .records-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .records-container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 2px;
            }
            
            .records-container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .record-item {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 8px !important;
                width: 100% !important;
                flex-shrink: 0 !important;
                background: white !important;
                border-radius: 8px !important;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                z-index: 1 !important;
                margin: 0 !important;
            }
            
            /* ÁßªÈô§Ë®òÈåÑÈ†ÖÁõÆÁöÑÁâπÊÆäÊ®£ÂºèÔºåÊîπÁÇ∫ÂûÇÁõ¥ÂàóË°® */
            
            .record-info {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            .record-info h4 {
                font-size: 0.9em !important;
                margin-bottom: 3px !important;
                color: #333 !important;
                font-weight: bold !important;
            }
            
            .record-info p {
                font-size: 0.8em !important;
                margin: 2px 0 !important;
                color: #666 !important;
            }
            
            .record-amount {
                font-size: 1.1em !important;
                font-weight: bold !important;
                color: #333 !important;
            }
            
            .record-actions {
                display: flex;
                gap: 4px;
            }
            
            .record-actions .btn-small {
                padding: 4px 8px;
                font-size: 0.7em;
            }
            
            /* ÂÑ™ÂåñÂÖßÂÆπÂçÄÂüü */
            .content {
                padding: 10px;
                min-height: calc(100vh - 200px) !important;
            }
            
            /* Á∑äÊπäÁöÑÁØ©ÈÅ∏Ê®ôÁ±§ */
            .record-filter-tabs {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 4px !important;
                margin-bottom: 15px !important;
                justify-content: space-between !important;
                overflow-x: auto !important;
            }
            
            .filter-tab {
                padding: 8px 6px !important;
                font-size: 0.75em !important;
                border-radius: 6px !important;
                min-width: 0 !important;
                flex: 1 !important;
                text-align: center !important;
                background: #f8f9fa !important;
                border: 1px solid #dee2e6 !important;
                color: #495057 !important;
                transition: all 0.3s ease !important;
                white-space: nowrap !important;
            }
            
            .filter-tab.active {
                background: #007bff !important;
                color: white !important;
                border-color: #007bff !important;
            }
            
            .filter-tab:hover {
                background: #e9ecef !important;
                border-color: #adb5bd !important;
            }
            
            .filter-tab.active:hover {
                background: #0056b3 !important;
                border-color: #0056b3 !important;
            }
            
            /* Á∑äÊπäÁöÑÂúñË°®ÂçÄÂüü */
            .chart-controls {
                margin-bottom: 10px;
            }
            
            .chart-controls select {
                padding: 8px;
                font-size: 0.8em;
            }
            
            /* Á∑äÊπäÁöÑË®≠ÂÆöÈ†ÅÈù¢ */
            .settings-section {
                margin-bottom: 15px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 6px;
            }
            
            .settings-section h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }
            
            .settings-section p {
                font-size: 0.8em;
                margin-bottom: 5px;
            }
            
            /* Á∑äÊπäÁöÑÂêåÊ≠•ÁãÄÊÖã */
            .sync-status {
                padding: 8px;
                font-size: 0.8em;
                border-radius: 4px;
            }
            
            /* Á∑äÊπäÁöÑÁí∞Â¢ÉÈÄöÁü• */
            .env-notice {
                padding: 10px;
                margin: 10px 0;
                font-size: 0.8em;
            }
            
            .env-notice .notice-content h4 {
                font-size: 0.9em;
                margin-bottom: 5px;
            }
            
            .env-notice .notice-content p {
                font-size: 0.75em;
                margin: 3px 0;
            }
            
            /* ÊªëÂãïÊåáÁ§∫Âô® */
            .swipe-indicator {
                text-align: center;
                color: #666;
                font-size: 0.7em;
                margin: 5px 0;
                opacity: 0.7;
            }
            
            .swipe-indicator::before {
                content: "‚Üê Â∑¶Âè≥ÊªëÂãïÊü•ÁúãÊõ¥Â§ö ‚Üí";
            }
            
            /* ÊàêÂì°ÊåáÁ§∫Âô® */
            .member-indicators {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin: 10px 0;
            }
            
            .member-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .member-indicator.active {
                background: white;
                transform: scale(1.2);
            }
            
            /* ÂãïÊÖãÊªëÂãïÊïàÊûú */
            .stats:active .stat-card,
            .stats-grid:active .stat-card,
            .member-stats-grid:active .stat-card {
                transition: transform 0.1s ease;
            }
            
            .stats:active .stat-card:nth-child(2),
            .stats-grid:active .stat-card:nth-child(2),
            .member-stats-grid:active .stat-card:nth-child(2) {
                transform: scale(0.98);
            }
            
            /* ÊªëÂãïÊôÇÁöÑË¶ñË¶∫ÂèçÈ•ã */
            .stats::-webkit-scrollbar-thumb:active,
            .stats-grid::-webkit-scrollbar-thumb:active,
            .member-stats-grid::-webkit-scrollbar-thumb:active {
                background: #333;
            }
            
            /* Footer Ê®£Âºè */
            .footer {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 8px !important;
                border-radius: 0 !important;
                margin-top: 10px !important;
                text-align: center !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
            }
            
            .footer-content {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 10px !important;
            }
            
            .footer-version {
                font-size: 0.8em !important;
                opacity: 0.9 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
            
            .footer-version-label {
                font-weight: bold !important;
            }
            
            .footer-version-number {
                font-family: monospace !important;
            }
        }

        /* ÈüøÊáâÂºèË®≠Ë®à - iPad Áâà (768x1024) */
        @media screen and (min-width: 481px) and (max-width: 1024px) {
            body {
                padding: 0;
                margin: 0;
                height: 100vh;
                overflow: hidden;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .container {
                border-radius: 12px;
                padding-top: 105px !important;
                padding-bottom: 60px !important;
                background: white;
                height: 100vh;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .container::-webkit-scrollbar {
                width: 10px;
            }
            
            .container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 5px;
            }
            
            .container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 5px;
            }
            
            .container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .header {
                padding: 12px 20px;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1001 !important;
                border-radius: 0 !important;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .nav-tabs {
                gap: 8px;
                position: fixed !important;
                top: 90px !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                z-index: 1000 !important;
                border-bottom: 1px solid #dee2e6 !important;
            }
            
            .nav-tab {
                padding: 14px 18px;
                font-size: 0.95em;
            }
            
            .tab-content {
                padding: 20px;
                min-height: calc(100vh - 250px) !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 1.2em;
            }
            
            .stat-card .stat-value {
                font-size: 1.4em;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px;
            }
            
            .form-row {
                gap: 15px;
            }
            
            .form-row .form-group {
                min-width: 180px;
            }
            
            .btn {
                padding: 14px 24px;
                font-size: 0.95em;
            }
            
            .record-item {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 3px !important;
                background: #f8f9fa !important;
                border-radius: 8px !important;
                padding: 10px !important;
                margin: 12px 0 !important;
            }
            
            .calendar-day {
                padding: 10px 6px !important;
                font-size: 0.85em !important;
                background: white !important;
                border-radius: 5px !important;
                text-align: center !important;
                min-height: 45px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                transition: all 0.3s ease !important;
            }
            
            .calendar-day:hover {
                background: #f8f9fa !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            }
            
            .calendar-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 18px !important;
                padding: 12px 0 !important;
            }
            
            .calendar-title {
                font-size: 1.5em !important;
                font-weight: bold !important;
                color: #333 !important;
                text-align: center !important;
                flex: 1 !important;
            }
            
            .calendar-nav {
                padding: 10px 16px !important;
                font-size: 0.9em !important;
                background: #007bff !important;
                color: white !important;
                border: none !important;
                border-radius: 6px !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
            }
            
            .calendar-nav:hover {
                background: #0056b3 !important;
            }
            
            .calendar-weekdays {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 3px !important;
                margin-bottom: 6px !important;
                padding: 0 10px !important;
            }
            
            .calendar-weekday {
                text-align: center !important;
                font-size: 0.8em !important;
                font-weight: bold !important;
                color: #666 !important;
                padding: 6px 0 !important;
                background: #e9ecef !important;
                border-radius: 3px !important;
            }
            
            .day-number {
                font-size: 1em !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 3px !important;
            }
            
            .day-records {
                font-size: 0.75em !important;
                color: #666 !important;
                text-align: center !important;
                line-height: 1.2 !important;
            }
            
            .day-income {
                color: #51cf66 !important;
                font-weight: 500 !important;
                font-size: 0.7em !important;
                margin: 1px 0 !important;
            }
            
            .day-expense {
                color: #ff6b6b !important;
                font-weight: 500 !important;
                font-size: 0.7em !important;
                margin: 1px 0 !important;
            }
            
            .calendar-day.today {
                background: #e3f2fd !important;
                border: 2px solid #2196f3 !important;
            }
            
            .calendar-day.has-records {
                background: #fff3e0 !important;
            }
            
            .chart-section canvas {
                max-height: 300px;
            }
            
            /* iPadÁâà Footer Ê®£Âºè */
            .footer {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 12px !important;
                border-radius: 0 !important;
                margin-top: 15px !important;
                text-align: center !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
            }
            
            .footer-content {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 15px !important;
            }
            
            .footer-version {
                font-size: 0.9em !important;
                opacity: 0.9 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
            
            .footer-version-label {
                font-weight: bold !important;
            }
            
            .footer-version-number {
                font-family: monospace !important;
            }
        }

        /* ÈüøÊáâÂºèË®≠Ë®à - ÈõªËÖ¶Áâà (1025px+) */
        @media screen and (min-width: 1025px) {
            body {
                padding: 0;
                margin: 0;
                height: 100vh;
                overflow: hidden;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .container {
                max-width: 1400px;
                padding-top: 140px !important;
                padding-bottom: 80px !important;
                background: white;
                height: 100vh;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .container::-webkit-scrollbar {
                width: 12px;
            }
            
            .container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 6px;
            }
            
            .container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 6px;
            }
            
            .container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            .header {
                padding: 15px 30px;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1001 !important;
                border-radius: 0 !important;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .nav-tabs {
                gap: 10px;
                position: fixed !important;
                top: 110px !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                z-index: 1000 !important;
                border-bottom: 1px solid #dee2e6 !important;
            }
            
            .nav-tab {
                padding: 16px 20px;
                font-size: 1em;
            }
            
            .tab-content {
                padding: 25px;
                min-height: calc(100vh - 250px) !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
            
            .stat-card {
                padding: 25px;
            }
            
            .stat-card h3 {
                font-size: 1.3em;
            }
            
            .stat-card .stat-value {
                font-size: 1.5em;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 16px;
            }
            
            .form-row {
                gap: 20px;
            }
            
            .form-row .form-group {
                min-width: 200px;
            }
            
            .btn {
                padding: 16px 28px;
                font-size: 1em;
            }
            
            .record-item {
                padding: 18px;
                margin-bottom: 15px;
            }
            
            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 4px !important;
                background: #f8f9fa !important;
                border-radius: 8px !important;
                padding: 12px !important;
                margin: 15px 0 !important;
            }
            
            .calendar-day {
                padding: 12px 8px !important;
                font-size: 0.9em !important;
                background: white !important;
                border-radius: 6px !important;
                text-align: center !important;
                min-height: 50px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                transition: all 0.3s ease !important;
            }
            
            .calendar-day:hover {
                background: #f8f9fa !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            }
            
            .calendar-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 20px !important;
                padding: 15px 0 !important;
            }
            
            .calendar-title {
                font-size: 1.8em !important;
                font-weight: bold !important;
                color: #333 !important;
                text-align: center !important;
                flex: 1 !important;
            }
            
            .calendar-nav {
                padding: 12px 20px !important;
                font-size: 1em !important;
                background: #007bff !important;
                color: white !important;
                border: none !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
            }
            
            .calendar-nav:hover {
                background: #0056b3 !important;
                transform: translateY(-1px) !important;
            }
            
            .calendar-weekdays {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
                padding: 0 12px !important;
            }
            
            .calendar-weekday {
                text-align: center !important;
                font-size: 0.9em !important;
                font-weight: bold !important;
                color: #666 !important;
                padding: 8px 0 !important;
                background: #e9ecef !important;
                border-radius: 4px !important;
            }
            
            .day-number {
                font-size: 1.1em !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 4px !important;
            }
            
            .day-records {
                font-size: 0.8em !important;
                color: #666 !important;
                text-align: center !important;
                line-height: 1.3 !important;
            }
            
            .day-income {
                color: #51cf66 !important;
                font-weight: 500 !important;
                font-size: 0.75em !important;
                margin: 2px 0 !important;
            }
            
            .day-expense {
                color: #ff6b6b !important;
                font-weight: 500 !important;
                font-size: 0.75em !important;
                margin: 2px 0 !important;
            }
            
            .calendar-day.today {
                background: #e3f2fd !important;
                border: 2px solid #2196f3 !important;
            }
            
            .calendar-day.has-records {
                background: #fff3e0 !important;
            }
            
            .chart-section canvas {
                max-height: 400px;
            }
            
            /* Ê°åÈù¢Áâà Footer Ê®£Âºè */
            .footer {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 18px !important;
                border-radius: 0 !important;
                margin-top: 25px !important;
                text-align: center !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
            }
            
            .footer-content {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 20px !important;
            }
            
            .footer-version {
                font-size: 1em !important;
                opacity: 0.9 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
            
            .footer-version-label {
                font-weight: bold !important;
            }
            
            .footer-version-number {
                font-family: monospace !important;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .header-main {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .version-info {
            display: none !important;
        }

        .version-label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .version-number {
            font-weight: bold;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .env-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        /* Excel ÂåØÂÖ•ÂäüËÉΩÊ®£Âºè */
        .excel-import-section {
            margin-top: 20px;
        }
        
        /* ÂåØÂÖ•Ê†ºÂºèÈÅ∏ÊìáÂô®Ê®£Âºè */
        .import-format-selector {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .import-format-selector label {
            display: inline-block;
            margin-right: 20px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .import-format-selector input[type="radio"] {
            margin-right: 8px;
        }

        /* ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢Ê®£Âºè */
        .import-selection {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .selection-description {
            margin-bottom: 10px;
            padding: 8px 12px;
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            font-size: 14px;
            color: #0066cc;
        }
        
        .selection-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .selection-controls .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        #selectedCount {
            margin-left: auto;
            font-weight: bold;
            color: #495057;
        }
        
        .records-selection {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }
        
        .record-selection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }
        
        .record-selection-item:hover {
            background-color: #f8f9fa;
        }
        
        .record-selection-item:last-child {
            border-bottom: none;
        }
        
        .record-selection-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .record-info {
            flex: 1;
            display: grid;
            grid-template-columns: 80px 120px 100px 200px 80px;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }
        
        .record-info .label {
            font-weight: bold;
            color: #495057;
        }
        
        .record-info .value {
            color: #6c757d;
        }
        
        .duplicate-note {
            margin-top: 8px;
            padding: 6px 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            font-size: 12px;
            color: #856404;
            font-weight: bold;
        }
        
        .record-type-note {
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .record-type-note.new {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .record-type-note.duplicate {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .selection-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* ÈÄöÁü•ÂãïÁï´Ê®£Âºè */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .compare-result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
        }

        .summary-item.new {
            border-left-color: #28a745;
        }

        .summary-item.duplicate {
            border-left-color: #ffc107;
        }

        .summary-item .label {
            font-weight: 500;
        }

        .summary-item .value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .records-list {
            margin-top: 15px;
        }

        .records-preview {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 15px;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-info {
            flex: 1;
        }

        .record-date {
            font-weight: 500;
            color: #333;
        }

        .record-details {
            font-size: 0.9em;
            color: #666;
        }

        /* Excel Ê†ºÂºèË™™ÊòéÊ®£Âºè */
        .format-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .format-info h4 {
            margin: 0 0 15px 0;
            color: #495057;
        }

        .format-example ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .format-example li {
            margin: 5px 0;
        }

        .format-table {
            margin-top: 15px;
            overflow-x: auto;
        }

        .format-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .format-table th,
        .format-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .format-table th {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .format-table td {
            color: #6c757d;
        }

        .format-table tbody tr:hover {
            background: #f8f9fa;
        }

        .env-notice .notice-content h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .env-notice .notice-content p {
            margin: 5px 0;
            color: #856404;
        }

        .env-notice .notice-content a {
            color: #007bff;
            text-decoration: underline;
        }

        .env-notice .notice-content a:hover {
            color: #0056b3;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: inline-block;
            text-align: center;
            text-decoration: none;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .member-stats {
            margin-bottom: 30px;
        }

        .record-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .member-stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Ê°åÈù¢ÁâàÊàêÂì°Áµ±Ë®à - Âè™Âú®ÈùûÊâãÊ©üÁâàÁîüÊïà */
        @media screen and (min-width: 481px) {
        .member-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            }
            
            .member-stats .stat-card {
                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%) !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .record-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-item.income {
            border-left-color: #51cf66;
        }

        .record-item.expense {
            border-left-color: #ff6b6b;
        }

        .record-info {
            flex: 1;
        }

        .record-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-amount {
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #51cf66;
        }

        .record-amount.expense {
            color: #ff6b6b;
        }

        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 1px !important;
            background: #dee2e6 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-records {
            font-size: 12px;
            margin-top: 5px;
        }

        .day-income {
            color: #51cf66;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(81, 207, 102, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-expense {
            color: #ff6b6b;
            font-size: 10px;
            margin: 1px 0;
            padding: 2px 3px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .import-section, .export-section, .github-sync-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .import-section h3, .export-section h3, .github-sync-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .github-sync-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .github-sync-section h3 {
            color: white;
        }
        
        .github-sync-section p {
            opacity: 0.9;
        }
        
        .sync-info {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .info-icon {
            font-size: 1.5em;
            color: white;
        }
        
        .sync-info h4 {
            margin: 0 0 8px 0;
            color: white;
            font-size: 1.1em;
        }
        
        .sync-info p {
            margin: 0 0 8px 0;
            color: white;
            font-size: 0.9em;
        }
        
        .sync-info ul {
            margin: 0;
            padding-left: 20px;
            color: white;
            font-size: 0.9em;
        }
        
        .sync-info li {
            margin-bottom: 4px;
        }
        
        .sync-actions {
            text-align: center;
        }
        
        .sync-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .sync-status.success {
            background: rgba(40, 167, 69, 0.2);
            color: white;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .sync-status.error {
            background: rgba(220, 53, 69, 0.2);
            color: white;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .sync-status.loading {
            background: rgba(255, 193, 7, 0.2);
            color: white;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-card h4 {
            margin-bottom: 10px;
            color: #4facfe;
        }

        .import-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-card li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .import-card input[type="file"] {
            display: none;
        }

        .import-card button {
            margin-top: 15px;
        }

        .import-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .preview-table .status-valid {
            color: #51cf66;
        }

        .preview-table .status-invalid {
            color: #ff6b6b;
        }

        .import-actions, .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-section h3 {
            color: white;
        }

        .export-section p {
            opacity: 0.9;
        }

        .delete-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border: 1px solid #fed7d7;
        }

        .delete-section h3 {
            margin-bottom: 15px;
            color: #e53e3e;
        }

        .delete-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .delete-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .delete-card h4 {
            margin-bottom: 10px;
            color: #e53e3e;
        }

        .delete-card p {
            margin-bottom: 15px;
            color: #666;
        }

        #dataStats p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        #dataStats span {
            font-weight: bold;
            color: #e53e3e;
        }

        .filter-delete {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-delete select,
        .filter-delete input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e53e3e;
        }

        .delete-preview h4 {
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .delete-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* ÂúñË°®È†ÅÈù¢Ê®£Âºè */
        .chart-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-amount {
                margin: 10px 0;
            }

            .import-options {
                grid-template-columns: 1fr;
            }

            .import-actions, .export-actions {
                flex-direction: column;
            }
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .token-settings {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .token-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
            flex: 1;
            min-width: 300px;
        }

        .token-status {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .token-status p {
            margin: 5px 0;
        }

        .token-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .token-actions input {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-main">
                    <h1>üí∞ Êî∂ÊîØÂπ≥Âè∞</h1>
                    <p>ËºïÈ¨ÜÁÆ°ÁêÜÊÇ®ÁöÑË≤°Âãô</p>
                </div>
                <div class="version-info">
                    <span class="version-label">ÁâàÊú¨</span>
                    <span class="version-number" id="versionNumber">ËºâÂÖ•‰∏≠...</span>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <i>üìä</i>
                <span>Á∏ΩË¶Ω</span>
            </button>
            <button class="nav-tab" onclick="showTab('list')">
                <i>üìã</i>
                <span>ÂàóË°®</span>
            </button>
            <button class="nav-tab" onclick="showTab('calendar')">
                <i>üìÖ</i>
                <span>Êó•ÊõÜ</span>
            </button>
            <button class="nav-tab" onclick="showTab('charts')">
                <i>üìà</i>
                <span>ÂúñË°®</span>
            </button>
            <button class="nav-tab" onclick="showTab('add')">
                <i>‚ûï</i>
                <span>Êñ∞Â¢û</span>
            </button>
            <button class="nav-tab" onclick="showTab('import')">
                <i>‚öôÔ∏è</i>
                <span>Ë®≠ÂÆö</span>
            </button>
        </div>

        <div class="content">
            <!-- Á∏ΩË¶ΩÈ†ÅÈù¢ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-section">
                    <h3>Áµ±Ë®à</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <h3 id="totalExpense">$0</h3>
                            <p>Á∏ΩÊîØÂá∫</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="creditExpense">$0</h3>
                            <p>‰ø°Áî®Âç°ÊîØÂá∫</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="balance">$0</h3>
                            <p>ÁèæÈáëÈ§òÈ°ç</p>
                        </div>
                    </div>
                </div>
                <div class="swipe-indicator" id="statsSwipeIndicator"></div>
                <div class="member-stats">
                    <h3>ÊàêÂì°Êî∂ÊîØÁµ±Ë®à</h3>
                    <div class="member-stats-grid" id="memberStats"></div>
                    <div class="member-indicators" id="memberIndicators"></div>
                    <div class="swipe-indicator" id="memberSwipeIndicator"></div>
                </div>
                <div class="records-list">
                    <h3>Ë®òÈåÑÊü•Áúã</h3>
                    <div class="record-filter-tabs">
                        <button class="filter-tab active" onclick="showExpenseRecords()">ÊîØÂá∫</button>
                        <button class="filter-tab" onclick="showCashExpenseRecords()">ÁèæÈáë</button>
                        <button class="filter-tab" onclick="showCreditExpenseRecords()">‰ø°Áî®Âç°</button>
                        <button class="filter-tab" onclick="showIncomeRecords()">Êî∂ÂÖ•</button>
                        <button class="filter-tab" onclick="showAllRecords()">ÂÖ®ÈÉ®</button>
                    </div>
                    <div id="recentRecords"></div>
                </div>
            </div>

            <!-- ÂàóË°®È†ÅÈù¢ -->
            <div id="list" class="tab-content">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="ÊêúÂ∞ãË®òÈåÑ..." onkeyup="filterRecords()">
                    <select id="memberFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÊàêÂì°</option>
                        <option value="Kelvin">Kelvin</option>
                        <option value="Phuong">Phuong</option>
                        <option value="Ryan">Ryan</option>
                        <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                    </select>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                        <option value="income">Êî∂ÂÖ•</option>
                        <option value="expense">ÊîØÂá∫</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRecords()">
                </div>
                <div class="records-list">
                    <div id="allRecords"></div>
                </div>
            </div>

            <!-- Êó•ÊõÜÈ†ÅÈù¢ -->
            <div id="calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ ‰∏äÊúà</button>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">‰∏ãÊúà ‚Ä∫</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Êó•</div>
                        <div class="calendar-weekday">‰∏Ä</div>
                        <div class="calendar-weekday">‰∫å</div>
                        <div class="calendar-weekday">‰∏â</div>
                        <div class="calendar-weekday">Âõõ</div>
                        <div class="calendar-weekday">‰∫î</div>
                        <div class="calendar-weekday">ÂÖ≠</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- ÂúñË°®È†ÅÈù¢ -->
            <div id="charts" class="tab-content">
                <div class="chart-controls">
                    <div class="chart-filter-bar">
                        <select id="chartYear" onchange="updateCharts()">
                            <option value="2024">2024Âπ¥</option>
                            <option value="2025" selected>2025Âπ¥</option>
                        </select>
                        <select id="chartMonth" onchange="updateCharts()">
                            <option value="1">1Êúà</option>
                            <option value="2">2Êúà</option>
                            <option value="3">3Êúà</option>
                            <option value="4">4Êúà</option>
                            <option value="5">5Êúà</option>
                            <option value="6">6Êúà</option>
                            <option value="7">7Êúà</option>
                            <option value="8">8Êúà</option>
                            <option value="9">9Êúà</option>
                            <option value="10">10Êúà</option>
                            <option value="11">11Êúà</option>
                            <option value="12">12Êúà</option>
                        </select>
                        <button class="btn" onclick="refreshCharts()">üîÑ ÈáçÊñ∞Êï¥ÁêÜ</button>
                    </div>
                </div>

                <!-- Êî∂ÊîØË∂®Âã¢ÂúñË°® -->
                <div class="chart-section">
                    <h3>üìà Êî∂ÊîØË∂®Âã¢</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- È°ûÂà•Áµ±Ë®àÂúñË°® -->
                <div class="chart-section">
                    <h3>ü•ß È°ûÂà•Áµ±Ë®à</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- ÊàêÂì°Êî∂ÊîØÂ∞çÊØî -->
                <div class="chart-section">
                    <h3>üë• ÊàêÂì°Êî∂ÊîØÂ∞çÊØî</h3>
                    <div class="chart-container">
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÈ†ÅÈù¢ -->
            <div id="add" class="tab-content">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="member">ÊàêÂì°</label>
                            <select id="member" required>
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="Kelvin">Kelvin</option>
                                <option value="Phuong">Phuong</option>
                                <option value="Ryan">Ryan</option>
                                <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="type">È°ûÂûã</label>
                            <select id="type" required onchange="handleTypeChange()">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="income">Êî∂ÂÖ•</option>
                                <option value="expense">ÊîØÂá∫</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">ÈáëÈ°ç</label>
                            <input type="number" id="amount" step="0.01" required placeholder="Ëº∏ÂÖ•ÈáëÈ°çÔºàÊ≠£Êï∏Ôºâ">
                        </div>
                        <div class="form-group">
                            <label for="date">Êó•Êúü</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="mainCategory" required onchange="handleMainCategoryChange()">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                            </select>
                            <input type="text" id="customMainCategory" placeholder="Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="subCategory">‰ªòÊ¨æÊñπÂºè</label>
                            <select id="subCategory" required>
                                <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                                <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                                <option value="ÁèæÈáë">ÁèæÈáë</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">ÊèèËø∞</label>
                        <textarea id="description" rows="3" placeholder="Ë´ãËº∏ÂÖ•Ë©≥Á¥∞ÊèèËø∞..."></textarea>
                    </div>
                    <button type="submit" class="btn">Êñ∞Â¢ûË®òÈåÑ</button>
                </form>
            </div>

            <!-- Ë®≠ÂÆöÈ†ÅÈù¢ -->
            <div id="import" class="tab-content">
                <!-- Êï∏ÊìöÂåØÂÖ•ÂäüËÉΩ -->
                <div class="import-section">
                    <h3>üì• Êï∏ÊìöÂåØÂÖ•</h3>
                    <p>ÊîØÊè¥ Excel Ê™îÊ°àÂåØÂÖ•</p>
                    
                    <!-- ExcelÂåØÂÖ•Ê†ºÂºèË™™Êòé -->
                    <div class="import-format-info">
                        <p><strong>Excel Ê™îÊ°àÊ†ºÂºè</strong>ÔºöÊàêÂì°„ÄÅÈáëÈ°ç„ÄÅÈ°ûÂà•„ÄÅ‰∏ªÈ°ûÂà•„ÄÅ‰ªòÊ¨æÊñπÂºè„ÄÅÊèèËø∞„ÄÅÊó•Êúü</p>
                    </div>
                    
                    <div class="excel-import-section">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-icon">üìÅ</div>
                                <p id="uploadDescription">ÈªûÊìäÊàñÊãñÊãΩ Excel Ê™îÊ°àÂà∞Ê≠§Ëôï</p>
                                <p class="upload-hint">ÊîØÊè¥ .xlsx Âíå .xls Ê†ºÂºèÔºåÊúÄÂ§ß 10MB</p>
                                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                                <button class="btn" onclick="document.getElementById('excelFileInput').click()">ÈÅ∏ÊìáÊ™îÊ°à</button>
            </div>
        </div>
                    
                        <div id="compareResult" class="compare-result" style="display: none;">
                            <h4>üìã ÊØîÂ∞çÁµêÊûú</h4>
                            <div class="result-summary">
                                <div class="summary-item">
                                    <span class="label">Excel Á∏ΩË®òÈåÑÊï∏:</span>
                                    <span class="value" id="totalExcelRecords">0</span>
                            </div>
                                <div class="summary-item">
                                    <span class="label">Á≥ªÁµ±ÁèæÊúâË®òÈåÑÊï∏:</span>
                                    <span class="value" id="systemRecords">0</span>
                            </div>
                                <div class="summary-item new">
                                    <span class="label">ÂèØÊñ∞Â¢ûË®òÈåÑÊï∏:</span>
                                    <span class="value" id="newRecords">0</span>
                        </div>
                                <div class="summary-item duplicate">
                                    <span class="label">ÈáçË§áË®òÈåÑÊï∏:</span>
                                    <span class="value" id="duplicateRecords">0</span>
                    </div>
                </div>

                            <div class="result-actions">
                                <button class="btn btn-primary" id="importBtn" disabled>
                                    üì• ÈÅ∏ÊìáÂåØÂÖ•Ë®òÈåÑ
                                </button>
                                <button class="btn btn-success" id="importAllBtn" style="display: none;">
                                    üì• ÂåØÂÖ•ÂÖ®ÈÉ®Ë®òÈåÑ
                                </button>
                                <button class="btn btn-secondary" onclick="clearCompareResult()">
                                    üîÑ ÈáçÊñ∞ÊØîÂ∞ç
                                </button>
                            </div>
                            
                            <div id="newRecordsList" class="records-list" style="display: none;">
                                <h5>üÜï Êñ∞Ë®òÈåÑÈ†êË¶Ω</h5>
                                <div class="records-preview" id="newRecordsPreview"></div>
                        </div>
                        
                            <div id="duplicateRecordsList" class="records-list" style="display: none;">
                                <h5>üîÑ ÈáçË§áË®òÈåÑ</h5>
                                <div class="records-preview" id="duplicateRecordsPreview"></div>
                        </div>
                    </div>
                    
                        <!-- ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢ -->
                        <div id="importSelection" class="import-selection" style="display: none;">
                            <h4>üìã ÈÅ∏ÊìáË¶ÅÂåØÂÖ•ÁöÑË®òÈåÑ</h4>
                            <div class="selection-controls">
                                <button class="btn btn-secondary" onclick="selectAllRecords()">ÂÖ®ÈÅ∏</button>
                                <button class="btn btn-secondary" onclick="selectNewRecordsOnly()">Âè™ÈÅ∏Êñ∞Ë®òÈåÑ</button>
                                <button class="btn btn-secondary" onclick="clearSelection()">Ê∏ÖÈô§ÈÅ∏Êìá</button>
                        </div>
                            <div class="records-selection" id="recordsSelection"></div>
                            <div class="selection-actions">
                                <button class="btn btn-success" onclick="confirmSelectedImport()">Á¢∫Ë™çÂåØÂÖ•ÈÅ∏‰∏≠Ë®òÈåÑ</button>
                                <button class="btn btn-secondary" onclick="cancelImportSelection()">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Êï∏ÊìöÂåØÂá∫ÂäüËÉΩ -->
                <div class="export-section">
                    <h3>üì§ Êï∏ÊìöÂåØÂá∫</h3>
                    <p>Â∞áÁèæÊúâË®òÈåÑÂåØÂá∫ÁÇ∫ Excel Ê™îÊ°à</p>
                    <div class="export-actions">
                        <button class="btn" onclick="downloadExcelBackup()">üìä ‰∏ãËºâ Excel ÂÇô‰ªΩ</button>
                    </div>
                </div>
                
                <!-- Excel ÂåØÂÖ•ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞Êï∏ÊìöÂåØÂÖ•ÂçÄÂ°ä -->
                
                <!-- GitHub ÂêåÊ≠•ÂäüËÉΩ -->
                <div class="github-sync-section">
                    <h3>‚òÅÔ∏è GitHub ÂêåÊ≠•</h3>
                    <p>Â∞áË≥áÊñôÂêåÊ≠•Âà∞ GitHub ÂÑ≤Â≠òÂ∫´</p>
                    
                    <div class="sync-info">
                        <div class="info-icon">‚ÑπÔ∏è</div>
                        <div class="info-content">
                            <h4>ÂêåÊ≠•Ë™™Êòé</h4>
                            <p>ÊâãÂãïÂêåÊ≠•Â∞áÊúÉÔºö</p>
                            <ul>
                                <li>Â∞áÊâÄÊúâÊú¨Âú∞Ë®òÈåÑ‰∏äÂÇ≥Âà∞ GitHub</li>
                                <li>Á¢∫‰øùË≥áÊñôÂú®Èõ≤Á´ØÂÇô‰ªΩ</li>
                                <li>ÂèØÂú®ÂÖ∂‰ªñË£ùÁΩÆÂêåÊ≠•Ë≥áÊñô</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="sync-actions">
                        <button class="btn btn-primary" onclick="syncToGitHub()" id="syncBtn">
                            üíæ ÂÑ≤Â≠òÂà∞ GitHub
                        </button>
                        <div id="syncStatus" class="sync-status" style="display: none;"></div>
                        
                        <!-- GitHub Token ÁãÄÊÖãÊ™¢Êü• -->
                        <div class="github-token-status" style="margin-top: 20px;">
                            <h4>üîç GitHub Token ÁãÄÊÖã</h4>
                            <div id="tokenStatus" class="token-status"></div>
                            
                            <!-- Token ÁãÄÊÖãÊìç‰ΩúÊåâÈàï -->
                            <div class="token-actions">
                                <button class="btn btn-warning" onclick="checkTokenStatus()" id="checkTokenBtn">üîç Ê™¢Êü• Token ÁãÄÊÖã</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ë≥áÊñôÊ∏ÖÈô§ÂäüËÉΩ -->
                <div class="clear-section">
                    <h3>üóëÔ∏è Ë≥áÊñôÊ∏ÖÈô§</h3>
                    <p>Ê∏ÖÈô§ÊâÄÊúâÊî∂ÊîØË®òÈåÑÊï∏Êìö</p>
                    
                    <div class="clear-warning">
                        <div class="warning-icon">‚ö†Ô∏è</div>
                        <div class="warning-content">
                            <h4>Ë≠¶ÂëäÔºöÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ</h4>
                            <p>Ê∏ÖÈô§Ë≥áÊñôÂ∞áÊúÉÔºö</p>
                            <ul>
                                <li>Âà™Èô§ÊâÄÊúâÊî∂ÊîØË®òÈåÑ</li>
                                <li>Ê∏ÖÁ©∫Áµ±Ë®àÊï∏Êìö</li>
                                <li>ÁÑ°Ê≥ïÂæ©Âéü</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="clear-actions">
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØË®òÈåÑÁöÑÊ®°ÊÖãÊ°Ü -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Á∑®ËºØË®òÈåÑ</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMember">ÊàêÂì°</label>
                        <select id="editMember" required>
                            <option value="Kelvin">Kelvin</option>
                            <option value="Phuong">Phuong</option>
                            <option value="Ryan">Ryan</option>
                            <option value="ÂÆ∂Áî®">ÂÆ∂Áî®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editType">È°ûÂûã</label>
                        <select id="editType" required>
                            <option value="income">Êî∂ÂÖ•</option>
                            <option value="expense">ÊîØÂá∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">ÈáëÈ°ç</label>
                        <input type="number" id="editAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="editMainCategory">‰∏ªÈ°ûÂà•</label>
                            <select id="editMainCategory" required onchange="handleEditMainCategoryChange()">
                            </select>
                            <input type="text" id="editCustomMainCategory" placeholder="Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•" style="display: none; margin-top: 10px;">
                        </div>
                    <div class="form-group">
                        <label for="editSubCategory">‰ªòÊ¨æÊñπÂºè</label>
                        <select id="editSubCategory" required>
                            <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                            <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                            <option value="ÁèæÈáë">ÁèæÈáë</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">ÊèèËø∞</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editDate">Êó•Êúü</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">ÂÑ≤Â≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ê∑ªÂä† CSV Âíå Excel Ëß£ÊûêÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Ê∑ªÂä† Chart.js ÂúñË°®Â∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Êï∏ÊìöÂ≠òÂÑ≤
        let records = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Ë∑®ÁÄèË¶ΩÂô®Êï∏ÊìöÂêåÊ≠•
        // syncIntervalËÆäÈáèÂ∑≤ÁßªÈô§ - ‰∏çÂÜçÈúÄË¶ÅËá™ÂãïÂêåÊ≠•
        // localStorageÁ∑©Â≠òÂ∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•ÂæûJSONÊñá‰ª∂ËÆÄÂèñ

        // ÊúçÂãôÂô®ÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•

        // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
        function updateAllDisplays() {
            console.log('üîÑ updateAllDisplays: ÈñãÂßãÊõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫');
            console.log('üìä Áï∂ÂâçrecordsÊï∏Èáè:', records.length);
            console.log('üìä recordsÂÖßÂÆπ:', records.slice(0, 3)); // È°ØÁ§∫Ââç3Á≠ÜË®òÈåÑ
            
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
            updateMemberStats();
            
            console.log('‚úÖ updateAllDisplays: ÊâÄÊúâÈ°ØÁ§∫Êõ¥Êñ∞ÂÆåÊàê');
        }

        // Ëá™ÂãïÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•

        // ÊâãÂãïÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•

        // Ê∏ÖÈô§Á∑©Â≠òÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÁ∑©Â≠ò

        // Ëá™ÂãïÂêåÊ≠•ÂàáÊèõÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•

        // ÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫ÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•ÁãÄÊÖã

        // GitHubËá™ÂãïÂÇô‰ªΩÂäüËÉΩ - Â∑≤ÁßªÈô§

        // ÂæûJSONÊñá‰ª∂ÈÇÑÂéüÊï∏ÊìöÔºàGitHubÈÇÑÂéüÂäüËÉΩÂ∑≤ÁßªÈô§Ôºâ
        async function restoreFromDatabase() {
            try {
                console.log('üîÑ ÂæûJSONÊñá‰ª∂ÈÇÑÂéüÊï∏Êìö...');
                
                // Áõ¥Êé•ÂæûJSONÊñá‰ª∂ËºâÂÖ•Êï∏Êìö
                await loadDataFromFile();
                updateAllDisplays();
                
                console.log('‚úÖ ÊàêÂäüÂæûJSONÊñá‰ª∂ÈÇÑÂéüÊï∏Êìö');
                return true;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è JSONÊñá‰ª∂ÈÇÑÂéüÂ§±Êïó:', error.message);
                return false;
            }
        }
        
        // Ê™¢Êü•ÊòØÂê¶Êúâ2025Âπ¥ÁöÑË®òÈåÑÔºåÂ¶ÇÊûúÊúâÂâáÂàáÊèõÂà∞2025Âπ¥
        function checkAndSwitchTo2025() {
            const has2025Records = records.some(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === 2025;
            });
            
            if (has2025Records) {
                currentYear = 2025;
                console.log('Ê™¢Ê∏¨Âà∞2025Âπ¥Ë®òÈåÑÔºåÂàáÊèõÊó•ÊõÜÂà∞2025Âπ¥');
                updateCalendar();
            }
        }
        let importData = []; // ÂÑ≤Â≠òË¶ÅÂåØÂÖ•ÁöÑÊï∏Êìö
        let deleteData = []; // ÂÑ≤Â≠òË¶ÅÂà™Èô§ÁöÑÊï∏Êìö
        // let dataBackup = null; // Êï∏ÊìöÂÇô‰ªΩ - Â∑≤ÁßªÈô§
        
        // ÂúñË°®Áõ∏ÈóúËÆäÊï∏
        let trendChart = null;
        let categoryChart = null;
        let memberChart = null;

        // È°ûÂà•ÈÅ∏È†Ö
        const categories = {
            income: ['ÈÜ´ÁôÇ', 'ÁçéÈáë', 'ÊäïË≥áÊî∂Áõä', 'ÊàøÁßüÊî∂ÂÖ•', 'ÂÄüÊ¨æÊî∂ÂÖ•', '‰ª£‰ªòÊî∂ÂÖ•', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
            expense: {
                'Â®õÊ®Ç': [],
                'Êó•Â∏∏': [],
                'È§êÈ£≤': [],
                'Ê•äÊ¢Ö': [],
                '‰∫§ÈÄö': [],
                'ÂÖ∂‰ªñ': [],
                'ÈÜ´ÁôÇ': [],
                'Á¶ÆÁâ©': [],
                'Â≠∏Ë≤ª': []
            }
        };

        // ÂÆ∂Â∫≠ÊàêÂì°
        const familyMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];

        // Âõ∫ÂÆöÊîØÂá∫ÊèêÈÜí
        const recurringExpenses = [
            { name: 'ÊàøÁßü', amount: 15000, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊàøË≤∏', amount: 21454, day: 1, member: 'ÂÆ∂Áî®' },
            { name: 'ÊâãÊ©üË≤ª', amount: 1200, day: 15, member: 'Kelvin' },
            { name: 'Á∂≤Ë∑ØË≤ª', amount: 1598, day: 15, member: 'Phuong' }
        ];

        // SafariÂÖºÂÆπÊÄßÊ™¢Ê∏¨Âíå‰øÆÂæ©
        function detectAndFixSafari() {
            const userAgent = navigator.userAgent;
            const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');
            
            if (isSafari) {
                console.log('üçé Ê™¢Ê∏¨Âà∞SafariÔºåÂü∑Ë°åÂÖºÂÆπÊÄß‰øÆÂæ©...');
                
                // SafariÁ∑©Â≠òÊ∏ÖÈô§Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•ÂæûJSONÊñá‰ª∂ËÆÄÂèñ
                
                // Ê∑ªÂä†SafariÂ∞àÁî®ÊèêÁ§∫
                const safariNotice = document.createElement('div');
                safariNotice.id = 'safari-notice';
                safariNotice.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #ff6b6b;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                safariNotice.innerHTML = `
                    üçé SafariÊ®°Âºè | 
                    <button onclick="forceRefreshData()" style="background: white; color: #ff6b6b; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px;">
                        Âº∑Âà∂Âà∑Êñ∞
                    </button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                        ‚úï
                    </button>
                `;
                document.body.appendChild(safariNotice);
                
                // 5ÁßíÂæåËá™ÂãïÈö±Ëóè
                setTimeout(() => {
                    if (safariNotice.parentElement) {
                        safariNotice.remove();
                    }
                }, 5000);
                
                console.log('‚úÖ SafariÂÖºÂÆπÊÄß‰øÆÂæ©ÂÆåÊàê');
            }
            
            return isSafari;
        }

        // Âº∑Âà∂Âà∑Êñ∞Êï∏ÊìöÔºàSafariÂ∞àÁî®Ôºâ
        async function forceRefreshData() {
            console.log('üîÑ SafariÂº∑Âà∂Âà∑Êñ∞Êï∏Êìö...');
            
            try {
                // Áõ¥Êé•ÂæûJSONÊñá‰ª∂ËÆÄÂèñÊï∏Êìö
                console.log('üì° ÂæûJSONÊñá‰ª∂Âº∑Âà∂Âà∑Êñ∞Êï∏Êìö...');
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && Array.isArray(result.records)) {
                        records = result.records;
                        console.log('‚úÖ SafariÂº∑Âà∂Âà∑Êñ∞ÂÆåÊàêÔºåËºâÂÖ•', records.length, 'Á≠ÜË®òÈåÑ');
                        
                        // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        updateSyncStatus();
                        
                        console.log(`‚úÖ SafariÂº∑Âà∂Âà∑Êñ∞ÊàêÂäüÔºåËºâÂÖ• ${records.length} Á≠ÜË®òÈåÑ`);
                        alert(`‚úÖ SafariÂº∑Âà∂Âà∑Êñ∞ÊàêÂäüÔºÅ\nËºâÂÖ• ${records.length} Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå SafariÂº∑Âà∂Âà∑Êñ∞Â§±Êïó:', error);
                alert('‚ùå SafariÂº∑Âà∂Âà∑Êñ∞Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊúçÂãôÁãÄÊÖã');
            }
        }

        // ÁîüÊàêÂîØ‰∏ÄIDÁöÑÂáΩÊï∏
        function generateUniqueId() {
            // ‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑIDÁîüÊàêÊñπÂºèÔºöÊôÇÈñìÊà≥ + Èö®Ê©üÊï∏ + Ë®àÊï∏Âô®
            const timestamp = Date.now().toString();
            const random = Math.random().toString(36).substr(2, 9);
            const counter = (generateUniqueId.counter = (generateUniqueId.counter || 0) + 1);
            return `${timestamp}_${random}_${counter}`;
        }

        // Áí∞Â¢ÉÈÖçÁΩÆ
        const ENV_CONFIG = {
            // Ê™¢Ê∏¨Áï∂ÂâçÁí∞Â¢É
            getEnvironment() {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'local';
                } else if (hostname.includes('vercel.app')) {
                    return 'vercel'; // Vercel Áí∞Â¢É
                } else if (hostname.includes('onrender.com')) {
                    return 'render'; // Render Áí∞Â¢É
                } else if (hostname.includes('github.io')) {
                    return 'sit'; // GitHub Pages Áí∞Â¢É
                }
                return 'local'; // ÈªòË™çÊú¨Âú∞Áí∞Â¢É
            },
            
            // Áç≤ÂèñAPIÂü∫Á§éURL
            getApiBase() {
                const env = this.getEnvironment();
                if (env === 'vercel') {
                    return window.location.origin; // Vercel ÊîØÊåÅÂæåÁ´Ø
                } else if (env === 'render') {
                    return window.location.origin; // Render ÊîØÊåÅÂæåÁ´Ø
                } else if (env === 'sit') {
                    return window.location.origin; // GitHub Pages ‰∏çÊîØÊåÅÂæåÁ´Ø
                } else {
                    return 'http://localhost:3001'; // Êú¨Âú∞Áí∞Â¢É
                }
            },
            
            // Áç≤ÂèñÂæåÁ´ØURL
            getBackendUrl() {
                const env = this.getEnvironment();
                if (env === 'vercel') {
                    return window.location.origin; // Vercel ÊîØÊåÅÂæåÁ´Ø
                } else if (env === 'render') {
                    return window.location.origin; // Render ÊîØÊåÅÂæåÁ´Ø
                } else if (env === 'sit') {
                    return window.location.origin; // GitHub Pages ‰∏çÊîØÊåÅÂæåÁ´Ø
                } else {
                    return 'http://localhost:3001'; // Êú¨Âú∞Áí∞Â¢É
                }
            }
        };

        // Ê™¢Êü•Áí∞Â¢ÉÈôêÂà∂
        function checkEnvironmentLimitations() {
            const env = ENV_CONFIG.getEnvironment();
            const limitationNotice = document.getElementById('envLimitationNotice');

            if (env === 'sit' && limitationNotice) {
                limitationNotice.style.display = 'block';
                console.log('‚ö†Ô∏è GitHub Pages Áí∞Â¢ÉÈôêÂà∂ÔºöÂæåÁ´ØÂäüËÉΩ‰∏çÂèØÁî®');
            } else if (limitationNotice) {
                limitationNotice.style.display = 'none';
                if (env === 'vercel') {
                    console.log('‚úÖ Vercel Áí∞Â¢ÉÔºöÂæåÁ´ØÂäüËÉΩÂÆåÂÖ®ÂèØÁî®');
                } else if (env === 'render') {
                    console.log('‚úÖ Render Áí∞Â¢ÉÔºöÂæåÁ´ØÂäüËÉΩÂÆåÂÖ®ÂèØÁî®');
                } else if (env === 'local') {
                    console.log('‚úÖ Êú¨Âú∞Áí∞Â¢ÉÔºöÂæåÁ´ØÂäüËÉΩÂÆåÂÖ®ÂèØÁî®');
                }
            }
        }

        // ËºâÂÖ•ÁâàÊú¨‰ø°ÊÅØ
        async function loadVersionInfo() {
            try {
                // Ê∑ªÂä†ÊôÇÈñìÊà≥ÈÅøÂÖçÂø´Âèñ
                const timestamp = new Date().getTime();
                const response = await fetch(`data/version.json?t=${timestamp}`);
                const versionData = await response.json();
                
                const versionElement = document.getElementById('versionNumber');
                const footerVersionElement = document.getElementById('footerVersionNumber');
                
                if (versionElement) {
                    versionElement.textContent = versionData.version;
                    versionElement.title = `Âª∫ÊßãÊôÇÈñì: ${versionData.buildTime}\nCommit: ${versionData.commitHash || 'N/A'}`;
                }
                
                if (footerVersionElement) {
                    footerVersionElement.textContent = versionData.version;
                    footerVersionElement.title = `Âª∫ÊßãÊôÇÈñì: ${versionData.buildTime}\nCommit: ${versionData.commitHash || 'N/A'}`;
                }
                
                console.log('‚úÖ ÁâàÊú¨‰ø°ÊÅØÂ∑≤ËºâÂÖ•:', versionData.version);
                console.log('üåç Áï∂ÂâçÁí∞Â¢É:', ENV_CONFIG.getEnvironment());
                console.log('üîó APIÂú∞ÂùÄ:', ENV_CONFIG.getApiBase());
                
                // Ê™¢Êü•Áí∞Â¢ÉÈôêÂà∂
                checkEnvironmentLimitations();
            } catch (error) {
                console.error('‚ùå ËºâÂÖ•ÁâàÊú¨‰ø°ÊÅØÂ§±Êïó:', error);
                const versionElement = document.getElementById('versionNumber');
                const footerVersionElement = document.getElementById('footerVersionNumber');
                
                if (versionElement) {
                    versionElement.textContent = 'ËºâÂÖ•Â§±Êïó';
                }
                
                if (footerVersionElement) {
                    footerVersionElement.textContent = 'ËºâÂÖ•Â§±Êïó';
                }
            }
        }

        // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈ°ØÁ§∫ÊªëÂãïÊåáÁ§∫Âô®ÔºàÂÖ®Â±ÄÂáΩÊï∏Ôºâ
        function checkScrollable(element, indicator) {
            if (element && indicator) {
                const isScrollable = element.scrollWidth > element.clientWidth;
                indicator.style.display = isScrollable ? 'block' : 'none';
                console.log('üîç ÊªëÂãïÊ™¢Êü•:', element.className, 'ÂèØÊªëÂãï:', isScrollable, 'scrollWidth:', element.scrollWidth, 'clientWidth:', element.clientWidth);
            }
        }

        // ÂàùÂßãÂåñÊªëÂãïÊåáÁ§∫Âô®
        function initializeSwipeIndicators() {
            const statsGrid = document.querySelector('.stats');
            const memberStatsGrid = document.querySelector('.member-stats-grid');
            const statsIndicator = document.getElementById('statsSwipeIndicator');
            const memberIndicator = document.getElementById('memberSwipeIndicator');
            
            // Ê∑ªÂä†ÊªëÂãïÊôÇÁöÑÂãïÊÖãÊïàÊûú
            function addSwipeEffects(element) {
                if (!element) return;
                
                let isScrolling = false;
                
                element.addEventListener('scroll', function() {
                    if (!isScrolling) {
                        isScrolling = true;
                        element.style.transition = 'none';
                        
                        // ÊªëÂãïÊôÇÁöÑÊïàÊûú
                        const cards = element.querySelectorAll('.stat-card');
                        cards.forEach((card, index) => {
                            const rect = card.getBoundingClientRect();
                            const center = window.innerWidth / 2;
                            const distance = Math.abs(rect.left + rect.width / 2 - center);
                            const scale = Math.max(0.9, 1 - distance / 200);
                            
                            card.style.transform = `scale(${scale})`;
                            card.style.zIndex = Math.round(scale * 10);
                        });
                        
                        setTimeout(() => {
                            isScrolling = false;
                            element.style.transition = '';
                        }, 100);
                    }
                });
            }
            
            // ÂàùÂßãÊ™¢Êü•
            checkScrollable(statsGrid, statsIndicator);
            checkScrollable(memberStatsGrid, memberIndicator);
            
            // Ê∑ªÂä†ÊªëÂãïÊïàÊûú
            addSwipeEffects(statsGrid);
            addSwipeEffects(memberStatsGrid);
            
            // ÂàùÂßãÂåñÁ∏ΩÊîØÂá∫Áµ±Ë®àÊªëÂãï
            if (statsGrid) {
                initializeStatsSwipe();
            }
            
            // Áõ£ËÅΩÁ™óÂè£Â§ßÂ∞èËÆäÂåñ
            window.addEventListener('resize', function() {
                checkScrollable(statsGrid, statsIndicator);
                checkScrollable(memberStatsGrid, memberIndicator);
            });
            
            // Áõ£ËÅΩÂÖßÂÆπËÆäÂåñ
            const observer = new MutationObserver(function() {
                checkScrollable(statsGrid, statsIndicator);
                checkScrollable(memberStatsGrid, memberIndicator);
            });
            
            if (statsGrid) observer.observe(statsGrid, { childList: true, subtree: true });
            if (memberStatsGrid) observer.observe(memberStatsGrid, { childList: true, subtree: true });
        }
        
        // ÂàùÂßãÂåñÁ∏ΩÊîØÂá∫Áµ±Ë®àÊªëÂãïÂäüËÉΩ
        function initializeStatsSwipe() {
            const statsGrid = document.querySelector('.stats');
            
            if (!statsGrid) return;
            
            let currentIndex = 1; // È†êË®≠È°ØÁ§∫‰∏≠ÈñìÁöÑÂç°ÁâáÔºàÁ¨¨‰∫åÂÄã‰ΩçÁΩÆÔºâ
            
            // ÊªëÂãïÂà∞ÊåáÂÆö‰ΩçÁΩÆ
            function scrollToStats(index) {
                const cardWidth = 200; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                statsGrid.scrollTo({
                    left: index * cardWidth,
                    behavior: 'smooth'
                });
                currentIndex = index;
            }
            
            // ÂàùÂßãÂåñÊôÇÊªëÂãïÂà∞‰∏≠Èñì‰ΩçÁΩÆ
            setTimeout(() => {
                scrollToStats(1);
            }, 200);
            
            // Áõ£ËÅΩÊªëÂãï‰∫ã‰ª∂
            statsGrid.addEventListener('scroll', () => {
                const cardWidth = 200; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                const scrollLeft = statsGrid.scrollLeft;
                const newIndex = Math.round(scrollLeft / cardWidth);
                
                if (newIndex !== currentIndex && newIndex >= 0 && newIndex < 4) {
                    currentIndex = newIndex;
                }
            });
            
            // Ê∑ªÂä†Ëß∏ÊéßÊªëÂãïÊîØÊåÅ
            let startX = 0;
            let isScrolling = false;
            
            statsGrid.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isScrolling = false;
            });
            
            statsGrid.addEventListener('touchmove', (e) => {
                if (!isScrolling) {
                    const currentX = e.touches[0].clientX;
                    const diffX = Math.abs(currentX - startX);
                    
                    if (diffX > 10) {
                        isScrolling = true;
                    }
                }
            });
            
            statsGrid.addEventListener('touchend', () => {
                if (isScrolling) {
                    const cardWidth = 200; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                    const scrollLeft = statsGrid.scrollLeft;
                    const newIndex = Math.round(scrollLeft / cardWidth);
                    
                    if (newIndex !== currentIndex && newIndex >= 0 && newIndex < 4) {
                        currentIndex = newIndex;
                    }
                }
            });
        }

        // Èò≤Ê≠¢ÈÅéÂ∫¶ÊªæÂãïÁöÑÂáΩÊï∏
        function preventOverScroll() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            container.addEventListener('scroll', function() {
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                // Èò≤Ê≠¢Âêë‰∏äÈÅéÂ∫¶ÊªæÂãï
                if (scrollTop <= 0) {
                    container.scrollTop = 0;
                }
                
                // Èò≤Ê≠¢Âêë‰∏ãÈÅéÂ∫¶ÊªæÂãï
                if (scrollTop + clientHeight >= scrollHeight) {
                    container.scrollTop = scrollHeight - clientHeight;
                }
            });
            
            // Èò≤Ê≠¢Ëß∏ÊéßÈÅéÂ∫¶ÊªæÂãï
            container.addEventListener('touchstart', function(e) {
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                // Â¶ÇÊûúÂ∑≤Á∂ìÂú®È†ÇÈÉ®ÔºåÈòªÊ≠¢Âêë‰∏äÊªëÂãï
                if (scrollTop <= 0 && e.touches[0].clientY > e.touches[0].clientY) {
                    e.preventDefault();
                }
                
                // Â¶ÇÊûúÂ∑≤Á∂ìÂú®Â∫ïÈÉ®ÔºåÈòªÊ≠¢Âêë‰∏ãÊªëÂãï
                if (scrollTop + clientHeight >= scrollHeight && e.touches[0].clientY < e.touches[0].clientY) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Excel ÂåØÂÖ•ÂäüËÉΩ
        let currentCompareData = null;
        // currentExcelImportData Â∑≤ÁßªÈô§ - ‰ΩøÁî®Áµ±‰∏ÄÁöÑ currentCompareData

        // ÂàùÂßãÂåñÊ™îÊ°à‰∏äÂÇ≥ÂäüËÉΩ
        function initExcelUpload() {
            const fileInput = document.getElementById('excelFileInput');
            const uploadArea = document.getElementById('uploadArea');
            const uploadDescription = document.getElementById('uploadDescription');

            // Ê†ºÂºèÈÅ∏Êìá‰∫ã‰ª∂Â∑≤ÁßªÈô§ - Âè™ÊîØÊè¥ExcelÊ†ºÂºè

            // Ê™îÊ°àÈÅ∏Êìá‰∫ã‰ª∂
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], 'excel');
                }
            });

            // ÊãñÊãΩÂäüËÉΩ
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0], 'excel');
                }
            });

            // ÈªûÊìä‰∏äÂÇ≥ÂçÄÂüü
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        // ËôïÁêÜÊ™îÊ°à‰∏äÂÇ≥
        async function handleFileUpload(file, format = 'excel') {
            console.log('üìÅ ÈñãÂßãËôïÁêÜÊ™îÊ°à‰∏äÂÇ≥:', file.name);
            console.log('üìÅ Ê™îÊ°àÂ§ßÂ∞è:', file.size, 'bytes');
            console.log('üìÅ Ê™îÊ°àÈ°ûÂûã:', file.type);
            console.log('üìÅ ÂåØÂÖ•Ê†ºÂºè:', format);
            console.log('üìÅ API Âú∞ÂùÄ:', ENV_CONFIG.getApiBase() + '/api/excel/compare');
            
            // È©óË≠âÊ™îÊ°àÈ°ûÂûã
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert(`‚ùå Ë´ãÈÅ∏Êìá Excel Ê™îÊ°à (.xlsx Êàñ .xls)`);
                return;
            }

            // È©óË≠âÊ™îÊ°àÂ§ßÂ∞è
            if (file.size > 10 * 1024 * 1024) {
                alert('‚ùå Ê™îÊ°àÂ§ßÂ∞è‰∏çËÉΩË∂ÖÈÅé 10MB');
                return;
            }

            const formData = new FormData();
            formData.append('excelFile', file);
            formData.append('format', format); // Ê∑ªÂä†Ê†ºÂºèÂèÉÊï∏

            try {
                console.log('üì° ÈñãÂßãÁôºÈÄÅË´ãÊ±ÇÂà∞:', ENV_CONFIG.getApiBase() + '/api/excel/compare');
                console.log('üì° FormData ÂÖßÂÆπ:', formData);
                console.log('üì° ÂåØÂÖ•Ê†ºÂºè:', format);
                
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/excel/compare', {
                    method: 'POST',
                    body: formData
                });

                console.log('üì° Êî∂Âà∞ÂõûÊáâÁãÄÊÖã:', response.status);
                console.log('üì° Êî∂Âà∞ÂõûÊáâÊ®ôÈ†≠:', response.headers);
                
                const result = await response.json();
                console.log('üì° Êî∂Âà∞ÂõûÊáâÂÖßÂÆπ:', result);
                
                if (result.success) {
                    console.log('‚úÖ Excel ÊØîÂ∞çÊàêÂäü:', result.data);
                    displayCompareResult(result.data);
                } else {
                    console.error('‚ùå Excel ÊØîÂ∞çÂ§±Êïó:', result.message);
                    alert('‚ùå Excel ÊØîÂ∞çÂ§±Êïó: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå ‰∏äÂÇ≥Â§±Êïó:', error);
                alert('‚ùå ‰∏äÂÇ≥Â§±Êïó: ' + error.message);
            }
        }

        // È°ØÁ§∫ÊØîÂ∞çÁµêÊûú
        function displayCompareResult(data) {
            currentCompareData = data;
            
            // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
            document.getElementById('totalExcelRecords').textContent = data.totalExcelRecords;
            document.getElementById('systemRecords').textContent = data.systemRecords;
            document.getElementById('newRecords').textContent = data.newRecords;
            document.getElementById('duplicateRecords').textContent = data.duplicateRecords;
            
            // È°ØÁ§∫ÊØîÂ∞çÁµêÊûú
            document.getElementById('compareResult').style.display = 'block';
            
            // ÂïüÁî®/Á¶ÅÁî®ÂåØÂÖ•ÊåâÈàï
            const importBtn = document.getElementById('importBtn');
            const importAllBtn = document.getElementById('importAllBtn');
            
            if (data.newRecords > 0) {
                // ÊúâÊñ∞Ë®òÈåÑÊôÇÔºåÈ°ØÁ§∫ÂÖ©ÂÄãÊåâÈàï
                importBtn.disabled = false;
                importBtn.textContent = `üì• ÂåØÂÖ• ${data.newRecords} Á≠ÜÊñ∞Ë®òÈåÑ`;
                importBtn.onclick = () => importAllNewRecords(data.newRecordsData);
                
                if (data.duplicateRecords > 0) {
                    // ‰πüÊúâÈáçË§áË®òÈåÑÊôÇÔºåÈ°ØÁ§∫ÂåØÂÖ•ÂÖ®ÈÉ®ÊåâÈàï
                    importAllBtn.style.display = 'inline-block';
                    importAllBtn.textContent = `üì• ÂåØÂÖ•ÂÖ®ÈÉ® ${data.newRecords + data.duplicateRecords} Á≠ÜË®òÈåÑ`;
                    importAllBtn.onclick = () => {
                        const allRecords = [...data.newRecordsData, ...data.duplicateRecordsData];
                        importAllRecords(allRecords);
                    };
                } else {
                    importAllBtn.style.display = 'none';
                }
            } else if (data.duplicateRecords > 0) {
                // Âè™ÊúâÈáçË§áË®òÈåÑÊôÇÔºåÂè™È°ØÁ§∫ÂåØÂÖ•ÈáçË§áË®òÈåÑÊåâÈàï
                importBtn.disabled = false;
                importBtn.textContent = `üì• ÂåØÂÖ• ${data.duplicateRecords} Á≠ÜÈáçË§áË®òÈåÑ`;
                importBtn.onclick = () => importAllRecords(data.duplicateRecordsData);
                importAllBtn.style.display = 'none';
            } else {
                // Ê≤íÊúâË®òÈåÑÊôÇÔºåÁ¶ÅÁî®ÊåâÈàï
                importBtn.disabled = true;
                importBtn.textContent = 'üì• ÈÅ∏ÊìáÂåØÂÖ•Ë®òÈåÑ';
                importAllBtn.style.display = 'none';
            }
            
            // È°ØÁ§∫Ë®òÈåÑÈ†êË¶Ω
            displayRecordsPreview(data.newRecordsData, 'newRecordsPreview', 'newRecordsList');
            displayRecordsPreview(data.duplicateRecordsData, 'duplicateRecordsPreview', 'duplicateRecordsList');
        }

        // È°ØÁ§∫Ë®òÈåÑÈ†êË¶Ω
        function displayRecordsPreview(records, previewId, listId) {
            const previewElement = document.getElementById(previewId);
            const listElement = document.getElementById(listId);
            
            if (records.length > 0) {
                listElement.style.display = 'block';
                
                previewElement.innerHTML = records.slice(0, 10).map(record => `
                    <div class="record-item">
                        <div class="record-info">
                            <div class="record-date">${record.date || 'N/A'}</div>
                            <div class="record-details">
                                ${record.member || 'N/A'} - ${record.description || 'N/A'} - $${record.amount || 'N/A'}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (records.length > 10) {
                    previewElement.innerHTML += `<div class="record-item"><div class="record-info">... ÈÇÑÊúâ ${records.length - 10} Á≠ÜË®òÈåÑ</div></div>`;
                }
            } else {
                listElement.style.display = 'none';
            }
        }

        // È°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
        function showImportSelection() {
            console.log('üîç [DEBUG] showImportSelection Ë¢´Ë™øÁî®');
            console.log('üîç [DEBUG] currentCompareData:', currentCompareData);
            
            if (!currentCompareData || currentCompareData.newRecords === 0) {
                console.log('‚ùå [DEBUG] Ê≤íÊúâÂèØÂåØÂÖ•ÁöÑÊñ∞Ë®òÈåÑ');
                alert('‚ùå Ê≤íÊúâÂèØÂåØÂÖ•ÁöÑÊñ∞Ë®òÈåÑ');
                return;
            }

            console.log('üîç [DEBUG] Ê∫ñÂÇôÈ°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢');
            
            // Èö±ËóèÊØîÂ∞çÁµêÊûú
            const compareResult = document.getElementById('compareResult');
            if (compareResult) {
                compareResult.style.display = 'none';
                console.log('‚úÖ [DEBUG] Â∑≤Èö±ËóèÊØîÂ∞çÁµêÊûú');
            } else {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ compareResult ÂÖÉÁ¥†');
            }
            
            // È°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
            const importSelection = document.getElementById('importSelection');
            if (importSelection) {
                importSelection.style.display = 'block';
                console.log('‚úÖ [DEBUG] Â∑≤È°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢');
            } else {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ importSelection ÂÖÉÁ¥†');
            }
            
            // ÁîüÊàêË®òÈåÑÈÅ∏ÊìáÊ∏ÖÂñÆ
            console.log('üîç [DEBUG] Ê∫ñÂÇôÁîüÊàêË®òÈåÑÊ∏ÖÂñÆÔºåË®òÈåÑÊï∏:', currentCompareData.newRecordsData ? currentCompareData.newRecordsData.length : 'undefined');
            generateRecordsSelectionList(currentCompareData.newRecordsData);
        }

        // ÁîüÊàêË®òÈåÑÈÅ∏ÊìáÊ∏ÖÂñÆ
        function generateRecordsSelectionList(records) {
            console.log('üîç [DEBUG] generateRecordsSelectionList Ë¢´Ë™øÁî®');
            console.log('üîç [DEBUG] records:', records);
            
            const listContainer = document.getElementById('recordsSelectionList');
            if (!listContainer) {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ recordsSelectionList ÂÖÉÁ¥†');
                return;
            }
            
            console.log('‚úÖ [DEBUG] ÊâæÂà∞ recordsSelectionList ÂÖÉÁ¥†');
            listContainer.innerHTML = '';
            
            if (!records || !Array.isArray(records)) {
                console.error('‚ùå [DEBUG] records ‰∏çÊòØÊúâÊïàÊï∏ÁµÑ:', records);
                return;
            }
            
            // Âêà‰ΩµÊâÄÊúâË®òÈåÑÔºàÊñ∞Ë®òÈåÑ + ÈáçË§áË®òÈåÑÔºâ
            const allRecords = [];
            
            // Ê∑ªÂä†Êñ∞Ë®òÈåÑ
            if (currentCompareData.newRecordsData) {
                allRecords.push(...currentCompareData.newRecordsData.map(record => ({
                    ...record,
                    isNew: true
                })));
            }
            
            // Ê∑ªÂä†ÈáçË§áË®òÈåÑ
            if (currentCompareData.duplicateRecordsData) {
                allRecords.push(...currentCompareData.duplicateRecordsData.map(record => ({
                    ...record,
                    isNew: false
                })));
            }
            
            console.log('üîç [DEBUG] Âêà‰ΩµÂæåÁ∏ΩË®òÈåÑÊï∏:', allRecords.length);
            
            // ÊåâÊó•ÊúüÂæûÊñ∞Âà∞ËàäÊéíÂ∫è
            allRecords.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Êñ∞Âà∞Ëàä
            });
            
            console.log('üîç [DEBUG] ÊéíÂ∫èÂÆåÊàêÔºåÈñãÂßãÁîüÊàêË®òÈåÑÊ∏ÖÂñÆ');
            
            allRecords.forEach((record, index) => {
                console.log(`üîç [DEBUG] ËôïÁêÜË®òÈåÑ ${index}:`, record);
                
                const item = document.createElement('div');
                item.className = 'record-selection-item';
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÈáçË§áË≥áÊñô
                const duplicateInfo = checkForDuplicateRecord(record);
                const duplicateNote = duplicateInfo ? 
                    `<div class="duplicate-note">‚ö†Ô∏è ÂèØËÉΩËàáÁ≥ªÁµ±‰∏≠ÁèæÊúâË®òÈåÑÈáçË§á</div>` : '';
                
                // Ê∑ªÂä†Ë®òÈåÑÈ°ûÂûãÊ®ôË®ò
                const recordTypeNote = record.isNew ? 
                    `<div class="record-type-note new">üÜï Êñ∞Ë®òÈåÑ</div>` : 
                    `<div class="record-type-note duplicate">üîÑ ÈáçË§áË®òÈåÑ</div>`;
                
                item.innerHTML = `
                    <input type="checkbox" id="record_${index}" value="${index}" onchange="updateSelectedCount()" checked>
                    <div class="record-info">
                        <span class="label">ÊàêÂì°:</span>
                        <span class="value">${record.member}</span>
                        <span class="label">Êó•Êúü:</span>
                        <span class="value">${record.date}</span>
                        <span class="label">ÈáëÈ°ç:</span>
                        <span class="value">$${record.amount}</span>
                        <span class="label">È°ûÂà•:</span>
                        <span class="value">${record.mainCategory}</span>
                        <span class="label">ÊèèËø∞:</span>
                        <span class="value">${record.description}</span>
                    </div>
                    ${recordTypeNote}
                    ${duplicateNote}
                `;
                listContainer.appendChild(item);
                console.log(`‚úÖ [DEBUG] Â∑≤Ê∑ªÂä†Ë®òÈåÑ ${index} Âà∞Ê∏ÖÂñÆ`);
            });
            
            console.log('‚úÖ [DEBUG] ÊâÄÊúâË®òÈåÑÂ∑≤Ê∑ªÂä†Âà∞Ê∏ÖÂñÆÔºåÈñãÂßãÂàùÂßãÂåñÈÅ∏ÊìáË®àÊï∏');
            // ÂàùÂßãÂåñÈÅ∏ÊìáË®àÊï∏
            updateSelectedCount();
        }

        // Ê™¢Êü•Ë®òÈåÑÊòØÂê¶ÂèØËÉΩÈáçË§á
        function checkForDuplicateRecord(excelRecord) {
            // ‰ΩøÁî®Á∞°ÂåñÁöÑÊØîÂ∞çÈÇèËºØÊ™¢Êü•ÊòØÂê¶ÊúâÁõ∏‰ººÁöÑË®òÈåÑ
            return records.some(systemRecord => {
                if (!systemRecord) return false;
                
                // ÊØîËºÉÊ†∏ÂøÉÊ¨Ñ‰Ωç
                const memberMatch = systemRecord.member === excelRecord.member;
                const dateMatch = systemRecord.date === excelRecord.date;
                const amountMatch = Math.abs(systemRecord.amount) === Math.abs(excelRecord.amount);
                
                // Â¶ÇÊûúÊàêÂì°„ÄÅÊó•Êúü„ÄÅÈáëÈ°çÈÉΩÂåπÈÖçÔºåÂèØËÉΩÊòØÈáçË§áË®òÈåÑ
                return memberMatch && dateMatch && amountMatch;
            });
        }

        // Êõ¥Êñ∞ÈÅ∏ÊìáË®àÊï∏
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]');
            const checkedBoxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]:checked');
            const count = checkedBoxes.length;
            
            document.getElementById('selectedCount').textContent = `Â∑≤ÈÅ∏Êìá ${count} Á≠ÜË®òÈåÑ`;
            document.getElementById('confirmImportBtn').disabled = count === 0;
        }

        // ÂÖ®ÈÅ∏Ë®òÈåÑ
        function selectAllRecords() {
            const checkboxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }

        // ÂÖ®‰∏çÈÅ∏Ë®òÈåÑ
        function deselectAllRecords() {
            const checkboxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }

        // Âè™ÈÅ∏Êñ∞Ë®òÈåÑ
        function selectNewRecordsOnly() {
            const checkboxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                // ÊâæÂà∞Â∞çÊáâÁöÑË®òÈåÑÈ°ûÂûãÊ®ôË®ò
                const recordItem = checkbox.closest('.record-selection-item');
                const typeNote = recordItem.querySelector('.record-type-note.new');
                checkbox.checked = typeNote !== null; // Âè™ÊúâÊñ∞Ë®òÈåÑÊâçÈÅ∏‰∏≠
            });
            updateSelectedCount();
        }

        // ÂåØÂÖ•ÊâÄÊúâË®òÈåÑÔºàÂåÖÊã¨ÈáçË§áË®òÈåÑÔºâ
        async function importAllRecords(allRecordsData) {
            console.log('üì• ÈñãÂßãÂåØÂÖ•ÊâÄÊúâË®òÈåÑ:', allRecordsData.length, 'Á≠Ü');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // ÈÄêÁ≠ÜÊ∑ªÂä†Âà∞JSONÊñá‰ª∂
                for (const record of allRecordsData) {
                    try {
                        // ÁÇ∫ÊØèÁ≠ÜË®òÈåÑÁîüÊàêÊñ∞ÁöÑÂîØ‰∏ÄIDÔºåÈÅøÂÖçÈáçË§á
                        const newRecord = {
                            ...record,
                            id: generateUniqueId()
                        };
                        
                        const addResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(newRecord)
                        });
                        
                        const addResult = await addResponse.json();
                        
                        if (addResult.success) {
                            successCount++;
                            console.log('‚úÖ Ë®òÈåÑÂ∑≤Ê∑ªÂä†:', newRecord.id);
                        } else {
                            errorCount++;
                            errors.push(`Ë®òÈåÑ ${newRecord.id}: ${addResult.message}`);
                            console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†Â§±Êïó:', newRecord.id, addResult.message);
                        }
                    } catch (recordError) {
                        errorCount++;
                        errors.push(`Ë®òÈåÑ ${record.id}: ${recordError.message}`);
                        console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†ÈåØË™§:', record.id, recordError.message);
                    }
                }
                
                if (successCount > 0) {
                    console.log(`‚úÖ ÊàêÂäüÂåØÂÖ• ${successCount} Á≠ÜË®òÈåÑÂà∞JSONÊñá‰ª∂`);
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                    await loadDataFromFile();
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                    updateAllDisplays();
                    
                    // Ê∏ÖÈô§ÊØîÂ∞çÁµêÊûú
                    clearCompareResult();
                    
                    if (errorCount > 0) {
                        // È°ØÁ§∫Ë©≥Á¥∞ÁöÑÂåØÂÖ•ÁµêÊûú
                        const resultMessage = `üìä ÂåØÂÖ•ÁµêÊûúÁµ±Ë®àÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                        alert(resultMessage);
                    } else {
                        alert(`‚úÖ ÂåØÂÖ•ÂÆåÊàêÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö0 Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    console.error('‚ùå ÊâÄÊúâË®òÈåÑÂåØÂÖ•Â§±Êïó');
                    const failMessage = `‚ùå ÂåØÂÖ•Â§±ÊïóÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                    alert(failMessage);
                }
            } catch (error) {
                console.error('‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', error);
                alert(`‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö${error.message}\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${allRecordsData.length} Á≠ÜË®òÈåÑ`);
            }
        }

        // Áõ¥Êé•ÂåØÂÖ•ÊâÄÊúâÊñ∞Ë®òÈåÑ
        async function importAllNewRecords(newRecordsData) {
            console.log('üì• ÈñãÂßãÁõ¥Êé•ÂåØÂÖ•ÊâÄÊúâÊñ∞Ë®òÈåÑ:', newRecordsData.length, 'Á≠Ü');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // ÈÄêÁ≠ÜÊ∑ªÂä†Âà∞JSONÊñá‰ª∂
                for (const record of newRecordsData) {
                    try {
                        console.log('üì§ Ê∫ñÂÇôÊ∑ªÂä†Ë®òÈåÑ:', record);
                        
                        const addResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(record)
                        });
                        
                        console.log('üì° APIÂõûÊáâÁãÄÊÖã:', addResponse.status);
                        console.log('üì° APIÂõûÊáâÊ®ôÈ†≠:', addResponse.headers);
                        
                        const addResult = await addResponse.json();
                        console.log('üì° APIÂõûÊáâÂÖßÂÆπ:', addResult);
                        
                        if (addResult.success) {
                            successCount++;
                            console.log('‚úÖ Ë®òÈåÑÂ∑≤Ê∑ªÂä†:', record.id);
                        } else {
                            errorCount++;
                            errors.push(`Ë®òÈåÑ ${record.id}: ${addResult.message}`);
                            console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†Â§±Êïó:', record.id, addResult.message);
                        }
                    } catch (recordError) {
                        errorCount++;
                        errors.push(`Ë®òÈåÑ ${record.id}: ${recordError.message}`);
                        console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†ÈåØË™§:', record.id, recordError.message);
                        console.error('‚ùå ÈåØË™§Â†ÜÁñä:', recordError.stack);
                    }
                }
                
                if (successCount > 0) {
                    console.log(`‚úÖ ÊàêÂäüÂåØÂÖ• ${successCount} Á≠ÜË®òÈåÑÂà∞JSONÊñá‰ª∂`);
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                    await loadDataFromFile();
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                    updateAllDisplays();
                    
                    // Ê∏ÖÈô§ÊØîÂ∞çÁµêÊûú
                    clearCompareResult();
                    
                    if (errorCount > 0) {
                        // È°ØÁ§∫Ë©≥Á¥∞ÁöÑÂåØÂÖ•ÁµêÊûú
                        const resultMessage = `üìä ÂåØÂÖ•ÁµêÊûúÁµ±Ë®àÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${newRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                        alert(resultMessage);
                    } else {
                        alert(`‚úÖ ÂåØÂÖ•ÂÆåÊàêÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${newRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö0 Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    console.error('‚ùå ÊâÄÊúâË®òÈåÑÂåØÂÖ•Â§±Êïó');
                    const failMessage = `‚ùå ÂåØÂÖ•Â§±ÊïóÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${newRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                    alert(failMessage);
                }
            } catch (error) {
                console.error('‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', error);
                alert(`‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö${error.message}\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${newRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${newRecordsData.length} Á≠ÜË®òÈåÑ`);
            }
        }

        // Á¢∫Ë™çÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑË®òÈåÑ
        async function confirmSelectedImport() {
            const checkedBoxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                alert('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÁ≠ÜË®òÈåÑ');
                return;
            }

            if (!confirm(`Á¢∫ÂÆöË¶ÅÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑ ${checkedBoxes.length} Á≠ÜË®òÈåÑÂóéÔºü`)) {
                return;
            }

            // Êî∂ÈõÜÈÅ∏‰∏≠ÁöÑË®òÈåÑ
            const selectedRecords = [];
            checkedBoxes.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                selectedRecords.push(currentCompareData.newRecordsData[index]);
            });

            try {
                console.log('üì• ÈñãÂßãÂêëJSONÊñá‰ª∂ÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑË®òÈåÑ...');
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // ÈÄêÁ≠ÜÊ∑ªÂä†Âà∞JSONÊñá‰ª∂
                for (const record of selectedRecords) {
                    try {
                        const addResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(record)
                        });
                        
                        const addResult = await addResponse.json();
                        
                        if (addResult.success) {
                            successCount++;
                            console.log('‚úÖ Ë®òÈåÑÂ∑≤Ê∑ªÂä†:', record.id);
                        } else {
                            errorCount++;
                            errors.push(`Ë®òÈåÑ ${record.id}: ${addResult.message}`);
                            console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†Â§±Êïó:', record.id, addResult.message);
                        }
                    } catch (recordError) {
                        errorCount++;
                        errors.push(`Ë®òÈåÑ ${record.id}: ${recordError.message}`);
                        console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†ÈåØË™§:', record.id, recordError.message);
                    }
                }
                
                if (successCount > 0) {
                    console.log(`‚úÖ ÊàêÂäüÂåØÂÖ• ${successCount} Á≠ÜË®òÈåÑÂà∞JSONÊñá‰ª∂`);
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                    await loadDataFromFile();
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                    updateAllDisplays();
                    
                    // Ëá™ÂãïÊèê‰∫§Âà∞GitÔºà‰∏çÊõ¥Êñ∞ÁâàÊú¨ËôüÔºâ - Â∑≤ÁßªÈô§
                    
                    // Ê∏ÖÈô§ÊâÄÊúâÁµêÊûú
                    clearCompareResult();
                    hideImportSelection();
                    
                    if (errorCount > 0) {
                        // È°ØÁ§∫Ë©≥Á¥∞ÁöÑÂåØÂÖ•ÁµêÊûú
                        const resultMessage = `üìä ÂåØÂÖ•ÁµêÊûúÁµ±Ë®àÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                        alert(resultMessage);
                    } else {
                        alert(`‚úÖ ÂåØÂÖ•ÂÆåÊàêÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö0 Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    console.error('‚ùå ÊâÄÊúâË®òÈåÑÂåØÂÖ•Â§±Êïó');
                    const failMessage = `‚ùå ÂåØÂÖ•Â§±ÊïóÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                    alert(failMessage);
                }
            } catch (error) {
                console.error('‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', error);
                alert(`‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö${error.message}\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${allRecordsData.length} Á≠ÜË®òÈåÑ`);
            }
        }

        // Èö±ËóèÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
        function hideImportSelection() {
            document.getElementById('importSelection').style.display = 'none';
            document.getElementById('compareResult').style.display = 'block';
        }

        // ÂèñÊ∂àÂåØÂÖ•ÈÅ∏Êìá
        function cancelImportSelection() {
            hideImportSelection();
        }

        // Ê∏ÖÈô§ÈÅ∏Êìá
        function clearSelection() {
            const checkboxes = document.querySelectorAll('#recordsSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }

        // Ëá™ÂãïÊèê‰∫§Âà∞GitÔºàÂåÖÂê´ÁâàÊú¨ËôüÊõ¥Êñ∞Ôºâ - Â∑≤ÁßªÈô§

        // Êèê‰∫§Âà∞GitÔºà‰∏çÊõ¥Êñ∞ÁâàÊú¨ËôüÔºâ - Â∑≤ÁßªÈô§

        // Êõ¥Êñ∞ÁâàÊú¨Ëôü
        async function updateVersionNumber() {
            try {
                console.log('üîÑ ÈñãÂßãÊõ¥Êñ∞ÁâàÊú¨Ëôü...');
                
                // Ë™øÁî®ÂæåÁ´ØAPIÊõ¥Êñ∞ÁâàÊú¨Ëôü
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/version/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        commitHash: 'auto-update',
                        description: "ExcelÂåØÂÖ•ÂæåËá™ÂãïÊõ¥Êñ∞ÁâàÊú¨Ëôü"
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ ÁâàÊú¨ËôüÊõ¥Êñ∞ÊàêÂäü:', result.data.version);
                    
                    // Êõ¥Êñ∞ÂâçÁ´ØÈ°ØÁ§∫ÁöÑÁâàÊú¨Ëôü
                    updateVersionDisplay(result.data.version);
                    
                    return result.data.version;
                } else {
                    console.error('‚ùå ÁâàÊú¨ËôüÊõ¥Êñ∞Â§±Êïó:', result.message);
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('‚ùå ÁâàÊú¨ËôüÊõ¥Êñ∞Â§±Êïó:', error);
                throw error;
            }
        }

        // Êõ¥Êñ∞ÁâàÊú¨ËôüÈ°ØÁ§∫
        function updateVersionDisplay(versionString) {
            const versionElements = document.querySelectorAll('.version-info');
            versionElements.forEach(element => {
                if (element.textContent.includes('ÁâàÊú¨')) {
                    element.textContent = element.textContent.replace(/ÁâàÊú¨: [^\s]+/, `ÁâàÊú¨: ${versionString}`);
                }
            });
        }

        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'info') {
            // ÂâµÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Ê∑ªÂä†Ê®£Âºè
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Ê†πÊìöÈ°ûÂûãË®≠ÁΩÆÈ°èËâ≤
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ffc107';
                    notification.style.color = '#000';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                default:
                    notification.style.backgroundColor = '#007bff';
            }
            
            // Ê∑ªÂä†Âà∞È†ÅÈù¢
            document.body.appendChild(notification);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Ê∏ÖÈô§ÊØîÂ∞çÁµêÊûú
        function clearCompareResult() {
            document.getElementById('compareResult').style.display = 'none';
            document.getElementById('importSelection').style.display = 'none';
            document.getElementById('excelFileInput').value = '';
            currentCompareData = null;
        }

        // ==================== Êñ∞ÁöÑ Excel ÂåØÂÖ•ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞Êï∏ÊìöÂåØÂÖ•ÂçÄÂ°ä ====================
        
        // ÂàùÂßãÂåñÊñ∞ÁöÑ Excel ÂåØÂÖ•ÂäüËÉΩ
        function initExcelImportUpload() {
            const fileInput = document.getElementById('excelImportFileInput');
            const uploadArea = document.getElementById('excelImportUploadArea');

            // Ê™îÊ°àÈÅ∏Êìá‰∫ã‰ª∂
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleExcelImportUpload(e.target.files[0]);
                }
            });

            // ÊãñÊãΩÂäüËÉΩ
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleExcelImportUpload(files[0]);
                }
            });

            // ÈªûÊìä‰∏äÂÇ≥ÂçÄÂüü
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        // ËôïÁêÜÊñ∞ÁöÑ Excel ÂåØÂÖ•Ê™îÊ°à‰∏äÂÇ≥
        async function handleExcelImportUpload(file) {
            console.log('üìÅ ÈñãÂßãËôïÁêÜ Excel ÂåØÂÖ•Ê™îÊ°à‰∏äÂÇ≥:', file.name);
            console.log('üìÅ Ê™îÊ°àÂ§ßÂ∞è:', file.size, 'bytes');
            console.log('üìÅ Ê™îÊ°àÈ°ûÂûã:', file.type);
            console.log('üìÅ API Âú∞ÂùÄ:', ENV_CONFIG.getApiBase() + '/api/excel/compare');
            
            // È©óË≠âÊ™îÊ°àÈ°ûÂûã
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('‚ùå Ë´ãÈÅ∏Êìá Excel Ê™îÊ°à (.xlsx Êàñ .xls)');
                return;
            }

            // È©óË≠âÊ™îÊ°àÂ§ßÂ∞è
            if (file.size > 10 * 1024 * 1024) {
                alert('‚ùå Ê™îÊ°àÂ§ßÂ∞è‰∏çËÉΩË∂ÖÈÅé 10MB');
                return;
            }

            const formData = new FormData();
            formData.append('excelFile', file);

            try {
                console.log('üì° ÈñãÂßãÁôºÈÄÅË´ãÊ±ÇÂà∞:', ENV_CONFIG.getApiBase() + '/api/excel/compare');
                console.log('üì° FormData ÂÖßÂÆπ:', formData);
                
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/excel/compare', {
                    method: 'POST',
                    body: formData
                });

                console.log('üì° Êî∂Âà∞ÂõûÊáâÁãÄÊÖã:', response.status);
                console.log('üì° Êî∂Âà∞ÂõûÊáâÊ®ôÈ†≠:', response.headers);
                
                const result = await response.json();
                console.log('üì° Êî∂Âà∞ÂõûÊáâÂÖßÂÆπ:', result);
                
                if (result.success) {
                    console.log('‚úÖ Excel ÊØîÂ∞çÊàêÂäü:', result.data);
                    displayExcelImportCompareResult(result.data);
                } else {
                    console.error('‚ùå Excel ÊØîÂ∞çÂ§±Êïó:', result.message);
                    alert('‚ùå Excel ÊØîÂ∞çÂ§±Êïó: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå ‰∏äÂÇ≥Â§±Êïó:', error);
                alert('‚ùå ‰∏äÂÇ≥Â§±Êïó: ' + error.message);
            }
        }

        // È°ØÁ§∫Êñ∞ÁöÑ Excel ÂåØÂÖ•ÊØîÂ∞çÁµêÊûú
        function displayExcelImportCompareResult(data) {
            currentExcelImportData = data;
            
            // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
            document.getElementById('excelImportTotalRecords').textContent = data.totalExcelRecords;
            document.getElementById('excelImportSystemRecords').textContent = data.systemRecords;
            document.getElementById('excelImportNewRecords').textContent = data.newRecords;
            document.getElementById('excelImportDuplicateRecords').textContent = data.duplicateRecords;
            
            // È°ØÁ§∫ÊØîÂ∞çÁµêÊûú
            document.getElementById('excelImportCompareResult').style.display = 'block';
            
            // ÂïüÁî®/Á¶ÅÁî®ÂåØÂÖ•ÊåâÈàï
            const importBtn = document.getElementById('excelImportBtn');
            if (data.newRecords > 0) {
                importBtn.disabled = false;
                importBtn.textContent = `üì• ÈÅ∏ÊìáÂåØÂÖ• ${data.newRecords} Á≠ÜË®òÈåÑ`;
            } else {
                importBtn.disabled = true;
                importBtn.textContent = 'üì• ÈÅ∏ÊìáÂåØÂÖ•Ë®òÈåÑ';
            }
            
            // È°ØÁ§∫Êñ∞Ë®òÈåÑÈ†êË¶Ω
            if (data.newRecordsData && data.newRecordsData.length > 0) {
                const preview = document.getElementById('excelImportNewRecordsPreview');
                preview.innerHTML = data.newRecordsData.slice(0, 5).map(record => 
                    `<div class="record-preview-item">
                        <span class="record-date">${record.date}</span>
                        <span class="record-member">${record.member}</span>
                        <span class="record-description">${record.description || record.mainCategory}</span>
                        <span class="record-amount">$${record.amount}</span>
                    </div>`
                ).join('');
                document.getElementById('excelImportNewRecordsList').style.display = 'block';
            }
            
            // È°ØÁ§∫ÈáçË§áË®òÈåÑÈ†êË¶Ω
            if (data.duplicateRecordsData && data.duplicateRecordsData.length > 0) {
                const preview = document.getElementById('excelImportDuplicateRecordsPreview');
                preview.innerHTML = data.duplicateRecordsData.slice(0, 5).map(record => 
                    `<div class="record-preview-item">
                        <span class="record-date">${record.date}</span>
                        <span class="record-member">${record.member}</span>
                        <span class="record-description">${record.description || record.mainCategory}</span>
                        <span class="record-amount">$${record.amount}</span>
                    </div>`
                ).join('');
                document.getElementById('excelImportDuplicateRecordsList').style.display = 'block';
            }
        }

        // È°ØÁ§∫Êñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
        function showExcelImportSelection() {
            console.log('üîç [DEBUG] showExcelImportSelection Ë¢´Ë™øÁî®');
            console.log('üîç [DEBUG] currentExcelImportData:', currentExcelImportData);
            
            if (!currentExcelImportData || currentExcelImportData.newRecords === 0) {
                console.log('‚ùå [DEBUG] Ê≤íÊúâÂèØÂåØÂÖ•ÁöÑÊñ∞Ë®òÈåÑ');
                alert('‚ùå Ê≤íÊúâÂèØÂåØÂÖ•ÁöÑÊñ∞Ë®òÈåÑ');
                return;
            }

            console.log('üîç [DEBUG] Ê∫ñÂÇôÈ°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢');
            
            // Èö±ËóèÊØîÂ∞çÁµêÊûú
            const compareResult = document.getElementById('excelImportCompareResult');
            if (compareResult) {
                compareResult.style.display = 'none';
                console.log('‚úÖ [DEBUG] Â∑≤Èö±ËóèÊØîÂ∞çÁµêÊûú');
            } else {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ excelImportCompareResult ÂÖÉÁ¥†');
            }
            
            // È°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
            const importSelection = document.getElementById('excelImportSelection');
            if (importSelection) {
                importSelection.style.display = 'block';
                console.log('‚úÖ [DEBUG] Â∑≤È°ØÁ§∫ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢');
            } else {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ excelImportSelection ÂÖÉÁ¥†');
            }
            
            // ÁîüÊàêË®òÈåÑÈÅ∏ÊìáÊ∏ÖÂñÆ
            console.log('üîç [DEBUG] Ê∫ñÂÇôÁîüÊàêË®òÈåÑÊ∏ÖÂñÆÔºåË®òÈåÑÊï∏:', currentExcelImportData.newRecordsData ? currentExcelImportData.newRecordsData.length : 'undefined');
            generateExcelImportRecordsSelectionList(currentExcelImportData.newRecordsData);
        }

        // ÁîüÊàêÊñ∞ÁöÑ Excel ÂåØÂÖ•Ë®òÈåÑÈÅ∏ÊìáÊ∏ÖÂñÆ
        function generateExcelImportRecordsSelectionList(records) {
            console.log('üîç [DEBUG] generateExcelImportRecordsSelectionList Ë¢´Ë™øÁî®');
            console.log('üîç [DEBUG] records:', records);
            
            const listContainer = document.getElementById('excelImportRecordsSelection');
            if (!listContainer) {
                console.error('‚ùå [DEBUG] Êâæ‰∏çÂà∞ excelImportRecordsSelection ÂÖÉÁ¥†');
                return;
            }
            
            console.log('‚úÖ [DEBUG] ÊâæÂà∞ excelImportRecordsSelection ÂÖÉÁ¥†');
            listContainer.innerHTML = '';
            
            if (!records || !Array.isArray(records)) {
                console.error('‚ùå [DEBUG] records ‰∏çÊòØÊúâÊïàÊï∏ÁµÑ:', records);
                return;
            }
            
            // Âêà‰ΩµÊâÄÊúâË®òÈåÑÔºàÊñ∞Ë®òÈåÑ + ÈáçË§áË®òÈåÑÔºâ
            const allRecords = [];
            
            // Ê∑ªÂä†Êñ∞Ë®òÈåÑ
            if (currentExcelImportData.newRecordsData) {
                allRecords.push(...currentExcelImportData.newRecordsData.map(record => ({
                    ...record,
                    isNew: true
                })));
            }
            
            // Ê∑ªÂä†ÈáçË§áË®òÈåÑ
            if (currentExcelImportData.duplicateRecordsData) {
                allRecords.push(...currentExcelImportData.duplicateRecordsData.map(record => ({
                    ...record,
                    isNew: false
                })));
            }
            
            console.log('üîç [DEBUG] Âêà‰ΩµÂæåÁ∏ΩË®òÈåÑÊï∏:', allRecords.length);
            
            // ÊåâÊó•ÊúüÂæûÊñ∞Âà∞ËàäÊéíÂ∫è
            allRecords.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Êñ∞Âà∞Ëàä
            });
            
            console.log('üîç [DEBUG] ÊéíÂ∫èÂÆåÊàêÔºåÈñãÂßãÁîüÊàêË®òÈåÑÊ∏ÖÂñÆ');
            
            allRecords.forEach((record, index) => {
                console.log(`üîç [DEBUG] ËôïÁêÜË®òÈåÑ ${index}:`, record);
                
                const item = document.createElement('div');
                item.className = 'record-selection-item';
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÈáçË§áË≥áÊñô
                const duplicateInfo = checkForDuplicateRecord(record);
                const duplicateNote = duplicateInfo ? 
                    `<div class="duplicate-note">‚ö†Ô∏è ÂèØËÉΩËàáÁ≥ªÁµ±‰∏≠ÁèæÊúâË®òÈåÑÈáçË§á</div>` : '';
                
                // Ê∑ªÂä†Ë®òÈåÑÈ°ûÂûãÊ®ôË®ò
                const recordTypeNote = record.isNew ? 
                    `<div class="record-type-note new">üÜï Êñ∞Ë®òÈåÑ</div>` : 
                    `<div class="record-type-note duplicate">üîÑ ÈáçË§áË®òÈåÑ</div>`;
                
                item.innerHTML = `
                    <div class="record-selection-content">
                        <input type="checkbox" value="${index}" onchange="updateExcelImportSelectedCount()">
                        <div class="record-info">
                            <div class="record-header">
                                ${recordTypeNote}
                                <span class="record-date">${record.date}</span>
                                <span class="record-member">${record.member}</span>
                                <span class="record-amount ${record.type}">$${record.amount}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-category">${record.mainCategory}</span>
                                <span class="record-subcategory">${record.subCategory || 'Êú™Ë®≠ÂÆö'}</span>
                                ${record.description ? `<span class="record-description">${record.description}</span>` : ''}
                            </div>
                            ${duplicateNote}
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(item);
                console.log(`‚úÖ [DEBUG] Â∑≤Ê∑ªÂä†Ë®òÈåÑ ${index} Âà∞Ê∏ÖÂñÆ`);
            });
            
            console.log('‚úÖ [DEBUG] ÊâÄÊúâË®òÈåÑÂ∑≤Ê∑ªÂä†Âà∞Ê∏ÖÂñÆÔºåÈñãÂßãÂàùÂßãÂåñÈÅ∏ÊìáË®àÊï∏');
            // ÂàùÂßãÂåñÈÅ∏ÊìáË®àÊï∏
            updateExcelImportSelectedCount();
        }

        // Êõ¥Êñ∞Êñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏ÊìáË®àÊï∏
        function updateExcelImportSelectedCount() {
            const checkboxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]');
            const checkedBoxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]:checked');
            const count = checkedBoxes.length;
            
            // Êõ¥Êñ∞Á¢∫Ë™çÊåâÈàïÁãÄÊÖã
            const confirmBtn = document.querySelector('#excelImportSelection .btn-success');
            if (confirmBtn) {
                confirmBtn.disabled = count === 0;
                confirmBtn.textContent = count === 0 ? 'Á¢∫Ë™çÂåØÂÖ•ÈÅ∏‰∏≠Ë®òÈåÑ' : `Á¢∫Ë™çÂåØÂÖ•ÈÅ∏‰∏≠Ë®òÈåÑ (${count})`;
            }
        }

        // ÂÖ®ÈÅ∏Êñ∞ÁöÑ Excel ÂåØÂÖ•Ë®òÈåÑ
        function selectAllExcelImportRecords() {
            const checkboxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateExcelImportSelectedCount();
        }

        // Âè™ÈÅ∏Êñ∞ÁöÑ Excel ÂåØÂÖ•Ë®òÈåÑ
        function selectNewExcelImportRecordsOnly() {
            const checkboxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                // ÊâæÂà∞Â∞çÊáâÁöÑË®òÈåÑÈ°ûÂûãÊ®ôË®ò
                const recordItem = checkbox.closest('.record-selection-item');
                const typeNote = recordItem.querySelector('.record-type-note.new');
                checkbox.checked = typeNote !== null;
            });
            updateExcelImportSelectedCount();
        }

        // Ê∏ÖÈô§Êñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏Êìá
        function clearExcelImportSelection() {
            const checkboxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateExcelImportSelectedCount();
        }

        // Á¢∫Ë™çÊñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑË®òÈåÑ
        async function confirmExcelImportSelected() {
            const checkedBoxes = document.querySelectorAll('#excelImportRecordsSelection input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                alert('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÁ≠ÜË®òÈåÑ');
                return;
            }

            if (!confirm(`Á¢∫ÂÆöË¶ÅÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑ ${checkedBoxes.length} Á≠ÜË®òÈåÑÂóéÔºü`)) {
                return;
            }

            // Êî∂ÈõÜÈÅ∏‰∏≠ÁöÑË®òÈåÑ
            const selectedRecords = [];
            checkedBoxes.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const allRecords = [
                    ...(currentExcelImportData.newRecordsData || []),
                    ...(currentExcelImportData.duplicateRecordsData || [])
                ];
                selectedRecords.push(allRecords[index]);
            });

            try {
                console.log('üì• ÈñãÂßãÂêëJSONÊñá‰ª∂ÂåØÂÖ•ÈÅ∏‰∏≠ÁöÑË®òÈåÑ...');
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // ÈÄêÁ≠ÜÊ∑ªÂä†Âà∞JSONÊñá‰ª∂
                for (const record of selectedRecords) {
                    try {
                        const addResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(record)
                        });
                        
                        const addResult = await addResponse.json();
                        
                        if (addResult.success) {
                            successCount++;
                            console.log('‚úÖ Ë®òÈåÑÂ∑≤Ê∑ªÂä†:', record.id);
                        } else {
                            errorCount++;
                            errors.push(`Ë®òÈåÑ ${record.id}: ${addResult.message}`);
                            console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†Â§±Êïó:', record.id, addResult.message);
                        }
                    } catch (recordError) {
                        errorCount++;
                        errors.push(`Ë®òÈåÑ ${record.id}: ${recordError.message}`);
                        console.error('‚ùå Ë®òÈåÑÊ∑ªÂä†ÈåØË™§:', record.id, recordError.message);
                    }
                }
                
                if (successCount > 0) {
                    console.log(`‚úÖ ÊàêÂäüÂåØÂÖ• ${successCount} Á≠ÜË®òÈåÑÂà∞JSONÊñá‰ª∂`);
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                    await loadDataFromFile();
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                    updateAllDisplays();
                    
                    // Ëá™ÂãïÊèê‰∫§Âà∞GitÔºà‰∏çÊõ¥Êñ∞ÁâàÊú¨ËôüÔºâ - Â∑≤ÁßªÈô§
                    
                    // Ê∏ÖÈô§ÊâÄÊúâÁµêÊûú
                    clearExcelImportResult();
                    hideExcelImportSelection();
                    
                    if (errorCount > 0) {
                        // È°ØÁ§∫Ë©≥Á¥∞ÁöÑÂåØÂÖ•ÁµêÊûú
                        const resultMessage = `üìä ÂåØÂÖ•ÁµêÊûúÁµ±Ë®àÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                        alert(resultMessage);
                    } else {
                        alert(`‚úÖ ÂåØÂÖ•ÂÆåÊàêÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö${successCount} Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö0 Á≠ÜË®òÈåÑ`);
                    }
                } else {
                    console.error('‚ùå ÊâÄÊúâË®òÈåÑÂåØÂÖ•Â§±Êïó');
                    const failMessage = `‚ùå ÂåØÂÖ•Â§±ÊïóÔºÅ\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${errorCount} Á≠ÜË®òÈåÑ\n\nüìã Â§±ÊïóË®òÈåÑË©≥ÊÉÖÔºö\n${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}`;
                    alert(failMessage);
                }
            } catch (error) {
                console.error('‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', error);
                alert(`‚ùå ÂåØÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö${error.message}\n\nüìä Áµ±Ë®àÁµêÊûúÔºö\nüìÑ ExcelÁ∏ΩÁ≠ÜÊï∏Ôºö${allRecordsData.length} Á≠ÜË®òÈåÑ\n‚úÖ ÊàêÂäüÂåØÂÖ•Ôºö0 Á≠ÜË®òÈåÑ\n‚ùå ÂåØÂÖ•Â§±ÊïóÔºö${allRecordsData.length} Á≠ÜË®òÈåÑ`);
            }
        }

        // Èö±ËóèÊñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏ÊìáÁïåÈù¢
        function hideExcelImportSelection() {
            document.getElementById('excelImportSelection').style.display = 'none';
            document.getElementById('excelImportCompareResult').style.display = 'block';
        }

        // ÂèñÊ∂àÊñ∞ÁöÑ Excel ÂåØÂÖ•ÈÅ∏Êìá
        function cancelExcelImportSelection() {
            hideExcelImportSelection();
        }

        // Ê∏ÖÈô§Êñ∞ÁöÑ Excel ÂåØÂÖ•ÁµêÊûú
        function clearExcelImportResult() {
            document.getElementById('excelImportCompareResult').style.display = 'none';
            document.getElementById('excelImportSelection').style.display = 'none';
            document.getElementById('excelImportFileInput').value = '';
            currentExcelImportData = null;
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMÂ∑≤ËºâÂÖ•ÔºåÈñãÂßãÂàùÂßãÂåñ...');
            
            // ËºâÂÖ•ÁâàÊú¨‰ø°ÊÅØ
            loadVersionInfo();
            
            // ÂàùÂßãÂåñ Excel ‰∏äÂÇ≥ÂäüËÉΩ
            initExcelUpload();
            
            // ÂàùÂßãÂåñÊñ∞ÁöÑ Excel ÂåØÂÖ•ÂäüËÉΩÂ∑≤ÁßªÈô§ - Â∑≤Êï¥ÂêàÂà∞Êï∏ÊìöÂåØÂÖ•ÂçÄÂ°ä
            
            // Èò≤Ê≠¢ÈÅéÂ∫¶ÊªæÂãï
            preventOverScroll();
            
            // Ê™¢Ê∏¨‰∏¶‰øÆÂæ©Safari
            const isSafari = detectAndFixSafari();
            console.log('üåê ÁÄèË¶ΩÂô®Ê™¢Ê∏¨:', isSafari ? 'Safari' : 'ÂÖ∂‰ªñ');
            
            initializeApp();
            initializeSwipeIndicators();
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÊôÇÂêåÊ≠•Êï∏ÊìöÔºàÊ∏õÂ∞ëÈ†ªÁéáÔºâ
        let lastSyncTime = 0;
        const SYNC_COOLDOWN = 5000; // 5ÁßíÂÜ∑ÂçªÊôÇÈñì
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = Date.now();
                if (now - lastSyncTime > SYNC_COOLDOWN) {
                    console.log('üëÅÔ∏è È†ÅÈù¢ÈáçÊñ∞ÂèØË¶ãÔºåÂêåÊ≠•Êï∏Êìö...');
                    lastSyncTime = now;
                    // ÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁõ¥Êé•ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö
                    loadDataFromFile().then(() => {
                        updateAllDisplays();
                        console.log('‚úÖ È†ÅÈù¢ÂèØË¶ãÊÄßÊï∏ÊìöÈáçÊñ∞ËºâÂÖ•ÂÆåÊàê');
                    });
                } else {
                    console.log('‚è∞ ÂêåÊ≠•ÂÜ∑Âçª‰∏≠ÔºåË∑≥ÈÅéÊú¨Ê¨°ÂêåÊ≠•');
                }
            }
        });

        // È†ÅÈù¢Áç≤ÂæóÁÑ¶ÈªûÊôÇÂêåÊ≠•Êï∏ÊìöÔºà‰ΩøÁî®Áõ∏ÂêåÁöÑÂÜ∑ÂçªÊ©üÂà∂Ôºâ
        window.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastSyncTime > SYNC_COOLDOWN) {
                console.log('üéØ È†ÅÈù¢Áç≤ÂæóÁÑ¶ÈªûÔºåÊ™¢Êü•Êï∏ÊìöÊõ¥Êñ∞');
                lastSyncTime = now;
                // ÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁõ¥Êé•ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö
                loadDataFromFile().then(() => {
                    updateAllDisplays();
                    console.log('‚úÖ ÁÑ¶ÈªûÊï∏ÊìöÈáçÊñ∞ËºâÂÖ•ÂÆåÊàê');
                });
            } else {
                console.log('‚è∞ ÁÑ¶ÈªûÂêåÊ≠•ÂÜ∑Âçª‰∏≠ÔºåË∑≥ÈÅéÊú¨Ê¨°ÂêåÊ≠•');
            }
        });

        async function initializeApp() {
            console.log('ÈñãÂßãÂàùÂßãÂåñÊáâÁî®Á®ãÂºè...');
            
            // Á∏ΩÊòØÂæûÊúçÂãôÂô®ËÆÄÂèñÊúÄÊñ∞Êï∏Êìö
            console.log('üîÑ ÂæûÊúçÂãôÂô®ËÆÄÂèñÊúÄÊñ∞Êï∏Êìö...');
            await loadDataFromFile();
            
            // TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ - ÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§
            console.log('üîë TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∑≥ÈÅéÊ™¢Êü•...');
            
            // Á¢∫‰øùrecordsËÆäÈáèÂ∑≤Êõ¥Êñ∞
            console.log('üîÑ ÂàùÂßãÂåñÂÆåÊàêÔºåÁï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('üîÑ Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // GitHubÊõ¥Êñ∞Ê™¢Êü•Â∑≤ÁßªÈô§ÔºàÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§Ôºâ
            console.log('üìä ÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§Ôºå‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤');
            
            // Ëá™ÂãïÂêåÊ≠•ÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•
            
            // Êõ¥Êñ∞ÊâÄÊúâUIÈ°ØÁ§∫
            console.log('üîÑ ÈñãÂßãÊõ¥Êñ∞ÊâÄÊúâUIÈ°ØÁ§∫...');
            updateAllDisplays();
            
            // TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ - ÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§
            console.log('üîë TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∑≥ÈÅéÊúÄÁµÇÊ™¢Êü•...');
            updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫
            
            // Â¶ÇÊûúÊ≤íÊúâË®òÈåÑÔºå‰∏çËá™ÂãïÊ∑ªÂä†Á§∫‰æãÊï∏Êìö
            // if (records.length === 0) {
            //     addSampleData();
            // }
            
            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
            checkAndSwitchTo2025();
            
            console.log('ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂÆåÊàê');
        }

        // Êï∏ÊìöËºâÂÖ•ÁãÄÊÖãÁÆ°ÁêÜ
        let isLoadingData = false;
        
        // ÂæûJSONÊñá‰ª∂ËºâÂÖ•Ë≥áÊñô
        async function loadDataFromFile() {
            // Èò≤Ê≠¢ÈáçË§áËºâÂÖ•
            if (isLoadingData) {
                console.log('‚è∞ Êï∏ÊìöÊ≠£Âú®ËºâÂÖ•‰∏≠ÔºåË∑≥ÈÅéÈáçË§áË´ãÊ±Ç');
                return;
            }
            
            isLoadingData = true;
            try {
                console.log('üîÑ ÈñãÂßãÂæûJSONÊñá‰ª∂ËºâÂÖ•Ë≥áÊñô...');
                console.log('üåç Áï∂ÂâçÁí∞Â¢É:', ENV_CONFIG.getEnvironment());
                console.log('üîó APIÂü∫Á§éURL:', ENV_CONFIG.getApiBase());
                console.log('üîó ÂÆåÊï¥API URL:', ENV_CONFIG.getApiBase() + '/api/records');
                
                // ‰ΩøÁî®JSONÊñá‰ª∂APIÁ´ØÈªûÔºåÊ∑ªÂä†ÁÑ°Á∑©Â≠òÊ®ôÈ†≠Á¢∫‰øùÁç≤ÂèñÊúÄÊñ∞Êï∏Êìö
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('üì° APIÈüøÊáâÁãÄÊÖã:', response.status);
                console.log('üì° APIÈüøÊáâOK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì° APIÈüøÊáâÂÖßÂÆπ:', result);
                    
                    if (result.success && Array.isArray(result.records)) {
                        records = result.records;
                        console.log('‚úÖ ÂæûJSONÊñá‰ª∂ËºâÂÖ•‰∫Ü', records.length, 'Á≠ÜË®òÈåÑ');
                        console.log('üîÑ ÂÖ®Â±ÄrecordsËÆäÈáèÂ∑≤Êõ¥Êñ∞ÁÇ∫:', records.length, 'Á≠ÜË®òÈåÑ');
                        console.log('üìä Ââç3Á≠ÜË®òÈåÑ:', records.slice(0, 3));
                        return;
                    } else {
                        console.warn('‚ö†Ô∏è JSONÊñá‰ª∂APIËøîÂõûÁÑ°ÊïàÊï∏Êìö:', result);
                    }
                } else {
                    console.warn('‚ö†Ô∏è JSONÊñá‰ª∂APIË´ãÊ±ÇÂ§±ÊïóÔºåÁãÄÊÖãÁ¢º:', response.status);
                    const errorText = await response.text();
                    console.warn('‚ö†Ô∏è ÈåØË™§ÂÖßÂÆπ:', errorText);
                }
                
                // JSONÊñá‰ª∂APIÂ§±ÊïóÔºåË®≠ÁÇ∫Á©∫Êï∏ÁµÑ
                records = [];
                console.log('üìù JSONÊñá‰ª∂APIÂ§±ÊïóÔºårecordsË®≠ÁÇ∫Á©∫Êï∏ÁµÑ');
                
            } catch (error) {
                console.error('‚ùå ÂæûJSONÊñá‰ª∂ËºâÂÖ•Â§±Êïó:', error);
                records = [];
                console.log('üìù JSONÊñá‰ª∂ËºâÂÖ•Â§±ÊïóÔºårecordsË®≠ÁÇ∫Á©∫Êï∏ÁµÑ');
            } finally {
                isLoadingData = false; // ÈáçÁΩÆËºâÂÖ•ÁãÄÊÖã
                console.log('‚úÖ Êï∏ÊìöËºâÂÖ•ÁãÄÊÖãÂ∑≤ÈáçÁΩÆ');
            }
        }

        // Ê∑ªÂä†Á§∫‰æãÊï∏Êìö
        function addSampleData() {
            const today = new Date();
            const sampleRecords = [
                {
                    id: 'sample-1',
                    member: 'Kelvin',
                    type: 'expense',
                    amount: 1200,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'ÊâãÊ©üË≤ª',
                    description: 'ÊâãÊ©üË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-2',
                    member: 'Phuong',
                    type: 'expense',
                    amount: 1598,
                    mainCategory: 'Êó•Â∏∏',
                    subCategory: 'Á∂≤Ë∑ØË≤ª',
                    description: 'Á∂≤Ë∑ØË≤ª',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-3',
                    member: 'ÂÆ∂Áî®',
                    type: 'income',
                    amount: 50000,
                    mainCategory: 'Ëñ™Ë≥á',
                    subCategory: '',
                    description: 'Kelvin Ëñ™Ë≥á',
                    date: today.toISOString().split('T')[0]
                },
                {
                    id: 'sample-4',
                    member: 'ÂÆ∂Áî®',
                    type: 'expense',
                    amount: 15000,
                    mainCategory: 'Â±Ö‰Ωè',
                    subCategory: 'ÊàøÁßü',
                    description: 'ÊàøÁßü',
                    date: today.toISOString().split('T')[0]
                }
            ];
            
            records = records.concat(sampleRecords);
            // saveRecords() Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂
            updateStats();
            updateRecentRecords();
            updateAllRecords();
            updateCalendar();
            updateDataStats();
        }

        // Áµ±‰∏ÄÁöÑÊó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∏ÔºåÈÅøÂÖçÊôÇÂçÄÂïèÈ°å
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setTodayDate() {
            const today = formatDateToYYYYMMDD(new Date());
            document.getElementById('date').value = today;
        }

        function updateCategoryOptions() {
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');

            function updateMainCategories(amountInput, mainCategorySelect) {
                const amount = parseFloat(amountInput.value) || 0;
                // Â¶ÇÊûúÈáëÈ°çÁÇ∫0ÊàñÁ©∫ÔºåÈªòË™çÈ°ØÁ§∫ÊîØÂá∫È°ûÂà•ÔºàÂõ†ÁÇ∫Â§ßÈÉ®ÂàÜË®òÈåÑÈÉΩÊòØÊîØÂá∫Ôºâ
                const type = (amount === 0 || isNaN(amount)) ? 'expense' : (amount >= 0 ? 'income' : 'expense');
                mainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
                
                console.log('updateMainCategories called:', { amount, type, inputValue: amountInput.value });
                
                if (type === 'income') {
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                } else if (type === 'expense') {
                    // Áç≤ÂèñÊâÄÊúâÊîØÂá∫È°ûÂà•ÔºàÊéíÈô§"ÂÖ∂‰ªñ"Ôºâ
                    const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñ');
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        mainCategorySelect.appendChild(option);
                    });
                    // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
                    const otherOption = document.createElement('option');
                    otherOption.value = 'ÂÖ∂‰ªñ';
                    otherOption.textContent = 'ÂÖ∂‰ªñ';
                    mainCategorySelect.appendChild(otherOption);
                }
                
                console.log('‰∏ªÈ°ûÂà•ÈÅ∏È†ÖÂ∑≤Êõ¥Êñ∞ÔºåÊï∏Èáè:', mainCategorySelect.options.length);
            }

            amountInput.addEventListener('input', () => {
                updateMainCategories(amountInput, mainCategorySelect);
            });
            
            // ÂàùÂßãÂåñÊôÇ‰πüË™øÁî®‰∏ÄÊ¨°ÔºåÁ¢∫‰øùÈ†ÅÈù¢Âä†ËºâÊôÇÊúâÊ≠£Á¢∫ÁöÑÁãÄÊÖã
            console.log('ÂàùÂßãÂåñÈ°ûÂà•ÈÅ∏ÊìáÂô®...');
            updateMainCategories(amountInput, mainCategorySelect);

            // Á∑®ËºØË°®ÂñÆÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®Ôºà‰øùÊåÅÂéüÊúâÈÇèËºØÔºåÂõ†ÁÇ∫Á∑®ËºØË°®ÂñÆ‰ªçÊúâÈ°ûÂûãÈÅ∏ÊìáÂô®Ôºâ
            editTypeSelect.addEventListener('change', () => {
                updateMainCategories(editTypeSelect, editMainCategorySelect);
            });
        }

        // ËôïÁêÜÈ°ûÂûãËÆäÂåñ
        function handleTypeChange() {
            const typeSelect = document.getElementById('type');
            const amountInput = document.getElementById('amount');
            const mainCategorySelect = document.getElementById('mainCategory');
            
            updateMainCategories(typeSelect, mainCategorySelect);
        }

        // ËôïÁêÜ‰∏ªÈ°ûÂà•ËÆäÂåñ
        function handleMainCategoryChange() {
            const mainCategorySelect = document.getElementById('mainCategory');
            const customInput = document.getElementById('customMainCategory');
            
            if (mainCategorySelect.value === 'ÂÖ∂‰ªñ') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // ËôïÁêÜÁ∑®ËºØË°®ÂñÆ‰∏ªÈ°ûÂà•ËÆäÂåñ
        function handleEditMainCategoryChange() {
            const mainCategorySelect = document.getElementById('editMainCategory');
            const customInput = document.getElementById('editCustomMainCategory');
            
            if (mainCategorySelect.value === 'ÂÖ∂‰ªñ') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        function showTab(tabName) {
            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
            document.getElementById(tabName).classList.add('active');
            
            // Ê∑ªÂä†ÈÅ∏‰∏≠Ê®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'dashboard' ? 'Á∏ΩË¶Ω' : 
                                           tabName === 'list' ? 'ÂàóË°®' :
                                           tabName === 'calendar' ? 'Êó•ÊõÜ' :
                                           tabName === 'add' ? 'Êñ∞Â¢û' :
                                           tabName === 'import' ? 'Ë®≠ÂÆö' : '')) {
                    tab.classList.add('active');
                }
            });

            // Â¶ÇÊûúÂàáÊèõÂà∞Êó•ÊõÜÈ†ÅÈù¢ÔºåÊõ¥Êñ∞Êó•ÊõÜ
            if (tabName === 'calendar') {
                setTimeout(() => {
                    updateCalendar();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞ÂúñË°®È†ÅÈù¢ÔºåÂàùÂßãÂåñÂúñË°®
            if (tabName === 'charts') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // Â¶ÇÊûúÂàáÊèõÂà∞Ë®≠ÂÆöÈ†ÅÈù¢ÔºåÊõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
            if (tabName === 'import') {
                updateSyncStatus();
                // TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ - ÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§
            }
        }

        // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®àÈ°ØÁ§∫
        function updateDataStats() {
            try {
                const totalRecords = records.length;
                const totalIncome = records
                    .filter(r => r.type === 'income')
                    .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
                const totalExpense = records
                    .filter(r => r.type === 'expense')
                    .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
                
                console.log('üìä Êï∏ÊìöÁµ±Ë®àÊõ¥Êñ∞:', {
                    totalRecords,
                    totalIncome,
                    totalExpense,
                    balance: totalIncome - totalExpense
                });
                
                // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫ÔºàÂ¶ÇÊûúÂ≠òÂú®Áõ∏ÈóúÂÖÉÁ¥†Ôºâ
                const statsElements = document.querySelectorAll('[data-stat]');
                statsElements.forEach(element => {
                    const statType = element.getAttribute('data-stat');
                    switch(statType) {
                        case 'total-records':
                            element.textContent = totalRecords;
                            break;
                        case 'total-income':
                            element.textContent = `$${totalIncome.toLocaleString()}`;
                            break;
                        case 'total-expense':
                            element.textContent = `$${totalExpense.toLocaleString()}`;
                            break;
                        case 'balance':
                            element.textContent = `$${(totalIncome - totalExpense).toLocaleString()}`;
                            break;
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®àÂ§±Êïó:', error);
            }
        }

        function updateStats() {
            // Ë™øË©¶ÔºöÊ™¢Êü•Ë®òÈåÑÊï∏ÈáèÂíåÈáçË§áID
            console.log('üîç updateStatsË™øË©¶‰ø°ÊÅØ:');
            console.log('- Á∏ΩË®òÈåÑÊï∏:', records.length);
            console.log('- Ë®òÈåÑIDÂàóË°®:', records.map(r => r.id));
            
            // Ê™¢Êü•ÈáçË§áID
            const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            if (duplicateIds.length > 0) {
                console.warn('‚ö†Ô∏è ÁôºÁèæÈáçË§áID:', duplicateIds);
            }
            
            const totalIncome = records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            console.log('- Á∏ΩÊî∂ÂÖ•:', totalIncome);
            console.log('- Á∏ΩÊîØÂá∫:', totalExpense);
            
            // Ë®àÁÆóÁèæÈáëÊîØÂá∫ÔºàÊâÄÊúâÊàêÂì°ÁöÑÁèæÈáëÊîØÂá∫Ôºâ
            const cashExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === 'ÁèæÈáë')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆóÁèæÈáëÊî∂ÂÖ•ÔºàÊâÄÊúâÊàêÂì°ÁöÑÁèæÈáëÊî∂ÂÖ•Ôºâ
            const cashIncome = records
                .filter(record => record.type === 'income' && record.subCategory === 'ÁèæÈáë')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆóÁèæÈáëÈ§òÈ°ç = ÊâÄÊúâÊàêÂì°ÁöÑÁèæÈáëÊî∂ÂÖ• - ÊâÄÊúâÊàêÂì°ÁöÑÁèæÈáëÊîØÂá∫
            const cashBalance = cashIncome - cashExpense;
            
            // Ë™øË©¶‰ø°ÊÅØ
            console.log('üí∞ ÁèæÈáëÁµ±Ë®àË™øË©¶:');
            console.log('- ÊâÄÊúâÊàêÂì°ÁèæÈáëÊî∂ÂÖ•:', cashIncome);
            console.log('- ÊâÄÊúâÊàêÂì°ÁèæÈáëÊîØÂá∫:', cashExpense);
            console.log('- ÁèæÈáëÈ§òÈ°ç (ÊâÄÊúâÊàêÂì°ÁèæÈáëÊî∂ÂÖ•-ÊâÄÊúâÊàêÂì°ÁèæÈáëÊîØÂá∫):', cashBalance);
            
            // Ë©≥Á¥∞Ë™øË©¶ÔºöÊ™¢Êü•ÁèæÈáëÊî∂ÂÖ•Ë®òÈåÑ
            const cashIncomeRecords = records.filter(record => record.type === 'income' && record.subCategory === 'ÁèæÈáë');
            console.log('üìä ÁèæÈáëÊî∂ÂÖ•Ë®òÈåÑË©≥ÊÉÖ:', cashIncomeRecords);
            
            // Ë©≥Á¥∞Ë™øË©¶ÔºöÊ™¢Êü•ÁèæÈáëÊîØÂá∫Ë®òÈåÑ
            const cashExpenseRecords = records.filter(record => record.type === 'expense' && record.subCategory === 'ÁèæÈáë');
            console.log('üìä ÁèæÈáëÊîØÂá∫Ë®òÈåÑË©≥ÊÉÖ:', cashExpenseRecords);
            
            // Ê™¢Êü•ÊâÄÊúâË®òÈåÑÁöÑ subCategory È°ûÂûã
            const allSubCategories = [...new Set(records.map(r => r.subCategory))];
            console.log('üìä ÊâÄÊúâ subCategory È°ûÂûã:', allSubCategories);
            
            // Ë®àÁÆó‰ø°Áî®Âç°ÊîØÂá∫
            const creditExpense = records
                .filter(record => record.type === 'expense' && record.subCategory === '‰ø°Áî®Âç°')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Ë®àÁÆóÁï∂ÊúàÁèæÈáëÊµÅÔºàÁï∂ÊúàÂÆ∂Áî®Êî∂ÂÖ• - Áï∂ÊúàÁèæÈáëÊîØÂá∫Ôºâ
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyHouseholdIncome = records
                .filter(record => {
                    const recordDate = new Date(record.date);
                    return record.member === 'ÂÆ∂Áî®' && 
                           record.type === 'income' &&
                           recordDate.getMonth() === currentMonth && 
                           recordDate.getFullYear() === currentYear;
                })
                .reduce((sum, record) => sum + record.amount, 0);
            
            const monthlyCashExpense = records
                .filter(record => {
                    const recordDate = new Date(record.date);
                    return record.type === 'expense' && 
                           record.subCategory === 'ÁèæÈáë' &&
                           recordDate.getMonth() === currentMonth && 
                           recordDate.getFullYear() === currentYear;
                })
                .reduce((sum, record) => sum + record.amount, 0);
            
            // Áï∂ÊúàÁèæÈáëÊµÅ = Áï∂ÊúàÂÆ∂Áî®Êî∂ÂÖ• - Áï∂ÊúàÁèæÈáëÊîØÂá∫
            const monthlyCashFlow = monthlyHouseholdIncome - monthlyCashExpense;

            document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
            document.getElementById('creditExpense').textContent = `$${creditExpense.toLocaleString()}`;
            
            // ÁèæÈáëÈ§òÈ°çÈ°ØÁ§∫ÔºàÊâÄÊúâÁèæÈáëÊî∂ÂÖ• - ÊâÄÊúâÁèæÈáëÊîØÂá∫ÔºåÂ∏∂È°èËâ≤Ôºâ
            const cashBalanceElement = document.getElementById('balance');
            const cashBalancePrefix = cashBalance >= 0 ? '+' : '';
            cashBalanceElement.textContent = `${cashBalancePrefix}$${Math.abs(cashBalance).toLocaleString()}`;
            cashBalanceElement.style.color = cashBalance >= 0 ? '#4CAF50' : '#F44336';

            // Êõ¥Êñ∞ÂêÑÊàêÂì°Áµ±Ë®à
            updateMemberStats();
            
            // Ê™¢Êü•‰∏¶È°ØÁ§∫ÊªëÂãïÊåáÁ§∫Âô®
            setTimeout(() => {
                checkScrollable(document.querySelector('.stats'), document.getElementById('statsSwipeIndicator'));
                checkScrollable(document.querySelector('.member-stats-grid'), document.getElementById('memberSwipeIndicator'));
            }, 100);
        }

        function updateMemberStats() {
            const memberStatsContainer = document.getElementById('memberStats');
            const memberIndicatorsContainer = document.getElementById('memberIndicators');
            memberStatsContainer.innerHTML = '';
            memberIndicatorsContainer.innerHTML = '';

            console.log('updateMemberStats: Á∏ΩË®òÈåÑÊï∏', records.length);
            console.log('updateMemberStats: Ë®òÈåÑÂÖßÂÆπ', records);

            // ÈáçÊñ∞ÊéíÂàóÊàêÂì°È†ÜÂ∫èÔºåËÆìÁ¨¨‰∏ÄÂÄãÊàêÂì°Âú®‰∏≠Èñì
            const reorderedMembers = [...familyMembers];
            if (reorderedMembers.length > 1) {
                const firstMember = reorderedMembers.shift();
                reorderedMembers.splice(1, 0, firstMember); // Â∞áÁ¨¨‰∏ÄÂÄãÊàêÂì°ÊèíÂÖ•Âà∞Á¨¨‰∫åÂÄã‰ΩçÁΩÆÔºà‰∏≠ÈñìÔºâ
            }
            
            reorderedMembers.forEach((member, index) => {
                const memberRecords = records.filter(record => record.member === member);
                console.log(`${member} ÁöÑË®òÈåÑ:`, memberRecords);
                
                const memberIncome = memberRecords
                    .filter(record => record.type === 'income')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberExpense = memberRecords
                    .filter(record => record.type === 'expense')
                    .reduce((sum, record) => sum + record.amount, 0);
                const memberBalance = memberIncome - memberExpense;
                
                console.log(`${member} Áµ±Ë®à: Êî∂ÂÖ•=${memberIncome}, ÊîØÂá∫=${memberExpense}, È§òÈ°ç=${memberBalance}`);
                console.log(`${member} Ë®òÈåÑË©≥ÊÉÖ:`, memberRecords.map(r => ({
                    date: r.date,
                    type: r.type,
                    amount: r.amount,
                    description: r.description
                })));

                const memberCard = document.createElement('div');
                memberCard.className = 'stat-card';
                memberCard.style.cursor = 'pointer';
                memberCard.innerHTML = `
                    <h4>${member}</h4>
                    <small>Êî∂ÂÖ•: $${memberIncome.toLocaleString()}</small>
                            <small>ÊîØÂá∫: $${memberExpense.toLocaleString()}</small>
                    <div class="balance" style="color: ${memberBalance >= 0 ? '#51cf66' : '#ff6b6b'};">
                            $${memberBalance.toLocaleString()}
                        </div>
                    <div class="view-details">
                        ÈªûÊìäÊü•ÁúãË©≥Á¥∞Ë®òÈåÑ
                    </div>
                `;
                
                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
                memberCard.addEventListener('click', () => {
                    showMemberRecords(member);
                });
                
                memberStatsContainer.appendChild(memberCard);
                
                // ÂâµÂª∫ÊàêÂì°ÊåáÁ§∫Âô®
                const indicator = document.createElement('div');
                indicator.className = 'member-indicator';
                if (index === 1) indicator.classList.add('active'); // Á¨¨‰∫åÂÄã‰ΩçÁΩÆÔºà‰∏≠ÈñìÔºâÁÇ∫È†êË®≠Ê¥ªÂãï
                indicator.addEventListener('click', () => {
                    scrollToMember(index);
                });
                memberIndicatorsContainer.appendChild(indicator);
            });
            
            // ÂàùÂßãÂåñÊªëÂãïÂäüËÉΩ
            initializeMemberSwipe();
            
            // Ë™øË©¶‰ø°ÊÅØ
            console.log('üì± ÊàêÂì°Áµ±Ë®àÂàùÂßãÂåñÂÆåÊàê');
            console.log('üì± ÊàêÂì°Êï∏Èáè:', reorderedMembers.length);
            console.log('üì± ÂÆπÂô®:', memberStatsContainer);
            console.log('üì± ÂÆπÂô®Ê®£Âºè:', window.getComputedStyle(memberStatsContainer).display);
        }
        
        // ÂàùÂßãÂåñÊàêÂì°ÊªëÂãïÂäüËÉΩ
        function initializeMemberSwipe() {
            const memberStatsGrid = document.querySelector('.member-stats-grid');
            const indicators = document.querySelectorAll('.member-indicator');
            
            if (!memberStatsGrid) return;
            
            let currentIndex = 1; // È†êË®≠È°ØÁ§∫‰∏≠ÈñìÁöÑÂç°ÁâáÔºàÁ¨¨‰∫åÂÄã‰ΩçÁΩÆÔºâ
            
            // ÊªëÂãïÂà∞ÊåáÂÆöÊàêÂì°
            function scrollToMember(index) {
                const cardWidth = 280; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                memberStatsGrid.scrollTo({
                    left: index * cardWidth,
                    behavior: 'smooth'
                });
                updateActiveIndicator(index);
                currentIndex = index;
            }
            
            // Âº∑Âà∂ÈáçÊñ∞Ê∏≤Êüì
            memberStatsGrid.style.display = 'none';
            memberStatsGrid.offsetHeight; // Ëß∏ÁôºÈáçÊéí
            memberStatsGrid.style.display = 'flex';
            
            // ÂàùÂßãÂåñÊôÇÊªëÂãïÂà∞‰∏≠Èñì‰ΩçÁΩÆ
            setTimeout(() => {
                scrollToMember(1);
            }, 200);
            
            // Êõ¥Êñ∞Ê¥ªÂãïÊåáÁ§∫Âô®
            function updateActiveIndicator(index) {
                indicators.forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === index);
                });
            }
            
            // Áõ£ËÅΩÊªëÂãï‰∫ã‰ª∂
            memberStatsGrid.addEventListener('scroll', () => {
                const cardWidth = 280; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                const scrollLeft = memberStatsGrid.scrollLeft;
                const newIndex = Math.round(scrollLeft / cardWidth);
                
                if (newIndex !== currentIndex && newIndex >= 0 && newIndex < indicators.length) {
                    currentIndex = newIndex;
                    updateActiveIndicator(currentIndex);
                }
            });
            
            // Ê∑ªÂä†Ëß∏ÊéßÊªëÂãïÊîØÊåÅ
            let startX = 0;
            let isScrolling = false;
            
            memberStatsGrid.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isScrolling = false;
            });
            
            memberStatsGrid.addEventListener('touchmove', (e) => {
                if (!isScrolling) {
                    const currentX = e.touches[0].clientX;
                    const diffX = Math.abs(currentX - startX);
                    
                    if (diffX > 10) {
                        isScrolling = true;
                    }
                }
            });
            
            memberStatsGrid.addEventListener('touchend', () => {
                if (isScrolling) {
                    const cardWidth = 280; // Âõ∫ÂÆöÂç°ÁâáÂØ¨Â∫¶
                    const scrollLeft = memberStatsGrid.scrollLeft;
                    const newIndex = Math.round(scrollLeft / cardWidth);
                    
                    if (newIndex !== currentIndex && newIndex >= 0 && newIndex < indicators.length) {
                        currentIndex = newIndex;
                        updateActiveIndicator(currentIndex);
                    }
                }
            });
        }

        // È°ØÁ§∫ÊàêÂì°Ë©≥Á¥∞Ë®òÈåÑÔºàÂú®Á∏ΩË¶ΩÈ†ÅÈù¢‰∏ãÊñπÈ°ØÁ§∫Ôºâ
        function showMemberRecords(member) {
            const memberRecords = records.filter(record => record.member === member);
            
            if (memberRecords.length === 0) {
                alert(`${member} ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ„ÄÇ`);
                return;
            }
            
            // Ë®àÁÆóÊî∂ÂÖ•ÂíåÊîØÂá∫ÔºàËàáÊàêÂì°Áµ±Ë®àÂç°ÁâáÈÇèËºØ‰∏ÄËá¥Ôºâ
            const memberIncome = memberRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            const memberExpense = memberRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            const memberBalance = memberIncome - memberExpense;
            
            // Âú®Á∏ΩË¶ΩÈ†ÅÈù¢‰∏ãÊñπÈ°ØÁ§∫ÊàêÂì°Ë®òÈåÑ
            displayMemberRecordsBelow(memberRecords, member, { income: memberIncome, expense: memberExpense, balance: memberBalance });
        }
        
        // Âú®Á∏ΩË¶ΩÈ†ÅÈù¢‰∏ãÊñπÈ°ØÁ§∫ÊàêÂì°Ë®òÈåÑ
        function displayMemberRecordsBelow(memberRecords, member, stats) {
            // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            memberRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Êü•ÊâæÊàñÂâµÂª∫ÊàêÂì°Ë®òÈåÑÈ°ØÁ§∫ÂçÄÂüü
            let memberRecordsContainer = document.getElementById('memberRecordsContainer');
            if (!memberRecordsContainer) {
                // ÂâµÂª∫ÊàêÂì°Ë®òÈåÑÈ°ØÁ§∫ÂÆπÂô®
                memberRecordsContainer = document.createElement('div');
                memberRecordsContainer.id = 'memberRecordsContainer';
                memberRecordsContainer.style.cssText = `
                    margin-top: 30px;
                    background: white;
                    border-radius: 15px;
                    padding: 20px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    max-width: 100%;
                `;
                
                // ÊèíÂÖ•Âà∞Á∏ΩË¶ΩÈ†ÅÈù¢ÂÖßÂÆπÁöÑÊú´Â∞æ
                const dashboardContent = document.getElementById('dashboard');
                dashboardContent.appendChild(memberRecordsContainer);
            }
            
            // ÁîüÊàêÊàêÂì°Ë®òÈåÑHTML
            let recordsHtml = `
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid #f0f0f0;
                ">
                    <h3 style="margin: 0; color: #333; font-size: 24px;">${member} ÁöÑË®òÈåÑ</h3>
                    <button onclick="clearMemberRecords()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        padding: 8px 16px;
                        font-size: 14px;
                        cursor: pointer;
                        transition: background 0.2s;
                    " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                        ÈóúÈñâ
                    </button>
                </div>
                
                <div style="
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    text-align: center;
                ">
                    <p style="margin: 0; font-size: 18px; color: #666;">
                        ÂÖ± <strong style="color: #333;">${memberRecords.length}</strong> Á≠ÜË®òÈåÑÔºå 
                        Êî∂ÂÖ•Ôºö<strong style="color: #27ae60">$${stats.income.toLocaleString()}</strong> | 
                        ÊîØÂá∫Ôºö<strong style="color: #e74c3c">$${stats.expense.toLocaleString()}</strong> | 
                        È§òÈ°çÔºö<strong style="color: ${stats.balance >= 0 ? '#27ae60' : '#e74c3c'}">$${stats.balance.toLocaleString()}</strong>
                    </p>
                </div>
                
                <div class="member-records-list" style="max-height: 500px; overflow-y: auto;">
            `;
            
            memberRecords.forEach(record => {
                const amount = record.amount;
                const prefix = record.type === 'income' ? '+' : '-';
                
                recordsHtml += `
                    <div class="record-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        margin: 8px 0;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid ${record.type === 'income' ? '#27ae60' : '#e74c3c'};
                        transition: transform 0.2s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.background='#e9ecef'" onmouseout="this.style.transform='translateY(0)'; this.style.background='#f8f9fa'">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">
                                ${record.date} - ${record.member}
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}
                                ${record.description ? ' - ' + record.description : ''}
                            </div>
                        </div>
                        <div style="
                            font-size: 18px;
                            font-weight: bold;
                            color: ${record.type === 'income' ? '#27ae60' : '#e74c3c'};
                        ">
                            ${prefix}$${Math.abs(record.amount).toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `</div>`;
            
            // Êõ¥Êñ∞ÂÆπÂô®ÂÖßÂÆπ
            memberRecordsContainer.innerHTML = recordsHtml;
            
            // ÊªæÂãïÂà∞ÊàêÂì°Ë®òÈåÑÂçÄÂüü
            memberRecordsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Ê∏ÖÈô§ÊàêÂì°Ë®òÈåÑÈ°ØÁ§∫
        function clearMemberRecords() {
            const container = document.getElementById('memberRecordsContainer');
            if (container) {
                container.remove();
            }
        }

        // È°ØÁ§∫Á∏ΩÊîØÂá∫Ë®òÈåÑ
        function showExpenseRecords() {
            console.log('showExpenseRecords Ë¢´Ë™øÁî®');
            console.log('Áï∂ÂâçË®òÈåÑÁ∏ΩÊï∏:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            console.log('Áï∂ÂâçÊúà‰ªΩ:', currentMonth, 'Áï∂ÂâçÂπ¥‰ªΩ:', currentYear);
            
            // Êö´ÊôÇÁßªÈô§Êó•ÊúüÁØ©ÈÅ∏ÔºåÈ°ØÁ§∫ÊâÄÊúâÊîØÂá∫Ë®òÈåÑ
            const expenseRecords = records.filter(record => {
                const isExpense = record.type === 'expense';
                console.log(`Ë®òÈåÑ ${record.id}: ÊàêÂì°=${record.member}, ÊòØÊîØÂá∫=${isExpense}`);
                return isExpense;
            });
            
            console.log('ÁØ©ÈÅ∏ÂæåÁöÑÊîØÂá∫Ë®òÈåÑ:', expenseRecords);
            
            const totalAmount = expenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('expense');
            displayRecords(expenseRecords, `Á∏ΩÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${expenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫ÁèæÈáëÊîØÂá∫Ë®òÈåÑ
        function showCashExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const cashExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === 'ÁèæÈáë' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = cashExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('cash');
            displayRecords(cashExpenseRecords, `Áï∂ÊúàÁèæÈáëÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${cashExpenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ
        function showCreditExpenseRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const creditExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && 
                       record.subCategory === '‰ø°Áî®Âç°' &&
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = creditExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('credit');
            displayRecords(creditExpenseRecords, `Áï∂Êúà‰ø°Áî®Âç°ÊîØÂá∫Ë®òÈåÑ (ÂÖ± ${creditExpenseRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫Á∏ΩÊî∂ÂÖ•Ë®òÈåÑ
        function showIncomeRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const incomeRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.member === 'ÂÆ∂Áî®' && record.type === 'income' && 
                       recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalAmount = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
            
            updateFilterTabs('income');
            displayRecords(incomeRecords, `Áï∂ÊúàÁ∏ΩÊî∂ÂÖ•Ë®òÈåÑ (ÂÖ± ${incomeRecords.length} Á≠ÜÔºå$${totalAmount.toLocaleString()})`);
        }

        // È°ØÁ§∫ÂÖ®ÈÉ®Ë®òÈåÑ
        function showAllRecords() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const allRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && 
                       recordDate.getFullYear() === currentYear;
            });
            
            const totalIncome = allRecords.filter(r => r.member === 'ÂÆ∂Áî®' && r.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = allRecords.filter(r => r.member === 'ÂÆ∂Áî®' && r.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const netAmount = totalIncome - totalExpense;
            
            updateFilterTabs('all');
            displayRecords(allRecords, `Áï∂ÊúàÂÖ®ÈÉ®Ë®òÈåÑ (ÂÖ± ${allRecords.length} Á≠ÜÔºå$${netAmount.toLocaleString()})`);
        }

        // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
        function updateFilterTabs(activeType) {
            const tabs = document.querySelectorAll('.filter-tab');
            console.log('Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã:', activeType, 'Ê®ôÁ±§Êï∏Èáè:', tabs.length);
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('ÁßªÈô§activeÈ°ûÂà•:', tab.textContent);
            });
            
            if (activeType === 'expense') {
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊîØÂá∫ÁÇ∫active:', tabs[0].textContent);
                }
            } else if (activeType === 'cash') {
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁèæÈáëÊîØÂá∫ÁÇ∫active:', tabs[1].textContent);
                }
            } else if (activeType === 'credit') {
                if (tabs[2]) {
                    tabs[2].classList.add('active');
                    console.log('Ë®≠ÁΩÆ‰ø°Áî®Âç°ÊîØÂá∫ÁÇ∫active:', tabs[2].textContent);
                }
            } else if (activeType === 'income') {
                if (tabs[3]) {
                    tabs[3].classList.add('active');
                    console.log('Ë®≠ÁΩÆÁ∏ΩÊî∂ÂÖ•ÁÇ∫active:', tabs[3].textContent);
                }
            } else if (activeType === 'all') {
                if (tabs[4]) {
                    tabs[4].classList.add('active');
                    console.log('Ë®≠ÁΩÆÂÖ®ÈÉ®Ë®òÈåÑÁÇ∫active:', tabs[4].textContent);
                }
            }
            // member È°ûÂûã‰∏çÊõ¥Êñ∞Ê®ôÁ±§È†ÅÔºå‰øùÊåÅÁï∂ÂâçÁãÄÊÖã
        }

        // È°ØÁ§∫Ë®òÈåÑÁöÑÈÄöÁî®ÂáΩÊï∏
        function displayRecords(recordsToShow, title) {
            console.log('displayRecords Ë¢´Ë™øÁî®');
            console.log('Ë¶ÅÈ°ØÁ§∫ÁöÑË®òÈåÑÊï∏Èáè:', recordsToShow.length);
            console.log('Ê®ôÈ°å:', title);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', recordsToShow);
            
            if (recordsToShow.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑË¶ÅÈ°ØÁ§∫ÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã');
                document.getElementById('recentRecords').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®òÈåÑ</p>
                    </div>
                `;
                return;
            }
            
            // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let recordsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #333; margin-bottom: 15px;">${title}</h4>
                    <div class="records-container">
            `;
            
            recordsToShow.forEach(record => {
                const amount = record.amount;
                const amountClass = record.type === 'income' ? 'income' : 'expense';
                const prefix = record.type === 'income' ? '+' : '-';
                
                recordsHtml += `
                    <div class="record-item ${amountClass}">
                        <div class="record-info">
                            <h4>${record.member} - ${record.mainCategory}${record.subCategory ? ' - ' + record.subCategory : ''}</h4>
                            <p>${record.description || 'ÁÑ°ÊèèËø∞'}</p>
                            <p>${record.date}</p>
                            </div>
                        <div class="record-amount" style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'};">
                                ${prefix}$${record.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            recordsHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('recentRecords').innerHTML = recordsHtml;
        }

        function updateRecentRecords() {
            const recentRecords = records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentRecords');
            container.innerHTML = '';
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            recentRecords.forEach(record => {
                const recordElement = createRecordElement(record);
                container.appendChild(recordElement);
            });
        }

        function updateAllRecords() {
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÁÑ°Ë®òÈåÑ</p>';
                return;
            }

            records
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        function createRecordElement(record) {
            const div = document.createElement('div');
            div.className = `record-item ${record.type}`;
            
            const amountClass = record.type === 'income' ? 'income' : 'expense';
            const amountPrefix = record.type === 'income' ? '+' : '-';
            const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
            
            div.innerHTML = `
                <div class="record-info">
                    <h4>${record.member} - ${categoryText}</h4>
                    <p>${record.description || 'ÁÑ°ÊèèËø∞'}</p>
                    <p>${new Date(record.date).toLocaleDateString('zh-TW')}</p>
                </div>
                <div class="record-amount ${amountClass}">
                    ${amountPrefix}$${record.amount.toLocaleString()}
                </div>
                <div class="record-actions">
                    <button class="btn btn-small" onclick="editRecord('${record.id}')">Á∑®ËºØ</button>
                    <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')">Âà™Èô§</button>
                </div>
            `;
            
            return div;
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendarTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            
            calendarTitle.textContent = `${currentYear}Âπ¥${currentMonth + 1}Êúà`;
            
            // Ê∏ÖÁ©∫Êó•ÊõÜÔºà‰∏çÂåÖÂê´ÊòüÊúüÊ®ôÈ°åÔºåÂõ†ÁÇ∫HTML‰∏≠Â∑≤Á∂ìÊúâ‰∫ÜÔºâ
            calendarGrid.innerHTML = '';
            
            // Áç≤ÂèñÁï∂ÊúàÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂæå‰∏ÄÂ§©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ÁîüÊàê42Â§©Ôºà6ÈÄ±Ôºâ
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentMonth) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = formatDateToYYYYMMDD(date);
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-records" id="day-records-${dateStr}"></div>
                `;
                dayElement.id = `day-${dateStr}`;
                
                dayElement.onclick = () => showDayRecords(date);
                calendarGrid.appendChild(dayElement);
            }
            
            // Êõ¥Êñ∞ÊØèÊó•Ë®òÈåÑ
            updateDayRecords();
        }

        function updateDayRecords() {
            console.log('üìÖ updateDayRecords: ÈñãÂßãÊõ¥Êñ∞Êó•ÊõÜË®òÈåÑ');
            console.log('üìÖ Áï∂ÂâçrecordsÊï∏Èáè:', records.length);
            
            // ÂÖàÊ∏ÖÁ©∫ÊâÄÊúâÊó•ÊúüÁöÑË®òÈåÑ
            document.querySelectorAll('.day-records').forEach(element => {
                element.innerHTML = '';
            });
            
            // ÊåâÊó•ÊúüÂíåÊàêÂì°ÂàÜÁµÑË®àÁÆóÁ∏ΩÈ°ç
            const dayMemberTotals = {};
            records.forEach(record => {
                const date = record.date;
                const member = record.member;
                const amount = record.type === 'income' ? record.amount : -record.amount;
                
                if (!dayMemberTotals[date]) {
                    dayMemberTotals[date] = {};
                }
                if (!dayMemberTotals[date][member]) {
                    dayMemberTotals[date][member] = 0;
                }
                dayMemberTotals[date][member] += amount;
            });
            
            // È°ØÁ§∫ÊØèÂÄãÊàêÂì°ÁöÑÁï∂Êó•Á∏ΩÈ°ç
            Object.keys(dayMemberTotals).forEach(date => {
                const dayRecordsElement = document.getElementById(`day-records-${date}`);
                if (dayRecordsElement) {
                    const memberTotals = dayMemberTotals[date];
                    Object.keys(memberTotals).forEach(member => {
                        const total = memberTotals[member];
                        if (total !== 0) {
                            const recordClass = total > 0 ? 'day-income' : 'day-expense';
                            const prefix = total > 0 ? '+' : '';
                            
                            const recordDiv = document.createElement('div');
                            recordDiv.className = recordClass;
                            recordDiv.textContent = `${member}: ${prefix}$${Math.abs(total).toLocaleString()}`;
                            dayRecordsElement.appendChild(recordDiv);
                        }
                    });
                    
                    // Â¶ÇÊûúÊúâË®òÈåÑÔºåÊ∑ªÂä†has-recordsÈ°û
                    if (dayRecordsElement.children.length > 0) {
                        const dayElement = dayRecordsElement.closest('.calendar-day');
                        if (dayElement) {
                            dayElement.classList.add('has-records');
                        }
                    }
                }
            });
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function showDayRecords(date) {
            const dayRecords = records.filter(record => record.date === formatDateToYYYYMMDD(date));
            
            if (dayRecords.length === 0) {
                // ‰∏çÈ°ØÁ§∫ÊèêÈÜíÔºåÁõ¥Êé•ËøîÂõû
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} ÁöÑË®òÈåÑÔºö\n\n`;
            dayRecords.forEach(record => {
                const prefix = record.type === 'income' ? '+' : '-';
                const categoryText = record.subCategory ? `${record.mainCategory} - ${record.subCategory}` : record.mainCategory;
                message += `${record.member} - ${categoryText}: ${prefix}$${record.amount}\n`;
                if (record.description) {
                    message += `  ÊèèËø∞: ${record.description}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberFilter = document.getElementById('memberFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredRecords = records.filter(record => {
                const matchesSearch = !searchTerm || 
                    record.member.toLowerCase().includes(searchTerm) ||
                    record.mainCategory.toLowerCase().includes(searchTerm) ||
                    (record.subCategory && record.subCategory.toLowerCase().includes(searchTerm)) ||
                    record.description.toLowerCase().includes(searchTerm);
                
                const matchesMember = !memberFilter || record.member === memberFilter;
                
                const matchesType = !typeFilter || record.type === typeFilter;
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                return matchesSearch && matchesMember && matchesType && matchesDate;
            });
            
            const container = document.getElementById('allRecords');
            container.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ</p>';
                return;
            }
            
            filteredRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(record => {
                    const recordElement = createRecordElement(record);
                    container.appendChild(recordElement);
                });
        }

        // Ë°®ÂñÆÊèê‰∫§
        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('member').value;
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            let mainCategory = document.getElementById('mainCategory').value;
            const customMainCategory = document.getElementById('customMainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const date = document.getElementById('date').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!type) {
                alert('Ë´ãÈÅ∏ÊìáÈ°ûÂûãÔºàÊî∂ÂÖ•/ÊîØÂá∫ÔºâÔºÅ');
                return;
            }
            
            if (!amount || amount === 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºàÊ≠£Êï∏ÔºâÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÈÅ∏Êìá‰∫Ü"ÂÖ∂‰ªñ"Ôºå‰ΩøÁî®Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
            if (mainCategory === 'ÂÖ∂‰ªñ') {
                if (!customMainCategory.trim()) {
                    alert('Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•ÔºÅ');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Ë®≠ÁÇ∫‰ªäÂ§©ÁöÑÁµêÊùüÊôÇÈñì
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const record = {
                id: Date.now().toString(),
                member: member,
                type: type,
                amount: amount, // Â≠òÂÑ≤Ê≠£Êï∏ÈáëÈ°ç
                mainCategory: mainCategory,
                subCategory: subCategory,
                description: document.getElementById('description').value,
                date: date
            };
            
            try {
                console.log('‚ûï ÈñãÂßãÂêëJSONÊñá‰ª∂Ê∑ªÂä†Ë®òÈåÑ...');
                
                // ‰ΩøÁî®JSONÊñá‰ª∂Ê∑ªÂä†API
                const addResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(record)
                });
                
                const addResult = await addResponse.json();
                
                if (addResult.success) {
                    console.log('‚úÖ Ë®òÈåÑÂ∑≤Ê∑ªÂä†:', addResult.message);
                    showNotification('Ë®òÈåÑÊ∑ªÂä†ÊàêÂäüÔºåÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂', 'success');
                    
                    // Ê∑ªÂä†Âà∞ÂâçÁ´ØÊï∏ÁµÑ
                    records.push(record);
                    // localStorageÁ∑©Â≠òÂ∑≤ÁßªÈô§
            
            // ÈáçÁΩÆË°®ÂñÆ
            this.reset();
            setTodayDate();
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateStats();
            updateRecentRecords();
            updateAllRecords();
                    updateCalendar();
                    updateSyncStatus();
                    
                    alert('‚úÖ Ë®òÈåÑÂ∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ');
                } else {
                    console.error('‚ùå JSONÊñá‰ª∂Ê∑ªÂä†Â§±Êïó:', addResult.message);
                    alert('‚ùå Ë®òÈåÑÊ∑ªÂä†Â§±ÊïóÔºö' + addResult.message);
                }
            } catch (error) {
                console.error('‚ùå Ê∑ªÂä†Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§:', error);
                alert('‚ùå Ê∑ªÂä†Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
            }
        });

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMember').value = record.member;
            document.getElementById('editType').value = record.type;
            document.getElementById('editAmount').value = record.amount;
            
            // Êõ¥Êñ∞È°ûÂà•ÈÅ∏È†Ö
            const editTypeSelect = document.getElementById('editType');
            const editMainCategorySelect = document.getElementById('editMainCategory');
            const editSubCategorySelect = document.getElementById('editSubCategory');
            
            // ÂÖàÊõ¥Êñ∞‰∏ªÈ°ûÂà•ÈÅ∏È†Ö
            const type = editTypeSelect.value;
            editMainCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá</option>';
            if (type === 'income') {
                categories.income.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
            } else if (type === 'expense') {
                // Áç≤ÂèñÊâÄÊúâÊîØÂá∫È°ûÂà•ÔºàÊéíÈô§"ÂÖ∂‰ªñ"Ôºâ
                const expenseCategories = Object.keys(categories.expense).filter(cat => cat !== 'ÂÖ∂‰ªñ');
                expenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editMainCategorySelect.appendChild(option);
                });
                // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
                const otherOption = document.createElement('option');
                otherOption.value = 'ÂÖ∂‰ªñ';
                otherOption.textContent = 'ÂÖ∂‰ªñ';
                editMainCategorySelect.appendChild(otherOption);
            }
            
            // ÁÑ∂ÂæåË®≠ÁΩÆ‰∏ªÈ°ûÂà•ÂÄº
            const predefinedCategories = [...categories.income, ...Object.keys(categories.expense)];
            if (predefinedCategories.includes(record.mainCategory)) {
                document.getElementById('editMainCategory').value = record.mainCategory;
                document.getElementById('editCustomMainCategory').style.display = 'none';
                document.getElementById('editCustomMainCategory').value = '';
            } else {
                document.getElementById('editMainCategory').value = 'ÂÖ∂‰ªñ';
                document.getElementById('editCustomMainCategory').style.display = 'block';
                document.getElementById('editCustomMainCategory').value = record.mainCategory;
            }
            
            document.getElementById('editSubCategory').value = record.subCategory;
            document.getElementById('editDescription').value = record.description;
            document.getElementById('editDate').value = record.date;
            
            // Êõ¥Êñ∞Â≠êÈ°ûÂà•Ôºà‰ªòÊ¨æÊñπÂºèÔºâ
            const mainCategory = editMainCategorySelect.value;
            editSubCategorySelect.innerHTML = '<option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>';
            
            // Ê∑ªÂä†‰ªòÊ¨æÊñπÂºèÈÅ∏È†Ö
            const paymentMethods = ['‰ø°Áî®Âç°', 'ÁèæÈáë'];
            paymentMethods.forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                editSubCategorySelect.appendChild(option);
            });
            
            // Â¶ÇÊûúÊúâÈ†êÂÆöÁæ©ÁöÑÂ≠êÈ°ûÂà•Ôºå‰πüÊ∑ªÂä†ÂÆÉÂÄë
            if (type === 'expense' && mainCategory && categories.expense[mainCategory]) {
                categories.expense[mainCategory].forEach(subCategory => {
                    // ÈÅøÂÖçÈáçË§áÊ∑ªÂä†‰ªòÊ¨æÊñπÂºè
                    if (!paymentMethods.includes(subCategory)) {
                        const option = document.createElement('option');
                        option.value = subCategory;
                        option.textContent = subCategory;
                        editSubCategorySelect.appendChild(option);
                    }
                });
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Êï∏ÊìöÈ©óË≠â
            const member = document.getElementById('editMember').value;
            const type = document.getElementById('editType').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            let mainCategory = document.getElementById('editMainCategory').value;
            const customMainCategory = document.getElementById('editCustomMainCategory').value;
            const subCategory = document.getElementById('editSubCategory').value;
            const date = document.getElementById('editDate').value;
            
            if (!member) {
                alert('Ë´ãÈÅ∏ÊìáÊàêÂì°ÔºÅ');
                return;
            }
            
            if (!type) {
                alert('Ë´ãÈÅ∏ÊìáÈ°ûÂûãÔºÅ');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºÅ');
                return;
            }
            
            if (!mainCategory) {
                alert('Ë´ãÈÅ∏Êìá‰∏ªÈ°ûÂà•ÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÈÅ∏Êìá‰∫Ü"ÂÖ∂‰ªñ"Ôºå‰ΩøÁî®Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
            if (mainCategory === 'ÂÖ∂‰ªñ') {
                if (!customMainCategory.trim()) {
                    alert('Ë´ãËº∏ÂÖ•Ëá™ÂÆöÁæ©‰∏ªÈ°ûÂà•ÔºÅ');
                    return;
                }
                mainCategory = customMainCategory.trim();
            }
            
            if (!subCategory) {
                alert('Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºèÔºÅ');
                return;
            }
            
            if (!date) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Êó•ÊúüÊòØÂê¶ÁÇ∫Êú™‰æÜÊó•Êúü
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (selectedDate > today) {
                alert('‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•ÊúüÔºÅ');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                // Ê∫ñÂÇôÊõ¥Êñ∞Êï∏Êìö
                const updatedRecord = {
                    id: id,
                    member: member,
                    type: type,
                    amount: amount,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    description: document.getElementById('editDescription').value,
                    date: date
                };
                
                try {
                    // Ë™øÁî®ÂæåÁ´Ø API Êõ¥Êñ∞Ë®òÈåÑ
                    const response = await fetch(ENV_CONFIG.getApiBase() + `/api/records/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedRecord)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ Ë®òÈåÑÂ∑≤Êõ¥Êñ∞:', result.message);
                        showNotification('Ë®òÈåÑÊõ¥Êñ∞ÊàêÂäüÔºåÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂', 'success');
                        
                        // Êõ¥Êñ∞ÂâçÁ´ØÊï∏ÁµÑ
                        records[recordIndex] = updatedRecord;
                        
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        closeModal();
                    } else {
                        console.error('‚ùå Êõ¥Êñ∞Ë®òÈåÑÂ§±Êïó:', result.message);
                        alert('‚ùå Êõ¥Êñ∞Ë®òÈåÑÂ§±Êïó: ' + result.message);
                    }
                } catch (error) {
                    console.error('‚ùå Êõ¥Êñ∞Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§:', error);
                    alert('‚ùå Êõ¥Êñ∞Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            }
        });

        async function deleteRecord(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')) {
                try {
                    console.log('üóëÔ∏è ÈñãÂßãÂæûJSONÊñá‰ª∂Âà™Èô§Ë®òÈåÑ:', id);
                    
                    // ‰ΩøÁî®JSONÊñá‰ª∂Âà™Èô§API
                    const deleteResponse = await fetch(ENV_CONFIG.getApiBase() + `/api/records/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const deleteResult = await deleteResponse.json();
                    
                    if (deleteResult.success) {
                        console.log('‚úÖ Ë®òÈåÑÂ∑≤Âà™Èô§:', deleteResult.message);
                        showNotification('Ë®òÈåÑÂà™Èô§ÊàêÂäüÔºåÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂', 'success');
                        
                        // ÂæûÂâçÁ´ØÊï∏ÁµÑ‰∏≠ÁßªÈô§Ë®òÈåÑ
                records = records.filter(record => record.id !== id);
                        // localStorageÁ∑©Â≠òÂ∑≤ÁßªÈô§
                        
                        // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                        updateCalendar();
                        updateSyncStatus();
                        
                        alert('‚úÖ Ë®òÈåÑÂ∑≤ÊàêÂäüÂà™Èô§ÔºÅ');
                    } else {
                        console.error('‚ùå JSONÊñá‰ª∂Âà™Èô§Â§±Êïó:', deleteResult.message);
                        alert('‚ùå Ë®òÈåÑÂà™Èô§Â§±ÊïóÔºö' + deleteResult.message);
                    }
                } catch (error) {
                    console.error('‚ùå Âà™Èô§Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§:', error);
                    alert('‚ùå Âà™Èô§Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            }
        }

        // saveRecordsÂáΩÊï∏Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂

        // ÂØ´ÂÖ• data.json Ê™îÊ°àÔºàÈÄöÈÅé‰∏ãËºâÊñπÂºèÔºâ
        function saveToDataJson() {
            try {
                const now = new Date();
                const dataToSave = {
                    records: records,
                    settings: {
                        version: "1.0",
                        lastUpdated: now.toISOString()
                    }
                };
                
                // ÂÇô‰ªΩÊôÇÈñìË®òÈåÑÂ∑≤ÁßªÈô§
                
                // ÂâµÂª∫‰∏¶‰∏ãËºâ data.json Ê™îÊ°à
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.json';
                
                // ÈùúÈªò‰∏ãËºâÔºà‰∏çÈ°ØÁ§∫‰∏ãËºâÂ∞çË©±Ê°ÜÔºâ
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ÊàêÂäüÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à');
                
                // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫
                updateDataStats();
            } catch (error) {
                console.warn('ÁÑ°Ê≥ïÁîüÊàê data.json ÂÇô‰ªΩÊ™îÊ°à:', error);
            }
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            recurringExpenses.forEach(expense => {
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìË®òÈåÑ‰∫ÜÈÄôÂÄãÊúàÁöÑÂõ∫ÂÆöÊîØÂá∫
                const thisMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const existingRecord = records.find(record => 
                    record.member === expense.member &&
                    record.description.includes(expense.name) &&
                    record.date.startsWith(thisMonth)
                );
                
                // Â¶ÇÊûú‰ªäÂ§©ÊòØÂõ∫ÂÆöÊîØÂá∫ÁöÑÊó•Êúü‰∏îÈÇÑÊ≤íÊúâË®òÈåÑÔºåÈ°ØÁ§∫ÊèêÈÜí
                if (currentDay === expense.day && !existingRecord) {
                    const confirmAdd = confirm(`ÊèêÈÜíÔºö‰ªäÂ§©ÊòØ ${expense.name} ÁöÑÁπ≥Ë≤ªÊó•Ôºà$${expense.amount.toLocaleString()}ÔºâÔºåÊòØÂê¶Ë¶ÅÊñ∞Â¢ûÈÄôÁ≠ÜË®òÈåÑÔºü`);
                    if (confirmAdd) {
                        // Ê†πÊìöË≤ªÁî®ÂêçÁ®±Ê±∫ÂÆöÊ≠£Á¢∫ÁöÑÈ°ûÂà•
                        let mainCategory, subCategory;
                        if (expense.name === 'ÊàøÁßü') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøÁßü';
                        } else if (expense.name === 'ÊàøË≤∏') {
                            mainCategory = 'Â±Ö‰Ωè';
                            subCategory = 'ÊàøË≤∏';
                        } else if (expense.name === 'ÊâãÊ©üË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'ÊâãÊ©üË≤ª';
                        } else if (expense.name === 'Á∂≤Ë∑ØË≤ª') {
                            mainCategory = 'Êó•Â∏∏';
                            subCategory = 'Á∂≤Ë∑ØË≤ª';
                        }
                        
                        const record = {
                            id: Date.now().toString(),
                            member: expense.member,
                            type: 'expense',
                            amount: expense.amount,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            description: `${expense.name} - ${thisMonth}`,
                            date: today.toISOString().split('T')[0]
                        };
                        
                        records.push(record);
                        // saveRecords() Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂
                        updateStats();
                        updateRecentRecords();
                        updateAllRecords();
                        updateCalendar();
                        
                        // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub - Â∑≤ÁßªÈô§
                        
                        alert(`${expense.name} Ë®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ`);
                    }
                }
            });
        }

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // CSV ÂåØÂÖ•ÂäüËÉΩ
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('CSV Ê™îÊ°àËß£ÊûêÈåØË™§Ôºö' + results.errors[0].message);
                        return;
                    }
                    processImportData(results.data);
                },
                error: function(error) {
                    alert('ËÆÄÂèñ CSV Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            });
        }

        // Excel ÂåØÂÖ•ÂäüËÉΩ
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ‰ΩøÁî® raw: false ‰æÜÁç≤ÂèñÊ†ºÂºèÂåñÁöÑÂÄº
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        dateNF: 'yyyy-mm-dd' // ÊåáÂÆöÊó•ÊúüÊ†ºÂºè
                    });
                    
                    console.log('Excel Ëß£ÊûêÁµêÊûú:', jsonData);
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Excel ËÆÄÂèñÈåØË™§:', error);
                    alert('ËÆÄÂèñ Excel Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ËôïÁêÜÂåØÂÖ•Êï∏Êìö
        function processImportData(data) {
            importData = [];
            const errors = [];
            const warnings = [];

            console.log('ÂéüÂßãÊï∏Êìö:', data);

            data.forEach((row, index) => {
                console.log(`ËôïÁêÜÁ¨¨ ${index + 1} Ë°å:`, row);
                const record = validateImportRecord(row, index + 1);
                if (record) {
                    importData.push(record);
                } else {
                    errors.push(`Á¨¨ ${index + 1} Ë°åÊï∏ÊìöÁÑ°Êïà`);
                }
            });

            if (errors.length > 0) {
                alert('ÁôºÁèæ‰ª•‰∏ãÈåØË™§Ôºö\n' + errors.join('\n') + '\n\nË´ãÊ™¢Êü•Êï∏ÊìöÊ†ºÂºèÊòØÂê¶Ê≠£Á¢∫„ÄÇ');
            }

            if (warnings.length > 0) {
                console.warn('Ë≠¶Âëä:', warnings);
            }

            showImportPreview();
        }

        // È©óË≠âÂåØÂÖ•Ë®òÈåÑ
        function validateImportRecord(row, rowNumber) {
            const requiredFields = ['ÊàêÂì°', 'ÈáëÈ°ç', '‰∏ªÈ°ûÂà•', 'Â≠êÈ°ûÂà•', 'ÊèèËø∞', 'Êó•Êúü'];
            const errors = [];
            
            console.log(`È©óË≠âÁ¨¨ ${rowNumber} Ë°å:`, row);
            
            // Ê™¢Êü•ÂøÖË¶ÅÊ¨Ñ‰Ωç
            for (let field of requiredFields) {
                if (!row[field] && row[field] !== 0) {
                    errors.push(`Áº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰ΩçÔºö${field}`);
                }
            }
            
            // È©óË≠â‰ªòÊ¨æÊñπÂºèÔºàÂ≠êÈ°ûÂà•Ôºâ
            const paymentMethod = row['Â≠êÈ°ûÂà•'];
            if (paymentMethod && !['‰ø°Áî®Âç°', 'ÁèæÈáë'].includes(paymentMethod)) {
                errors.push(`‰ªòÊ¨æÊñπÂºèÁÑ°ÊïàÔºö${paymentMethod} (ÊúâÊïàÂÄº: ‰ø°Áî®Âç°, ÁèæÈáë)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈåØË™§:`, errors);
                return null;
            }

            // È©óË≠âÊàêÂì°
            if (!familyMembers.includes(row['ÊàêÂì°'])) {
                errors.push(`ÊàêÂì°ÁÑ°ÊïàÔºö${row['ÊàêÂì°']} (ÊúâÊïàÂÄº: ${familyMembers.join(', ')})`);
            }

            // È©óË≠âÈáëÈ°ç
            let amountValue = row['ÈáëÈ°ç'];
            
            // Ê∏ÖÁêÜÈáëÈ°çÂ≠óÁ¨¶‰∏≤
            if (typeof amountValue === 'string') {
                // ÂÖàËôïÁêÜÊã¨ËôüÊ†ºÂºèÔºàÊúÉË®àÊ†ºÂºèÔºâ
                if (amountValue.includes('(') && amountValue.includes(')')) {
                    amountValue = '-' + amountValue.replace(/[()]/g, '');
                }
                
                // ÁßªÈô§Ë≤®Âπ£Á¨¶Ëôü„ÄÅÁ©∫Ê†ºÁ≠âÔºå‰ΩÜ‰øùÁïôË≤†ËôüÂíåÈÄóËôü
                amountValue = amountValue.toString().replace(/[¬•Ôø•\s]/g, '');
                
                // ÁßªÈô§ÂçÉÂàÜ‰ΩçÈÄóËôü
                amountValue = amountValue.replace(/,/g, '');
                
                // ÁßªÈô§ÁæéÂÖÉÁ¨¶ËôüÔºàÂú®ÈÄóËôüËôïÁêÜÂæåÔºâ
                amountValue = amountValue.replace(/\$/g, '');
            }
            
            const amount = parseFloat(amountValue);
            console.log(`Á¨¨ ${rowNumber} Ë°åÈáëÈ°çËß£Êûê:`, {
                'ÂéüÂßãÂÄº': row['ÈáëÈ°ç'],
                'Ê∏ÖÁêÜÂæå': amountValue,
                'Ëß£ÊûêÂæå': amount,
                'È°ûÂûã': typeof row['ÈáëÈ°ç']
            });
            
            if (isNaN(amount) || amount === 0) {
                errors.push(`ÈáëÈ°çÁÑ°ÊïàÔºö${row['ÈáëÈ°ç']} (Ê∏ÖÁêÜÂæå: ${amountValue}, Ëß£ÊûêÂæå: ${amount})`);
            }

            // Ê†πÊìöÈáëÈ°çÊ≠£Ë≤†Êï∏Âà§Êñ∑È°ûÂûã
            const type = amount > 0 ? 'income' : 'expense';
            const absAmount = Math.abs(amount); // ÂÖßÈÉ®Â≠òÂÑ≤‰ΩøÁî®ÁµïÂ∞çÂÄº

            // È©óË≠âÊó•Êúü
            let dateStr = row['Êó•Êúü'];
            // ËôïÁêÜ‰∏çÂêåÁöÑÊó•ÊúüÊ†ºÂºè
            if (typeof dateStr === 'string') {
                // Â¶ÇÊûúÊòØ Excel Êó•ÊúüÊï∏Â≠óÔºåËΩâÊèõÁÇ∫Êó•Êúü
                if (!isNaN(dateStr) && dateStr > 25569) { // Excel Êó•ÊúüËµ∑ÂßãÂÄº
                    const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                    dateStr = formatDateToYYYYMMDD(excelDate);
                } else {
                    // ËôïÁêÜÊñúÁ∑öÂàÜÈöîÁöÑÊó•ÊúüÊ†ºÂºè (2025/09/01 -> 2025-09-01)
                    dateStr = dateStr.replace(/\//g, '-');
                }
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                errors.push(`Êó•ÊúüÁÑ°ÊïàÔºö${row['Êó•Êúü']} (Ê†ºÂºè: YYYY-MM-DD)`);
            }

            if (errors.length > 0) {
                console.error(`Á¨¨ ${rowNumber} Ë°åÈ©óË≠âÂ§±Êïó:`, errors);
                return null;
            }

            return {
                id: generateUniqueId(),
                member: row['ÊàêÂì°'],
                type: type,
                amount: absAmount,
                mainCategory: row['‰∏ªÈ°ûÂà•'],
                subCategory: row['Â≠êÈ°ûÂà•'],
                description: row['ÊèèËø∞'] || '',
                date: dateStr
            };
        }

        // È°ØÁ§∫ÂåØÂÖ•È†êË¶Ω
        function showImportPreview() {
            const previewDiv = document.getElementById('importPreview');
            const tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            importData.forEach((record, index) => {
                const row = document.createElement('tr');
                const isValid = validateRecord(record);
                
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                    <td class="${isValid ? 'status-valid' : 'status-invalid'}">
                        ${isValid ? '‚úì ÊúâÊïà' : '‚úó ÁÑ°Êïà'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // È©óË≠âË®òÈåÑ
        function validateRecord(record) {
            return familyMembers.includes(record.member) &&
                   ['income', 'expense'].includes(record.type) &&
                   record.amount > 0 &&
                   record.mainCategory &&
                   record.date;
        }

        // Á¢∫Ë™çÂåØÂÖ•
        function confirmImport() {
            const validRecords = importData.filter(record => validateRecord(record));
            
            if (validRecords.length === 0) {
                alert('Ê≤íÊúâÊúâÊïàÁöÑË®òÈåÑÂèØ‰ª•ÂåØÂÖ•ÔºÅ');
                return;
            }

            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicateCheck = checkForDuplicates(validRecords);
            const newRecords = duplicateCheck.newRecords;
            const duplicates = duplicateCheck.duplicates;

            if (duplicates.length > 0) {
                const duplicateInfo = duplicates.map(dup => 
                    `${dup.member} - ${dup.mainCategory} - $${dup.amount} - ${dup.date}`
                ).join('\n');
                
                if (newRecords.length === 0) {
                    alert(`ÊâÄÊúâË®òÈåÑÈÉΩÊòØÈáçË§áÁöÑÔºÅ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nË´ãÊ™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂåØÂÖ•ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ`);
                    return;
                } else {
                    const proceed = confirm(`ÁôºÁèæ ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑÔºåÂ∞áË∑≥ÈÅéÈÄô‰∫õË®òÈåÑ„ÄÇ\n\nÈáçË§áÁöÑË®òÈåÑÔºö\n${duplicateInfo}\n\nÁ¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜÊñ∞Ë®òÈåÑÂóéÔºü`);
                    if (!proceed) {
                        return;
                    }
                }
            }

            if (confirm(`Á¢∫ÂÆöË¶ÅÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÂóéÔºü`)) {
                records = records.concat(newRecords);
                // saveRecords() Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂
                
                // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub - Â∑≤ÁßªÈô§
                
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                
                // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊèõÂà∞2025Âπ¥
                checkAndSwitchTo2025();
                
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateSyncStatus(); // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã
                
                let message = `ÊàêÂäüÂåØÂÖ• ${newRecords.length} Á≠ÜË®òÈåÑÔºÅ`;
                if (duplicates.length > 0) {
                    message += `\nË∑≥ÈÅé‰∫Ü ${duplicates.length} Á≠ÜÈáçË§áË®òÈåÑ„ÄÇ`;
                }
                alert(message);
                cancelImport();
            }
        }

        // Ê™¢Êü•ÈáçË§áË®òÈåÑ
        function checkForDuplicates(importRecords) {
            const newRecords = [];
            const duplicates = [];
            
            importRecords.forEach(importRecord => {
                // Ê™¢Êü•ÊòØÂê¶ËàáÁèæÊúâË®òÈåÑÈáçË§á
                const isDuplicate = records.some(existingRecord => {
                    return existingRecord.member === importRecord.member &&
                           existingRecord.amount === importRecord.amount &&
                           existingRecord.mainCategory === importRecord.mainCategory &&
                           existingRecord.subCategory === importRecord.subCategory &&
                           existingRecord.date === importRecord.date &&
                           existingRecord.description === importRecord.description;
                });
                
                if (isDuplicate) {
                    duplicates.push(importRecord);
                } else {
                    newRecords.push(importRecord);
                }
            });
            
            return { newRecords, duplicates };
        }

        // ÂèñÊ∂àÂåØÂÖ•
        function cancelImport() {
            importData = [];
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFile').value = '';
        }





        // ‰∏ãËºâ Excel Ê†ºÂºèÂÇô‰ªΩÔºàÂèØÈáçÊñ∞ÂåØÂÖ•Ôºâ
        function downloadExcelBackup() {
            if (records.length === 0) {
                alert('Ê≤íÊúâË®òÈåÑÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            // Â∞áË®òÈåÑËΩâÊèõÁÇ∫ Excel Ê†ºÂºè (7Ê¨ÑÊ†ºÂºè)
            const excelData = records.map(record => ({
                'ÊàêÂì°': record.member,
                'ÈáëÈ°ç': record.amount, // ‰øùÊåÅÂéüÂßãÈáëÈ°çÔºå‰∏çËΩâÊèõÊ≠£Ë≤†Ëôü
                'È°ûÂà•': record.type === 'income' ? 'Êî∂ÂÖ•' : 'ÊîØÂá∫',
                '‰∏ªÈ°ûÂà•': record.mainCategory,
                '‰ªòÊ¨æÊñπÂºè': record.subCategory || 'ÁèæÈáë',
                'ÊèèËø∞': record.description || '',
                'Êó•Êúü': record.date
            }));

            // ÂâµÂª∫ Excel Â∑•‰ΩúË°®
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ÂÆ∂Â∫≠Êî∂ÊîØË®òÈåÑ');
            
            // ‰∏ãËºâÊ™îÊ°à
            const fileName = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`ÊàêÂäü‰∏ãËºâ Excel ÂÇô‰ªΩÊ™îÊ°àÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ\nÊ™îÊ°àÂêç: ${fileName}\n\nÊ≠§Ê™îÊ°àÂèØ‰ª•Áõ¥Êé•ÈáçÊñ∞ÂåØÂÖ•Á≥ªÁµ±„ÄÇ`);
        }











        // Êõ¥Êñ∞Êï∏ÊìöÁµ±Ë®à
        // Êõ¥Êñ∞ÂêåÊ≠•ÁãÄÊÖã - Â∑≤ÁßªÈô§ÂÇô‰ªΩÁõ∏ÈóúÂäüËÉΩ
        function updateSyncStatus() {
            // ÂêåÊ≠•ÁãÄÊÖãÂäüËÉΩÂ∑≤ÁßªÈô§ - ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÈúÄË¶ÅÂêåÊ≠•ÁãÄÊÖã
            // Âè™‰øùÁïôÊï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•
            checkDataHealth();
        }

        // Êï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•
        function checkDataHealth() {
            console.log('üîç ÈñãÂßãÊï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•...');
            
            const healthIssues = [];
            const warnings = [];
            
            // Ê™¢Êü•Ë®òÈåÑÊï∏Èáè
            if (records.length === 0) {
                healthIssues.push('‚ùå Ê≤íÊúâÊï∏ÊìöË®òÈåÑ');
            } else if (records.length > 1000) {
                warnings.push('‚ö†Ô∏è Ë®òÈåÑÊï∏ÈáèÈÅéÂ§ö (' + records.length + ' Á≠Ü)');
            }
            
            // Ê™¢Êü•Êï∏ÊìöÂÆåÊï¥ÊÄß
            const invalidRecords = records.filter(record => 
                !record.id || !record.member || !record.type || !record.amount || !record.date
            );
            if (invalidRecords.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidRecords.length} Á≠ÜÁÑ°ÊïàË®òÈåÑ`);
            }
            
            // Ê™¢Êü•ÈáçË§áË®òÈåÑ
            const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            if (duplicateIds.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${duplicateIds.length} Á≠ÜÈáçË§áID`);
            }
            
            // Ê™¢Êü•Êó•ÊúüÊ†ºÂºè
            const invalidDates = records.filter(record => {
                const date = new Date(record.date);
                return isNaN(date.getTime());
            });
            if (invalidDates.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidDates.length} Á≠ÜÁÑ°ÊïàÊó•Êúü`);
            }
            
            // Ê™¢Êü•ÈáëÈ°ç
            const invalidAmounts = records.filter(record => 
                isNaN(record.amount) || record.amount === 0
            );
            if (invalidAmounts.length > 0) {
                healthIssues.push(`‚ùå ÁôºÁèæ ${invalidAmounts.length} Á≠ÜÁÑ°ÊïàÈáëÈ°ç`);
            }
            
            // localStorageÊ™¢Êü•Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•ÂæûJSONÊñá‰ª∂ËÆÄÂèñ
            
            // Êõ¥Êñ∞ÂÅ•Â∫∑ÁãÄÊÖãÈ°ØÁ§∫
            let healthStatus = '‚úÖ ÂÅ•Â∫∑';
            let healthColor = '#28a745';
            
            if (healthIssues.length > 0) {
                healthStatus = `‚ùå ${healthIssues.length} ÂÄãÂïèÈ°å`;
                healthColor = '#dc3545';
            } else if (warnings.length > 0) {
                healthStatus = `‚ö†Ô∏è ${warnings.length} ÂÄãË≠¶Âëä`;
                healthColor = '#ffc107';
            }
            
            const healthElement = document.getElementById('dataHealth');
            if (healthElement) {
                healthElement.textContent = healthStatus;
                healthElement.style.color = healthColor;
            }
            
            // Ëº∏Âá∫Ë©≥Á¥∞Â†±Âëä
            console.log('üìä Êï∏ÊìöÂÅ•Â∫∑Ê™¢Êü•Â†±Âëä:');
            console.log(`Á∏ΩË®òÈåÑÊï∏: ${records.length}`);
            console.log(`ÂÅ•Â∫∑ÂïèÈ°å: ${healthIssues.length}`);
            console.log(`Ë≠¶Âëä: ${warnings.length}`);
            
            if (healthIssues.length > 0) {
                console.log('‚ùå ÂÅ•Â∫∑ÂïèÈ°å:', healthIssues);
            }
            if (warnings.length > 0) {
                console.log('‚ö†Ô∏è Ë≠¶Âëä:', warnings);
            }
            
            return {
                healthy: healthIssues.length === 0,
                issues: healthIssues,
                warnings: warnings,
                totalRecords: records.length
            };
        }

        // GitHub Token ÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ - ÂÇô‰ªΩÂäüËÉΩÂ∑≤ÁßªÈô§
        async function checkTokenStatus() {
            console.log('üîë TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∑≥ÈÅéÊ™¢Êü•...');
            
            // Ê™¢Êü•DOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂâáË∑≥ÈÅé
            const tokenStatus = document.getElementById('tokenStatus');
            const deleteBtn = document.getElementById('deleteTokenBtn');
            
            if (tokenStatus) {
                tokenStatus.innerHTML = `
                    <p>‚ÑπÔ∏è <strong>TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§</strong></p>
                    <p>Á≥ªÁµ±ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÂÜçÈúÄË¶ÅGitHub TokenÂÇô‰ªΩ</p>
                `;
                tokenStatus.style.color = '#6c757d';
            }
            
            if (deleteBtn) {
                deleteBtn.style.display = 'none';
            }
        }

        async function saveGitHubToken() {
            alert('‚ö†Ô∏è TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§\n\nÁ≥ªÁµ±ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÂÜçÈúÄË¶ÅGitHub TokenÂÇô‰ªΩÂäüËÉΩ„ÄÇ');
            return;
        }

        async function deleteGitHubToken() {
            alert('‚ö†Ô∏è TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§\n\nÁ≥ªÁµ±ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÂÜçÈúÄË¶ÅGitHub TokenÂÇô‰ªΩÂäüËÉΩ„ÄÇ');
            return;
        }

        // ÂæûÂÇô‰ªΩÊÅ¢Âæ©TokenÂäüËÉΩÂ∑≤ÁßªÈô§
        async function recoverTokenFromBackup() {
            alert('‚ö†Ô∏è TokenÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªÈô§\n\nÁ≥ªÁµ±ÁèæÂú®‰ΩøÁî®JSONÊñá‰ª∂Â≠òÂÑ≤Ôºå‰∏çÂÜçÈúÄË¶ÅGitHub TokenÂÇô‰ªΩÂäüËÉΩ„ÄÇ');
            return;
        }

        // Âø´ÈÄü‰øÆÂæ©ÂäüËÉΩ
        async function quickFix() {
            console.log('üîß ÈñãÂßãÂø´ÈÄü‰øÆÂæ©...');
            
            const fixes = [];
            
            try {
                // 1. Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö
                console.log('üîÑ Ê≠•È©ü1: Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö...');
                await loadDataFromFile();
                fixes.push('‚úÖ ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö');
                
                // 2. Ê™¢Êü•‰∏¶‰øÆÂæ©ÈáçË§áID
                console.log('üîç Ê≠•È©ü2: Ê™¢Êü•ÈáçË§áID...');
                const duplicateIds = records.map(r => r.id).filter((id, index, arr) => arr.indexOf(id) !== index);
                if (duplicateIds.length > 0) {
                    // ÁÇ∫ÈáçË§áIDÁîüÊàêÊñ∞ÁöÑÂîØ‰∏ÄID
                    const idMap = new Map();
                    records.forEach(record => {
                        if (idMap.has(record.id)) {
                            record.id = Date.now() + Math.random().toString(36).substr(2, 9);
                        }
                        idMap.set(record.id, true);
                    });
                    fixes.push(`‚úÖ ‰øÆÂæ© ${duplicateIds.length} ÂÄãÈáçË§áID`);
                }
                
                // 3. Ê™¢Êü•‰∏¶‰øÆÂæ©ÁÑ°ÊïàË®òÈåÑ
                console.log('üîç Ê≠•È©ü3: Ê™¢Êü•ÁÑ°ÊïàË®òÈåÑ...');
                const originalLength = records.length;
                records = records.filter(record => 
                    record.id && record.member && record.type && record.amount && record.date
                );
                const removedCount = originalLength - records.length;
                if (removedCount > 0) {
                    fixes.push(`‚úÖ ÁßªÈô§ ${removedCount} Á≠ÜÁÑ°ÊïàË®òÈåÑ`);
                }
                
                // 4. localStorageÂêåÊ≠•Â∑≤ÁßªÈô§
                console.log('üíæ Ê≠•È©ü4: localStorageÂêåÊ≠•Â∑≤ÁßªÈô§');
                fixes.push('‚úÖ localStorageÂêåÊ≠•Â∑≤ÁßªÈô§');
                
                // 5. Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                console.log('üîÑ Ê≠•È©ü5: Êõ¥Êñ∞È°ØÁ§∫...');
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar();
                updateSyncStatus();
                fixes.push('‚úÖ Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫');
                
                // 6. Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub - Â∑≤ÁßªÈô§
                
                // È°ØÁ§∫‰øÆÂæ©ÁµêÊûú
                const message = `üîß Âø´ÈÄü‰øÆÂæ©ÂÆåÊàêÔºÅ\n\n‰øÆÂæ©È†ÖÁõÆÔºö\n${fixes.join('\n')}\n\nÁï∂ÂâçË®òÈåÑÊï∏Ôºö${records.length}`;
                alert(message);
                console.log('‚úÖ Âø´ÈÄü‰øÆÂæ©ÂÆåÊàê:', fixes);
                
            } catch (error) {
                console.error('‚ùå Âø´ÈÄü‰øÆÂæ©Â§±Êïó:', error);
                alert('‚ùå Âø´ÈÄü‰øÆÂæ©Â§±ÊïóÔºö' + error.message);
            }
        }

        // È†êË¶ΩÂà™Èô§
        function previewDelete() {
            const memberFilter = document.getElementById('deleteMemberFilter').value;
            const typeFilter = document.getElementById('deleteTypeFilter').value;
            const dateFrom = document.getElementById('deleteDateFrom').value;
            const dateTo = document.getElementById('deleteDateTo').value;

            deleteData = records.filter(record => {
                const matchesMember = !memberFilter || record.member === memberFilter;
                const matchesType = !typeFilter || record.type === typeFilter;
                const matchesDateFrom = !dateFrom || record.date >= dateFrom;
                const matchesDateTo = !dateTo || record.date <= dateTo;

                return matchesMember && matchesType && matchesDateFrom && matchesDateTo;
            });

            if (deleteData.length === 0) {
                alert('Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑÂèØ‰ª•Âà™Èô§ÔºÅ');
                return;
            }

            showDeletePreview();
        }

        // È°ØÁ§∫Âà™Èô§È†êË¶Ω
        function showDeletePreview() {
            const previewDiv = document.getElementById('deletePreview');
            const tableBody = document.getElementById('deletePreviewTableBody');
            
            tableBody.innerHTML = '';
            
            deleteData.forEach((record, index) => {
                const row = document.createElement('tr');
                const amountDisplay = record.type === 'income' ? 
                    `+$${record.amount.toLocaleString()}` : 
                    `-$${record.amount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td>${record.member}</td>
                    <td style="color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}">${amountDisplay}</td>
                    <td>${record.mainCategory}</td>
                    <td>${record.subCategory}</td>
                    <td>${record.description}</td>
                    <td>${record.date}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
        }

        // Á¢∫Ë™çÂà™Èô§
        function confirmDelete() {
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                // Âæû records ‰∏≠ÁßªÈô§Ë¶ÅÂà™Èô§ÁöÑË®òÈåÑ
                records = records.filter(record => !deleteData.includes(record));
                
                // saveRecords() Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂
                updateStats();
                updateRecentRecords();
                updateAllRecords();
                updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                updateDataStats();
                cancelDelete();
                
                // Ëá™ÂãïÂÇô‰ªΩÂà∞GitHub - Â∑≤ÁßªÈô§
                
                alert(`ÊàêÂäüÂà™Èô§ ${deleteData.length} Á≠ÜË®òÈåÑÔºÅ`);
            }
        }

        // ÂèñÊ∂àÂà™Èô§
        function cancelDelete() {
            deleteData = [];
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteMemberFilter').value = '';
            document.getElementById('deleteTypeFilter').value = '';
            document.getElementById('deleteDateFrom').value = '';
            document.getElementById('deleteDateTo').value = '';
        }

        // GitHub Token ÁãÄÊÖãÊ™¢Êü•ÂäüËÉΩ
        async function checkTokenStatus() {
            const tokenStatus = document.getElementById('tokenStatus');
            const checkBtn = document.getElementById('checkTokenBtn');
            
            try {
                checkBtn.disabled = true;
                checkBtn.innerHTML = 'üîç Ê™¢Êü•‰∏≠...';
                
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/github/token/status');
                const result = await response.json();
                
                if (result.success) {
                    if (result.hasToken) {
                        tokenStatus.innerHTML = `
                            <div style="background: rgba(40, 167, 69, 0.2); color: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <h5 style="margin: 0 0 10px 0;">‚úÖ Token ÁãÄÊÖãÊ≠£Â∏∏</h5>
                                <p style="margin: 5px 0;"><strong>Token:</strong> ${result.tokenPreview}</p>
                                <p style="margin: 5px 0;"><strong>‰æÜÊ∫ê:</strong> ${result.tokenSource}</p>
                                <p style="margin: 5px 0; font-size: 0.9em; opacity: 0.8;">${result.message}</p>
                            </div>
                        `;
                    } else {
                        tokenStatus.innerHTML = `
                            <div style="background: rgba(255, 193, 7, 0.2); color: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <h5 style="margin: 0 0 10px 0;">‚ö†Ô∏è Token Êú™Ë®≠ÁΩÆ</h5>
                                <p style="margin: 5px 0;">${result.message}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;">Ë´ãÂú® Render Dashboard ‰∏≠Ë®≠ÁΩÆ GITHUB_TOKEN Áí∞Â¢ÉËÆäÊï∏</p>
                            </div>
                        `;
                    }
                } else {
                    tokenStatus.innerHTML = `
                        <div style="background: rgba(220, 53, 69, 0.2); color: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h5 style="margin: 0 0 10px 0;">‚ùå Token Ê™¢Êü•Â§±Êïó</h5>
                            <p style="margin: 5px 0;">${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                tokenStatus.innerHTML = `
                    <div style="background: rgba(220, 53, 69, 0.2); color: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5 style="margin: 0 0 10px 0;">‚ùå Token Ê™¢Êü•ÈåØË™§</h5>
                        <p style="margin: 5px 0;">${error.message}</p>
                    </div>
                `;
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerHTML = 'üîç Ê™¢Êü• Token ÁãÄÊÖã';
            }
        }
        

        // GitHub ÂêåÊ≠•ÂäüËÉΩ
        async function syncToGitHub() {
            const syncBtn = document.getElementById('syncBtn');
            const syncStatus = document.getElementById('syncStatus');
            
            try {
                // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
                syncBtn.disabled = true;
                syncBtn.innerHTML = 'üîÑ ÂêåÊ≠•‰∏≠...';
                syncStatus.style.display = 'block';
                syncStatus.className = 'sync-status loading';
                syncStatus.innerHTML = 'Ê≠£Âú®ÂêåÊ≠•Ë≥áÊñôÂà∞ GitHub...';
                
                console.log('üîÑ ÈñãÂßãÂêåÊ≠•Ë≥áÊñôÂà∞ GitHub...');
                
                // ÂëºÂè´ÂæåÁ´Ø API
                const response = await fetch(ENV_CONFIG.getApiBase() + '/api/github/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ÊàêÂäü
                    syncStatus.className = 'sync-status success';
                    syncStatus.innerHTML = `‚úÖ ${result.message}`;
                    console.log('‚úÖ ÂêåÊ≠•ÊàêÂäü:', result);
                } else {
                    // Â§±Êïó
                    syncStatus.className = 'sync-status error';
                    syncStatus.innerHTML = `‚ùå ÂêåÊ≠•Â§±Êïó: ${result.message}`;
                    console.error('‚ùå ÂêåÊ≠•Â§±Êïó:', result);
                }
                
            } catch (error) {
                // ÈåØË™§ËôïÁêÜ
                syncStatus.className = 'sync-status error';
                syncStatus.innerHTML = `‚ùå ÂêåÊ≠•Â§±Êïó: ${error.message}`;
                console.error('‚ùå ÂêåÊ≠•ÈåØË™§:', error);
            } finally {
                // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                syncBtn.disabled = false;
                syncBtn.innerHTML = 'üíæ ÂÑ≤Â≠òÂà∞ GitHub';
                
                // 3ÁßíÂæåÈö±ËóèÁãÄÊÖãË®äÊÅØ
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö
        async function clearAllData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•Ê∏ÖÁ©∫ÔºÅ');
                return;
            }

            const confirmMessage = `‚ö†Ô∏è Ë≠¶ÂëäÔºöÊÇ®Âç≥Â∞áÊ∏ÖÁ©∫ÊâÄÊúâ ${records.length} Á≠ÜË®òÈåÑÔºÅ\n\nÊ≠§Êìç‰ΩúÂ∞áÔºö\n- Âà™Èô§JSONÊñá‰ª∂‰∏≠ÁöÑÊâÄÊúâË®òÈåÑ\n- Ê∏ÖÁ©∫Áµ±Ë®àÊï∏Êìö\n- ÁÑ°Ê≥ïÂæ©Âéü\n\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm('ÊúÄÂæåÁ¢∫Ë™çÔºöÊÇ®ÁúüÁöÑË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÂóéÔºü\n\nË´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÔºàË´ãÊâãÂãïËº∏ÂÖ• YESÔºâ');
                
                if (doubleConfirm) {
                    const userInput = prompt('Ë´ãËº∏ÂÖ• "YES" ‰æÜÁ¢∫Ë™çÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÔºö');
                    
                    if (userInput === 'YES') {
                        try {
                            console.log('üóëÔ∏è ÈñãÂßãÊ∏ÖÈô§JSONÊñá‰ª∂‰∏≠ÁöÑÊâÄÊúâÊï∏Êìö...');
                            console.log('üîó Ê∏ÖÈô§API URL:', ENV_CONFIG.getApiBase() + '/api/records/clear');
                            
                            // ‰ΩøÁî®JSONÊñá‰ª∂Ê∏ÖÈô§API
                            const clearResponse = await fetch(ENV_CONFIG.getApiBase() + '/api/records/clear', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            console.log('üì° Ê∏ÖÈô§APIÂõûÊáâÁãÄÊÖã:', clearResponse.status);
                            console.log('üì° Ê∏ÖÈô§APIÂõûÊáâOK:', clearResponse.ok);
                            
                            const clearResult = await clearResponse.json();
                            console.log('üì° Ê∏ÖÈô§APIÂõûÊáâÂÖßÂÆπ:', clearResult);
                            
                            if (clearResult.success) {
                                console.log('‚úÖ JSONÊñá‰ª∂Â∑≤Ê∏ÖÁ©∫:', clearResult.message);
                                
                                // Ê∏ÖÈô§ÂâçÁ´ØÊï∏Êìö
                                records = [];
                                // localStorageÊ∏ÖÈô§Â∑≤ÁßªÈô§
                                
                                // Ê∏ÖÈô§Âæå‰∏çÈúÄË¶ÅÈáçÊñ∞ËºâÂÖ•Êï∏ÊìöÔºåÂõ†ÁÇ∫Â∑≤Á∂ìÊ∏ÖÁ©∫‰∫Ü
                                console.log('‚úÖ Êï∏ÊìöÂ∑≤Ê∏ÖÁ©∫Ôºå‰∏çÈúÄË¶ÅÈáçÊñ∞ËºâÂÖ•');
                                
                                // Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                                updateStats();
                                updateRecentRecords();
                                updateAllRecords();
                                updateCalendar();
                                updateDataStats();
                                updateMemberStats();
                        
                                alert(`‚úÖ ÊâÄÊúâÊï∏ÊìöÂ∑≤ÊàêÂäüÊ∏ÖÁ©∫ÔºÅ\n\nÊ∏ÖÈô§‰∫Ü ${clearResult.changes} Á≠ÜË®òÈåÑ`);
                            } else {
                                console.error('‚ùå JSONÊñá‰ª∂Ê∏ÖÈô§Â§±Êïó:', clearResult.message);
                                alert('‚ùå Êñá‰ª∂Ê∏ÖÈô§Â§±ÊïóÔºö' + clearResult.message);
                            }
                            
                            console.log('‚úÖ Ê∏ÖÈô§Êï∏ÊìöÂÆåÊàê');
                        } catch (error) {
                            console.error('‚ùå Ê∏ÖÈô§Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§:', error);
                            alert('‚ùå Ê∏ÖÈô§Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                        }
                    } else {
                        alert('Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ');
                    }
                }
            }
        }

        // ÂÇô‰ªΩÊï∏Êìö
        function backupData() {
            if (records.length === 0) {
                alert('Ê≤íÊúâÊï∏ÊìöÂèØ‰ª•ÂÇô‰ªΩÔºÅ');
                return;
            }

            dataBackup = JSON.parse(JSON.stringify(records));
            const backupData = {
                timestamp: new Date().toISOString(),
                records: dataBackup,
                count: records.length
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family_records_backup_${formatDateToYYYYMMDD(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`Êï∏ÊìöÂÇô‰ªΩÂÆåÊàêÔºÅ\nÂÇô‰ªΩ‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
        }

        // ÈÇÑÂéüÊï∏Êìö
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.records || !Array.isArray(backupData.records)) {
                            alert('ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÔºÅ');
                            return;
                        }

                        const confirmMessage = `ÊâæÂà∞ÂÇô‰ªΩÊï∏ÊìöÔºö\n- ÂÇô‰ªΩÊôÇÈñìÔºö${backupData.timestamp}\n- Ë®òÈåÑÊï∏ÈáèÔºö${backupData.count}\n\nÁ¢∫ÂÆöË¶ÅÈÇÑÂéüÈÄô‰∫õÊï∏ÊìöÂóéÔºü\nÔºàÁï∂ÂâçÊï∏ÊìöÂ∞áË¢´Ë¶ÜËìãÔºâ`;
                        
                        if (confirm(confirmMessage)) {
                            records = backupData.records;
                            // saveRecords() Â∑≤ÁßªÈô§ - Êï∏ÊìöÁõ¥Êé•‰øùÂ≠òÂà∞JSONÊñá‰ª∂
                            updateStats();
                            updateRecentRecords();
                            updateAllRecords();
                            updateCalendar(); // Á¢∫‰øùÊó•ÊõÜÊõ¥Êñ∞
                            updateDataStats();
                            
                            alert(`Êï∏ÊìöÈÇÑÂéüÂÆåÊàêÔºÅ\nÈÇÑÂéü‰∫Ü ${records.length} Á≠ÜË®òÈåÑ„ÄÇ`);
                        }
                    } catch (error) {
                        alert('ËÆÄÂèñÂÇô‰ªΩÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== ÂúñË°®Áõ∏ÈóúÂáΩÊï∏ ====================

        // ÂàùÂßãÂåñÊâÄÊúâÂúñË°®
        function initializeCharts() {
            console.log('ÂàùÂßãÂåñÂúñË°®...');
            console.log('Áï∂ÂâçË®òÈåÑÊï∏Èáè:', records.length);
            console.log('Ë®òÈåÑÂÖßÂÆπ:', records);
            
            // Ê™¢Êü• Chart.js ÊòØÂê¶ËºâÂÖ•
            if (typeof Chart === 'undefined') {
                console.error('Chart.js Êú™ËºâÂÖ•');
                showErrorMessage('ÂúñË°®Â∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                return;
            }
            
            setCurrentMonth();
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÊï∏Êìö
            if (records.length === 0) {
                console.log('Ê≤íÊúâË®òÈåÑÊï∏ÊìöÔºåÈ°ØÁ§∫ÊèêÁ§∫‰ø°ÊÅØ');
                showNoDataMessage();
                return;
            }
            
            updateCharts();
        }

        // È°ØÁ§∫ÈåØË™§‰ø°ÊÅØ
        function showErrorMessage(message) {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <h4>‚ùå ÂúñË°®ËºâÂÖ•Â§±Êïó</h4>
                            <p>${message}</p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                                ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
                            </button>
                        </div>
                    `;
                }
            });
        }

        // È°ØÁ§∫ÁÑ°Êï∏ÊìöÊèêÁ§∫
        function showNoDataMessage() {
            const chartSections = document.querySelectorAll('.chart-section');
            chartSections.forEach(section => {
                const canvas = section.querySelector('canvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h4>üìä Êö´ÁÑ°Êï∏Êìö</h4>
                            <p>Ë´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÊî∂ÊîØË®òÈåÑÔºåÁÑ∂ÂæåÂÜçÊü•ÁúãÂúñË°®</p>
                            <button class="btn" onclick="showTab('add')" style="margin-top: 15px;">
                                ÂâçÂæÄÊñ∞Â¢ûË®òÈåÑ
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Ë®≠ÁΩÆÁï∂ÂâçÊúà‰ªΩÁÇ∫ÈªòË™çÈÅ∏‰∏≠
        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11
            const monthSelect = document.getElementById('chartMonth');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂúñË°®
        function updateCharts() {
            const year = parseInt(document.getElementById('chartYear').value);
            const month = parseInt(document.getElementById('chartMonth').value);
            
            console.log('Êõ¥Êñ∞ÂúñË°®:', { year, month });
            
            updateTrendChart(year, month);
            updateCategoryChart(year, month);
            updateMemberChart(year, month);
        }

        // ÈáçÊñ∞Êï¥ÁêÜÂúñË°®
        function refreshCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (memberChart) memberChart.destroy();
            
            updateCharts();
        }

        // Áç≤ÂèñÊåáÂÆöÊúà‰ªΩÁöÑÊï∏Êìö
        function getDataByMonth(year, month) {
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // getMonth() ËøîÂõû 0-11ÔºåÈúÄË¶Å +1
                
                return recordYear === year && recordMonth === month;
            });
            
            return filteredRecords;
        }

        // Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®
        function updateTrendChart(year, month) {
            console.log('Êõ¥Êñ∞Êî∂ÊîØË∂®Âã¢ÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ trendChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('Ë∂®Âã¢ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processDailyTrendData(data, year, month);
            console.log('ËôïÁêÜÂæåÁöÑË∂®Âã¢ÂúñË°®Êï∏Êìö:', chartData);
            
            trendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊØèÊó•Êî∂ÊîØË∂®Âã¢`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }


        // Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®
        function updateCategoryChart(year, month) {
            console.log('Êõ¥Êñ∞È°ûÂà•Áµ±Ë®àÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('categoryChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ categoryChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('È°ûÂà•ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processCategoryData(data);
            console.log('ËôïÁêÜÂæåÁöÑÈ°ûÂà•ÂúñË°®Êï∏Êìö:', chartData);
            
            categoryChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊîØÂá∫È°ûÂà•Áµ±Ë®à`
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®
        function updateMemberChart(year, month) {
            console.log('Êõ¥Êñ∞ÊàêÂì°Êî∂ÊîØÂ∞çÊØîÂúñË°®:', { year, month });
            
            const ctx = document.getElementById('memberChart');
            if (!ctx) {
                console.error('Êâæ‰∏çÂà∞ memberChart canvas ÂÖÉÁ¥†');
                return;
            }
            
            if (memberChart) {
                memberChart.destroy();
            }
            
            const data = getDataByMonth(year, month);
            console.log('ÊàêÂì°ÂúñË°®Êï∏Êìö:', data);
            
            const chartData = processMemberData(data);
            console.log('ËôïÁêÜÂæåÁöÑÊàêÂì°ÂúñË°®Êï∏Êìö:', chartData);
            
            memberChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Êî∂ÂÖ•',
                            data: chartData.income,
                            backgroundColor: 'rgba(81, 207, 102, 0.8)',
                            borderColor: '#51cf66',
                            borderWidth: 1
                        },
                        {
                            label: 'ÊîØÂá∫',
                            data: chartData.expense,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}Âπ¥${month}Êúà ÊàêÂì°Êî∂ÊîØÂ∞çÊØî`
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ËôïÁêÜÊØèÊó•Ë∂®Âã¢Êï∏Êìö
        function processDailyTrendData(data, year, month) {
            const groupedData = {};
            
            // Áç≤ÂèñË©≤ÊúàÁöÑÂ§©Êï∏
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // ÂàùÂßãÂåñÊâÄÊúâÂ§©Êï∏
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day).padStart(2, '0');
                groupedData[dayKey] = { income: 0, expense: 0 };
            }
            
            // ËôïÁêÜÂØ¶ÈöõÊï∏Êìö
            data.forEach(record => {
                const date = new Date(record.date);
                const day = String(date.getDate()).padStart(2, '0');
                
                if (record.type === 'income') {
                    groupedData[day].income += record.amount;
                } else {
                    groupedData[day].expense += record.amount;
                }
            });
            
            const labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
            const income = labels.map(day => groupedData[day].income);
            const expense = labels.map(day => groupedData[day].expense);
            
            return { labels, income, expense };
        }


        // ËôïÁêÜÈ°ûÂà•Êï∏Êìö
        function processCategoryData(data) {
            const categoryTotals = {};
            
            data.filter(record => record.type === 'expense').forEach(record => {
                const category = record.mainCategory;
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += record.amount;
            });
            
            // ÊåâÈáëÈ°çÊéíÂ∫è
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Âè™È°ØÁ§∫Ââç10ÂÄãÈ°ûÂà•
            
            const labels = sortedCategories.map(([category]) => category);
            const values = sortedCategories.map(([, amount]) => amount);
            
            return { labels, values };
        }

        // ËôïÁêÜÊàêÂì°Êï∏Êìö
        function processMemberData(data) {
            const memberTotals = {};
            
            data.forEach(record => {
                const member = record.member;
                
                if (!memberTotals[member]) {
                    memberTotals[member] = { income: 0, expense: 0 };
                }
                
                if (record.type === 'income') {
                    memberTotals[member].income += record.amount;
                } else {
                    memberTotals[member].expense += record.amount;
                }
            });
            
            // ÊåâÁÖßÊåáÂÆöÈ†ÜÂ∫èÊéíÂàóÔºöKelvin„ÄÅPhuong„ÄÅRyan„ÄÅÂÆ∂Áî®
            const orderedMembers = ['Kelvin', 'Phuong', 'Ryan', 'ÂÆ∂Áî®'];
            const labels = orderedMembers.filter(member => memberTotals[member]);
            const income = labels.map(member => memberTotals[member].income);
            const expense = labels.map(member => memberTotals[member].expense);
            
            return { labels, income, expense };
        }

    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-version">
                <span class="footer-version-label">ÁâàÊú¨</span>
                <span class="footer-version-number" id="footerVersionNumber">ËºâÂÖ•‰∏≠...</span>
            </div>
        </div>
    </footer>
</body>
</html>
// Ëß∏ÁôºÈáçÊñ∞ÈÉ®ÁΩ≤ - Thu Sep 25 15:25:15 CST 2025
